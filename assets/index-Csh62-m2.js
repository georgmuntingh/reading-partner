(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function F(_,e="en"){if(!_||typeof _!="string")return[];if(_=_.replace(/([.!?:;])([A-Z])/g,"$1 $2"),_=_.replace(/([a-z]):([a-z])/gi,"$1: $2"),_=_.replace(/\s+/g," ").trim(),!_)return[];if("Segmenter"in Intl)try{return[...new Intl.Segmenter(e,{granularity:"sentence"}).segment(_)].map(i=>i.segment.trim()).filter(i=>i.length>0)}catch(t){console.warn("Intl.Segmenter failed, using fallback:",t)}return O(_)}function O(_){const e=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","vs","etc","e.g","i.e","Inc","Ltd","Corp","St","Ave","Blvd","Rd","Mt","Ft","Jan","Feb","Mar","Apr","Jun","Jul","Aug","Sep","Oct","Nov","Dec","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];let t=_;const s=[];e.forEach((l,c)=>{const h=new RegExp(`\\b${l}\\.`,"g"),d=`__ABBR${c}__`;t=t.replace(h,`${l}${d}`),s.push({placeholder:d,replacement:"."})});const i=/([.!?]+)(?:\s+|$)/g,o=[];let n=0,a;for(;(a=i.exec(t))!==null;){const l=t.slice(n,a.index+a[1].length);l.trim()&&o.push(l.trim()),n=a.index+a[0].length}const r=t.slice(n).trim();return r&&o.push(r),o.map(l=>{let c=l;return s.forEach(({placeholder:h,replacement:d})=>{c=c.replace(new RegExp(h,"g"),d)}),c})}function U(_,e=500){if(!_||_.length<=e)return[_];const t=[];let s=_;for(;s.length>e;){let i=-1;const o=Math.min(e,s.length),n=Math.floor(o*.7),a=[{char:";",offset:1},{char:",",offset:1},{char:" - ",offset:3},{char:" ‚Äî ",offset:3},{char:" ",offset:1}];for(const{char:r,offset:l}of a)if(i=s.lastIndexOf(r,o),i>=n){i+=l;break}i<n&&(i=e),t.push(s.substring(0,i).trim()),s=s.substring(i).trim()}return s.length>0&&t.push(s),t}async function K(_){const t=new TextEncoder().encode(_),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(o=>o.toString(16).padStart(2,"0")).join("").slice(0,16)}function z(_,e){let t;return function(...s){clearTimeout(t),t=setTimeout(()=>_.apply(this,s),e)}}class Q{constructor(){this._book=null}async loadFromFile(e){if(console.time("EPUBParser.loadFromFile"),!e.name.toLowerCase().endsWith(".epub"))throw new Error("Invalid file type. Please select an EPUB file.");console.time("EPUBParser.readFile");const t=await e.arrayBuffer();console.timeEnd("EPUBParser.readFile");const s=e.name+e.size+e.lastModified,i=await K(s);console.time("EPUBParser.initBook"),this._book=ePub(t),await this._book.ready,console.timeEnd("EPUBParser.initBook");const o=await this._extractMetadata();console.time("EPUBParser.getChapterMetadata");const n=await this._getChapterMetadata();console.timeEnd("EPUBParser.getChapterMetadata");const a=await this._extractCover();return console.timeEnd("EPUBParser.loadFromFile"),console.log(`Book loaded: ${n.length} chapters (content will be loaded on-demand)`),{id:i,title:o.title||e.name.replace(".epub",""),author:o.author||"Unknown Author",coverImage:a,chapters:n,lastOpened:Date.now()}}async _extractMetadata(){const e=this._book.package.metadata;return{title:e.title||"",author:e.creator||""}}async _extractCover(){try{if(this._book.cover){const e=await this._book.archive.getBlob(this._book.cover).catch(()=>null);if(e&&e.size>0)return this._ensureBlobMimeType(e,this._book.cover)}}catch{}try{const e=await this._book.coverUrl();if(e){const t=await fetch(e);if(t.ok)return await t.blob()}}catch(e){console.warn("Could not extract cover:",e)}return null}async _getChapterMetadata(){var o;const e=this._book.spine,t=((o=this._book.navigation)==null?void 0:o.toc)||[],s=[],i=new Map;this._flattenToc(t,i);for(let n=0;n<e.items.length;n++){const a=e.items[n],r=i.get(a.href)||i.get(a.href.split("#")[0])||`Chapter ${n+1}`;s.push({id:a.idref||`chapter-${n}`,title:r,href:a.href,sentences:null,html:null,loaded:!1})}return s}async loadChapter(e,t){var i,o;if(t<0||t>=e.chapters.length)return[];const s=e.chapters[t];if(s.loaded&&s.sentences)return console.log(`Chapter ${t} already loaded (${s.sentences.length} sentences)`),s.sentences;console.time(`EPUBParser.loadChapter[${t}]`),console.log(`Loading chapter ${t}: "${s.title}"`);try{const n=await this._book.load(s.href);console.log("Loaded doc type:",typeof n,n),console.log("Doc has body:",!!(n!=null&&n.body)),n!=null&&n.body&&(console.log("Body innerHTML length:",(i=n.body.innerHTML)==null?void 0:i.length),console.log("Body textContent length:",(o=n.body.textContent)==null?void 0:o.length));const{html:a,sentences:r}=await this._processHtmlWithSentences(n,s.href);return console.log(`Processed HTML length: ${a.length}, sentences: ${r.length}`),r.length===0?(console.warn("Chapter has no text content"),s.sentences=[],s.html=a||'<div class="epub-content"></div>',s.loaded=!0,console.timeEnd(`EPUBParser.loadChapter[${t}]`),[]):(s.sentences=r,s.html=a,s.loaded=!0,console.timeEnd(`EPUBParser.loadChapter[${t}]`),console.log(`Chapter ${t} loaded: ${r.length} sentences`),r)}catch(n){return console.error(`Failed to load chapter ${t}:`,n),s.sentences=[],s.html='<div class="epub-content"></div>',s.loaded=!0,[]}}async _processHtmlWithSentences(e,t){let s=this._getBodyElement(e);if(!s)return{html:'<div class="epub-content"></div>',sentences:[]};s=s.cloneNode(!0);const i=["script","style","nav","aside",'[role="navigation"]','[role="banner"]',".pagebreak",".page-break"];s.querySelectorAll(i.join(",")).forEach(a=>a.remove()),await this._fixImageSources(s,t);const o=[];this._wrapSentencesInElement(s,o);const n=document.createElement("div");return n.className="epub-content",n.innerHTML=s.innerHTML,{html:n.outerHTML,sentences:o}}_getBodyElement(e){return e?typeof e=="string"?new DOMParser().parseFromString(e,"text/html").body:e.body?e.body:e.nodeType===Node.ELEMENT_NODE?e:e.documentElement?e.documentElement:null:null}async _fixImageSources(e,t){const s=[];e.querySelectorAll("img").forEach(n=>{const a=n.getAttribute("src");if(a&&!a.startsWith("data:")&&!a.startsWith("blob:")&&!a.startsWith("http")){const r=this._loadImageBlob(a,t).then(l=>{l&&(n.src=URL.createObjectURL(l))}).catch(l=>{console.warn("Failed to load image:",a,l)});s.push(r)}}),e.querySelectorAll("image").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("xlink:href")||n.getAttributeNS("http://www.w3.org/1999/xlink","href");if(a&&!a.startsWith("data:")&&!a.startsWith("blob:")&&!a.startsWith("http")){const r=this._loadImageBlob(a,t).then(l=>{if(l){const c=URL.createObjectURL(l);n.setAttribute("href",c),n.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",c)}}).catch(l=>{console.warn("Failed to load SVG image:",a,l)});s.push(r)}}),s.length>0&&(console.log(`Loading ${s.length} images...`),await Promise.all(s),console.log("All images loaded"))}async _loadImageBlob(e,t){var s,i;try{const n=(((i=(s=this._book)==null?void 0:s.path)==null?void 0:i.directory)||"/")+t,a=this._resolveToArchivePath(e,n);if(a){const r=await this._book.archive.getBlob(a).catch(()=>null);if(r&&r.size>0)return this._ensureBlobMimeType(r,e)}}catch{}try{const o=this._resolveToArchivePath(e,t);if(o){const n=await this._book.archive.getBlob(o).catch(()=>null);if(n&&n.size>0)return this._ensureBlobMimeType(n,e)}}catch{}try{const o=e.startsWith("/")?e:"/"+e,n=await this._book.archive.getBlob(o).catch(()=>null);if(n&&n.size>0)return this._ensureBlobMimeType(n,e)}catch{}try{const o=this._book.resolve(e,!1);if(o){const n=await this._book.archive.getBlob(o).catch(()=>null);if(n&&n.size>0)return this._ensureBlobMimeType(n,e)}}catch{}return console.warn("All image loading strategies failed for:",e),null}_resolveToArchivePath(e,t){if(!t)return null;const s=t.lastIndexOf("/"),i=s>=0?t.substring(0,s):"",n=(i?i+"/"+e:e).split("/"),a=[];for(const r of n)r===".."&&a.length>0&&a[a.length-1]!==""?a.pop():r!=="."&&r!==""&&a.push(r);return"/"+a.join("/")}_ensureBlobMimeType(e,t){var n;if(e.type&&e.type.startsWith("image/"))return e;const s=(n=t.split(".").pop())==null?void 0:n.toLowerCase().split("?")[0],o={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp",bmp:"image/bmp",tif:"image/tiff",tiff:"image/tiff",avif:"image/avif",jxl:"image/jxl"}[s];return o?new Blob([e],{type:o}):e}_wrapSentencesInElement(e,t){const s=new Set(["SCRIPT","STYLE","CODE","PRE","TEXTAREA"]),i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:n=>{var r;let a=n.parentNode;for(;a&&a!==e;){if(s.has(a.tagName))return NodeFilter.FILTER_REJECT;a=a.parentNode}return(r=n.textContent)!=null&&r.trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),o=[];for(;i.nextNode();)o.push(i.currentNode);for(const n of o)this._wrapTextNodeSentences(n,t)}_wrapTextNodeSentences(e,t){const s=e.textContent;if(!(s!=null&&s.trim()))return;const i=F(s);if(i.length===0)return;const o=document.createDocumentFragment();let n=s;for(const a of i){const r=a.trim();if(!r)continue;const l=n.indexOf(r);if(l===-1){const d=n.replace(/\s+/g," "),f=r.replace(/\s+/g," "),b=d.indexOf(f);if(b===-1)continue;const S=n.substring(0,b);S&&o.appendChild(document.createTextNode(S));const v=document.createElement("span");v.className="sentence",v.dataset.index=t.length.toString(),v.textContent=r,o.appendChild(v),o.appendChild(document.createTextNode(" ")),t.push(r),n=n.substring(b+f.length);continue}if(l>0){const d=n.substring(0,l);o.appendChild(document.createTextNode(d))}const c=document.createElement("span");c.className="sentence",c.dataset.index=t.length.toString(),c.textContent=r,o.appendChild(c);const h=l+r.length;h<n.length&&/\s/.test(n[h])&&o.appendChild(document.createTextNode(" ")),t.push(r),n=n.substring(h).replace(/^\s+/,"")}n.trim()&&o.appendChild(document.createTextNode(n)),e.parentNode.replaceChild(o,e)}getChapterHtml(e,t){return t<0||t>=e.chapters.length?null:e.chapters[t].html||null}_flattenToc(e,t){var s,i;for(const o of e){if(o.href){t.set(o.href,((s=o.label)==null?void 0:s.trim())||"");const n=o.href.split("#")[0];t.has(n)||t.set(n,((i=o.label)==null?void 0:i.trim())||"")}o.subitems&&o.subitems.length>0&&this._flattenToc(o.subitems,t)}}_extractText(e){let t;if(!e)return console.warn("_extractText: doc is null/undefined"),"";if(typeof e=="string")console.log("_extractText: doc is a string, parsing as HTML"),t=new DOMParser().parseFromString(e,"text/html").body;else if(e.body)t=e.body.cloneNode(!0);else if(e.nodeType===Node.ELEMENT_NODE)console.log("_extractText: doc is an Element"),t=e.cloneNode(!0);else if(e.documentElement)console.log("_extractText: doc has documentElement"),t=e.documentElement.cloneNode(!0);else return console.warn("_extractText: unknown doc type",typeof e,e),"";if(!t)return console.warn("_extractText: could not get body"),"";const s=["script","style","nav","aside",'[role="navigation"]','[role="banner"]',".pagebreak",".page-break"];t.querySelectorAll(s.join(",")).forEach(n=>n.remove());let i="";const o=t.querySelectorAll("p, h1, h2, h3, h4, h5, h6, div, li, blockquote, span");if(console.log(`Found ${o.length} block elements`),o.length>0){const n=new Set;o.forEach(a=>{var l;if(n.has(a))return;a.querySelectorAll("p, div, span").forEach(c=>n.add(c));const r=(l=a.textContent)==null?void 0:l.trim();r&&(i+=r+`

`)})}return i.trim()||(console.log("No text from block elements, using body.textContent"),i=t.textContent||""),i=i.replace(/[\t ]+/g," ").replace(/\n{3,}/g,`

`).replace(/^\s+|\s+$/gm,"").trim(),i}getChapterSentences(e,t){return t<0||t>=e.chapters.length?[]:e.chapters[t].sentences||[]}destroy(){this._book&&(this._book.destroy(),this._book=null)}}const L=new Q,V="modulepreload",G=function(_){return"/reading-partner/"+_},q={},j=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){let n=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),r=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=n(t.map(l=>{if(l=G(l),l in q)return;q[l]=!0;const c=l.endsWith(".css"),h=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const d=document.createElement("link");if(d.rel=c?"stylesheet":V,c||(d.as="script"),d.crossOrigin="",d.href=l,r&&d.setAttribute("nonce",r),document.head.appendChild(d),c)return new Promise((f,b)=>{d.addEventListener("load",f),d.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${l}`)))})}))}function o(n){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=n,window.dispatchEvent(a),!a.defaultPrevented)throw n}return i.then(n=>{for(const a of n||[])a.status==="rejected"&&o(a.reason);return e().catch(o)})},M="http://localhost:8880";class W{constructor(){this._kokoro=null,this._isReady=!1,this._isLoading=!1,this._useKokoro=!0,this._currentVoice="af_heart",this._speed=1,this._audioContext=null,this._onProgress=null,this._device="wasm",this._dtype="fp32",this._sampleRate=24e3,this._backend="kokoro-js",this._fastApiUrl=M,this._fastApiAvailable=!1,this._benchmarkResults=[],this._benchmarkEnabled=!1,this._synthesisQueue=[],this._isSynthesizing=!1,this._currentSource=null,this._webSpeechSupported="speechSynthesis"in window}onProgress(e){this._onProgress=e}async isWebGPUAvailable(){if(!navigator.gpu)return!1;try{return await navigator.gpu.requestAdapter()!==null}catch{return!1}}async isKokoroFastAPIAvailable(e){const t=e||this._fastApiUrl;try{const s=new AbortController,i=setTimeout(()=>s.abort(),2e3),o=await fetch(`${t}/v1/models`,{signal:s.signal});return clearTimeout(i),this._fastApiAvailable=o.ok,o.ok}catch{return this._fastApiAvailable=!1,!1}}isFastAPIAvailable(){return this._fastApiAvailable}setFastApiUrl(e){this._fastApiUrl=e||M}getFastApiUrl(){return this._fastApiUrl}getBackend(){return this._backend}async setBackend(e){e===this._backend&&this._isReady||(this._backend=e,this._isReady=!1,this._isLoading=!1,this._kokoro=null,await this.initialize({backend:e}))}async initialize(e={}){if(this._isReady)return this._useKokoro;if(this._isLoading)return new Promise(i=>{const o=setInterval(()=>{this._isReady&&(clearInterval(o),i(this._useKokoro))},100)});if(this._isLoading=!0,e.backend&&(this._backend=e.backend),this._backend==="kokoro-fastapi")try{if(this._reportProgress({status:"Connecting to Kokoro FastAPI..."}),await this.isKokoroFastAPIAvailable())return this._useKokoro=!0,this._device="fastapi",this._isReady=!0,this._isLoading=!1,this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)),this._reportProgress({status:"TTS ready (Kokoro FastAPI)",progress:100}),console.log(`Kokoro FastAPI TTS initialized: ${this._fastApiUrl}`),!0;console.warn("Kokoro FastAPI not available, falling back to kokoro-js"),this._backend="kokoro-js"}catch(i){console.warn("Kokoro FastAPI check failed:",i),this._backend="kokoro-js"}if(this._backend==="web-speech"){if(this._webSpeechSupported)return this._useKokoro=!1,this._device="web-speech",this._isReady=!0,this._isLoading=!1,this._reportProgress({status:"TTS ready (Browser)"}),console.log("Using Web Speech API backend"),!1;console.warn("Web Speech not supported, falling back to kokoro-js"),this._backend="kokoro-js"}let t=e.device||"auto";if(t==="auto"){const i=await this.isWebGPUAvailable();t=i?"webgpu":"wasm",console.log(`Auto-detected device: ${t} (WebGPU ${i?"available":"not available"})`),i||this._showWebGPUWarning()}let s=e.dtype;s||(s=t==="webgpu"?"fp32":"q8"),this._device=t,this._dtype=s;try{return this._reportProgress({status:`Loading TTS engine (${t})...`}),await this._initializeKokoro(t,s),this._useKokoro=!0,this._backend="kokoro-js",this._isReady=!0,this._reportProgress({status:`TTS ready (${t}, ${s})`,progress:100}),console.log(`Kokoro TTS initialized: device=${t}, dtype=${s}`),!0}catch(i){if(console.warn("Kokoro TTS failed to load, using Web Speech fallback:",i),this._webSpeechSupported)return this._useKokoro=!1,this._backend="web-speech",this._isReady=!0,this._reportProgress({status:"Using browser TTS (fallback)"}),!1;throw new Error("No TTS engine available. Please use a browser that supports speech synthesis.")}finally{this._isLoading=!1}}async _initializeKokoro(e,t){this._reportProgress({status:"Loading Kokoro library...",progress:10});const{KokoroTTS:s}=await j(async()=>{const{KokoroTTS:i}=await import("https://cdn.jsdelivr.net/npm/kokoro-js@1.1.0/+esm");return{KokoroTTS:i}},[]);this._reportProgress({status:`Initializing model (${e}, ${t})...`,progress:30}),this._kokoro=await s.from_pretrained("onnx-community/Kokoro-82M-v1.0-ONNX",{dtype:t,device:e}),this._reportProgress({status:"Model loaded",progress:100}),this._audioContext=new(window.AudioContext||window.webkitAudioContext)}_reportProgress(e){this._onProgress&&this._onProgress(e)}_showWebGPUWarning(){const e=`No WebGPU enabled. For better performance, launch Google Chrome with:

google-chrome --enable-unsafe-webgpu --ozone-platform=x11 --use-angle=vulkan --enable-features=Vulkan,VulkanFromANGLE`;console.warn("WebGPU not available. Using WASM backend (slower)."),console.info(e);const t=document.createElement("div");t.id="webgpu-warning",t.style.cssText=`
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90vw;
            padding: 12px 16px;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            font-size: 13px;
            color: #92400e;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `,t.innerHTML=`
            <div style="display: flex; align-items: flex-start; gap: 10px;">
                <span style="font-size: 18px;">‚ö†Ô∏è</span>
                <div>
                    <strong>WebGPU not enabled</strong><br>
                    <span style="font-size: 12px;">Using slower WASM backend. For better performance, launch Chrome with:</span><br>
                    <code style="font-size: 11px; background: #fde68a; padding: 2px 4px; border-radius: 3px; word-break: break-all;">
                        google-chrome --enable-unsafe-webgpu --ozone-platform=x11 --use-angle=vulkan --enable-features=Vulkan,VulkanFromANGLE
                    </code>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 0; margin-left: auto;">√ó</button>
            </div>
        `,document.body.appendChild(t),setTimeout(()=>{t==null||t.remove()},15e3)}setBenchmarkEnabled(e){this._benchmarkEnabled=e,e||(this._benchmarkResults=[])}getBenchmarkResults(){return[...this._benchmarkResults]}getAverageRTF(){return this._benchmarkResults.length===0?null:this._benchmarkResults.reduce((t,s)=>t+s.rtf,0)/this._benchmarkResults.length}clearBenchmarks(){this._benchmarkResults=[]}async synthesize(e,t={}){if(this._isReady||await this.initialize(),!e||!e.trim())throw new Error("No text provided for synthesis");return this._backend==="kokoro-fastapi"?this._queueSynthesis(e,t):this._useKokoro?this._queueSynthesis(e,t):this._synthesizeWebSpeech(e,t)}_queueSynthesis(e,t){return new Promise((s,i)=>{this._synthesisQueue.push({text:e,options:t,resolve:s,reject:i}),this._processQueue()})}async _processQueue(){if(this._isSynthesizing||this._synthesisQueue.length===0)return;this._isSynthesizing=!0;const{text:e,options:t,resolve:s,reject:i}=this._synthesisQueue.shift();try{let o;this._backend==="kokoro-fastapi"?o=await this._synthesizeKokoroFastAPI(e,t):o=await this._synthesizeKokoro(e,t),s(o)}catch(o){i(o)}finally{this._isSynthesizing=!1,this._processQueue()}}async _synthesizeKokoro(e,t){const s=t.voice||this._currentVoice,i=t.speed||this._speed,o=U(e,500);if(o.length>1)return console.log(`Splitting long sentence (${e.length} chars) into ${o.length} chunks`),await this._synthesizeChunks(o,s,i);const n=performance.now(),a=await this._kokoro.generate(e,{voice:s,speed:i}),r=performance.now()-n,l=a.audio,c=a.sampling_rate||this._sampleRate,h=this._audioContext.createBuffer(1,l.length,c);h.getChannelData(0).set(l);const d=l.length/c*1e3;if(this._benchmarkEnabled){const f=r/d,b={text:e.slice(0,50)+(e.length>50?"...":""),textLength:e.length,synthesisTimeMs:Math.round(r),audioDurationMs:Math.round(d),rtf:Math.round(f*1e3)/1e3,device:this._device};this._benchmarkResults.push(b),console.log(`TTS Benchmark: ${b.synthesisTimeMs}ms for ${b.audioDurationMs}ms audio (RTF: ${b.rtf})`)}return h}async _synthesizeChunks(e,t,s){const i=[];let o=0,n=this._sampleRate;for(let c=0;c<e.length;c++){const h=e[c];console.log(`  Chunk ${c+1}/${e.length}: "${h.substring(0,50)}..."`);const d=await this._kokoro.generate(h,{voice:t,speed:s}),f=d.audio;n=d.sampling_rate||this._sampleRate;const b=this._audioContext.createBuffer(1,f.length,n);b.getChannelData(0).set(f),i.push(b),o+=f.length}const a=this._audioContext.createBuffer(1,o,n),r=a.getChannelData(0);let l=0;for(const c of i){const h=c.getChannelData(0);r.set(h,l),l+=h.length}return console.log(`Concatenated ${e.length} chunks into ${o} samples`),a}async _synthesizeKokoroFastAPI(e,t){const s=t.voice||this._currentVoice,i=t.speed||this._speed,o=performance.now(),n=await fetch(`${this._fastApiUrl}/v1/audio/speech`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"kokoro",input:e,voice:s,speed:i,response_format:"wav"})});if(!n.ok)throw new Error(`Kokoro FastAPI error: ${n.status} ${n.statusText}`);const a=await n.arrayBuffer(),r=performance.now()-o;this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext));const l=await this._audioContext.decodeAudioData(a);if(this._benchmarkEnabled){const c=l.duration*1e3,h=r/c,d={text:e.slice(0,50)+(e.length>50?"...":""),textLength:e.length,synthesisTimeMs:Math.round(r),audioDurationMs:Math.round(c),rtf:Math.round(h*1e3)/1e3,device:"fastapi"};this._benchmarkResults.push(d),console.log(`TTS Benchmark (FastAPI): ${d.synthesisTimeMs}ms for ${d.audioDurationMs}ms audio (RTF: ${d.rtf})`)}return l}async _synthesizeWebSpeech(e,t){this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext));const s=this._audioContext.createBuffer(1,1,22050);return s._webSpeechText=e,s._webSpeechOptions=t,s._isWebSpeechFallback=!0,s}async runBenchmark(e){if(this._isReady||await this.initialize(),!this._useKokoro&&this._backend!=="kokoro-fastapi")throw new Error("Benchmarking only available with Kokoro TTS");const t=this._benchmarkEnabled;this._benchmarkEnabled=!0;const s=this._benchmarkResults.length;console.log(`Running benchmark on ${e.length} sentences...`);for(const a of e)await this.synthesize(a);const i=this._benchmarkResults.slice(s),o=i.reduce((a,r)=>a+r.rtf,0)/i.length;this._benchmarkEnabled=t;const n={results:i,averageRTF:Math.round(o*1e3)/1e3,device:this._device,dtype:this._dtype,totalSynthesisTime:i.reduce((a,r)=>a+r.synthesisTimeMs,0),totalAudioTime:i.reduce((a,r)=>a+r.audioDurationMs,0)};return console.log("Benchmark Summary:",n),n}async playBuffer(e,t=1){return this._audioContext&&this._audioContext.state==="suspended"&&await this._audioContext.resume(),e._isWebSpeechFallback?this._playWebSpeech(e._webSpeechText,t):new Promise((s,i)=>{const o=this._audioContext.createBufferSource();o.buffer=e,o.connect(this._audioContext.destination),this._currentSource=o,o.onended=()=>{this._currentSource=null,s()},o.onerror=n=>{this._currentSource=null,i(n)},o.start()})}stopAudio(){if(this._currentSource){try{this._currentSource.stop()}catch{}this._currentSource=null}this.stopWebSpeech()}_playWebSpeech(e,t){return new Promise((s,i)=>{const o=new SpeechSynthesisUtterance(e);o.rate=t,o.onend=()=>s(),o.onerror=n=>i(n),speechSynthesis.speak(o)})}stopWebSpeech(){this._webSpeechSupported&&speechSynthesis.cancel()}isReady(){return this._isReady}isUsingKokoro(){return this._useKokoro}getDevice(){return this._device}getDtype(){return this._dtype}getAvailableVoices(){return this._useKokoro?[{id:"af_alloy",name:"Alloy (American Female)"},{id:"af_aoede",name:"Aoede (American Female)"},{id:"af_bella",name:"Bella (American Female)"},{id:"af_heart",name:"Heart (American Female)"},{id:"af_jessica",name:"Jessica (American Female)"},{id:"af_kore",name:"Kore (American Female)"},{id:"af_nicole",name:"Nicole (American Female)"},{id:"af_nova",name:"Nova (American Female)"},{id:"af_river",name:"River (American Female)"},{id:"af_sarah",name:"Sarah (American Female)"},{id:"af_sky",name:"Sky (American Female)"},{id:"am_adam",name:"Adam (American Male)"},{id:"am_echo",name:"Echo (American Male)"},{id:"am_eric",name:"Eric (American Male)"},{id:"am_fenrir",name:"Fenrir (American Male)"},{id:"am_liam",name:"Liam (American Male)"},{id:"am_michael",name:"Michael (American Male)"},{id:"am_onyx",name:"Onyx (American Male)"},{id:"am_puck",name:"Puck (American Male)"},{id:"bf_alice",name:"Alice (British Female)"},{id:"bf_emma",name:"Emma (British Female)"},{id:"bf_isabella",name:"Isabella (British Female)"},{id:"bf_lily",name:"Lily (British Female)"},{id:"bm_daniel",name:"Daniel (British Male)"},{id:"bm_fable",name:"Fable (British Male)"},{id:"bm_george",name:"George (British Male)"},{id:"bm_lewis",name:"Lewis (British Male)"}]:speechSynthesis.getVoices().map(t=>({id:t.voiceURI,name:t.name}))}setVoice(e){this._currentVoice=e}setSpeed(e){this._speed=Math.max(.5,Math.min(2,e))}getSpeed(){return this._speed}getAudioContext(){return this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)),this._audioContext}destroy(){this.stopWebSpeech(),this._audioContext&&(this._audioContext.close(),this._audioContext=null),this._kokoro=null,this._isReady=!1,this._isLoading=!1}}const u=new W,H="reading-partner-db",R=2,p={BOOKS:"books",POSITIONS:"positions",BOOKMARKS:"bookmarks",SETTINGS:"settings",HIGHLIGHTS:"highlights"};class X{constructor(){this._db=null}async init(){try{await this._openDatabase()}catch(e){console.warn("Database init failed, deleting and retrying:",e.message),await this._deleteDatabase(),await this._openDatabase()}}_deleteDatabase(){return new Promise((e,t)=>{const s=indexedDB.deleteDatabase(H);s.onsuccess=()=>{console.log("Database deleted for fresh creation"),e()},s.onerror=()=>t(new Error("Failed to delete database")),s.onblocked=()=>{console.warn("Database delete blocked, resolving anyway"),e()}})}_openDatabase(){return new Promise((e,t)=>{const s=indexedDB.open(H,R);let i=!1;s.onerror=()=>{var o;console.error("Database open error:",s.error),t(new Error("Failed to open database: "+(((o=s.error)==null?void 0:o.message)||"unknown error")))},s.onblocked=()=>{i=!0,console.warn("Database upgrade blocked by another connection"),t(new Error("Database upgrade blocked"))},s.onsuccess=()=>{i||(this._db=s.result,this._db.onversionchange=()=>{this._db.close(),this._db=null,console.log("Database version changed in another tab, connection closed")},console.log("Storage service initialized"),e())},s.onupgradeneeded=o=>{const n=o.target.result;n.objectStoreNames.contains(p.BOOKS)||n.createObjectStore(p.BOOKS,{keyPath:"id"}).createIndex("lastOpened","lastOpened",{unique:!1}),n.objectStoreNames.contains(p.POSITIONS)||n.createObjectStore(p.POSITIONS,{keyPath:"bookId"}),n.objectStoreNames.contains(p.BOOKMARKS)||n.createObjectStore(p.BOOKMARKS,{keyPath:"id"}).createIndex("bookId","bookId",{unique:!1}),n.objectStoreNames.contains(p.SETTINGS)||n.createObjectStore(p.SETTINGS,{keyPath:"key"}),n.objectStoreNames.contains(p.HIGHLIGHTS)||n.createObjectStore(p.HIGHLIGHTS,{keyPath:"id"}).createIndex("bookId","bookId",{unique:!1}),console.log("Database schema created/upgraded to version",R)}})}async saveBook(e){const s=this._db.transaction([p.BOOKS],"readwrite").objectStore(p.BOOKS);return e.lastOpened=Date.now(),new Promise((i,o)=>{const n=s.put(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}async getBook(e){const s=this._db.transaction([p.BOOKS],"readonly").objectStore(p.BOOKS);return new Promise((i,o)=>{const n=s.get(e);n.onsuccess=()=>i(n.result||null),n.onerror=()=>o(n.error)})}async getAllBooks(){const s=this._db.transaction([p.BOOKS],"readonly").objectStore(p.BOOKS).index("lastOpened");return new Promise((i,o)=>{const n=s.openCursor(null,"prev"),a=[];n.onsuccess=r=>{const l=r.target.result;l?(a.push(l.value),l.continue()):i(a)},n.onerror=()=>o(n.error)})}async deleteBook(e){const s=this._db.transaction([p.BOOKS],"readwrite").objectStore(p.BOOKS);return new Promise((i,o)=>{const n=s.delete(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}async savePosition(e){const s=this._db.transaction([p.POSITIONS],"readwrite").objectStore(p.POSITIONS);return e.updatedAt=Date.now(),new Promise((i,o)=>{const n=s.put(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}async getPosition(e){const s=this._db.transaction([p.POSITIONS],"readonly").objectStore(p.POSITIONS);return new Promise((i,o)=>{const n=s.get(e);n.onsuccess=()=>i(n.result||null),n.onerror=()=>o(n.error)})}async deletePosition(e){const s=this._db.transaction([p.POSITIONS],"readwrite").objectStore(p.POSITIONS);return new Promise((i,o)=>{const n=s.delete(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}async addBookmark(e){const s=this._db.transaction([p.BOOKMARKS],"readwrite").objectStore(p.BOOKMARKS);return e.createdAt=e.createdAt||Date.now(),new Promise((i,o)=>{const n=s.put(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}async getBookmarks(e){const i=this._db.transaction([p.BOOKMARKS],"readonly").objectStore(p.BOOKMARKS).index("bookId");return new Promise((o,n)=>{const a=i.getAll(e);a.onsuccess=()=>o(a.result||[]),a.onerror=()=>n(a.error)})}async deleteBookmark(e){const s=this._db.transaction([p.BOOKMARKS],"readwrite").objectStore(p.BOOKMARKS);return new Promise((i,o)=>{const n=s.delete(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}async addHighlight(e){const s=this._db.transaction([p.HIGHLIGHTS],"readwrite").objectStore(p.HIGHLIGHTS);return e.createdAt=e.createdAt||Date.now(),new Promise((i,o)=>{const n=s.put(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}async getHighlights(e){const i=this._db.transaction([p.HIGHLIGHTS],"readonly").objectStore(p.HIGHLIGHTS).index("bookId");return new Promise((o,n)=>{const a=i.getAll(e);a.onsuccess=()=>o(a.result||[]),a.onerror=()=>n(a.error)})}async deleteHighlight(e){const s=this._db.transaction([p.HIGHLIGHTS],"readwrite").objectStore(p.HIGHLIGHTS);return new Promise((i,o)=>{const n=s.delete(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}async saveSetting(e,t){const i=this._db.transaction([p.SETTINGS],"readwrite").objectStore(p.SETTINGS);return new Promise((o,n)=>{const a=i.put({key:e,value:t});a.onsuccess=()=>o(),a.onerror=()=>n(a.error)})}async getSetting(e){const s=this._db.transaction([p.SETTINGS],"readonly").objectStore(p.SETTINGS);return new Promise((i,o)=>{const n=s.get(e);n.onsuccess=()=>{const a=n.result;i(a?a.value:null)},n.onerror=()=>o(n.error)})}async getAllSettings(){const t=this._db.transaction([p.SETTINGS],"readonly").objectStore(p.SETTINGS);return new Promise((s,i)=>{const o=t.getAll();o.onsuccess=()=>{const n={};o.result.forEach(a=>{n[a.key]=a.value}),s(n)},o.onerror=()=>i(o.error)})}async deleteSetting(e){const s=this._db.transaction([p.SETTINGS],"readwrite").objectStore(p.SETTINGS);return new Promise((i,o)=>{const n=s.delete(e);n.onsuccess=()=>i(),n.onerror=()=>o(n.error)})}close(){this._db&&(this._db.close(),this._db=null)}}const m=new X,C={free:[{id:"openai/gpt-oss-120b:free",name:"GPT OSS 120B (Free)"},{id:"google/gemma-3-27b-it:free",name:"Gemma 3 27B (Free)"},{id:"nvidia/nemotron-3-nano-30b-a3b:free",name:"Nemotron 3 Nano 30B (Free)"},{id:"xiaomi/mimo-v2-flash:free",name:"MiMo V2 Flash (Free)"},{id:"z-ai/glm-4.5-air:free",name:"GLM 4.5 Air (Free)"}],paid:[{id:"anthropic/claude-sonnet-4",name:"Claude Sonnet 4"},{id:"google/gemini-2.5-pro",name:"Gemini 2.5 Pro"},{id:"google/gemini-2.5-flash",name:"Gemini 2.5 Flash"},{id:"anthropic/claude-opus-4",name:"Claude Opus 4"},{id:"openai/gpt-4o",name:"GPT-4o"},{id:"openai/gpt-4-turbo",name:"GPT-4 Turbo"},{id:"deepseek/deepseek-chat",name:"DeepSeek V3"},{id:"meta-llama/llama-3.1-405b-instruct",name:"Llama 3.1 405B"}]},x="openai/gpt-oss-120b:free";class Y{constructor(e=null,t=x){this._apiKey=e,this._model=t,this._endpoint="https://openrouter.ai/api/v1/chat/completions",this._abortController=null}setApiKey(e){this._apiKey=e}getApiKey(){return this._apiKey}hasApiKey(){return!!(this._apiKey&&this._apiKey.trim())}setModel(e){this._model=e}getModel(){return this._model}getAvailableModels(){return C}_buildSystemPrompt(e){let t="You are a helpful reading assistant. The user is reading a book";return e!=null&&e.title&&(t+=` titled "${e.title}"`,e.author&&(t+=` by ${e.author}`)),t+=" and has a question about it. Answer based on the provided context. Be concise and helpful. If the answer cannot be found in the context, say so.",t}_buildUserMessage(e,t,s){const i=e.join(" ");let o="";return s!=null&&s.title&&(o+=`Book: ${s.title}`,s.author&&(o+=` by ${s.author}`),o+=`

`),o+=`Context from the book:
"${i}"

Question: ${t}`,o}async askQuestion(e,t,s){var r;if(!this._apiKey)throw new Error("API key not set");const i=this._buildSystemPrompt(s),o=this._buildUserMessage(e,t,s),n=await fetch(this._endpoint,{method:"POST",headers:{Authorization:`Bearer ${this._apiKey}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"Reading Partner"},body:JSON.stringify({model:this._model,messages:[{role:"system",content:i},{role:"user",content:o}],max_tokens:500,temperature:.7})});if(!n.ok){const l=await n.json().catch(()=>({}));throw new Error(((r=l.error)==null?void 0:r.message)||`API error: ${n.status}`)}return(await n.json()).choices[0].message.content}async askQuestionStreaming(e,t,s,i,o){var f,b,S,v;if(!this._apiKey)throw new Error("API key not set");this._abortController=new AbortController;const n=this._buildSystemPrompt(o),a=this._buildUserMessage(e,t,o);let r;try{r=await fetch(this._endpoint,{method:"POST",headers:{Authorization:`Bearer ${this._apiKey}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"Reading Partner"},body:JSON.stringify({model:this._model,messages:[{role:"system",content:n},{role:"user",content:a}],max_tokens:500,temperature:.7,stream:!0}),signal:this._abortController.signal})}catch(y){throw y.name==="AbortError"?new Error("Request aborted"):y}if(!r.ok){const y=await r.json().catch(()=>({}));throw new Error(((f=y.error)==null?void 0:f.message)||`API error: ${r.status}`)}const l=r.body.getReader(),c=new TextDecoder;let h="",d="";try{for(;;){const{done:y,value:B}=await l.read();if(y){d.trim()&&(i==null||i(d.trim()));break}const $=c.decode(B,{stream:!0}).split(`
`);for(const E of $)if(E.startsWith("data: ")){const P=E.slice(6);if(P==="[DONE]")continue;try{const I=(v=(S=(b=JSON.parse(P).choices)==null?void 0:b[0])==null?void 0:S.delta)==null?void 0:v.content;if(I){h+=I,d+=I,s==null||s(I);const A=this._extractCompleteSentences(d);if(A.complete.length>0){for(const N of A.complete)i==null||i(N);d=A.remaining}}}catch{}}}}catch(y){if(y.name==="AbortError")return h;throw y}finally{this._abortController=null}return h}_extractCompleteSentences(e){const t=[];let s=e;const i=/[.!?]+[\s"')\]]*(?=\s|$)/g;let o,n=0;for(;(o=i.exec(e))!==null;){const a=o.index+o[0].length,r=e.slice(n,a).trim();r&&t.push(r),n=a}return s=e.slice(n),{complete:t,remaining:s}}abort(){this._abortController&&(this._abortController.abort(),this._abortController=null)}async validateApiKey(e){try{return(await fetch(this._endpoint,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"Reading Partner"},body:JSON.stringify({model:x,messages:[{role:"user",content:"Hi"}],max_tokens:1})})).ok}catch(t){return console.error("API key validation failed:",t),!1}}}const k=new Y,J=(()=>{const o=new ArrayBuffer(16044),n=new DataView(o),a=(c,h)=>{for(let d=0;d<h.length;d++)n.setUint8(c+d,h.charCodeAt(d))};a(0,"RIFF"),n.setUint32(4,16036,!0),a(8,"WAVE"),a(12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,8e3,!0),n.setUint32(28,8e3,!0),n.setUint16(32,1,!0),n.setUint16(34,8,!0),a(36,"data"),n.setUint32(40,16e3,!0);for(let c=44;c<16044;c++)n.setUint8(c,128);const r=new Uint8Array(o);let l="";for(let c=0;c<r.length;c++)l+=String.fromCharCode(r[c]);return"data:audio/wav;base64,"+btoa(l)})();class Z{constructor(){this._isSupported="mediaSession"in navigator,this._isInitialized=!1,this._isQAModeActive=!1,this._onPlay=null,this._onPause=null,this._onEnterQAMode=null,this._onExitQAMode=null,this._bookTitle="",this._chapterTitle="",this._author="",this._silentAudio=null,this._hasUserInteraction=!1}isSupported(){return this._isSupported}initialize({onPlay:e,onPause:t,onEnterQAMode:s,onExitQAMode:i}){if(!this._isSupported){console.warn("Media Session API not supported");return}this._onPlay=e,this._onPause=t,this._onEnterQAMode=s,this._onExitQAMode=i,this._createSilentAudio(),this._setupActionHandlers(),this._isInitialized=!0,console.log("Media Session Manager initialized"),console.log("Media Session debug: Call mediaSessionManager.diagnose() for diagnostic info")}_createSilentAudio(){this._silentAudio||(this._silentAudio=document.createElement("audio"),this._silentAudio.src=J,this._silentAudio.loop=!0,this._silentAudio.volume=.001,this._silentAudio.preload="auto",this._silentAudio.addEventListener("play",()=>{console.log("Media Session: Audio element started PLAYING")}),this._silentAudio.addEventListener("pause",()=>{console.log("Media Session: Audio element PAUSED")}),this._silentAudio.addEventListener("error",e=>{console.error("Media Session: Audio error",e.target.error)}),this._silentAudio.load())}_setupActionHandlers(){navigator.mediaSession.setActionHandler("play",async()=>{var e;if(console.log("Media Session: PLAY action received"),this._isQAModeActive){console.log("Media Session: Ignoring play - Q&A mode active");return}try{await this._silentAudio.play()}catch(t){console.warn("Media Session: Could not play audio:",t.message)}navigator.mediaSession.playbackState="playing",(e=this._onPlay)==null||e.call(this)}),navigator.mediaSession.setActionHandler("pause",()=>{var e;if(console.log("Media Session: PAUSE action received"),this._isQAModeActive){console.log("Media Session: Ignoring pause - Q&A mode active");return}this._silentAudio.pause(),navigator.mediaSession.playbackState="paused",(e=this._onPause)==null||e.call(this)}),navigator.mediaSession.setActionHandler("nexttrack",()=>{var e;console.log("Media Session: NEXTTRACK action received"),this._isQAModeActive||(e=this._onEnterQAMode)==null||e.call(this)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{var e;console.log("Media Session: PREVIOUSTRACK action received"),this._isQAModeActive&&((e=this._onExitQAMode)==null||e.call(this))}),navigator.mediaSession.setActionHandler("stop",()=>{var e;console.log("Media Session: STOP action received"),this._silentAudio.pause(),navigator.mediaSession.playbackState="paused",(e=this._onPause)==null||e.call(this)});try{navigator.mediaSession.setActionHandler("seekbackward",null),navigator.mediaSession.setActionHandler("seekforward",null),navigator.mediaSession.setActionHandler("seekto",null)}catch{}}updateMetadata({bookTitle:e,chapterTitle:t,author:s}={}){if(!this._isSupported)return;e!==void 0&&(this._bookTitle=e),t!==void 0&&(this._chapterTitle=t),s!==void 0&&(this._author=s);let i=this._bookTitle||"Reading Partner";this._chapterTitle&&(i=this._chapterTitle),navigator.mediaSession.metadata=new MediaMetadata({title:i,artist:this._author||"Reading Partner",album:this._bookTitle||"",artwork:[]}),console.log("Media Session: Metadata updated -",i)}async setPlaybackState(e){if(this._isSupported){if(console.log(`Media Session: setPlaybackState(${e})`),e==="playing"){try{await this._silentAudio.play(),this._hasUserInteraction=!0}catch(t){console.warn("Media Session: Could not start audio:",t.message)}navigator.mediaSession.playbackState="playing"}else(e==="paused"||e==="stopped")&&(this._silentAudio.pause(),navigator.mediaSession.playbackState="paused");console.log(`Media Session: playbackState=${navigator.mediaSession.playbackState}, audio.paused=${this._silentAudio.paused}`)}}setQAModeActive(e){this._isQAModeActive=e,console.log(`Media Session: Q&A mode ${e?"ACTIVE":"INACTIVE"}`),e?(navigator.mediaSession.metadata=new MediaMetadata({title:"Q&A Mode - Ask a question",artist:this._bookTitle||"Reading Partner",album:""}),this._hasUserInteraction&&this._silentAudio.play().catch(()=>{})):this.updateMetadata({})}isQAModeActive(){return this._isQAModeActive}diagnose(){var t,s;const e={supported:this._isSupported,initialized:this._isInitialized,hasUserInteraction:this._hasUserInteraction,audioElement:this._silentAudio?{paused:this._silentAudio.paused,currentTime:this._silentAudio.currentTime,duration:this._silentAudio.duration,readyState:this._silentAudio.readyState,volume:this._silentAudio.volume,src:this._silentAudio.src?"set":"not set"}:"not created",mediaSession:{playbackState:(t=navigator.mediaSession)==null?void 0:t.playbackState,metadata:(s=navigator.mediaSession)!=null&&s.metadata?{title:navigator.mediaSession.metadata.title,artist:navigator.mediaSession.metadata.artist}:"not set"},qaMode:this._isQAModeActive};return console.log("=== Media Session Diagnostic ==="),console.log(JSON.stringify(e,null,2)),console.log("================================"),console.log(`
üì± Android Troubleshooting:`),console.log("1. Check notification shade - do you see Reading Partner media controls?"),console.log("2. Is another app (Spotify, YouTube) controlling media?"),console.log("3. Try: Tap play button in app first, then use headset"),console.log("4. Make sure page is served over HTTPS"),console.log("5. Try locking/unlocking phone to refresh media session"),e}async forceStart(){console.log("Media Session: Force starting...");try{return await this._silentAudio.play(),this._hasUserInteraction=!0,navigator.mediaSession.playbackState="playing",console.log("Media Session: Force start successful"),setTimeout(()=>{this._silentAudio.pause(),navigator.mediaSession.playbackState="paused",console.log("Media Session: Ready for headset controls")},500),!0}catch(e){return console.error("Media Session: Force start failed:",e),!1}}destroy(){if(this._isSupported){this._silentAudio&&(this._silentAudio.pause(),this._silentAudio.src="",this._silentAudio=null);try{navigator.mediaSession.setActionHandler("play",null),navigator.mediaSession.setActionHandler("pause",null),navigator.mediaSession.setActionHandler("nexttrack",null),navigator.mediaSession.setActionHandler("previoustrack",null),navigator.mediaSession.setActionHandler("stop",null)}catch{}navigator.mediaSession.metadata=null,navigator.mediaSession.playbackState="none",this._isInitialized=!1}}}const w=new Z;typeof window<"u"&&(window.mediaSessionManager=w);class ee{constructor({onSentenceChange:e,onStateChange:t,onChapterEnd:s}){this._onSentenceChange=e,this._onStateChange=t,this._onChapterEnd=s,this._sentences=[],this._currentIndex=0,this._status="stopped",this._speed=1,this._bufferQueue=new Map,this._prefetchAhead=2,this._bufferBehind=2,this._currentSource=null,this._isPlaying=!1,this._stopRequested=!1,this._generatingIndices=new Set}async initialize(){await u.initialize()}setSentences(e,t=0){this._sentences=e,this._currentIndex=t,this._clearBuffers(),e.length>0&&(console.log("Pre-buffering first sentence..."),this._generateBuffer(t).then(()=>{console.log("First sentence pre-buffered")}).catch(s=>{console.warn("Pre-buffer failed:",s)}))}async play(e){var t;if(e!==void 0&&(this._currentIndex=e),this._sentences.length===0){console.warn("No sentences to play");return}if(this._currentIndex>=this._sentences.length){(t=this._onChapterEnd)==null||t.call(this);return}this._stopRequested=!1,this._status="playing",this._notifyStateChange(),await this._playbackLoop()}async _playbackLoop(){var e,t;for(;!this._stopRequested&&this._currentIndex<this._sentences.length;){this._isPlaying=!0;let s=this._bufferQueue.get(this._currentIndex);if(!s){this._status="buffering",this._notifyStateChange(),console.time(`TTS generate sentence ${this._currentIndex}`);try{s=await this._generateBuffer(this._currentIndex)}catch(i){console.error("Failed to generate audio:",i),this._currentIndex++;continue}console.timeEnd(`TTS generate sentence ${this._currentIndex}`),this._status="playing",this._notifyStateChange()}if(this._stopRequested)break;(e=this._onSentenceChange)==null||e.call(this,this._currentIndex),this._maintainBuffer();try{await u.playBuffer(s,this._speed)}catch(i){console.error("Playback error:",i)}if(this._stopRequested)break;this._currentIndex++}this._isPlaying=!1,!this._stopRequested&&this._currentIndex>=this._sentences.length&&(this._status="stopped",this._notifyStateChange(),(t=this._onChapterEnd)==null||t.call(this))}pause(){this._stopRequested=!0,this._status="paused",u.stopAudio(),this._notifyStateChange()}resume(){this._status==="paused"&&this.play()}stop(){this._stopRequested=!0,this._status="stopped",this._currentIndex=0,u.stopAudio(),this._notifyStateChange()}skipForward(){var t;const e=this._status==="playing";this._stopRequested=!0,u.stopAudio(),this._currentIndex<this._sentences.length-1&&(this._currentIndex++,(t=this._onSentenceChange)==null||t.call(this,this._currentIndex),e&&setTimeout(()=>this.play(),50))}skipBackward(e=1){var s;const t=this._status==="playing";this._stopRequested=!0,u.stopAudio(),this._currentIndex=Math.max(0,this._currentIndex-e),(s=this._onSentenceChange)==null||s.call(this,this._currentIndex),t&&setTimeout(()=>this.play(),50)}goToSentence(e){var s;const t=this._status==="playing";this._stopRequested=!0,u.stopAudio(),this._currentIndex=Math.max(0,Math.min(e,this._sentences.length-1)),(s=this._onSentenceChange)==null||s.call(this,this._currentIndex),t&&setTimeout(()=>this.play(),50)}setSpeed(e){const t=Math.max(.5,Math.min(2,e));t!==this._speed&&(this._speed=t,u.setSpeed(t),this._clearBuffers())}getState(){return{status:this._status,currentIndex:this._currentIndex}}getCurrentIndex(){return this._currentIndex}isFirstBufferReady(){return this._bufferQueue.has(this._currentIndex)}_maintainBuffer(){const e=Math.min(this._sentences.length,this._currentIndex+this._prefetchAhead+1);for(let s=this._currentIndex+1;s<e;s++)!this._bufferQueue.has(s)&&!this._generatingIndices.has(s)&&this._generateBuffer(s).catch(i=>{console.warn(`Buffer generation error for sentence ${s}:`,i)});const t=Math.max(0,this._currentIndex-this._bufferBehind);for(const s of this._bufferQueue.keys())s<t&&this._bufferQueue.delete(s)}async _generateBuffer(e){if(this._bufferQueue.has(e))return this._bufferQueue.get(e);if(this._generatingIndices.has(e))return new Promise((t,s)=>{const i=setInterval(()=>{this._bufferQueue.has(e)&&(clearInterval(i),t(this._bufferQueue.get(e)))},50);setTimeout(()=>{clearInterval(i),s(new Error("Buffer generation timeout"))},3e4)});this._generatingIndices.add(e);try{const t=this._sentences[e];console.log(`Generating TTS for sentence ${e}: "${t.slice(0,50)}..."`);const s=await u.synthesize(t);return this._bufferQueue.set(e,s),console.log(`TTS ready for sentence ${e}`),s}finally{this._generatingIndices.delete(e)}}clearBuffers(){this._clearBuffers()}_clearBuffers(){this._bufferQueue.clear(),this._generatingIndices.clear()}_notifyStateChange(){var e;(e=this._onStateChange)==null||e.call(this,{status:this._status,currentIndex:this._currentIndex})}destroy(){this.stop(),this._clearBuffers()}}class te{constructor(){this._recognition=null,this._isSupported=!1,this._isListening=!1,this.onInterimResult=null,this.onError=null,this.onStart=null,this.onEnd=null,this._initRecognition()}_initRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){console.warn("Web Speech API not supported"),this._isSupported=!1;return}this._isSupported=!0,this._recognition=new e,this._recognition.continuous=!1,this._recognition.interimResults=!0,this._recognition.lang="en-US",this._recognition.maxAlternatives=1}isSupported(){return this._isSupported}isListening(){return this._isListening}startListening(){return new Promise((e,t)=>{if(!this._isSupported){t(new Error("Speech recognition not supported"));return}if(this._isListening){t(new Error("Already listening"));return}this._isListening=!0;let s="",i=!1;this._recognition.onstart=()=>{var o;console.log("STT: Started listening"),(o=this.onStart)==null||o.call(this)},this._recognition.onresult=o=>{var a;let n="";for(let r=o.resultIndex;r<o.results.length;r++){const l=o.results[r];l.isFinal?(s+=l[0].transcript,i=!0):n+=l[0].transcript}n&&((a=this.onInterimResult)==null||a.call(this,n))},this._recognition.onerror=o=>{var a;console.error("STT Error:",o.error),this._isListening=!1;let n="Speech recognition error";switch(o.error){case"not-allowed":case"permission-denied":n="Microphone permission denied";break;case"no-speech":n="No speech detected";break;case"audio-capture":n="No microphone found";break;case"network":n="Network error occurred";break;case"aborted":n="Speech recognition aborted";break}(a=this.onError)==null||a.call(this,o.error,n),t(new Error(n))},this._recognition.onend=()=>{var o;console.log("STT: Stopped listening"),this._isListening=!1,(o=this.onEnd)==null||o.call(this),i&&s.trim()?e(s.trim()):i||t(new Error("No speech detected"))};try{this._recognition.start()}catch(o){this._isListening=!1,t(o)}})}stopListening(){this._recognition&&this._isListening&&this._recognition.stop()}abortListening(){this._recognition&&this._isListening&&this._recognition.abort()}setLanguage(e){this._recognition&&(this._recognition.lang=e)}async requestPermission(){try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(t=>t.stop()),!0}catch(e){return console.error("Microphone permission denied:",e),!1}}}const T=new te,g={IDLE:"idle",LISTENING:"listening",THINKING:"thinking",RESPONDING:"responding",PAUSED:"paused"};class se{constructor(e){this._readingState=e.readingState,this._onStateChange=e.onStateChange,this._onTranscript=e.onTranscript,this._onResponse=e.onResponse,this._onSentenceSpoken=e.onSentenceSpoken,this._onHistoryAdd=e.onHistoryAdd,this._state=g.IDLE,this._currentQuestion="",this._currentResponse="",this._responseSentences=[],this._currentSentenceIndex=0,this._isPaused=!1,this._isStopped=!1,this._isStreamingComplete=!1,this._playbackSpeed=1,this._audioBufferCache=new Map,this._nextSynthesisIndex=0,this._history=[],this._bookMeta=null,this._contextBefore=20,this._contextAfter=5,T.onInterimResult=t=>{var s;(s=this._onTranscript)==null||s.call(this,t)}}getState(){return this._state}isActive(){return this._state!==g.IDLE}getHistory(){return[...this._history]}clearHistory(){this._history=[]}setBookMeta(e){this._bookMeta=e}setContextSettings(e,t){this._contextBefore=e,this._contextAfter=t}setPlaybackSpeed(e){this._playbackSpeed=e}async startVoiceQA(){var e,t;if(this._state!==g.IDLE&&this._state!==g.PAUSED){console.warn("Q&A already in progress");return}this._isStopped=!1,this._isPaused=!1,this._setState(g.LISTENING);try{const s=await T.startListening();this._currentQuestion=s,(e=this._onTranscript)==null||e.call(this,s),await this._processQuestion(s)}catch(s){console.error("Voice Q&A error:",s),s.message!=="Speech recognition aborted"&&((t=this._onStateChange)==null||t.call(this,g.IDLE,{error:s.message})),this._setState(g.IDLE)}}async startTextQA(e){if(this._state!==g.IDLE&&this._state!==g.PAUSED){console.warn("Q&A already in progress");return}!e||!e.trim()||(this._isStopped=!1,this._isPaused=!1,this._currentQuestion=e.trim(),await this._processQuestion(this._currentQuestion))}async _processQuestion(e){var t,s;this._setState(g.THINKING),this._currentResponse="",this._responseSentences=[],this._currentSentenceIndex=0,this._isStreamingComplete=!1,this._audioBufferCache.clear(),this._nextSynthesisIndex=0;try{const i=await this._getContextSentences(),o=await k.askQuestionStreaming(i,e,a=>{var r;this._currentResponse+=a,(r=this._onResponse)==null||r.call(this,this._currentResponse)},a=>{if(this._isStopped)return;const r=this._responseSentences.length;this._responseSentences.push(a),this._prefetchSentenceAudio(r,a),this._state===g.THINKING&&this._responseSentences.length===1&&(this._setState(g.RESPONDING),this._startSpeaking())},this._bookMeta);this._isStreamingComplete=!0;const n={id:`qa_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,question:e,answer:o,timestamp:Date.now()};this._history.push(n),(t=this._onHistoryAdd)==null||t.call(this,n)}catch(i){console.error("Q&A processing error:",i),this._isStreamingComplete=!0,this._isStopped||((s=this._onStateChange)==null||s.call(this,g.IDLE,{error:i.message}),this._setState(g.IDLE))}}async _getContextSentences(){if(!this._readingState)return[];const e=await this._readingState.getContextSentences(this._contextBefore),t=await this._readingState.getContextSentencesAfter(this._contextAfter);return[...e,...t]}async _startSpeaking(){var e;for(;!this._isStopped;){if(this._isPaused){await new Promise(t=>{this._resumeCallback=t});continue}if(this._currentSentenceIndex<this._responseSentences.length){const t=this._responseSentences[this._currentSentenceIndex];try{await this._speakSentence(t),(e=this._onSentenceSpoken)==null||e.call(this,t,this._currentSentenceIndex),this._currentSentenceIndex++}catch(s){if(this._isStopped||this._isPaused)break;console.error("TTS error:",s),this._currentSentenceIndex++}}else{if(this._isStreamingComplete)break;await new Promise(t=>setTimeout(t,100))}}!this._isStopped&&!this._isPaused&&this._setState(g.IDLE)}async _prefetchSentenceAudio(e,t){if(!t||!t.trim()||this._isStopped||this._audioBufferCache.has(e))return;const s=u.synthesize(t).then(i=>(this._isStopped||this._audioBufferCache.set(e,i),i)).catch(i=>(console.error(`Pre-fetch synthesis error for sentence ${e}:`,i),null));this._audioBufferCache.set(e,s)}async _speakSentence(e){if(!e||!e.trim())return;const t=this._currentSentenceIndex;let s;const i=this._audioBufferCache.get(t);i&&(s=await Promise.resolve(i)),s||(s=await u.synthesize(e)),!this._isStopped&&(this._audioBufferCache.delete(t),await u.playBuffer(s,this._playbackSpeed))}pause(){this._state===g.RESPONDING&&(this._isPaused=!0,this._setState(g.PAUSED),u.stopAudio())}resume(){this._state===g.PAUSED&&(this._isPaused=!1,this._setState(g.RESPONDING),this._resumeCallback?(this._resumeCallback(),this._resumeCallback=null):this._startSpeaking())}stop(){this._isStopped=!0,this._isPaused=!1,this._state===g.LISTENING&&T.abortListening(),k.abort(),u.stopAudio(),this._currentQuestion="",this._currentResponse="",this._responseSentences=[],this._currentSentenceIndex=0,this._audioBufferCache.clear(),this._nextSynthesisIndex=0,this._setState(g.IDLE)}cancelListening(){this._state===g.LISTENING&&(T.abortListening(),this._setState(g.IDLE))}askAnother(){this.stop(),setTimeout(()=>{this.startVoiceQA()},100)}getCurrentQuestion(){return this._currentQuestion}getCurrentResponse(){return this._currentResponse}isSTTSupported(){return T.isSupported()}async requestMicPermission(){return T.requestPermission()}_setState(e){var s;const t=this._state;this._state=e,t!==e&&((s=this._onStateChange)==null||s.call(this,e,{question:this._currentQuestion,response:this._currentResponse,sentenceIndex:this._currentSentenceIndex,totalSentences:this._responseSentences.length}))}}class ie{constructor({onPositionChange:e,onBookmarksChange:t,onHighlightsChange:s}={}){this._currentBook=null,this._position={chapterIndex:0,sentenceIndex:0},this._bookmarks=[],this._highlights=[],this._saveTimeout=null,this._onPositionChange=e,this._onBookmarksChange=t,this._onHighlightsChange=s}async init(){await m.init(),console.log("Reading state controller initialized")}async loadBook(e,t=null){const s=await L.loadFromFile(e);s.id=this._generateBookId(e.name),t?s.source=t:s.source={type:"local",filename:e.name},await m.saveBook(s),this._currentBook=s;const i=await m.getPosition(s.id);return i?(this._position={chapterIndex:i.chapterIndex,sentenceIndex:i.sentenceIndex},console.log("Restored position:",this._position)):this._position={chapterIndex:0,sentenceIndex:0},this._bookmarks=await m.getBookmarks(s.id),this._highlights=await m.getHighlights(s.id),s}async openBook(e){const t=await m.getBook(e);if(!t)throw new Error("Book not found");this._currentBook=t;const s=await m.getPosition(e);return s?this._position={chapterIndex:s.chapterIndex,sentenceIndex:s.sentenceIndex}:this._position={chapterIndex:0,sentenceIndex:0},this._bookmarks=await m.getBookmarks(e),this._highlights=await m.getHighlights(e),await m.saveBook(t),t}async getAllBooks(){return await m.getAllBooks()}async deleteBook(e){await m.deleteBook(e),await m.deletePosition(e);const t=await m.getBookmarks(e);for(const i of t)await m.deleteBookmark(i.id);const s=await m.getHighlights(e);for(const i of s)await m.deleteHighlight(i.id)}getCurrentBook(){return this._currentBook}getCurrentPosition(){return{...this._position}}async loadChapter(e){if(!this._currentBook)throw new Error("No book loaded");return await L.loadChapter(this._currentBook,e)}goToChapter(e,t=0){this._currentBook&&(this._position.chapterIndex=e,this._position.sentenceIndex=t,this._schedulePositionSave(),this._notifyPositionChange())}goToSentence(e){this._position.sentenceIndex=e,this._schedulePositionSave(),this._notifyPositionChange()}updateSentencePosition(e){this._position.sentenceIndex=e,this._schedulePositionSave()}goToBookmark(e){this._position.chapterIndex=e.chapterIndex,this._position.sentenceIndex=e.sentenceIndex,this._schedulePositionSave(),this._notifyPositionChange()}async addBookmark(e=""){if(!this._currentBook)throw new Error("No book loaded");const t={id:this._generateBookmarkId(),bookId:this._currentBook.id,chapterIndex:this._position.chapterIndex,sentenceIndex:this._position.sentenceIndex,note:e,createdAt:Date.now()};return await m.addBookmark(t),this._bookmarks.push(t),this._bookmarks.sort((s,i)=>s.chapterIndex!==i.chapterIndex?s.chapterIndex-i.chapterIndex:s.sentenceIndex-i.sentenceIndex),this._notifyBookmarksChange(),t}async deleteBookmark(e){await m.deleteBookmark(e),this._bookmarks=this._bookmarks.filter(t=>t.id!==e),this._notifyBookmarksChange()}getBookmarks(){return[...this._bookmarks]}async addHighlight(e,t,s,i,o="",n="yellow"){if(!this._currentBook)throw new Error("No book loaded");const a={id:this._generateHighlightId(),bookId:this._currentBook.id,chapterIndex:e,startSentenceIndex:t,endSentenceIndex:s,text:i,note:o,color:n,createdAt:Date.now()};return await m.addHighlight(a),this._highlights.push(a),this._highlights.sort((r,l)=>r.chapterIndex!==l.chapterIndex?r.chapterIndex-l.chapterIndex:r.startSentenceIndex-l.startSentenceIndex),this._notifyHighlightsChange(),a}async deleteHighlight(e){await m.deleteHighlight(e),this._highlights=this._highlights.filter(t=>t.id!==e),this._notifyHighlightsChange()}getHighlights(){return[...this._highlights]}getHighlightsForChapter(e){return this._highlights.filter(t=>t.chapterIndex===e)}_generateHighlightId(){return`highlight_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}_notifyHighlightsChange(){var e;(e=this._onHighlightsChange)==null||e.call(this)}async getContextSentences(e=20){if(!this._currentBook)return[];const t=[];let s=e,i=this._position.chapterIndex,o=this._position.sentenceIndex;for(;s>0&&i>=0;){const n=await this.loadChapter(i),a=Math.max(0,o-s+1),r=n.slice(a,o+1);t.unshift(...r),s-=r.length,i--,i>=0&&(o=(await this.loadChapter(i)).length-1)}return t.slice(-e)}async getContextSentencesAfter(e=5){if(!this._currentBook)return[];const t=[];let s=e,i=this._position.chapterIndex,o=this._position.sentenceIndex+1;for(;s>0&&i<this._currentBook.chapters.length;){const n=await this.loadChapter(i),a=Math.min(o+s,n.length),r=n.slice(o,a);t.push(...r),s-=r.length,i++,o=0}return t.slice(0,e)}_schedulePositionSave(){this._currentBook&&(this._saveTimeout&&clearTimeout(this._saveTimeout),this._saveTimeout=setTimeout(async()=>{try{await m.savePosition({bookId:this._currentBook.id,chapterIndex:this._position.chapterIndex,sentenceIndex:this._position.sentenceIndex}),console.log("Position saved:",this._position)}catch(e){console.error("Failed to save position:",e)}},2e3))}async savePositionNow(){this._currentBook&&(this._saveTimeout&&(clearTimeout(this._saveTimeout),this._saveTimeout=null),await m.savePosition({bookId:this._currentBook.id,chapterIndex:this._position.chapterIndex,sentenceIndex:this._position.sentenceIndex}))}_notifyPositionChange(){var e;(e=this._onPositionChange)==null||e.call(this,this._position.chapterIndex,this._position.sentenceIndex)}_notifyBookmarksChange(){var e;(e=this._onBookmarksChange)==null||e.call(this)}_generateBookId(e){const t=Date.now(),s=Math.random().toString(36).substring(2,9);return`${e.replace(/[^a-z0-9]/gi,"_")}_${t}_${s}`}_generateBookmarkId(){return`bookmark_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}destroy(){this._saveTimeout&&clearTimeout(this._saveTimeout)}}class ne{constructor({container:e,titleElement:t,bookTitleElement:s,onSentenceClick:i,onPageChange:o,onLinkClick:n,onImageClick:a,onHighlight:r}){this._container=e,this._titleElement=t,this._bookTitleElement=s,this._onSentenceClick=i,this._onPageChange=o,this._onLinkClick=n,this._onImageClick=a,this._onHighlight=r,this._textContent=e.querySelector("#text-content")||e,this._pageContainer=e.querySelector("#page-container"),this._prevBtn=e.querySelector("#page-prev-btn"),this._nextBtn=e.querySelector("#page-next-btn"),this._pageCurrentEl=e.querySelector("#page-current"),this._pageTotalEl=e.querySelector("#page-total"),this._pageCurrentOverlayEl=e.querySelector("#page-current-overlay"),this._pageTotalOverlayEl=e.querySelector("#page-total-overlay"),this._sentences=[],this._currentIndex=-1,this._html=null,this._highlights=[],this._currentPage=0,this._totalPages=1,this._pageHeight=0,this._sentenceToPage=new Map,this._pageToSentences=new Map,this._isCalculatingPages=!1,this._highlightToolbar=null,this._createHighlightToolbar(),this._setupEventDelegation(),this._setupPageNavigation(),this._setupResizeHandler(),this._setupTextSelection()}_setupEventDelegation(){this._textContent.addEventListener("click",e=>{var o,n,a;const t=e.target.closest("img");if(t&&t.src){e.preventDefault();const r=t.alt||"";(o=this._onImageClick)==null||o.call(this,t.src,r);return}const s=e.target.closest("a[href]");if(s){const r=s.getAttribute("href");if(r){if(r.startsWith("mailto:")||r.startsWith("tel:"))return;if(r.startsWith("http://")||r.startsWith("https://")){e.preventDefault(),window.open(r,"_blank","noopener,noreferrer");return}e.preventDefault(),(n=this._onLinkClick)==null||n.call(this,r);return}}const i=e.target.closest(".sentence");if(i&&i.dataset.index!==void 0){const r=parseInt(i.dataset.index,10);(a=this._onSentenceClick)==null||a.call(this,r)}})}_setupPageNavigation(){this._prevBtn&&this._prevBtn.addEventListener("click",()=>this.previousPage()),this._nextBtn&&this._nextBtn.addEventListener("click",()=>this.nextPage())}_setupResizeHandler(){this._debouncedRecalculate=z(()=>{(this._sentences.length>0||this._html)&&this._recalculatePages()},250),window.addEventListener("resize",this._debouncedRecalculate)}setBookTitle(e){this._bookTitleElement&&(this._bookTitleElement.textContent=e)}setChapterTitle(e){this._titleElement&&(this._titleElement.textContent=e)}setSentences(e,t=0,s=null){if(console.time("ReaderView.setSentences"),this._sentences=e,this._currentIndex=t,this._html=s,this._currentPage=0,this._textContent.innerHTML="",e.length===0&&!s){this._textContent.innerHTML='<p class="empty-message">No content to display</p>',this._updatePageIndicator(),console.timeEnd("ReaderView.setSentences");return}console.log(`Chapter has ${e.length} sentences, HTML mode: ${!!s}`),s?this._renderHtml(s,t):this._renderSentencesOnly(e,t),requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(this._calculatePages(),t>0){const i=this._sentenceToPage.get(t);i!==void 0&&this._goToPageInternal(i,!1)}})}),console.timeEnd("ReaderView.setSentences")}renderSentences(e,t=0,s=null){this.setSentences(e,t,s)}_renderHtml(e,t){console.time("ReaderView._renderHtml"),this._textContent.innerHTML=e;const s=this._textContent.querySelectorAll(".sentence[data-index]");console.log(`Found ${s.length} sentence elements in HTML`),s.forEach(i=>{const o=parseInt(i.dataset.index,10);o<t?i.classList.add("played"):o===t&&i.classList.add("current")}),console.timeEnd("ReaderView._renderHtml")}_renderSentencesOnly(e,t){console.time("ReaderView._renderSentencesOnly");const s=document.createDocumentFragment();let i=document.createElement("p");i.className="paragraph";for(let o=0;o<e.length;o++){const n=e[o],a=document.createElement("span");a.className="sentence",a.dataset.index=o.toString(),a.textContent=n+" ",o<t?a.classList.add("played"):o===t&&a.classList.add("current"),i.appendChild(a);const r=/[.!?]["']?\s*$/.test(n),l=(o+1)%6===0;r&&l&&o<e.length-1&&(s.appendChild(i),i=document.createElement("p"),i.className="paragraph")}i.hasChildNodes()&&s.appendChild(i),this._textContent.appendChild(s),console.timeEnd("ReaderView._renderSentencesOnly")}_calculatePages(){if(this._isCalculatingPages)return;this._isCalculatingPages=!0,console.time("ReaderView._calculatePages");let t=(this._pageContainer||this._textContent.parentElement||this._textContent).clientHeight;const s=this._textContent.scrollHeight;console.log(`Page calculation: container=${t}px, content=${s}px`),(t<=0||t>=s)&&(t=Math.max(300,window.innerHeight-400),console.log(`Using fallback page height: ${t}px`)),this._sentenceToPage=new Map,this._pageToSentences=new Map,this._pageHeight=t;const i=this._textContent.querySelectorAll(".sentence[data-index]");if(i.length===0){const r=s/t,l=r%1;this._totalPages=l<.05?Math.floor(r):Math.ceil(r),this._totalPages=Math.max(1,this._totalPages),this._updatePageIndicator(),this._updatePageButtons(),this._isCalculatingPages=!1,console.log(`No sentence elements; ${this._totalPages} pages from content height (${s}px)`),console.timeEnd("ReaderView._calculatePages");return}const o=s/t,n=o%1;this._totalPages=n<.05?Math.floor(o):Math.ceil(o),this._totalPages=Math.max(1,this._totalPages),i.forEach(r=>{const l=parseInt(r.dataset.index,10),c=r.offsetTop,h=Math.floor(c/t);this._sentenceToPage.set(l,h),this._pageToSentences.has(h)||this._pageToSentences.set(h,[]),this._pageToSentences.get(h).push(l)});const a=Math.max(...this._sentenceToPage.values(),0);this._totalPages=Math.max(this._totalPages,a+1),console.log(`Calculated ${this._totalPages} pages for ${i.length} sentences (pageHeight=${t}px)`),console.timeEnd("ReaderView._calculatePages"),this._updatePageIndicator(),this._updatePageButtons(),this._isCalculatingPages=!1}_recalculatePages(){const e=this._currentIndex;if(this._calculatePages(),e>=0){const t=this._sentenceToPage.get(e);t!==void 0&&t!==this._currentPage&&this._goToPageInternal(t,!1)}}goToPage(e){this._goToPageInternal(e,!0)}_goToPageInternal(e,t=!0){var n;const s=Math.max(0,Math.min(e,this._totalPages-1));if(s===this._currentPage&&this._totalPages>1)return;this._currentPage=s;const i=this._pageHeight||this._textContent.clientHeight,o=s*i;this._textContent.scrollTop=o,this._updatePageIndicator(),this._updatePageButtons(),t&&((n=this._onPageChange)==null||n.call(this))}nextPage(){return this._currentPage<this._totalPages-1?(this._goToPageInternal(this._currentPage+1),!0):!1}previousPage(){return this._currentPage>0?(this._goToPageInternal(this._currentPage-1),!0):!1}getCurrentPage(){return this._currentPage}getTotalPages(){return this._totalPages}_updatePageIndicator(){this._pageCurrentEl&&(this._pageCurrentEl.textContent=(this._currentPage+1).toString()),this._pageTotalEl&&(this._pageTotalEl.textContent=this._totalPages.toString()),this._pageCurrentOverlayEl&&(this._pageCurrentOverlayEl.textContent=(this._currentPage+1).toString()),this._pageTotalOverlayEl&&(this._pageTotalOverlayEl.textContent=this._totalPages.toString())}_updatePageButtons(){this._prevBtn&&(this._prevBtn.disabled=this._currentPage<=0),this._nextBtn&&(this._nextBtn.disabled=this._currentPage>=this._totalPages-1)}_navigateToSentencePage(e){const t=this._sentenceToPage.get(e);return t!==void 0&&t!==this._currentPage?(this._goToPageInternal(t,!1),!0):!1}highlightSentence(e,t=!0){const s=this._textContent.querySelector(`.sentence[data-index="${this._currentIndex}"]`);s&&(s.classList.remove("current"),s.classList.add("played")),this._currentIndex=e;const i=this._textContent.querySelector(`.sentence[data-index="${e}"]`);i&&(i.classList.remove("played"),i.classList.add("current"),t&&this._navigateToSentencePage(e))}clearHighlights(){this._textContent.querySelectorAll(".sentence").forEach(t=>{t.classList.remove("current","played")}),this._currentIndex=-1}resetPlayedState(e){this._textContent.querySelectorAll(".sentence[data-index]").forEach(s=>{parseInt(s.dataset.index,10)>=e&&s.classList.remove("played")})}getCurrentIndex(){return this._currentIndex}getSentenceCount(){return this._sentences.length}showLoading(){this._textContent.innerHTML=`
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading chapter...</p>
            </div>
        `,this._totalPages=1,this._currentPage=0,this._updatePageIndicator(),this._updatePageButtons()}showError(e){this._textContent.innerHTML=`
            <div class="error-message">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>${e}</span>
            </div>
        `,this._totalPages=1,this._currentPage=0,this._updatePageIndicator(),this._updatePageButtons()}scrollToTop(){this._goToPageInternal(0,!1)}scrollToFragment(e){if(!e)return!1;try{const t=this._textContent.querySelector(`[id="${CSS.escape(e)}"]`);if(t){const s=t.offsetTop,i=this._pageHeight||this._textContent.clientHeight;if(i>0){const o=Math.floor(s/i);this._goToPageInternal(o,!1)}return t.classList.add("link-target"),setTimeout(()=>t.classList.remove("link-target"),2e3),!0}}catch(t){console.warn("Failed to scroll to fragment:",e,t)}return!1}_createHighlightToolbar(){this._highlightToolbar=document.createElement("div"),this._highlightToolbar.className="highlight-toolbar hidden",this._highlightToolbar.innerHTML=`
            <button class="highlight-btn highlight-btn-yellow" data-color="yellow" title="Highlight yellow">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02zm1.414-1.414l2.829 2.828-1.415 1.414-2.828-2.828 1.414-1.414z"/>
                </svg>
            </button>
            <button class="highlight-btn highlight-btn-green" data-color="green" title="Highlight green">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02zm1.414-1.414l2.829 2.828-1.415 1.414-2.828-2.828 1.414-1.414z"/>
                </svg>
            </button>
            <button class="highlight-btn highlight-btn-blue" data-color="blue" title="Highlight blue">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02zm1.414-1.414l2.829 2.828-1.415 1.414-2.828-2.828 1.414-1.414z"/>
                </svg>
            </button>
            <button class="highlight-btn highlight-btn-pink" data-color="pink" title="Highlight pink">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02zm1.414-1.414l2.829 2.828-1.415 1.414-2.828-2.828 1.414-1.414z"/>
                </svg>
            </button>
        `,document.body.appendChild(this._highlightToolbar),this._highlightToolbar.addEventListener("mousedown",e=>{e.preventDefault()}),this._highlightToolbar.addEventListener("click",e=>{const t=e.target.closest(".highlight-btn");if(t){const s=t.dataset.color;this._createHighlightFromSelection(s)}})}_setupTextSelection(){document.addEventListener("selectionchange",()=>{this._handleSelectionChange()}),document.addEventListener("mousedown",e=>{!this._highlightToolbar.contains(e.target)&&!this._textContent.contains(e.target)&&this._hideHighlightToolbar()})}_handleSelectionChange(){const e=window.getSelection();if(!e||e.isCollapsed||e.rangeCount===0){this._hideToolbarTimeout=setTimeout(()=>{this._hideHighlightToolbar()},200);return}const t=e.getRangeAt(0);if(!this._textContent.contains(t.startContainer)||!this._textContent.contains(t.endContainer))return;const s=this._findSentenceElement(t.startContainer),i=this._findSentenceElement(t.endContainer);if(!s||!i)return;this._hideToolbarTimeout&&(clearTimeout(this._hideToolbarTimeout),this._hideToolbarTimeout=null);const o=t.getBoundingClientRect();this._showHighlightToolbar(o)}_findSentenceElement(e){let t=e.nodeType===Node.TEXT_NODE?e.parentElement:e;for(;t&&t!==this._textContent;){if(t.classList&&t.classList.contains("sentence")&&t.dataset.index!==void 0)return t;t=t.parentElement}return null}_showHighlightToolbar(e){const t=this._highlightToolbar;t.classList.remove("hidden");const s=t.offsetHeight,i=t.offsetWidth;let o=e.top-s-8+window.scrollY,n=e.left+e.width/2-i/2+window.scrollX;o<window.scrollY+4&&(o=e.bottom+8+window.scrollY),n=Math.max(4,Math.min(n,window.innerWidth-i-4)),t.style.top=`${o}px`,t.style.left=`${n}px`}_hideHighlightToolbar(){this._highlightToolbar.classList.add("hidden")}_createHighlightFromSelection(e="yellow"){var l;const t=window.getSelection();if(!t||t.isCollapsed||t.rangeCount===0)return;const s=t.getRangeAt(0),i=this._findSentenceElement(s.startContainer),o=this._findSentenceElement(s.endContainer);if(!i||!o)return;const n=parseInt(i.dataset.index,10),a=parseInt(o.dataset.index,10),r=t.toString().trim();r&&(this._applyHighlightToSentences(n,a,e),t.removeAllRanges(),this._hideHighlightToolbar(),(l=this._onHighlight)==null||l.call(this,n,a,r,e))}_applyHighlightToSentences(e,t,s="yellow"){for(let i=e;i<=t;i++){const o=this._textContent.querySelector(`.sentence[data-index="${i}"]`);o&&o.classList.add("user-highlight",`highlight-${s}`)}}_removeHighlightFromSentences(e,t){for(let s=e;s<=t;s++){const i=this._textContent.querySelector(`.sentence[data-index="${s}"]`);i&&i.classList.remove("user-highlight","highlight-yellow","highlight-green","highlight-blue","highlight-pink")}}setHighlights(e){this._highlights=e,this._applyAllHighlights()}_applyAllHighlights(){this._textContent.querySelectorAll(".user-highlight").forEach(t=>{t.classList.remove("user-highlight","highlight-yellow","highlight-green","highlight-blue","highlight-pink")});for(const t of this._highlights)this._applyHighlightToSentences(t.startSentenceIndex,t.endSentenceIndex,t.color||"yellow")}destroy(){window.removeEventListener("resize",this._debouncedRecalculate),this._highlightToolbar&&this._highlightToolbar.remove(),this._hideToolbarTimeout&&clearTimeout(this._hideToolbarTimeout)}}class oe{constructor(e,t){this._playBtn=e.playBtn,this._pauseIcon=e.pauseIcon,this._playIcon=e.playIcon,this._prevBtn=e.prevBtn,this._nextBtn=e.nextBtn,this._prevChapterBtn=e.prevChapterBtn,this._nextChapterBtn=e.nextChapterBtn,this._askBtn=e.askBtn,this._speedSlider=e.speedSlider,this._speedValue=e.speedValue,this._voiceSelect=e.voiceSelect,this._callbacks=t,this._isPlaying=!1,this._isEnabled=!1,this._setupEventListeners()}_setupEventListeners(){this._playBtn.addEventListener("click",()=>{var e,t,s,i;this._isPlaying?(t=(e=this._callbacks).onPause)==null||t.call(e):(i=(s=this._callbacks).onPlay)==null||i.call(s)}),this._prevBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onPrev)==null||t.call(e)}),this._nextBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onNext)==null||t.call(e)}),this._prevChapterBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onPrevChapter)==null||t.call(e)}),this._nextChapterBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onNextChapter)==null||t.call(e)}),this._askBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onAsk)==null||t.call(e)}),this._speedSlider.addEventListener("input",()=>{var t,s;const e=parseFloat(this._speedSlider.value);this._updateSpeedDisplay(e),(s=(t=this._callbacks).onSpeedChange)==null||s.call(t,e)}),this._voiceSelect.addEventListener("change",()=>{var t,s;const e=this._voiceSelect.value;(s=(t=this._callbacks).onVoiceChange)==null||s.call(t,e)})}_updateSpeedDisplay(e){this._speedValue.textContent=`${e.toFixed(1)}x`}setPlaying(e){this._isPlaying=e,this._setBuffering(!1),e?(this._playIcon.classList.add("hidden"),this._pauseIcon.classList.remove("hidden")):(this._playIcon.classList.remove("hidden"),this._pauseIcon.classList.add("hidden"))}setBuffering(e){this._setBuffering(e)}_setBuffering(e){e?(this._playBtn.classList.add("buffering"),this._playIcon.classList.add("hidden"),this._pauseIcon.classList.add("hidden")):this._playBtn.classList.remove("buffering")}setEnabled(e){this._isEnabled=e,this._playBtn.disabled=!e,this._prevBtn.disabled=!e,this._nextBtn.disabled=!e,this._prevChapterBtn.disabled=!e,this._nextChapterBtn.disabled=!e,this._askBtn.disabled=!e,this._speedSlider.disabled=!e}setSpeed(e){this._speedSlider.value=e.toString(),this._updateSpeedDisplay(e)}getSpeed(){return parseFloat(this._speedSlider.value)}setVoices(e){const t=this._voiceSelect.value;this._voiceSelect.innerHTML="",e.forEach(s=>{const i=document.createElement("option");i.value=s.id,i.textContent=s.name,this._voiceSelect.appendChild(i)}),e.some(s=>s.id===t)&&(this._voiceSelect.value=t)}setVoice(e){this._voiceSelect.value=e}getVoice(){return this._voiceSelect.value}setAskDisabled(e,t){this._askBtn.disabled=e,e&&t?this._askBtn.title=t:this._askBtn.title="Ask a question"}}class ae{constructor(e,t){this._panel=e.panel,this._overlay=e.overlay,this._menuBtn=e.menuBtn,this._callbacks=t,this._currentBook=null,this._currentChapterIndex=0,this._bookmarks=[],this._highlights=[],this._setupEventListeners()}_setupEventListeners(){this._menuBtn.addEventListener("click",()=>{this.open()}),this._overlay.addEventListener("click",()=>{this.close()});const e=this._panel.querySelector(".nav-close-btn");e&&e.addEventListener("click",()=>{this.close()});const t=this._panel.querySelector("#add-bookmark-btn");t&&t.addEventListener("click",()=>{var s,i;(i=(s=this._callbacks).onAddBookmark)==null||i.call(s)})}setBook(e,t=0){this._currentBook=e,this._currentChapterIndex=t,this.render()}setBookmarks(e){this._bookmarks=e,this._renderBookmarks()}setCurrentChapter(e){this._currentChapterIndex=e,this._renderChapters()}setHighlights(e){this._highlights=e,this._renderHighlights()}render(){this._currentBook&&(this._renderChapters(),this._renderBookmarks(),this._renderHighlights())}_renderChapters(){const e=this._panel.querySelector("#chapters-list");!e||!this._currentBook||(e.innerHTML="",this._currentBook.chapters.forEach((t,s)=>{const i=document.createElement("div");i.className="nav-item",s===this._currentChapterIndex&&i.classList.add("active"),i.innerHTML=`
                <span class="chapter-number">${s+1}.</span>
                <span class="chapter-title">${this._escapeHtml(t.title)}</span>
            `,i.addEventListener("click",()=>{var o,n;(n=(o=this._callbacks).onChapterSelect)==null||n.call(o,s),this.close()}),e.appendChild(i)}))}_renderBookmarks(){const e=this._panel.querySelector("#bookmarks-list");if(e){if(this._bookmarks.length===0){e.innerHTML='<div class="nav-empty">No bookmarks yet</div>';return}e.innerHTML="",this._bookmarks.forEach(t=>{var a,r;const s=document.createElement("div");s.className="nav-item bookmark-item";const i=((r=(a=this._currentBook)==null?void 0:a.chapters[t.chapterIndex])==null?void 0:r.title)||"Unknown";s.innerHTML=`
                <div class="bookmark-content">
                    <div class="bookmark-icon">üìë</div>
                    <div class="bookmark-details">
                        <div class="bookmark-chapter">Ch. ${t.chapterIndex+1}: ${this._escapeHtml(i)}</div>
                        ${t.note?`<div class="bookmark-note">${this._escapeHtml(t.note)}</div>`:""}
                    </div>
                </div>
                <button class="bookmark-delete-btn" aria-label="Delete bookmark">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `,s.querySelector(".bookmark-content").addEventListener("click",()=>{var l,c;(c=(l=this._callbacks).onBookmarkSelect)==null||c.call(l,t),this.close()}),s.querySelector(".bookmark-delete-btn").addEventListener("click",l=>{var c,h;l.stopPropagation(),confirm("Delete this bookmark?")&&((h=(c=this._callbacks).onBookmarkDelete)==null||h.call(c,t.id))}),e.appendChild(s)})}}_renderHighlights(){const e=this._panel.querySelector("#highlights-list");if(e){if(this._highlights.length===0){e.innerHTML='<div class="nav-empty">No highlights yet</div>';return}e.innerHTML="",this._highlights.forEach(t=>{var l,c;const s=document.createElement("div");s.className="nav-item highlight-item";const i=((c=(l=this._currentBook)==null?void 0:l.chapters[t.chapterIndex])==null?void 0:c.title)||"Unknown",o=`highlight-color-${t.color||"yellow"}`,n=t.text.length>80?t.text.substring(0,80)+"...":t.text;s.innerHTML=`
                <div class="highlight-nav-content">
                    <div class="highlight-color-indicator ${o}"></div>
                    <div class="highlight-nav-details">
                        <div class="highlight-nav-chapter">Ch. ${t.chapterIndex+1}: ${this._escapeHtml(i)}</div>
                        <div class="highlight-nav-text">"${this._escapeHtml(n)}"</div>
                    </div>
                </div>
                <button class="highlight-delete-btn" aria-label="Delete highlight">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `,s.querySelector(".highlight-nav-content").addEventListener("click",()=>{var h,d;(d=(h=this._callbacks).onHighlightSelect)==null||d.call(h,t),this.close()}),s.querySelector(".highlight-delete-btn").addEventListener("click",h=>{var d,f;h.stopPropagation(),confirm("Delete this highlight?")&&((f=(d=this._callbacks).onHighlightDelete)==null||f.call(d,t.id))}),e.appendChild(s)})}}open(){this._panel.classList.add("active"),this._overlay.classList.add("active"),document.body.style.overflow="hidden"}close(){this._panel.classList.remove("active"),this._overlay.classList.remove("active"),document.body.style.overflow=""}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class re{constructor(e,t){this._container=e.container,this._callbacks=t,this._state=g.IDLE,this._transcript="",this._response="",this._history=[],this._historyIndex=-1,this._showTextInput=!1,this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="qa-dialog">
                <div class="qa-header">
                    <h2 class="qa-title">Q&A Mode</h2>
                    <button class="qa-close-btn" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div class="qa-content">
                    <div class="qa-status-section">
                        <div class="qa-icon" id="qa-icon"></div>
                        <div class="qa-status" id="qa-status">Ready</div>
                    </div>

                    <div class="qa-transcript-section" id="qa-transcript-section">
                        <label class="qa-label">Your Question:</label>
                        <div class="qa-transcript" id="qa-transcript"></div>
                    </div>

                    <div class="qa-text-input-section hidden" id="qa-text-input-section">
                        <label class="qa-label">Type your question:</label>
                        <div class="qa-text-input-wrapper">
                            <input type="text" class="qa-text-input" id="qa-text-input" placeholder="Enter your question...">
                            <button class="btn btn-primary qa-submit-btn" id="qa-submit-btn">Ask</button>
                        </div>
                        <button class="btn btn-secondary qa-retry-voice-btn" id="qa-retry-voice-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            </svg>
                            Try Voice Again
                        </button>
                    </div>

                    <div class="qa-response-section hidden" id="qa-response-section">
                        <label class="qa-label">Answer:</label>
                        <div class="qa-response" id="qa-response"></div>
                    </div>

                    <div class="qa-history-section hidden" id="qa-history-section">
                        <label class="qa-label">Previous Q&A:</label>
                        <div class="qa-history-nav">
                            <button class="btn-icon qa-history-prev" id="qa-history-prev" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"/>
                                </svg>
                            </button>
                            <span class="qa-history-counter" id="qa-history-counter">0 / 0</span>
                            <button class="btn-icon qa-history-next" id="qa-history-next" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                        </div>
                        <div class="qa-history-item" id="qa-history-item">
                            <div class="qa-history-question" id="qa-history-question"></div>
                            <div class="qa-history-answer" id="qa-history-answer"></div>
                        </div>
                    </div>
                </div>

                <div class="qa-controls" id="qa-controls">
                    <button class="btn btn-secondary" id="qa-cancel-btn">Cancel</button>
                </div>
            </div>
        `,this._elements={dialog:this._container.querySelector(".qa-dialog"),closeBtn:this._container.querySelector(".qa-close-btn"),icon:this._container.querySelector("#qa-icon"),status:this._container.querySelector("#qa-status"),transcriptSection:this._container.querySelector("#qa-transcript-section"),transcript:this._container.querySelector("#qa-transcript"),textInputSection:this._container.querySelector("#qa-text-input-section"),textInput:this._container.querySelector("#qa-text-input"),submitBtn:this._container.querySelector("#qa-submit-btn"),retryVoiceBtn:this._container.querySelector("#qa-retry-voice-btn"),responseSection:this._container.querySelector("#qa-response-section"),response:this._container.querySelector("#qa-response"),historySection:this._container.querySelector("#qa-history-section"),historyPrev:this._container.querySelector("#qa-history-prev"),historyNext:this._container.querySelector("#qa-history-next"),historyCounter:this._container.querySelector("#qa-history-counter"),historyQuestion:this._container.querySelector("#qa-history-question"),historyAnswer:this._container.querySelector("#qa-history-answer"),controls:this._container.querySelector("#qa-controls"),cancelBtn:this._container.querySelector("#qa-cancel-btn")}}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._container.addEventListener("click",e=>{var t,s;e.target===this._container&&((s=(t=this._callbacks).onClose)==null||s.call(t))}),this._elements.submitBtn.addEventListener("click",()=>{this._submitTextQuestion()}),this._elements.textInput.addEventListener("keydown",e=>{e.key==="Enter"&&this._submitTextQuestion()}),this._elements.retryVoiceBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onRetryVoice)==null||t.call(e)}),this._elements.historyPrev.addEventListener("click",()=>{this._navigateHistory(-1)}),this._elements.historyNext.addEventListener("click",()=>{this._navigateHistory(1)}),this._elements.controls.addEventListener("click",e=>{var i,o,n,a,r,l,c,h,d,f,b,S,v,y;const t=e.target.closest("button");if(!t)return;switch(t.dataset.action){case"cancel":(o=(i=this._callbacks).onStop)==null||o.call(i),(a=(n=this._callbacks).onClose)==null||a.call(n);break;case"pause":(l=(r=this._callbacks).onPause)==null||l.call(r);break;case"resume":(h=(c=this._callbacks).onResume)==null||h.call(c);break;case"stop":(f=(d=this._callbacks).onStop)==null||f.call(d);break;case"continue":(S=(b=this._callbacks).onContinueReading)==null||S.call(b);break;case"ask-another":(y=(v=this._callbacks).onAskAnother)==null||y.call(v);break}})}_submitTextQuestion(){var t,s;const e=this._elements.textInput.value.trim();e&&(this._elements.textInput.value="",(s=(t=this._callbacks).onTextSubmit)==null||s.call(t,e))}show(){this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active")}hide(){this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||this._container.classList.add("hidden")},300)}isVisible(){return this._container.classList.contains("active")}setState(e,t={}){this._state=e,this._updateStatusDisplay(e),this._updateSectionsVisibility(e,t),this._updateControls(e),t.error&&this._showError(t.error)}_updateStatusDisplay(e){const t={[g.IDLE]:'<span class="qa-icon-emoji">?</span>',[g.LISTENING]:`
                <div class="qa-listening-animation">
                    <span></span><span></span><span></span>
                </div>
            `,[g.THINKING]:'<div class="spinner"></div>',[g.RESPONDING]:`
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 6 15 11 19 11 5"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
            `,[g.PAUSED]:`
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="4" width="4" height="16"/>
                    <rect x="14" y="4" width="4" height="16"/>
                </svg>
            `},s={[g.IDLE]:"Ready",[g.LISTENING]:"Listening...",[g.THINKING]:"Thinking...",[g.RESPONDING]:"Responding",[g.PAUSED]:"Paused"};this._elements.icon.innerHTML=t[e]||"",this._elements.status.textContent=s[e]||e}_updateSectionsVisibility(e,t){switch(this._elements.transcriptSection.classList.add("hidden"),this._elements.textInputSection.classList.add("hidden"),this._elements.responseSection.classList.add("hidden"),e){case g.IDLE:this._showTextInput&&this._elements.textInputSection.classList.remove("hidden");break;case g.LISTENING:this._elements.transcriptSection.classList.remove("hidden");break;case g.THINKING:this._elements.transcriptSection.classList.remove("hidden");break;case g.RESPONDING:case g.PAUSED:this._elements.transcriptSection.classList.remove("hidden"),this._elements.responseSection.classList.remove("hidden");break}}_updateControls(e){const t='<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',s='<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>',i='<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>',o='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>';let n="";switch(e){case g.IDLE:n=`
                    <button class="btn btn-secondary" data-action="cancel">Close</button>
                `;break;case g.LISTENING:n=`
                    <button class="btn btn-secondary" data-action="cancel">Cancel</button>
                `;break;case g.THINKING:n=`
                    <button class="btn btn-secondary btn-icon-text" data-action="stop" title="Stop">${s}</button>
                `;break;case g.RESPONDING:n=`
                    <button class="btn btn-secondary btn-icon-text" data-action="pause" title="Pause">${t}</button>
                    <button class="btn btn-secondary btn-icon-text" data-action="stop" title="Stop">${s}</button>
                    <button class="btn btn-secondary btn-icon-text" data-action="ask-another" title="Ask Another">${o}</button>
                    <button class="btn btn-primary" data-action="continue">Continue Reading</button>
                `;break;case g.PAUSED:n=`
                    <button class="btn btn-primary btn-icon-text" data-action="resume" title="Resume">${i}</button>
                    <button class="btn btn-secondary btn-icon-text" data-action="stop" title="Stop">${s}</button>
                    <button class="btn btn-secondary btn-icon-text" data-action="ask-another" title="Ask Another">${o}</button>
                    <button class="btn btn-secondary" data-action="continue">Continue Reading</button>
                `;break}this._elements.controls.innerHTML=n}setTranscript(e){this._transcript=e,this._elements.transcript.textContent=e||"..."}setResponse(e){this._response=e,this._elements.response.textContent=e,this._elements.response.scrollTop=this._elements.response.scrollHeight}showTextInput(){this._showTextInput=!0,this._elements.textInputSection.classList.remove("hidden"),this._elements.textInput.focus()}hideTextInput(){this._showTextInput=!1,this._elements.textInputSection.classList.add("hidden")}_showError(e){this._elements.status.textContent=`Error: ${e}`,this._elements.icon.innerHTML=`
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        `}setHistory(e){this._history=e,this._historyIndex=e.length>0?e.length-1:-1,this._updateHistoryDisplay()}addHistoryEntry(e){this._history.push(e),this._historyIndex=this._history.length-1,this._updateHistoryDisplay()}_navigateHistory(e){const t=this._historyIndex+e;t>=0&&t<this._history.length&&(this._historyIndex=t,this._updateHistoryDisplay())}_updateHistoryDisplay(){if(this._history.length===0){this._elements.historySection.classList.add("hidden");return}this._elements.historySection.classList.remove("hidden"),this._elements.historyCounter.textContent=`${this._historyIndex+1} / ${this._history.length}`,this._elements.historyPrev.disabled=this._historyIndex<=0,this._elements.historyNext.disabled=this._historyIndex>=this._history.length-1;const e=this._history[this._historyIndex];e&&(this._elements.historyQuestion.textContent=e.question,this._elements.historyAnswer.textContent=e.answer)}reset(){this._transcript="",this._response="",this._showTextInput=!1,this._elements.transcript.textContent="",this._elements.response.textContent="",this._elements.textInput.value="",this.setState(g.IDLE)}}class le{constructor(e,t){this._container=e.container,this._callbacks=t,this._fastApiAvailable=!1,this._settings={apiKey:"",model:x,contextBefore:20,contextAfter:5,ttsBackend:"kokoro-js",fastApiUrl:"http://localhost:8880"},this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="modal">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button class="btn-icon modal-close-btn" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div class="modal-content">
                    <div class="settings-section">
                        <h3>TTS Backend</h3>

                        <div class="form-group">
                            <label for="settings-tts-backend">Text-to-Speech Engine</label>
                            <select id="settings-tts-backend" class="form-select">
                                <option value="kokoro-fastapi">Kokoro FastAPI (local server)</option>
                                <option value="kokoro-js">Kokoro.js (in-browser, WebGPU/WASM)</option>
                                <option value="web-speech">Browser TTS (Web Speech API)</option>
                            </select>
                            <p class="form-hint" id="settings-tts-backend-hint">
                                Kokoro FastAPI requires a local server running at the URL below.
                            </p>
                        </div>

                        <div class="form-group" id="settings-fastapi-url-group">
                            <label for="settings-fastapi-url">Kokoro FastAPI URL</label>
                            <input type="text" id="settings-fastapi-url" class="form-input" placeholder="http://localhost:8880" value="http://localhost:8880">
                            <p class="form-hint" id="settings-fastapi-status"></p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Q&A Settings</h3>

                        <div class="form-group">
                            <label for="settings-api-key">OpenRouter API Key</label>
                            <input type="password" id="settings-api-key" class="form-input" placeholder="sk-or-...">
                            <p class="form-hint">
                                Get your free API key at <a href="https://openrouter.ai/keys" target="_blank" rel="noopener">openrouter.ai/keys</a>
                            </p>
                        </div>

                        <div class="form-group">
                            <label for="settings-model">AI Model</label>
                            <select id="settings-model" class="form-select">
                                <optgroup label="Free Models">
                                    ${C.free.map(e=>`
                                        <option value="${e.id}">${e.name}</option>
                                    `).join("")}
                                </optgroup>
                                <optgroup label="Paid Models">
                                    ${C.paid.map(e=>`
                                        <option value="${e.id}">${e.name}</option>
                                    `).join("")}
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="settings-context-before">Context Before (sentences)</label>
                            <input type="number" id="settings-context-before" class="form-input" min="0" max="100" value="20">
                            <p class="form-hint">Number of sentences before current position to include as context</p>
                        </div>

                        <div class="form-group">
                            <label for="settings-context-after">Context After (sentences)</label>
                            <input type="number" id="settings-context-after" class="form-input" min="0" max="100" value="5">
                            <p class="form-hint">Number of sentences after current position to include as context</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>About</h3>
                        <div id="settings-about-content" class="about-content">
                            <p>Loading information...</p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" id="settings-cancel-btn">Cancel</button>
                    <button class="btn btn-primary" id="settings-save-btn">Save</button>
                </div>
            </div>
        `,this._elements={modal:this._container.querySelector(".modal"),closeBtn:this._container.querySelector(".modal-close-btn"),ttsBackend:this._container.querySelector("#settings-tts-backend"),fastApiUrl:this._container.querySelector("#settings-fastapi-url"),fastApiUrlGroup:this._container.querySelector("#settings-fastapi-url-group"),fastApiStatus:this._container.querySelector("#settings-fastapi-status"),ttsBackendHint:this._container.querySelector("#settings-tts-backend-hint"),apiKey:this._container.querySelector("#settings-api-key"),model:this._container.querySelector("#settings-model"),contextBefore:this._container.querySelector("#settings-context-before"),contextAfter:this._container.querySelector("#settings-context-after"),cancelBtn:this._container.querySelector("#settings-cancel-btn"),saveBtn:this._container.querySelector("#settings-save-btn"),aboutContent:this._container.querySelector("#settings-about-content")}}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._elements.cancelBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._elements.saveBtn.addEventListener("click",()=>{this._save()}),this._elements.ttsBackend.addEventListener("change",()=>{this._updateBackendUI()}),this._container.addEventListener("click",e=>{var t,s;e.target===this._container&&((s=(t=this._callbacks).onClose)==null||s.call(t))}),document.addEventListener("keydown",e=>{var t,s;e.key==="Escape"&&this.isVisible()&&((s=(t=this._callbacks).onClose)==null||s.call(t))})}_updateBackendUI(){const e=this._elements.ttsBackend.value,t=e==="kokoro-fastapi";this._elements.fastApiUrlGroup.style.display=t?"":"none";const s={"kokoro-fastapi":"Kokoro FastAPI requires a local server running at the URL below.","kokoro-js":"Runs the Kokoro TTS model directly in the browser using WebGPU or WASM.","web-speech":"Uses the browser's built-in speech synthesis. No setup required."};this._elements.ttsBackendHint.textContent=s[e]||"",t&&(this._elements.fastApiStatus.textContent=this._fastApiAvailable?"Server detected":"Server not detected",this._elements.fastApiStatus.style.color=this._fastApiAvailable?"#059669":"#dc2626")}_save(){var s,i,o,n,a,r;const e={apiKey:this._elements.apiKey.value.trim(),model:this._elements.model.value,contextBefore:parseInt(this._elements.contextBefore.value)||20,contextAfter:parseInt(this._elements.contextAfter.value)||5,ttsBackend:this._elements.ttsBackend.value,fastApiUrl:this._elements.fastApiUrl.value.trim()||"http://localhost:8880"};e.contextBefore<0&&(e.contextBefore=0),e.contextBefore>100&&(e.contextBefore=100),e.contextAfter<0&&(e.contextAfter=0),e.contextAfter>100&&(e.contextAfter=100);const t=e.ttsBackend!==this._settings.ttsBackend||e.fastApiUrl!==this._settings.fastApiUrl;this._settings=e,(i=(s=this._callbacks).onSave)==null||i.call(s,e),t&&((n=(o=this._callbacks).onBackendChange)==null||n.call(o,e.ttsBackend)),(r=(a=this._callbacks).onClose)==null||r.call(a)}async _loadBuildInfo(){try{let e=await fetch("/public/build-info.json");e.ok||(e=await fetch("/build-info.json"));const t=await e.json(),i=new Date(t.buildTime).toLocaleString();let o='<div class="about-info">';o+=`<p><strong>Version:</strong> ${t.version}</p>`,o+=`<p><strong>Last Updated:</strong> ${i}</p>`,o+=`<p><strong>Commit:</strong> <code>${t.commitShort}</code></p>`,o+=`<p><strong>Branch:</strong> ${t.branch}</p>`,o+="</div>",this._elements.aboutContent.innerHTML=o}catch(e){console.warn("Could not load build info:",e),this._elements.aboutContent.innerHTML='<p class="form-hint">Build information not available</p>'}}show(){this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active"),this._loadCurrentSettings(),this._loadBuildInfo()}hide(){this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||this._container.classList.add("hidden")},300)}isVisible(){return this._container.classList.contains("active")}_loadCurrentSettings(){this._elements.apiKey.value=this._settings.apiKey||"",this._elements.model.value=this._settings.model||x,this._elements.contextBefore.value=this._settings.contextBefore||20,this._elements.contextAfter.value=this._settings.contextAfter||5,this._elements.ttsBackend.value=this._settings.ttsBackend||"kokoro-js",this._elements.fastApiUrl.value=this._settings.fastApiUrl||"http://localhost:8880",this._updateBackendUI()}setSettings(e){this._settings={...this._settings,...e}}getSettings(){return{...this._settings}}hasApiKey(){return!!(this._settings.apiKey&&this._settings.apiKey.trim())}setFastApiAvailable(e){this._fastApiAvailable=e}}class ce{constructor(e,t){this._container=e.container,this._callbacks=t,this._currentImage=null,this._scale=1,this._translateX=0,this._translateY=0,this._isDragging=!1,this._startX=0,this._startY=0,this._lastTouchDistance=0,this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="image-viewer-content">
                <button class="image-viewer-close-btn btn-icon" aria-label="Close">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
                <div class="image-viewer-controls">
                    <button class="btn-icon" id="image-zoom-out" aria-label="Zoom out" title="Zoom out">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button class="btn-icon" id="image-zoom-in" aria-label="Zoom in" title="Zoom in">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="11" y1="8" x2="11" y2="14"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button class="btn-icon" id="image-reset" aria-label="Reset zoom" title="Reset zoom">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="1 4 1 10 7 10"/>
                            <polyline points="23 20 23 14 17 14"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                    </button>
                </div>
                <div class="image-viewer-canvas" id="image-viewer-canvas">
                    <img id="image-viewer-img" alt="Full size image">
                </div>
            </div>
        `,this._elements={closeBtn:this._container.querySelector(".image-viewer-close-btn"),zoomInBtn:this._container.querySelector("#image-zoom-in"),zoomOutBtn:this._container.querySelector("#image-zoom-out"),resetBtn:this._container.querySelector("#image-reset"),canvas:this._container.querySelector("#image-viewer-canvas"),img:this._container.querySelector("#image-viewer-img")}}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{this.hide()}),this._container.addEventListener("click",e=>{e.target===this._container&&this.hide()}),this._escapeHandler=e=>{e.key==="Escape"&&this.isVisible()&&this.hide()},document.addEventListener("keydown",this._escapeHandler),this._elements.zoomInBtn.addEventListener("click",()=>{this._zoom(1.2)}),this._elements.zoomOutBtn.addEventListener("click",()=>{this._zoom(.8)}),this._elements.resetBtn.addEventListener("click",()=>{this._resetTransform()}),this._elements.canvas.addEventListener("wheel",e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1;this._zoom(t,e.clientX,e.clientY)},{passive:!1}),this._elements.canvas.addEventListener("mousedown",e=>{e.button===0&&this._startDrag(e.clientX,e.clientY)}),document.addEventListener("mousemove",e=>{this._isDragging&&this._drag(e.clientX,e.clientY)}),document.addEventListener("mouseup",()=>{this._endDrag()}),this._elements.canvas.addEventListener("touchstart",e=>{if(e.touches.length===1)this._startDrag(e.touches[0].clientX,e.touches[0].clientY);else if(e.touches.length===2){e.preventDefault();const t=e.touches[0],s=e.touches[1];this._lastTouchDistance=this._getTouchDistance(t,s)}},{passive:!1}),this._elements.canvas.addEventListener("touchmove",e=>{if(e.touches.length===1&&this._isDragging)this._drag(e.touches[0].clientX,e.touches[0].clientY);else if(e.touches.length===2){e.preventDefault();const t=e.touches[0],s=e.touches[1],i=this._getTouchDistance(t,s);if(this._lastTouchDistance>0){const o=i/this._lastTouchDistance,n=(t.clientX+s.clientX)/2,a=(t.clientY+s.clientY)/2;this._zoom(o,n,a)}this._lastTouchDistance=i}},{passive:!1}),this._elements.canvas.addEventListener("touchend",e=>{e.touches.length===0?(this._endDrag(),this._lastTouchDistance=0):e.touches.length===1&&(this._lastTouchDistance=0)})}_getTouchDistance(e,t){const s=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(s*s+i*i)}_startDrag(e,t){this._isDragging=!0,this._startX=e-this._translateX,this._startY=t-this._translateY,this._elements.canvas.style.cursor="grabbing"}_drag(e,t){this._isDragging&&(this._translateX=e-this._startX,this._translateY=t-this._startY,this._updateTransform())}_endDrag(){this._isDragging=!1,this._elements.canvas.style.cursor=this._scale>1?"grab":"default"}_zoom(e,t,s){const i=this._scale;if(this._scale=Math.min(Math.max(.5,this._scale*e),5),t!==void 0&&s!==void 0){const o=this._elements.canvas.getBoundingClientRect(),n=t-o.left,a=s-o.top;this._translateX=n-(n-this._translateX)*(this._scale/i),this._translateY=a-(a-this._translateY)*(this._scale/i)}this._updateTransform(),this._elements.canvas.style.cursor=this._scale>1?"grab":"default"}_resetTransform(){this._scale=1,this._translateX=0,this._translateY=0,this._updateTransform(),this._elements.canvas.style.cursor="default"}_updateTransform(){this._elements.img.style.transform=`translate(${this._translateX}px, ${this._translateY}px) scale(${this._scale})`}show(e,t=""){this._currentImage=e,this._elements.img.src=e,this._elements.img.alt=t,this._resetTransform(),this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active")}hide(){var e,t;this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||(this._container.classList.add("hidden"),this._elements.img.src="",this._currentImage=null)},300),(t=(e=this._callbacks).onClose)==null||t.call(e)}isVisible(){return this._container.classList.contains("active")}destroy(){document.removeEventListener("keydown",this._escapeHandler)}}class he{constructor(e,t){this._container=e.container,this._callbacks=t,this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="modal book-loader-modal">
                <div class="modal-header">
                    <h2>Select eBook</h2>
                    <button class="btn-icon modal-close-btn" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div class="modal-content">
                    <!-- Local File Option -->
                    <div class="book-source-option" id="local-file-option">
                        <div class="book-source-header">
                            <div class="book-source-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div class="book-source-info">
                                <h3>Load from Device</h3>
                                <p>Select an EPUB file from your computer</p>
                            </div>
                        </div>
                        <input type="file" id="book-loader-file-input" accept=".epub" hidden>
                        <button class="btn btn-primary book-source-btn" id="browse-local-btn">
                            Browse Files
                        </button>
                    </div>

                    <div class="book-source-divider">
                        <span>or</span>
                    </div>

                    <!-- Project Gutenberg Option -->
                    <div class="book-source-option" id="gutenberg-option">
                        <div class="book-source-header">
                            <div class="book-source-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                            </div>
                            <div class="book-source-info">
                                <h3>Load from Project Gutenberg</h3>
                                <p>Free public domain books</p>
                            </div>
                        </div>

                        <!-- Search Section -->
                        <div class="gutenberg-search-section">
                            <div class="gutenberg-input-row">
                                <input type="text" id="gutenberg-search-input" class="form-input" placeholder="Search books (e.g., Frankenstein)">
                                <button class="btn btn-primary" id="gutenberg-search-btn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                </button>
                            </div>
                            <div id="gutenberg-search-results" class="gutenberg-search-results hidden"></div>
                        </div>

                        <div class="gutenberg-or-divider">
                            <span>or enter book ID directly</span>
                        </div>

                        <!-- Direct ID Input -->
                        <div class="gutenberg-input-row">
                            <input type="text" id="book-loader-gutenberg-input" class="form-input" placeholder="Book ID or URL (e.g., 1342)">
                            <button class="btn btn-primary" id="load-gutenberg-btn">Load</button>
                        </div>
                        <p class="form-hint gutenberg-hint">
                            Enter a book ID (e.g., 1342 for Pride and Prejudice) or paste a Gutenberg URL.
                            <a href="https://www.gutenberg.org/" target="_blank" rel="noopener">Browse Gutenberg</a>
                        </p>
                    </div>

                    <!-- Loading State -->
                    <div id="book-loader-loading" class="book-loader-loading hidden">
                        <div class="spinner"></div>
                        <p id="book-loader-loading-text">Loading...</p>
                    </div>

                    <!-- Error State -->
                    <div id="book-loader-error" class="book-loader-error hidden">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span id="book-loader-error-text"></span>
                    </div>
                </div>
            </div>
        `,this._elements={modal:this._container.querySelector(".modal"),closeBtn:this._container.querySelector(".modal-close-btn"),fileInput:this._container.querySelector("#book-loader-file-input"),browseLocalBtn:this._container.querySelector("#browse-local-btn"),searchInput:this._container.querySelector("#gutenberg-search-input"),searchBtn:this._container.querySelector("#gutenberg-search-btn"),searchResults:this._container.querySelector("#gutenberg-search-results"),gutenbergInput:this._container.querySelector("#book-loader-gutenberg-input"),loadGutenbergBtn:this._container.querySelector("#load-gutenberg-btn"),loading:this._container.querySelector("#book-loader-loading"),loadingText:this._container.querySelector("#book-loader-loading-text"),error:this._container.querySelector("#book-loader-error"),errorText:this._container.querySelector("#book-loader-error-text")},this._isSearching=!1}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._container.addEventListener("click",e=>{var t,s;e.target===this._container&&((s=(t=this._callbacks).onClose)==null||s.call(t))}),this._escapeHandler=e=>{var t,s;e.key==="Escape"&&this.isVisible()&&((s=(t=this._callbacks).onClose)==null||s.call(t))},document.addEventListener("keydown",this._escapeHandler),this._elements.browseLocalBtn.addEventListener("click",()=>{this._elements.fileInput.click()}),this._elements.fileInput.addEventListener("change",e=>{var s,i,o;const t=(s=e.target.files)==null?void 0:s[0];if(t){this._hideError();const n={type:"local",filename:t.name};(o=(i=this._callbacks).onFileSelect)==null||o.call(i,t,n)}e.target.value=""}),this._elements.loadGutenbergBtn.addEventListener("click",()=>{this._loadFromGutenberg()}),this._elements.gutenbergInput.addEventListener("keypress",e=>{e.key==="Enter"&&this._loadFromGutenberg()}),this._elements.searchBtn.addEventListener("click",()=>{this._searchGutenberg()}),this._elements.searchInput.addEventListener("keypress",e=>{e.key==="Enter"&&this._searchGutenberg()}),this._elements.searchResults.addEventListener("click",e=>{var s,i;const t=e.target.closest(".gutenberg-search-result");if(t){const o=t.dataset.bookId;o&&(this._hideError(),this._clearSearchResults(),(i=(s=this._callbacks).onGutenbergLoad)==null||i.call(s,o))}})}_loadFromGutenberg(){var s,i;const e=this._elements.gutenbergInput.value.trim();if(!e){this._showError("Please enter a book ID or URL");return}let t;if(e.includes("gutenberg.org")){const o=e.match(/\/(?:ebooks|files|cache\/epub)\/(\d+)/);if(o)t=o[1];else{this._showError("Invalid Project Gutenberg URL");return}}else t=e;if(!/^\d+$/.test(t)){this._showError("Please enter a valid book ID (numbers only) or URL");return}this._hideError(),(i=(s=this._callbacks).onGutenbergLoad)==null||i.call(s,t)}async _searchGutenberg(){const e=this._elements.searchInput.value.trim();if(!e){this._showError("Please enter a search term");return}if(!this._isSearching){this._isSearching=!0,this._hideError(),this._showSearchLoading();try{const t=`https://www.gutenberg.org/ebooks/search/?query=${encodeURIComponent(e)}`,s=`https://api.allorigins.win/get?url=${encodeURIComponent(t)}`,i=await fetch(s);if(!i.ok)throw new Error("Failed to fetch search results");const o=await i.json();if(!o.contents)throw new Error("No content received from proxy");const r=new DOMParser().parseFromString(o.contents,"text/html").querySelectorAll(".booklink"),l=[];r.forEach(c=>{var b,S;const h=c.querySelector(".title"),d=c.querySelector(".subtitle"),f=c.querySelector("a.link");if(h&&f){const y=(f.getAttribute("href")||"").match(/\/ebooks\/(\d+)/),B=y?y[1]:null;B&&l.push({id:B,title:((b=h.textContent)==null?void 0:b.trim())||"Unknown Title",author:((S=d==null?void 0:d.textContent)==null?void 0:S.trim())||"Unknown Author"})}}),this._displaySearchResults(l,e)}catch(t){console.error("Gutenberg search error:",t),this._showError(`Search failed: ${t.message}`),this._clearSearchResults()}finally{this._isSearching=!1}}}_showSearchLoading(){this._elements.searchResults.classList.remove("hidden"),this._elements.searchResults.innerHTML=`
            <div class="gutenberg-search-loading">
                <div class="spinner"></div>
                <span>Searching Project Gutenberg...</span>
            </div>
        `}_displaySearchResults(e,t){if(this._elements.searchResults.classList.remove("hidden"),e.length===0){this._elements.searchResults.innerHTML=`
                <div class="gutenberg-search-empty">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <p>No books found for "${this._escapeHtml(t)}"</p>
                </div>
            `;return}const s=e.map(i=>`
            <div class="gutenberg-search-result" data-book-id="${i.id}">
                <div class="result-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                </div>
                <div class="result-info">
                    <div class="result-title">${this._escapeHtml(i.title)}</div>
                    <div class="result-author">${this._escapeHtml(i.author)}</div>
                </div>
                <div class="result-id">#${i.id}</div>
            </div>
        `).join("");this._elements.searchResults.innerHTML=`
            <div class="gutenberg-search-header">
                <span>${e.length} result${e.length!==1?"s":""} for "${this._escapeHtml(t)}"</span>
            </div>
            <div class="gutenberg-search-list">
                ${s}
            </div>
        `}_clearSearchResults(){this._elements.searchResults.classList.add("hidden"),this._elements.searchResults.innerHTML=""}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}show(){this._elements.gutenbergInput.value="",this._elements.searchInput.value="",this._clearSearchResults(),this._hideLoading(),this._hideError(),this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active"),setTimeout(()=>{this._elements.gutenbergInput.focus()},100)}hide(){this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||this._container.classList.add("hidden")},300)}isVisible(){return this._container.classList.contains("active")}showLoading(e="Loading..."){this._elements.loadingText.textContent=e,this._elements.loading.classList.remove("hidden"),this._elements.browseLocalBtn.disabled=!0,this._elements.loadGutenbergBtn.disabled=!0}_hideLoading(){this._elements.loading.classList.add("hidden"),this._elements.browseLocalBtn.disabled=!1,this._elements.loadGutenbergBtn.disabled=!1}hideLoading(){this._hideLoading()}_showError(e){this._elements.errorText.textContent=e,this._elements.error.classList.remove("hidden")}showError(e){this._hideLoading(),this._showError(e)}_hideError(){this._elements.error.classList.add("hidden")}destroy(){document.removeEventListener("keydown",this._escapeHandler)}}class de{constructor(){this._currentBook=null,this._currentChapterIndex=0,this._isInitialized=!1,this._savedSpeed=void 0,this._savedVoice=void 0,this._wasPlayingBeforeQA=!1,this._qaSettings={apiKey:"",model:x,contextBefore:20,contextAfter:5},this._elements={},this._readingState=null,this._readerView=null,this._controls=null,this._audioController=null,this._navigation=null,this._qaController=null,this._qaOverlay=null,this._settingsModal=null,this._imageViewerModal=null,this._bookLoaderModal=null}async init(){var e,t,s;this._cacheElements(),this._setupUploadHandlers(),this._setupKeyboardShortcuts(),this._setupQASetup(),this._readingState=new ie({onPositionChange:(i,o)=>{this._onPositionChange(i,o)},onBookmarksChange:()=>{this._onBookmarksChange()},onHighlightsChange:()=>{this._onHighlightsChange()}});try{await this._readingState.init()}catch(i){console.error("Storage initialization failed:",i)}this._navigation=new ae({panel:document.getElementById("nav-panel"),overlay:document.getElementById("nav-overlay"),menuBtn:this._elements.menuBtn},{onChapterSelect:i=>this._navigateToChapter(i),onBookmarkSelect:i=>this._navigateToBookmark(i),onBookmarkDelete:i=>this._deleteBookmark(i),onAddBookmark:()=>this._addBookmark(),onHighlightSelect:i=>this._navigateToHighlight(i),onHighlightDelete:i=>this._deleteHighlight(i)}),this._qaOverlay=new re({container:document.getElementById("qa-overlay")},{onClose:()=>this._closeQAOverlay(),onPause:()=>{var i;return(i=this._qaController)==null?void 0:i.pause()},onResume:()=>{var i;return(i=this._qaController)==null?void 0:i.resume()},onStop:()=>{var i;return(i=this._qaController)==null?void 0:i.stop()},onContinueReading:()=>this._continueReadingFromQA(),onAskAnother:()=>this._askAnotherQuestion(),onTextSubmit:i=>this._submitTextQuestion(i),onRetryVoice:()=>this._retryVoiceInput()}),this._settingsModal=new le({container:document.getElementById("settings-modal")},{onClose:()=>this._settingsModal.hide(),onSave:i=>this._saveQASettings(i),onBackendChange:i=>this._onTTSBackendChange(i)}),this._elements.settingsBtn=document.getElementById("settings-btn"),(e=this._elements.settingsBtn)==null||e.addEventListener("click",()=>{this._settingsModal.setSettings(this._qaSettings),this._settingsModal.show()}),this._imageViewerModal=new ce({container:document.getElementById("image-viewer-modal")},{onClose:()=>this._imageViewerModal.hide()}),this._bookLoaderModal=new he({container:document.getElementById("book-loader-modal")},{onClose:()=>this._bookLoaderModal.hide(),onFileSelect:(i,o)=>this._handleFileSelect(i,o),onGutenbergLoad:i=>this._handleGutenbergLoad(i)}),(t=this._elements.loadBookBtn)==null||t.addEventListener("click",()=>{this._bookLoaderModal.show()}),(s=this._elements.selectEbookBtn)==null||s.addEventListener("click",()=>{this._bookLoaderModal.show()}),await this._loadSettings(),this._checkResumeState(),this._showTTSStatus("Detecting TTS backends..."),u.onProgress(i=>{this._showTTSStatus(i.status)});try{const i=await m.getSetting("ttsBackend"),o=await m.getSetting("fastApiUrl");o&&u.setFastApiUrl(o);const n=await u.isKokoroFastAPIAvailable();this._settingsModal.setFastApiAvailable(n),console.log(`Kokoro FastAPI: ${n?"available":"not available"} at ${u.getFastApiUrl()}`);let a=i;a||(a=n?"kokoro-fastapi":"kokoro-js");const r=await u.initialize({backend:a}),l=u.getBackend();if(l==="kokoro-fastapi")this._showTTSStatus("TTS ready (Kokoro FastAPI)"),console.log(`TTS Engine: Kokoro FastAPI at ${u.getFastApiUrl()}`);else if(r){const c=u.getDevice(),h=u.getDtype();this._showTTSStatus(`TTS ready (${c}, ${h})`),console.log(`TTS Engine: Kokoro with ${c} backend, ${h} precision`)}else this._showTTSStatus("TTS ready (Browser)");this._settingsModal.setSettings({...this._settingsModal.getSettings(),ttsBackend:l,fastApiUrl:u.getFastApiUrl()}),setTimeout(()=>this._hideTTSStatus(),3e3)}catch(i){console.error("TTS initialization failed:",i),this._showTTSStatus("TTS initialization failed")}this._isInitialized=!0,console.log("Reading Partner initialized"),console.log("Tip: Run readingPartner.runBenchmark() to test TTS performance")}_cacheElements(){this._elements={uploadScreen:document.getElementById("upload-screen"),readerScreen:document.getElementById("reader-screen"),uploadArea:document.getElementById("upload-area"),fileInput:document.getElementById("file-input"),selectEbookBtn:document.getElementById("select-ebook-btn"),loadingIndicator:document.getElementById("loading-indicator"),loadingText:document.getElementById("loading-text"),qaSetupDetails:document.getElementById("qa-setup-details"),qaSetupStatus:document.getElementById("qa-setup-status"),setupApiKey:document.getElementById("setup-api-key"),setupModel:document.getElementById("setup-model"),setupFreeModels:document.getElementById("setup-free-models"),setupPaidModels:document.getElementById("setup-paid-models"),saveQaSetupBtn:document.getElementById("save-qa-setup-btn"),menuBtn:document.getElementById("menu-btn"),settingsBtn:document.getElementById("settings-btn"),bookTitle:document.getElementById("book-title"),chapterTitle:document.getElementById("chapter-title"),readerContent:document.getElementById("reader-content"),textContent:document.getElementById("text-content"),pageContainer:document.getElementById("page-container"),pagePrevBtn:document.getElementById("page-prev-btn"),pageNextBtn:document.getElementById("page-next-btn"),pageCurrent:document.getElementById("page-current"),pageTotal:document.getElementById("page-total"),playBtn:document.getElementById("play-btn"),playIcon:document.getElementById("play-icon"),pauseIcon:document.getElementById("pause-icon"),prevBtn:document.getElementById("prev-btn"),nextBtn:document.getElementById("next-btn"),prevChapterBtn:document.getElementById("prev-chapter-btn"),nextChapterBtn:document.getElementById("next-chapter-btn"),askBtn:document.getElementById("ask-btn"),speedSlider:document.getElementById("speed-slider"),speedValue:document.getElementById("speed-value"),voiceSelect:document.getElementById("voice-select"),loadBookBtn:document.getElementById("load-book-btn"),ttsStatus:document.getElementById("tts-status")}}_setupUploadHandlers(){const{uploadArea:e,fileInput:t}=this._elements;t.addEventListener("change",s=>{var o;const i=(o=s.target.files)==null?void 0:o[0];if(i){const n={type:"local",filename:i.name};this._loadBook(i,n)}s.target.value=""}),e.addEventListener("dragover",s=>{s.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",s=>{var o,n;s.preventDefault(),e.classList.remove("dragover");const i=(n=(o=s.dataTransfer)==null?void 0:o.files)==null?void 0:n[0];if(i){const a={type:"local",filename:i.name};this._loadBook(i,a)}})}async _handleFileSelect(e,t){var i,o;this._elements.readerScreen.classList.contains("active")&&(this._pause(),(i=this._qaController)==null||i.stop(),(o=this._qaOverlay)==null||o.hide(),this._qaController&&(this._qaController.setBookMeta(null),this._qaController.clearHistory()),this._currentChapterIndex=0),this._bookLoaderModal.hide(),await this._loadBook(e,t)}async _handleGutenbergLoad(e){var s,i;this._elements.readerScreen.classList.contains("active")&&(this._pause(),(s=this._qaController)==null||s.stop(),(i=this._qaOverlay)==null||i.hide(),this._qaController&&(this._qaController.setBookMeta(null),this._qaController.clearHistory()),this._currentChapterIndex=0),this._bookLoaderModal.showLoading("Fetching from Project Gutenberg...");try{this._bookLoaderModal.showLoading("Downloading EPUB...");const o="https://corsproxy.io/?",n=[`${o}https://gutenberg.org/cache/epub/${e}/pg${e}.epub`,`${o}https://www.gutenberg.org/files/${e}/${e}-0.epub`,`${o}https://www.gutenberg.org/files/${e}/${e}.epub`];let a=null,r=!1;for(const l of n)try{const c=await fetch(l);if(c.ok){const h=await c.blob();if(h.size<100)throw new Error("Downloaded file is too small to be an EPUB");const d=new File([h],`gutenberg-${e}.epub`,{type:"application/epub+zip"}),f={type:"gutenberg",bookId:e};this._bookLoaderModal.hide(),await this._loadBook(d,f),r=!0;break}}catch(c){a=c,console.log(`Failed to load from ${l}:`,c.message)}if(!r)throw new Error(`Book ${e} could not be loaded. The book might not be available as EPUB. Try downloading manually from https://www.gutenberg.org/ebooks/${e}`)}catch(o){console.error("Failed to load from Gutenberg:",o),this._bookLoaderModal.showError(o.message)}}_setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{var i,o,n,a;if(!this._elements.readerScreen.classList.contains("active"))return;const t=document.activeElement;if(!(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)))switch(e.code){case"Space":e.preventDefault(),this._togglePlayPause();break;case"ArrowLeft":e.preventDefault(),(i=this._audioController)==null||i.skipBackward(1);break;case"ArrowRight":e.preventDefault(),(o=this._audioController)==null||o.skipForward();break;case"KeyB":e.preventDefault(),this._navigateToPrevChapter();break;case"KeyN":e.preventDefault(),this._navigateToNextChapter();break;case"PageUp":e.preventDefault(),(n=this._readerView)==null||n.previousPage();break;case"PageDown":e.preventDefault(),(a=this._readerView)==null||a.nextPage();break}})}async _loadBook(e,t=null){const{loadingIndicator:s,loadingText:i}=this._elements,o=this._elements.readerScreen.classList.contains("active");try{if(o?this._showTTSStatus("Loading new book..."):(s.classList.remove("hidden"),i.textContent="Parsing EPUB..."),this._currentBook=await this._readingState.loadBook(e,t),!this._currentBook.chapters.length)throw new Error("No readable content found in this EPUB");o?this._showTTSStatus("Preparing reader..."):i.textContent="Preparing reader...",this._controls?(this._readerView.setBookTitle(this._currentBook.title),this._controls.setEnabled(!0),this._controls.setAskDisabled(!this._qaSettings.apiKey,"Configure API key in Q&A Settings to enable voice questions")):this._initializeReader();const n=this._readingState.getCurrentPosition();await this._loadChapter(n.chapterIndex,!1),this._navigation.setBook(this._currentBook,n.chapterIndex),this._navigation.setBookmarks(this._readingState.getBookmarks()),this._navigation.setHighlights(this._readingState.getHighlights()),n.sentenceIndex>0&&(this._audioController.goToSentence(n.sentenceIndex),this._readerView.highlightSentence(n.sentenceIndex)),this._showScreen("reader"),this._saveCookieState(),o&&(this._hideTTSStatus(),this._showToast(`Loaded "${this._currentBook.title}"`))}catch(n){console.error("Failed to load book:",n),o?(this._hideTTSStatus(),this._showToast(`Failed to load: ${n.message}`)):this._showUploadError(n.message)}finally{o||s.classList.add("hidden")}}_initializeReader(){this._readerView=new ne({container:this._elements.readerContent,titleElement:this._elements.chapterTitle,bookTitleElement:this._elements.bookTitle,onSentenceClick:t=>{var s;(s=this._audioController)==null||s.goToSentence(t)},onLinkClick:t=>{this._handleInternalLink(t)},onImageClick:(t,s)=>{var i;(i=this._imageViewerModal)==null||i.show(t,s)},onHighlight:(t,s,i,o)=>{this._addHighlight(t,s,i,o)}}),this._audioController=new ee({onSentenceChange:t=>{this._readerView.highlightSentence(t),this._readingState&&this._readingState.updateSentencePosition(t)},onStateChange:t=>{t.status==="buffering"?this._controls.setBuffering(!0):this._controls.setPlaying(t.status==="playing"),w.setPlaybackState(t.status)},onChapterEnd:()=>{this._onChapterEnd()}}),this._initializeMediaSession(),this._controls=new oe({playBtn:this._elements.playBtn,playIcon:this._elements.playIcon,pauseIcon:this._elements.pauseIcon,prevBtn:this._elements.prevBtn,nextBtn:this._elements.nextBtn,prevChapterBtn:this._elements.prevChapterBtn,nextChapterBtn:this._elements.nextChapterBtn,askBtn:this._elements.askBtn,speedSlider:this._elements.speedSlider,speedValue:this._elements.speedValue,voiceSelect:this._elements.voiceSelect},{onPlay:()=>this._play(),onPause:()=>this._pause(),onPrev:()=>this._audioController.skipBackward(1),onNext:()=>this._audioController.skipForward(),onPrevChapter:()=>this._navigateToPrevChapter(),onNextChapter:()=>this._navigateToNextChapter(),onAsk:()=>this._startQA(),onSpeedChange:t=>{this._audioController.setSpeed(t),this._saveSettings()},onVoiceChange:t=>{u.setVoice(t),this._saveSettings()}});const e=u.getAvailableVoices();this._controls.setVoices(e),this._savedVoice&&(this._controls.setVoice(this._savedVoice),u.setVoice(this._savedVoice)),this._savedSpeed!==void 0&&(this._controls.setSpeed(this._savedSpeed),this._audioController.setSpeed(this._savedSpeed)),this._readerView.setBookTitle(this._currentBook.title),this._controls.setEnabled(!0),this._controls.setAskDisabled(!this._qaSettings.apiKey,"Configure API key in Q&A Settings to enable voice questions")}_initializeMediaSession(){if(!w.isSupported()){console.log("Media Session API not supported on this device");return}w.initialize({onPlay:()=>{this._play()},onPause:()=>{this._pause()},onEnterQAMode:()=>{this._qaSettings.apiKey?this._startQA():this._showToast("Q&A not available - configure API key in settings")},onExitQAMode:()=>{this._continueReadingFromQA()}}),console.log("Media Session initialized for headset controls")}_updateMediaSessionMetadata(){if(!this._currentBook)return;const e=this._currentBook.chapters[this._currentChapterIndex];w.updateMetadata({bookTitle:this._currentBook.title,chapterTitle:(e==null?void 0:e.title)||"",author:this._currentBook.author||""})}async _loadChapter(e,t=!0){if(!this._currentBook||e<0||e>=this._currentBook.chapters.length)return;console.time(`App._loadChapter[${e}]`),this._currentChapterIndex=e;const s=this._currentBook.chapters[e];this._readerView.setChapterTitle(s.title),this._readerView.showLoading();const i=await this._readingState.loadChapter(e);if(console.timeEnd(`App._loadChapter[${e}]`),i.length===0&&t){const n=this._currentBook.chapters[e].html;if(!(n&&(n.includes("<img")||n.includes("<svg")||n.includes("<image")||n.includes("<video")||n.includes("<canvas")))){if(console.log(`Chapter ${e} is empty, skipping to next...`),e<this._currentBook.chapters.length-1)return this._loadChapter(e+1,t);this._readerView.showError("No readable content found");return}}const o=this._currentBook.chapters[e].html||null;if(this._readerView.renderSentences(i,0,o),this._readerView.scrollToTop(),this._readingState){const n=this._readingState.getHighlightsForChapter(e);this._readerView.setHighlights(n)}this._audioController.setSentences(i,0),this._updateMediaSessionMetadata()}async _onChapterEnd(){if(this._currentChapterIndex<this._currentBook.chapters.length-1){const e=this._currentChapterIndex+1;this._readingState.goToChapter(e,0),await this._loadChapter(e),this._navigation.setCurrentChapter(e),this._play()}else console.log("End of book reached"),this._showToast("End of book reached")}async _play(){this._audioController&&(u.isReady()||(this._showTTSStatus("Initializing TTS..."),await u.initialize(),this._hideTTSStatus()),this._audioController.play())}_pause(){var e;(e=this._audioController)==null||e.pause()}_togglePlayPause(){var t;const e=(t=this._audioController)==null?void 0:t.getState();(e==null?void 0:e.status)==="playing"?this._pause():this._play()}_setupQASetup(){const{setupFreeModels:e,setupPaidModels:t,setupApiKey:s,setupModel:i,saveQaSetupBtn:o}=this._elements;e&&t&&(C.free.forEach(n=>{const a=document.createElement("option");a.value=n.id,a.textContent=n.name,e.appendChild(a)}),C.paid.forEach(n=>{const a=document.createElement("option");a.value=n.id,a.textContent=n.name,t.appendChild(a)}),i&&(i.value=x)),o==null||o.addEventListener("click",()=>{var r;const n=((r=s==null?void 0:s.value)==null?void 0:r.trim())||"",a=(i==null?void 0:i.value)||x;this._qaSettings.apiKey=n,this._qaSettings.model=a,k.setApiKey(n),k.setModel(a),this._saveQASettings(this._qaSettings),this._updateQASetupStatus(),this._showToast("Q&A settings saved")})}_updateQASetupStatus(){const{qaSetupStatus:e,setupApiKey:t,setupModel:s}=this._elements;e&&(this._qaSettings.apiKey?(e.textContent="Configured",e.classList.add("configured")):(e.textContent="Not configured",e.classList.remove("configured"))),t&&(t.value=this._qaSettings.apiKey||""),s&&(s.value=this._qaSettings.model||x)}async _startQA(){var e,t,s;if(!this._qaSettings.apiKey){this._showToast("Please configure Q&A settings first"),this._settingsModal.setSettings(this._qaSettings),this._settingsModal.show();return}this._wasPlayingBeforeQA=((t=(e=this._audioController)==null?void 0:e.getState())==null?void 0:t.status)==="playing",this._pause(),this._qaController||this._initializeQAController(),this._qaController.setContextSettings(this._qaSettings.contextBefore,this._qaSettings.contextAfter),this._qaController.setPlaybackSpeed(((s=this._controls)==null?void 0:s.getSpeed())||1),this._currentBook&&this._qaController.setBookMeta({title:this._currentBook.title,author:this._currentBook.author}),this._qaOverlay.reset(),this._qaOverlay.setHistory(this._qaController.getHistory()),this._qaOverlay.show(),w.setQAModeActive(!0),this._qaController.isSTTSupported()?this._qaController.startVoiceQA():(this._qaOverlay.setState(g.IDLE),this._qaOverlay.showTextInput())}_initializeQAController(){k.setApiKey(this._qaSettings.apiKey),k.setModel(this._qaSettings.model),this._qaController=new se({readingState:this._readingState,onStateChange:(e,t)=>{this._qaOverlay.setState(e,t),t!=null&&t.error&&e===g.IDLE&&(t.error.includes("permission")||t.error.includes("Microphone"))&&this._qaOverlay.showTextInput()},onTranscript:e=>{this._qaOverlay.setTranscript(e)},onResponse:e=>{this._qaOverlay.setResponse(e)},onSentenceSpoken:(e,t)=>{},onHistoryAdd:e=>{this._qaOverlay.addHistoryEntry(e)}})}_closeQAOverlay(){var e;(e=this._qaController)==null||e.stop(),this._qaOverlay.hide(),w.setQAModeActive(!1)}_continueReadingFromQA(){var e;(e=this._qaController)==null||e.stop(),this._qaOverlay.hide(),w.setQAModeActive(!1),this._wasPlayingBeforeQA&&this._play()}_askAnotherQuestion(){var e,t,s;(e=this._qaController)==null||e.stop(),this._qaOverlay.reset(),this._qaOverlay.setHistory(((t=this._qaController)==null?void 0:t.getHistory())||[]),(s=this._qaController)!=null&&s.isSTTSupported()?this._qaController.startVoiceQA():(this._qaOverlay.setState(g.IDLE),this._qaOverlay.showTextInput())}_submitTextQuestion(e){this._qaController||this._initializeQAController(),this._qaOverlay.hideTextInput(),this._qaController.startTextQA(e)}async _retryVoiceInput(){this._qaController||this._initializeQAController(),await this._qaController.requestMicPermission()?(this._qaOverlay.hideTextInput(),this._qaController.startVoiceQA()):this._showToast("Microphone permission denied")}async _onTTSBackendChange(e){this._showTTSStatus("Switching TTS backend..."),this._pause(),this._audioController&&this._audioController.clearBuffers();try{const t=this._settingsModal.getSettings();u.setFastApiUrl(t.fastApiUrl),await u.setBackend(e);const s=u.getBackend();if(s==="kokoro-fastapi")this._showTTSStatus("TTS ready (Kokoro FastAPI)");else if(s==="kokoro-js"){const i=u.getDevice(),o=u.getDtype();this._showTTSStatus(`TTS ready (${i}, ${o})`)}else this._showTTSStatus("TTS ready (Browser)");if(this._controls){const i=u.getAvailableVoices();this._controls.setVoices(i)}setTimeout(()=>this._hideTTSStatus(),3e3)}catch(t){console.error("Failed to switch TTS backend:",t),this._showTTSStatus("Backend switch failed"),setTimeout(()=>this._hideTTSStatus(),5e3)}}async _saveQASettings(e){this._qaSettings={...this._qaSettings,...e},k.setApiKey(this._qaSettings.apiKey),k.setModel(this._qaSettings.model),this._qaController&&this._qaController.setContextSettings(this._qaSettings.contextBefore,this._qaSettings.contextAfter);try{await m.saveSetting("qaApiKey",this._qaSettings.apiKey),await m.saveSetting("qaModel",this._qaSettings.model),await m.saveSetting("qaContextBefore",this._qaSettings.contextBefore),await m.saveSetting("qaContextAfter",this._qaSettings.contextAfter),e.ttsBackend&&await m.saveSetting("ttsBackend",e.ttsBackend),e.fastApiUrl&&await m.saveSetting("fastApiUrl",e.fastApiUrl)}catch(t){console.error("Failed to save settings:",t)}this._updateQASetupStatus(),this._settingsModal.setSettings(this._qaSettings),this._controls&&this._controls.setAskDisabled(!this._qaSettings.apiKey,"Configure API key in Q&A Settings to enable voice questions")}async runBenchmark(e=5){if(this._currentBook){const t=this._currentBook.chapters[this._currentChapterIndex],s=t.sentences.slice(0,e);return console.log(`Running benchmark on ${s.length} sentences from "${t.title}"...`),u.runBenchmark(s)}else{const t=["The quick brown fox jumps over the lazy dog.","She sells seashells by the seashore.","How much wood would a woodchuck chuck if a woodchuck could chuck wood?","Peter Piper picked a peck of pickled peppers.","The rain in Spain stays mainly in the plain.","To be or not to be, that is the question.","All that glitters is not gold.","A journey of a thousand miles begins with a single step."];return console.log("No book loaded, using test sentences..."),u.runBenchmark(t.slice(0,e))}}setBenchmarkMode(e){u.setBenchmarkEnabled(e),console.log(`Benchmark mode ${e?"enabled":"disabled"}`),e&&console.log("TTS timing will be logged for each sentence.")}getTTSInfo(){return{ready:u.isReady(),usingKokoro:u.isUsingKokoro(),backend:u.getBackend(),device:u.getDevice(),dtype:u.getDtype(),fastApiUrl:u.getFastApiUrl(),fastApiAvailable:u.isFastAPIAvailable(),averageRTF:u.getAverageRTF(),benchmarkResults:u.getBenchmarkResults()}}_showScreen(e){this._elements.uploadScreen.classList.remove("active"),this._elements.readerScreen.classList.remove("active"),e==="upload"?this._elements.uploadScreen.classList.add("active"):this._elements.readerScreen.classList.add("active")}_showUploadError(e){const t=this._elements.uploadScreen.querySelector(".error-message");t&&t.remove();const s=document.createElement("div");s.className="error-message",s.innerHTML=`
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>${e}</span>
        `,this._elements.uploadArea.insertAdjacentElement("afterend",s),setTimeout(()=>{s.remove()},5e3)}_showTTSStatus(e){const t=this._elements.ttsStatus;t.querySelector("p").textContent=e,t.classList.remove("hidden")}_hideTTSStatus(){this._elements.ttsStatus.classList.add("hidden")}async _navigateToPrevChapter(){!this._currentBook||this._currentChapterIndex<=0||await this._navigateToChapter(this._currentChapterIndex-1)}async _navigateToNextChapter(){!this._currentBook||this._currentChapterIndex>=this._currentBook.chapters.length-1||await this._navigateToChapter(this._currentChapterIndex+1)}async _navigateToChapter(e){e!==this._currentChapterIndex&&(this._pause(),this._readingState.goToChapter(e,0),await this._loadChapter(e,!1),this._navigation.setCurrentChapter(e),this._audioController.goToSentence(0),this._readerView.highlightSentence(0))}async _navigateToBookmark(e){this._pause(),this._readingState.goToBookmark(e),e.chapterIndex!==this._currentChapterIndex&&(await this._loadChapter(e.chapterIndex,!1),this._navigation.setCurrentChapter(e.chapterIndex)),this._audioController.goToSentence(e.sentenceIndex),this._readerView.highlightSentence(e.sentenceIndex)}async _handleInternalLink(e){if(!this._currentBook)return;const t=e.indexOf("#"),s=t>=0?e.substring(0,t):e,i=t>=0?e.substring(t+1):"";if(!s&&i){this._readerView.scrollToFragment(i);return}const o=s.split("/").pop(),n=this._currentBook.chapters.findIndex(a=>a.href.split("/").pop().split("#")[0]===o);if(n===-1){console.warn("Could not find chapter for internal link:",e);return}n!==this._currentChapterIndex&&(this._pause(),this._readingState.goToChapter(n,0),await this._loadChapter(n,!1),this._navigation.setCurrentChapter(n),this._audioController.goToSentence(0),this._readerView.highlightSentence(0)),i&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{this._readerView.scrollToFragment(i)})})})}async _addBookmark(){if(this._readingState)try{const e=prompt("Add a note (optional):");if(e===null)return;await this._readingState.addBookmark(e),this._showToast("Bookmark added"),this._navigation.setBookmarks(this._readingState.getBookmarks())}catch(e){console.error("Failed to add bookmark:",e),this._showToast("Failed to add bookmark")}}async _deleteBookmark(e){try{await this._readingState.deleteBookmark(e),this._showToast("Bookmark deleted"),this._navigation.setBookmarks(this._readingState.getBookmarks())}catch(t){console.error("Failed to delete bookmark:",t)}}async _addHighlight(e,t,s,i){if(this._readingState)try{await this._readingState.addHighlight(this._currentChapterIndex,e,t,s,"",i),this._showToast("Highlight added"),this._saveCookieState()}catch(o){console.error("Failed to add highlight:",o),this._showToast("Failed to add highlight")}}async _deleteHighlight(e){try{if(await this._readingState.deleteHighlight(e),this._showToast("Highlight deleted"),this._readerView&&this._readingState){const t=this._readingState.getHighlightsForChapter(this._currentChapterIndex);this._readerView.setHighlights(t)}this._saveCookieState()}catch(t){console.error("Failed to delete highlight:",t)}}async _navigateToHighlight(e){this._pause(),e.chapterIndex!==this._currentChapterIndex&&(this._readingState.goToChapter(e.chapterIndex,e.startSentenceIndex),await this._loadChapter(e.chapterIndex,!1),this._navigation.setCurrentChapter(e.chapterIndex)),this._audioController.goToSentence(e.startSentenceIndex),this._readerView.highlightSentence(e.startSentenceIndex)}_onPositionChange(e,t){this._saveCookieState()}_onBookmarksChange(){this._navigation&&this._readingState&&this._navigation.setBookmarks(this._readingState.getBookmarks()),this._saveCookieState()}_onHighlightsChange(){this._navigation&&this._readingState&&this._navigation.setHighlights(this._readingState.getHighlights())}async _loadSettings(){var e;try{const t=await m.getSetting("playbackSpeed");t!==null&&(this._savedSpeed=t);const s=await m.getSetting("voice");s!==null&&(this._savedVoice=s);const i=await m.getSetting("qaApiKey");i!==null&&(this._qaSettings.apiKey=i,k.setApiKey(i));const o=await m.getSetting("qaModel");o!==null&&(this._qaSettings.model=o,k.setModel(o));const n=await m.getSetting("qaContextBefore");n!==null&&(this._qaSettings.contextBefore=n);const a=await m.getSetting("qaContextAfter");a!==null&&(this._qaSettings.contextAfter=a),this._updateQASetupStatus(),(e=this._settingsModal)==null||e.setSettings(this._qaSettings)}catch(t){console.error("Failed to load settings:",t)}}async _saveSettings(){try{if(this._controls){const e=this._controls.getSpeed();await m.saveSetting("playbackSpeed",e);const t=this._controls.getVoice();await m.saveSetting("voice",t)}}catch(e){console.error("Failed to save settings:",e)}}_saveCookieState(){if(!this._currentBook||!this._readingState)return;const e=this._readingState.getCurrentPosition(),t={bookId:this._currentBook.id,bookTitle:this._currentBook.title,chapterIndex:e.chapterIndex,sentenceIndex:e.sentenceIndex,bookmarkCount:this._readingState.getBookmarks().length,highlightCount:this._readingState.getHighlights().length,source:this._currentBook.source||null,timestamp:Date.now()};try{const s=JSON.stringify(t),i=new Date(Date.now()+365*24*60*60*1e3).toUTCString();document.cookie=`readingPartnerState=${encodeURIComponent(s)};expires=${i};path=/;SameSite=Lax`}catch(s){console.error("Failed to save cookie state:",s)}}_loadCookieState(){try{const e=document.cookie.split(";");for(const t of e){const[s,i]=t.trim().split("=");if(s==="readingPartnerState"&&i)return JSON.parse(decodeURIComponent(i))}}catch(e){console.error("Failed to load cookie state:",e)}return null}_checkResumeState(){var h,d;const e=this._loadCookieState();if(!e||!e.bookId)return;const t=(h=this._elements.uploadScreen)==null?void 0:h.querySelector(".upload-container");if(!t)return;const s=t.querySelector(".resume-banner");s&&s.remove();const i=document.createElement("div");i.className="resume-banner";const o=this._formatTimeAgo(e.timestamp),n=[];e.bookmarkCount>0&&n.push(`${e.bookmarkCount} bookmark${e.bookmarkCount>1?"s":""}`),e.highlightCount>0&&n.push(`${e.highlightCount} highlight${e.highlightCount>1?"s":""}`);const a=n.length>0?` (${n.join(", ")})`:"";let r="";((d=e.source)==null?void 0:d.type)==="gutenberg"&&(r=' <span class="resume-source">from Project Gutenberg</span>'),i.innerHTML=`
            <div class="resume-info">
                <div class="resume-title">Continue reading</div>
                <div class="resume-detail">"${this._escapeHtml(e.bookTitle)}"${r} - Chapter ${e.chapterIndex+1}${a}</div>
                <div class="resume-time">Last read ${o}</div>
            </div>
            <button class="btn btn-primary btn-sm resume-btn">Resume</button>
        `,i.querySelector(".resume-btn").addEventListener("click",()=>{this._resumeLastBook(e.bookId)});const c=t.querySelector(".upload-area");c?t.insertBefore(i,c):t.appendChild(i)}async _resumeLastBook(e){const{loadingIndicator:t,loadingText:s}=this._elements;try{if(t.classList.remove("hidden"),s.textContent="Resuming book...",this._currentBook=await this._readingState.openBook(e),!this._currentBook.chapters.length)throw new Error("No readable content found");s.textContent="Preparing reader...",this._controls?(this._readerView.setBookTitle(this._currentBook.title),this._controls.setEnabled(!0),this._controls.setAskDisabled(!this._qaSettings.apiKey,"Configure API key in Q&A Settings to enable voice questions")):this._initializeReader();const i=this._readingState.getCurrentPosition();await this._loadChapter(i.chapterIndex,!1),this._navigation.setBook(this._currentBook,i.chapterIndex),this._navigation.setBookmarks(this._readingState.getBookmarks()),this._navigation.setHighlights(this._readingState.getHighlights()),i.sentenceIndex>0&&(this._audioController.goToSentence(i.sentenceIndex),this._readerView.highlightSentence(i.sentenceIndex)),this._showScreen("reader")}catch(i){console.error("Failed to resume book:",i),this._showUploadError("Could not resume: "+i.message+". Please load the EPUB file again.")}finally{t.classList.add("hidden")}}_formatTimeAgo(e){const t=Math.floor((Date.now()-e)/1e3);if(t<60)return"just now";const s=Math.floor(t/60);if(s<60)return`${s} minute${s>1?"s":""} ago`;const i=Math.floor(s/60);if(i<24)return`${i} hour${i>1?"s":""} ago`;const o=Math.floor(i/24);if(o<30)return`${o} day${o>1?"s":""} ago`;const n=Math.floor(o/30);return`${n} month${n>1?"s":""} ago`}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}_showToast(e){const t=document.createElement("div");t.className="toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.remove()},300)},2e3)}}document.addEventListener("DOMContentLoaded",()=>{const _=new de;_.init(),window.readingPartner=_,window.ttsEngine=u});
