(function(){"use strict";let r=null,o=!1,a=0;const d=20;async function p(){if(typeof navigator>"u"||!navigator.gpu)return!1;try{return await navigator.gpu.requestAdapter()!==null}catch{return!1}}async function f(t){return t==="webgpu"?"webgpu":t==="wasm"?"wasm":await p()?"webgpu":"wasm"}async function u(t){if(o)return;o=!0;const{model:e="onnx-community/whisper-tiny.en",device:n="auto",dtype:w=null}=t;try{self.postMessage({type:"loading",progress:{status:"Loading transformers.js library..."}});const{pipeline:i,env:m}=await import("https://cdn.jsdelivr.net/npm/@huggingface/transformers@3");m.allowLocalModels=!1;const l=await f(n);self.postMessage({type:"loading",progress:{status:`Loading Whisper model (${l})...`}});const c=w||{encoder_model:"fp32",decoder_model_merged:"q4"};r=await i("automatic-speech-recognition",e,{device:l,dtype:c,progress_callback:s=>{s.status==="progress"&&self.postMessage({type:"loading",progress:{status:`Downloading ${s.file}`,file:s.file,loaded:s.loaded,total:s.total,progress:s.progress}})}}),a=0,o=!1,self.postMessage({type:"ready",info:{model:e,device:l,dtype:c}})}catch(i){o=!1,self.postMessage({type:"error",error:i.message})}}async function g(t){if(!r){self.postMessage({type:"error",error:"Model not loaded"});return}try{self.postMessage({type:"transcribing"});const e=await r(t,{chunk_length_s:30,stride_length_s:5,return_timestamps:!1});a++,self.postMessage({type:"result",text:e.text.trim()}),a>=d&&(console.log(`[whisper-worker] Reinitializing after ${a} inferences (memory leak workaround)`),self.postMessage({type:"reinit_recommended"}))}catch(e){self.postMessage({type:"error",error:e.message})}}function y(){r=null,a=0,self.postMessage({type:"unloaded"})}self.onmessage=async t=>{const{type:e,...n}=t.data;switch(e){case"load":await u(n);break;case"transcribe":await g(n.audio);break;case"unload":y();break;default:console.warn(`[whisper-worker] Unknown message type: ${e}`)}}})();
