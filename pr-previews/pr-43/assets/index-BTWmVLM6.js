var Lt=Object.defineProperty;var Et=(c,e,t)=>e in c?Lt(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var T=(c,e,t)=>Et(c,typeof e!="symbol"?e+"":e,t);import*as rt from"https://cdn.jsdelivr.net/npm/pdfjs-dist@4.9.155/build/pdf.min.mjs";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();rt.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.9.155/build/pdf.worker.min.mjs";window.pdfjsLib=rt;const Pt="modulepreload",Bt=function(c){return"/reading-partner/pr-previews/pr-43/"+c},Ve={},ye=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){let o=function(l){return Promise.all(l.map(h=>Promise.resolve(h).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=o(t.map(l=>{if(l=Bt(l),l in Ve)return;Ve[l]=!0;const h=l.endsWith(".css"),d=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const p=document.createElement("link");if(p.rel=h?"stylesheet":Pt,h||(p.as="script"),p.crossOrigin="",p.href=l,a&&p.setAttribute("nonce",a),document.head.appendChild(p),h)return new Promise((u,g)=>{p.addEventListener("load",u),p.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${l}`)))})}))}function n(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return i.then(o=>{for(const r of o||[])r.status==="rejected"&&n(r.reason);return e().catch(n)})};class ee{async loadFromFile(e){throw new Error("loadFromFile() must be implemented by subclass")}async initFromStoredData(e){throw new Error("initFromStoredData() must be implemented by subclass")}async loadChapter(e,t){throw new Error("loadChapter() must be implemented by subclass")}getChapterHtml(e,t){return t<0||t>=e.chapters.length?null:e.chapters[t].html||null}getChapterSentences(e,t){return t<0||t>=e.chapters.length?[]:e.chapters[t].sentences||[]}destroy(){}}function At(c,e="en"){if(!c||typeof c!="string")return[];if(c=c.replace(/([.!?:;])([A-Z])/g,"$1 $2"),c=c.replace(/([a-z]):([a-z])/gi,"$1: $2"),c=c.replace(/\s+/g," ").trim(),!c)return[];if("Segmenter"in Intl)try{const{processed:t,restore:s}=qt(c);return[...new Intl.Segmenter(e,{granularity:"sentence"}).segment(t)].map(o=>s(o.segment).trim()).filter(o=>o.length>0)}catch(t){console.warn("Intl.Segmenter failed, using fallback:",t)}return Mt(c)}const It=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","vs","etc","approx","dept","est","govt","Inc","Ltd","Corp","Co","St","Ave","Blvd","Rd","Mt","Ft","Gen","Gov","Sgt","Cpl","Pvt","Capt","Lt","Col","Maj","Rev","Hon","Pres","Dept","Assn","Bros","No","Vol","Jan","Feb","Mar","Apr","Jun","Jul","Aug","Sep","Sept","Oct","Nov","Dec"],G="";function qt(c){let e=c;for(const s of It){const i=new RegExp(`\\b${s}\\.`,"g");e=e.replace(i,`${s}${G}`)}return e=e.replace(/\be\.g\./gi,`e${G}g${G}`),e=e.replace(/\bi\.e\./gi,`i${G}e${G}`),{processed:e,restore:s=>s.replace(new RegExp(G,"g"),".")}}function Mt(c){const e=["Mr","Mrs","Ms","Dr","Prof","Sr","Jr","vs","etc","e.g","i.e","Inc","Ltd","Corp","St","Ave","Blvd","Rd","Mt","Ft","Jan","Feb","Mar","Apr","Jun","Jul","Aug","Sep","Oct","Nov","Dec","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];let t=c;const s=[];e.forEach((l,h)=>{const d=new RegExp(`\\b${l}\\.`,"g"),p=`__ABBR${h}__`;t=t.replace(d,`${l}${p}`),s.push({placeholder:p,replacement:"."})});const i=/([.!?]+)(?:\s+|$)/g,n=[];let o=0,r;for(;(r=i.exec(t))!==null;){const l=t.slice(o,r.index+r[1].length);l.trim()&&n.push(l.trim()),o=r.index+r[0].length}const a=t.slice(o).trim();return a&&n.push(a),n.map(l=>{let h=l;return s.forEach(({placeholder:d,replacement:p})=>{h=h.replace(new RegExp(d,"g"),p)}),h})}function zt(c,e=500){if(!c||c.length<=e)return[c];const t=[];let s=c;for(;s.length>e;){let i=-1;const n=Math.min(e,s.length),o=Math.floor(n*.7),r=[{char:";",offset:1},{char:",",offset:1},{char:" - ",offset:3},{char:" — ",offset:3},{char:" ",offset:1}];for(const{char:a,offset:l}of r)if(i=s.lastIndexOf(a,n),i>=o){i+=l;break}i<o&&(i=e),t.push(s.substring(0,i).trim()),s=s.substring(i).trim()}return s.length>0&&t.push(s),t}const at=new Set(["ADDRESS","ARTICLE","ASIDE","BLOCKQUOTE","DD","DETAILS","DIALOG","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","LI","MAIN","NAV","OL","P","PRE","SECTION","TABLE","TBODY","TD","TFOOT","TH","THEAD","TR","UL"]),ke=new Set(["SCRIPT","STYLE","CODE","PRE","TEXTAREA"]);function X(c){return c.tagName.toUpperCase()}function Rt(c){for(const e of c.children)if(at.has(X(e)))return!0;return!1}function We(c){const e=[],t=document.createTreeWalker(c,NodeFilter.SHOW_TEXT,{acceptNode(s){let i=s.parentNode;for(;i&&i!==c;){if(ke.has(X(i)))return NodeFilter.FILTER_REJECT;i=i.parentNode}return NodeFilter.FILTER_ACCEPT}});for(;t.nextNode();)e.push(t.currentNode);return e}function Ht(c,e,t){const s=c.indexOf(e,t);if(s!==-1)return{start:s,end:s+e.length};const n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\\?\s+/g,"\\s+"),r=new RegExp(n).exec(c.substring(t));return r?{start:t+r.index,end:t+r.index+r[0].length}:null}function Ke(c){const e=[];let t=0;for(const s of c){const i=s.textContent.length;e.push({node:s,start:t,end:t+i}),t+=i}return e}function me(c,e){const t=We(c);if(t.length===0)return;const s=Ke(t),i=s.map(d=>d.node.textContent).join("");if(!i.trim())return;const n=At(i);if(n.length===0)return;const o=[];let r=0;for(const d of n){const p=d.trim();if(!p)continue;const u=Ht(i,p,r);u&&(o.push({start:u.start,end:u.end,text:p,index:e.length}),e.push(p),r=u.end)}if(o.length===0)return;const a=new Set;for(const d of o)a.add(d.start),a.add(d.end);for(let d=s.length-1;d>=0;d--){const{node:p,start:u,end:g}=s[d],m=[];for(const v of a){const S=v-u;S>0&&S<g-u&&m.push(S)}if(m.length!==0){m.sort((v,S)=>S-v);for(const v of m)p.splitText(v)}}const l=We(c),h=Ke(l);for(const{node:d,start:p,end:u}of h){let g=null;for(const v of o)if(p>=v.start&&u<=v.end){g=v;break}if(!g)continue;const m=document.createElement("span");m.className="sentence",m.dataset.index=g.index.toString(),d.parentNode.insertBefore(m,d),m.appendChild(d)}}function W(c,e){if(!ke.has(X(c))){if(!Rt(c))me(c,e);else for(const t of Array.from(c.childNodes))if(t.nodeType===Node.ELEMENT_NODE){if(ke.has(X(t)))continue;at.has(X(t))?W(t,e):me(t,e)}else if(t.nodeType===Node.TEXT_NODE&&t.textContent.trim()){const s=document.createElement("span");for(t.parentNode.insertBefore(s,t),s.appendChild(t),me(s,e);s.firstChild;)s.parentNode.insertBefore(s.firstChild,s);s.remove()}}}async function te(c){const t=new TextEncoder().encode(c),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(n=>n.toString(16).padStart(2,"0")).join("").slice(0,16)}function lt(c,e){let t;return function(...s){clearTimeout(t),t=setTimeout(()=>c.apply(this,s),e)}}class ct extends ee{constructor(){super(),this._book=null}async loadFromFile(e){if(console.time("EPUBParser.loadFromFile"),!e.name.toLowerCase().endsWith(".epub"))throw new Error("Invalid file type. Please select an EPUB file.");console.time("EPUBParser.readFile");const t=await e.arrayBuffer();console.timeEnd("EPUBParser.readFile");const s=e.name+e.size+e.lastModified,i=await te(s);console.time("EPUBParser.initBook"),this._book=ePub(t),await this._book.ready,console.timeEnd("EPUBParser.initBook");const n=await this._extractMetadata();console.time("EPUBParser.getChapterMetadata");const o=await this._getChapterMetadata();console.timeEnd("EPUBParser.getChapterMetadata");const r=await this._extractCover();return console.timeEnd("EPUBParser.loadFromFile"),console.log(`Book loaded: ${o.length} chapters (content will be loaded on-demand)`),{id:i,title:n.title||e.name.replace(".epub",""),author:n.author||"Unknown Author",coverImage:r,chapters:o,fileData:t,fileType:"epub",lastOpened:Date.now()}}async initFromStoredData(e){this._book&&this._book.destroy(),this._book=ePub(e),await this._book.ready,console.log("EPUBParser reinitialized from stored data")}async _extractMetadata(){const e=this._book.package.metadata;return{title:e.title||"",author:e.creator||""}}async _extractCover(){try{if(this._book.cover){const e=await this._book.archive.getBlob(this._book.cover).catch(()=>null);if(e&&e.size>0)return this._ensureBlobMimeType(e,this._book.cover)}}catch{}try{const e=await this._book.coverUrl();if(e){const t=await fetch(e);if(t.ok)return await t.blob()}}catch(e){console.warn("Could not extract cover:",e)}return null}async _getChapterMetadata(){var n;const e=this._book.spine,t=((n=this._book.navigation)==null?void 0:n.toc)||[],s=[],i=new Map;this._flattenToc(t,i);for(let o=0;o<e.items.length;o++){const r=e.items[o],a=i.get(r.href)||i.get(r.href.split("#")[0])||`Chapter ${o+1}`;s.push({id:r.idref||`chapter-${o}`,title:a,href:r.href,sentences:null,html:null,loaded:!1})}return s}async loadChapter(e,t){var i,n;if(t<0||t>=e.chapters.length)return[];const s=e.chapters[t];if(s.loaded&&s.sentences)return console.log(`Chapter ${t} already loaded (${s.sentences.length} sentences)`),s.sentences;console.time(`EPUBParser.loadChapter[${t}]`),console.log(`Loading chapter ${t}: "${s.title}"`);try{const o=await this._book.load(s.href);console.log("Loaded doc type:",typeof o,o),console.log("Doc has body:",!!(o!=null&&o.body)),o!=null&&o.body&&(console.log("Body innerHTML length:",(i=o.body.innerHTML)==null?void 0:i.length),console.log("Body textContent length:",(n=o.body.textContent)==null?void 0:n.length));const{html:r,sentences:a}=await this._processHtmlWithSentences(o,s.href);return console.log(`Processed HTML length: ${r.length}, sentences: ${a.length}`),a.length===0?(console.warn("Chapter has no text content"),s.sentences=[],s.html=r||'<div class="epub-content"></div>',s.loaded=!0,console.timeEnd(`EPUBParser.loadChapter[${t}]`),[]):(s.sentences=a,s.html=r,s.loaded=!0,console.timeEnd(`EPUBParser.loadChapter[${t}]`),console.log(`Chapter ${t} loaded: ${a.length} sentences`),a)}catch(o){return console.error(`Failed to load chapter ${t}:`,o),s.sentences=[],s.html='<div class="epub-content"></div>',s.loaded=!0,[]}}async _processHtmlWithSentences(e,t){let s=this._getBodyElement(e);if(!s)return{html:'<div class="epub-content"></div>',sentences:[]};s=s.cloneNode(!0);const i=["script","style","nav","aside",'[role="navigation"]','[role="banner"]',".pagebreak",".page-break"];s.querySelectorAll(i.join(",")).forEach(r=>r.remove()),await this._fixImageSources(s,t);const n=[];W(s,n);const o=document.createElement("div");return o.className="epub-content",o.innerHTML=s.innerHTML,{html:o.outerHTML,sentences:n}}_getBodyElement(e){return e?typeof e=="string"?new DOMParser().parseFromString(e,"text/html").body:e.body?e.body:e.nodeType===Node.ELEMENT_NODE?e:e.documentElement?e.documentElement:null:null}async _fixImageSources(e,t){const s=[];e.querySelectorAll("img").forEach(o=>{const r=o.getAttribute("src");if(r&&!r.startsWith("data:")&&!r.startsWith("blob:")&&!r.startsWith("http")){const a=this._loadImageBlob(r,t).then(l=>{l&&(o.src=URL.createObjectURL(l))}).catch(l=>{console.warn("Failed to load image:",r,l)});s.push(a)}}),e.querySelectorAll("image").forEach(o=>{const r=o.getAttribute("href")||o.getAttribute("xlink:href")||o.getAttributeNS("http://www.w3.org/1999/xlink","href");if(r&&!r.startsWith("data:")&&!r.startsWith("blob:")&&!r.startsWith("http")){const a=this._loadImageBlob(r,t).then(l=>{if(l){const h=URL.createObjectURL(l);o.setAttribute("href",h),o.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",h)}}).catch(l=>{console.warn("Failed to load SVG image:",r,l)});s.push(a)}}),s.length>0&&(console.log(`Loading ${s.length} images...`),await Promise.all(s),console.log("All images loaded"))}async _loadImageBlob(e,t){var s,i;try{const o=(((i=(s=this._book)==null?void 0:s.path)==null?void 0:i.directory)||"/")+t,r=this._resolveToArchivePath(e,o);if(r){const a=await this._book.archive.getBlob(r).catch(()=>null);if(a&&a.size>0)return this._ensureBlobMimeType(a,e)}}catch{}try{const n=this._resolveToArchivePath(e,t);if(n){const o=await this._book.archive.getBlob(n).catch(()=>null);if(o&&o.size>0)return this._ensureBlobMimeType(o,e)}}catch{}try{const n=e.startsWith("/")?e:"/"+e,o=await this._book.archive.getBlob(n).catch(()=>null);if(o&&o.size>0)return this._ensureBlobMimeType(o,e)}catch{}try{const n=this._book.resolve(e,!1);if(n){const o=await this._book.archive.getBlob(n).catch(()=>null);if(o&&o.size>0)return this._ensureBlobMimeType(o,e)}}catch{}return console.warn("All image loading strategies failed for:",e),null}_resolveToArchivePath(e,t){if(!t)return null;const s=t.lastIndexOf("/"),i=s>=0?t.substring(0,s):"",o=(i?i+"/"+e:e).split("/"),r=[];for(const a of o)a===".."&&r.length>0&&r[r.length-1]!==""?r.pop():a!=="."&&a!==""&&r.push(a);return"/"+r.join("/")}_ensureBlobMimeType(e,t){var o;if(e.type&&e.type.startsWith("image/"))return e;const s=(o=t.split(".").pop())==null?void 0:o.toLowerCase().split("?")[0],n={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp",bmp:"image/bmp",tif:"image/tiff",tiff:"image/tiff",avif:"image/avif",jxl:"image/jxl"}[s];return n?new Blob([e],{type:n}):e}getChapterHtml(e,t){return t<0||t>=e.chapters.length?null:e.chapters[t].html||null}_flattenToc(e,t){var s,i;for(const n of e){if(n.href){t.set(n.href,((s=n.label)==null?void 0:s.trim())||"");const o=n.href.split("#")[0];t.has(o)||t.set(o,((i=n.label)==null?void 0:i.trim())||"")}n.subitems&&n.subitems.length>0&&this._flattenToc(n.subitems,t)}}_extractText(e){let t;if(!e)return console.warn("_extractText: doc is null/undefined"),"";if(typeof e=="string")console.log("_extractText: doc is a string, parsing as HTML"),t=new DOMParser().parseFromString(e,"text/html").body;else if(e.body)t=e.body.cloneNode(!0);else if(e.nodeType===Node.ELEMENT_NODE)console.log("_extractText: doc is an Element"),t=e.cloneNode(!0);else if(e.documentElement)console.log("_extractText: doc has documentElement"),t=e.documentElement.cloneNode(!0);else return console.warn("_extractText: unknown doc type",typeof e,e),"";if(!t)return console.warn("_extractText: could not get body"),"";const s=["script","style","nav","aside",'[role="navigation"]','[role="banner"]',".pagebreak",".page-break"];t.querySelectorAll(s.join(",")).forEach(o=>o.remove());let i="";const n=t.querySelectorAll("p, h1, h2, h3, h4, h5, h6, div, li, blockquote, span");if(console.log(`Found ${n.length} block elements`),n.length>0){const o=new Set;n.forEach(r=>{var l;if(o.has(r))return;r.querySelectorAll("p, div, span").forEach(h=>o.add(h));const a=(l=r.textContent)==null?void 0:l.trim();a&&(i+=a+`

`)})}return i.trim()||(console.log("No text from block elements, using body.textContent"),i=t.textContent||""),i=i.replace(/[\t ]+/g," ").replace(/\n{3,}/g,`

`).replace(/^\s+|\s+$/gm,"").trim(),i}getChapterSentences(e,t){return t<0||t>=e.chapters.length?[]:e.chapters[t].sentences||[]}destroy(){this._book&&(this._book.destroy(),this._book=null)}}new ct;function Ee(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var O=Ee();function ht(c){O=c}var J={exec:()=>null};function C(c,e=""){let t=typeof c=="string"?c:c.source,s={replace:(i,n)=>{let o=typeof n=="string"?n:n.source;return o=o.replace(P.caret,"$1"),t=t.replace(i,o),s},getRegex:()=>new RegExp(t,e)};return s}var $t=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),P={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:c=>new RegExp(`^( {0,3}${c})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:c=>new RegExp(`^ {0,${Math.min(3,c-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:c=>new RegExp(`^ {0,${Math.min(3,c-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:c=>new RegExp(`^ {0,${Math.min(3,c-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:c=>new RegExp(`^ {0,${Math.min(3,c-1)}}#`),htmlBeginRegex:c=>new RegExp(`^ {0,${Math.min(3,c-1)}}<(?:[a-z].*>|!--)`,"i")},Dt=/^(?:[ \t]*(?:\n|$))+/,Nt=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Ft=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,se=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,Ot=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Pe=/(?:[*+-]|\d{1,9}[.)])/,dt=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,ut=C(dt).replace(/bull/g,Pe).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),Qt=C(dt).replace(/bull/g,Pe).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Be=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Gt=/^[^\n]+/,Ae=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,Ut=C(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Ae).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),Vt=C(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Pe).getRegex(),ue="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Ie=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Wt=C("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Ie).replace("tag",ue).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),pt=C(Be).replace("hr",se).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",ue).getRegex(),Kt=C(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",pt).getRegex(),qe={blockquote:Kt,code:Nt,def:Ut,fences:Ft,heading:Ot,hr:se,html:Wt,lheading:ut,list:Vt,newline:Dt,paragraph:pt,table:J,text:Gt},je=C("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",se).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",ue).getRegex(),jt={...qe,lheading:Qt,table:je,paragraph:C(Be).replace("hr",se).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",je).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",ue).getRegex()},Yt={...qe,html:C(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Ie).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:J,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:C(Be).replace("hr",se).replace("heading",` *#{1,6} *[^
]`).replace("lheading",ut).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},Xt=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,Jt=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,gt=/^( {2,}|\\)\n(?!\s*$)/,Zt=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,pe=/[\p{P}\p{S}]/u,Me=/[\s\p{P}\p{S}]/u,_t=/[^\s\p{P}\p{S}]/u,es=C(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,Me).getRegex(),mt=/(?!~)[\p{P}\p{S}]/u,ts=/(?!~)[\s\p{P}\p{S}]/u,ss=/(?:[^\s\p{P}\p{S}]|~)/u,is=C(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",$t?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),ft=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,ns=C(ft,"u").replace(/punct/g,pe).getRegex(),os=C(ft,"u").replace(/punct/g,mt).getRegex(),vt="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",rs=C(vt,"gu").replace(/notPunctSpace/g,_t).replace(/punctSpace/g,Me).replace(/punct/g,pe).getRegex(),as=C(vt,"gu").replace(/notPunctSpace/g,ss).replace(/punctSpace/g,ts).replace(/punct/g,mt).getRegex(),ls=C("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,_t).replace(/punctSpace/g,Me).replace(/punct/g,pe).getRegex(),cs=C(/\\(punct)/,"gu").replace(/punct/g,pe).getRegex(),hs=C(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),ds=C(Ie).replace("(?:-->|$)","-->").getRegex(),us=C("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",ds).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),le=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,ps=C(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",le).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),bt=C(/^!?\[(label)\]\[(ref)\]/).replace("label",le).replace("ref",Ae).getRegex(),yt=C(/^!?\[(ref)\](?:\[\])?/).replace("ref",Ae).getRegex(),gs=C("reflink|nolink(?!\\()","g").replace("reflink",bt).replace("nolink",yt).getRegex(),Ye=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,ze={_backpedal:J,anyPunctuation:cs,autolink:hs,blockSkip:is,br:gt,code:Jt,del:J,emStrongLDelim:ns,emStrongRDelimAst:rs,emStrongRDelimUnd:ls,escape:Xt,link:ps,nolink:yt,punctuation:es,reflink:bt,reflinkSearch:gs,tag:us,text:Zt,url:J},_s={...ze,link:C(/^!?\[(label)\]\((.*?)\)/).replace("label",le).getRegex(),reflink:C(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",le).getRegex()},Se={...ze,emStrongRDelimAst:as,emStrongLDelim:os,url:C(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",Ye).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:C(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",Ye).getRegex()},ms={...Se,br:C(gt).replace("{2,}","*").getRegex(),text:C(Se.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},re={normal:qe,gfm:jt,pedantic:Yt},K={normal:ze,gfm:Se,breaks:ms,pedantic:_s},fs={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Xe=c=>fs[c];function R(c,e){if(e){if(P.escapeTest.test(c))return c.replace(P.escapeReplace,Xe)}else if(P.escapeTestNoEncode.test(c))return c.replace(P.escapeReplaceNoEncode,Xe);return c}function Je(c){try{c=encodeURI(c).replace(P.percentDecode,"%")}catch{return null}return c}function Ze(c,e){var n;let t=c.replace(P.findPipe,(o,r,a)=>{let l=!1,h=r;for(;--h>=0&&a[h]==="\\";)l=!l;return l?"|":" |"}),s=t.split(P.splitPipe),i=0;if(s[0].trim()||s.shift(),s.length>0&&!((n=s.at(-1))!=null&&n.trim())&&s.pop(),e)if(s.length>e)s.splice(e);else for(;s.length<e;)s.push("");for(;i<s.length;i++)s[i]=s[i].trim().replace(P.slashPipe,"|");return s}function j(c,e,t){let s=c.length;if(s===0)return"";let i=0;for(;i<s&&c.charAt(s-i-1)===e;)i++;return c.slice(0,s-i)}function vs(c,e){if(c.indexOf(e[1])===-1)return-1;let t=0;for(let s=0;s<c.length;s++)if(c[s]==="\\")s++;else if(c[s]===e[0])t++;else if(c[s]===e[1]&&(t--,t<0))return s;return t>0?-2:-1}function et(c,e,t,s,i){let n=e.href,o=e.title||null,r=c[1].replace(i.other.outputLinkReplace,"$1");s.state.inLink=!0;let a={type:c[0].charAt(0)==="!"?"image":"link",raw:t,href:n,title:o,text:r,tokens:s.inlineTokens(r)};return s.state.inLink=!1,a}function bs(c,e,t){let s=c.match(t.other.indentCodeCompensation);if(s===null)return e;let i=s[1];return e.split(`
`).map(n=>{let o=n.match(t.other.beginningSpace);if(o===null)return n;let[r]=o;return r.length>=i.length?n.slice(i.length):n}).join(`
`)}var ce=class{constructor(c){T(this,"options");T(this,"rules");T(this,"lexer");this.options=c||O}space(c){let e=this.rules.block.newline.exec(c);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(c){let e=this.rules.block.code.exec(c);if(e){let t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:j(t,`
`)}}}fences(c){let e=this.rules.block.fences.exec(c);if(e){let t=e[0],s=bs(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:s}}}heading(c){let e=this.rules.block.heading.exec(c);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){let s=j(t,"#");(this.options.pedantic||!s||this.rules.other.endingSpaceChar.test(s))&&(t=s.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(c){let e=this.rules.block.hr.exec(c);if(e)return{type:"hr",raw:j(e[0],`
`)}}blockquote(c){let e=this.rules.block.blockquote.exec(c);if(e){let t=j(e[0],`
`).split(`
`),s="",i="",n=[];for(;t.length>0;){let o=!1,r=[],a;for(a=0;a<t.length;a++)if(this.rules.other.blockquoteStart.test(t[a]))r.push(t[a]),o=!0;else if(!o)r.push(t[a]);else break;t=t.slice(a);let l=r.join(`
`),h=l.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");s=s?`${s}
${l}`:l,i=i?`${i}
${h}`:h;let d=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(h,n,!0),this.lexer.state.top=d,t.length===0)break;let p=n.at(-1);if((p==null?void 0:p.type)==="code")break;if((p==null?void 0:p.type)==="blockquote"){let u=p,g=u.raw+`
`+t.join(`
`),m=this.blockquote(g);n[n.length-1]=m,s=s.substring(0,s.length-u.raw.length)+m.raw,i=i.substring(0,i.length-u.text.length)+m.text;break}else if((p==null?void 0:p.type)==="list"){let u=p,g=u.raw+`
`+t.join(`
`),m=this.list(g);n[n.length-1]=m,s=s.substring(0,s.length-p.raw.length)+m.raw,i=i.substring(0,i.length-u.raw.length)+m.raw,t=g.substring(n.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:s,tokens:n,text:i}}}list(c){var t,s;let e=this.rules.block.list.exec(c);if(e){let i=e[1].trim(),n=i.length>1,o={type:"list",raw:"",ordered:n,start:n?+i.slice(0,-1):"",loose:!1,items:[]};i=n?`\\d{1,9}\\${i.slice(-1)}`:`\\${i}`,this.options.pedantic&&(i=n?i:"[*+-]");let r=this.rules.other.listItemRegex(i),a=!1;for(;c;){let h=!1,d="",p="";if(!(e=r.exec(c))||this.rules.block.hr.test(c))break;d=e[0],c=c.substring(d.length);let u=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,S=>" ".repeat(3*S.length)),g=c.split(`
`,1)[0],m=!u.trim(),v=0;if(this.options.pedantic?(v=2,p=u.trimStart()):m?v=e[1].length+1:(v=e[2].search(this.rules.other.nonSpaceChar),v=v>4?1:v,p=u.slice(v),v+=e[1].length),m&&this.rules.other.blankLine.test(g)&&(d+=g+`
`,c=c.substring(g.length+1),h=!0),!h){let S=this.rules.other.nextBulletRegex(v),L=this.rules.other.hrRegex(v),B=this.rules.other.fencesBeginRegex(v),M=this.rules.other.headingBeginRegex(v),Q=this.rules.other.htmlBeginRegex(v);for(;c;){let $=c.split(`
`,1)[0],D;if(g=$,this.options.pedantic?(g=g.replace(this.rules.other.listReplaceNesting,"  "),D=g):D=g.replace(this.rules.other.tabCharGlobal,"    "),B.test(g)||M.test(g)||Q.test(g)||S.test(g)||L.test(g))break;if(D.search(this.rules.other.nonSpaceChar)>=v||!g.trim())p+=`
`+D.slice(v);else{if(m||u.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||B.test(u)||M.test(u)||L.test(u))break;p+=`
`+g}!m&&!g.trim()&&(m=!0),d+=$+`
`,c=c.substring($.length+1),u=D.slice(v)}}o.loose||(a?o.loose=!0:this.rules.other.doubleBlankLine.test(d)&&(a=!0)),o.items.push({type:"list_item",raw:d,task:!!this.options.gfm&&this.rules.other.listIsTask.test(p),loose:!1,text:p,tokens:[]}),o.raw+=d}let l=o.items.at(-1);if(l)l.raw=l.raw.trimEnd(),l.text=l.text.trimEnd();else return;o.raw=o.raw.trimEnd();for(let h of o.items){if(this.lexer.state.top=!1,h.tokens=this.lexer.blockTokens(h.text,[]),h.task){if(h.text=h.text.replace(this.rules.other.listReplaceTask,""),((t=h.tokens[0])==null?void 0:t.type)==="text"||((s=h.tokens[0])==null?void 0:s.type)==="paragraph"){h.tokens[0].raw=h.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),h.tokens[0].text=h.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let p=this.lexer.inlineQueue.length-1;p>=0;p--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[p].src)){this.lexer.inlineQueue[p].src=this.lexer.inlineQueue[p].src.replace(this.rules.other.listReplaceTask,"");break}}let d=this.rules.other.listTaskCheckbox.exec(h.raw);if(d){let p={type:"checkbox",raw:d[0]+" ",checked:d[0]!=="[ ]"};h.checked=p.checked,o.loose?h.tokens[0]&&["paragraph","text"].includes(h.tokens[0].type)&&"tokens"in h.tokens[0]&&h.tokens[0].tokens?(h.tokens[0].raw=p.raw+h.tokens[0].raw,h.tokens[0].text=p.raw+h.tokens[0].text,h.tokens[0].tokens.unshift(p)):h.tokens.unshift({type:"paragraph",raw:p.raw,text:p.raw,tokens:[p]}):h.tokens.unshift(p)}}if(!o.loose){let d=h.tokens.filter(u=>u.type==="space"),p=d.length>0&&d.some(u=>this.rules.other.anyLine.test(u.raw));o.loose=p}}if(o.loose)for(let h of o.items){h.loose=!0;for(let d of h.tokens)d.type==="text"&&(d.type="paragraph")}return o}}html(c){let e=this.rules.block.html.exec(c);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(c){let e=this.rules.block.def.exec(c);if(e){let t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),s=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",i=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:s,title:i}}}table(c){var o;let e=this.rules.block.table.exec(c);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let t=Ze(e[1]),s=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),i=(o=e[3])!=null&&o.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],n={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===s.length){for(let r of s)this.rules.other.tableAlignRight.test(r)?n.align.push("right"):this.rules.other.tableAlignCenter.test(r)?n.align.push("center"):this.rules.other.tableAlignLeft.test(r)?n.align.push("left"):n.align.push(null);for(let r=0;r<t.length;r++)n.header.push({text:t[r],tokens:this.lexer.inline(t[r]),header:!0,align:n.align[r]});for(let r of i)n.rows.push(Ze(r,n.header.length).map((a,l)=>({text:a,tokens:this.lexer.inline(a),header:!1,align:n.align[l]})));return n}}lheading(c){let e=this.rules.block.lheading.exec(c);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(c){let e=this.rules.block.paragraph.exec(c);if(e){let t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(c){let e=this.rules.block.text.exec(c);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(c){let e=this.rules.inline.escape.exec(c);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(c){let e=this.rules.inline.tag.exec(c);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(c){let e=this.rules.inline.link.exec(c);if(e){let t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;let n=j(t.slice(0,-1),"\\");if((t.length-n.length)%2===0)return}else{let n=vs(e[2],"()");if(n===-2)return;if(n>-1){let o=(e[0].indexOf("!")===0?5:4)+e[1].length+n;e[2]=e[2].substring(0,n),e[0]=e[0].substring(0,o).trim(),e[3]=""}}let s=e[2],i="";if(this.options.pedantic){let n=this.rules.other.pedanticHrefTitle.exec(s);n&&(s=n[1],i=n[3])}else i=e[3]?e[3].slice(1,-1):"";return s=s.trim(),this.rules.other.startAngleBracket.test(s)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?s=s.slice(1):s=s.slice(1,-1)),et(e,{href:s&&s.replace(this.rules.inline.anyPunctuation,"$1"),title:i&&i.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(c,e){let t;if((t=this.rules.inline.reflink.exec(c))||(t=this.rules.inline.nolink.exec(c))){let s=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),i=e[s.toLowerCase()];if(!i){let n=t[0].charAt(0);return{type:"text",raw:n,text:n}}return et(t,i,t[0],this.lexer,this.rules)}}emStrong(c,e,t=""){let s=this.rules.inline.emStrongLDelim.exec(c);if(!(!s||s[3]&&t.match(this.rules.other.unicodeAlphaNumeric))&&(!(s[1]||s[2])||!t||this.rules.inline.punctuation.exec(t))){let i=[...s[0]].length-1,n,o,r=i,a=0,l=s[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(l.lastIndex=0,e=e.slice(-1*c.length+i);(s=l.exec(e))!=null;){if(n=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!n)continue;if(o=[...n].length,s[3]||s[4]){r+=o;continue}else if((s[5]||s[6])&&i%3&&!((i+o)%3)){a+=o;continue}if(r-=o,r>0)continue;o=Math.min(o,o+r+a);let h=[...s[0]][0].length,d=c.slice(0,i+s.index+h+o);if(Math.min(i,o)%2){let u=d.slice(1,-1);return{type:"em",raw:d,text:u,tokens:this.lexer.inlineTokens(u)}}let p=d.slice(2,-2);return{type:"strong",raw:d,text:p,tokens:this.lexer.inlineTokens(p)}}}}codespan(c){let e=this.rules.inline.code.exec(c);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," "),s=this.rules.other.nonSpaceChar.test(t),i=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return s&&i&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(c){let e=this.rules.inline.br.exec(c);if(e)return{type:"br",raw:e[0]}}del(c){let e=this.rules.inline.del.exec(c);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(c){let e=this.rules.inline.autolink.exec(c);if(e){let t,s;return e[2]==="@"?(t=e[1],s="mailto:"+t):(t=e[1],s=t),{type:"link",raw:e[0],text:t,href:s,tokens:[{type:"text",raw:t,text:t}]}}}url(c){var t;let e;if(e=this.rules.inline.url.exec(c)){let s,i;if(e[2]==="@")s=e[0],i="mailto:"+s;else{let n;do n=e[0],e[0]=((t=this.rules.inline._backpedal.exec(e[0]))==null?void 0:t[0])??"";while(n!==e[0]);s=e[0],e[1]==="www."?i="http://"+e[0]:i=e[0]}return{type:"link",raw:e[0],text:s,href:i,tokens:[{type:"text",raw:s,text:s}]}}}inlineText(c){let e=this.rules.inline.text.exec(c);if(e){let t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}},I=class we{constructor(e){T(this,"tokens");T(this,"options");T(this,"state");T(this,"inlineQueue");T(this,"tokenizer");this.tokens=[],this.tokens.links=Object.create(null),this.options=e||O,this.options.tokenizer=this.options.tokenizer||new ce,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:P,block:re.normal,inline:K.normal};this.options.pedantic?(t.block=re.pedantic,t.inline=K.pedantic):this.options.gfm&&(t.block=re.gfm,this.options.breaks?t.inline=K.breaks:t.inline=K.gfm),this.tokenizer.rules=t}static get rules(){return{block:re,inline:K}}static lex(e,t){return new we(t).lex(e)}static lexInline(e,t){return new we(t).inlineTokens(e)}lex(e){e=e.replace(P.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let s=this.inlineQueue[t];this.inlineTokens(s.src,s.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],s=!1){var i,n,o;for(this.options.pedantic&&(e=e.replace(P.tabCharGlobal,"    ").replace(P.spaceLine,""));e;){let r;if((n=(i=this.options.extensions)==null?void 0:i.block)!=null&&n.some(l=>(r=l.call({lexer:this},e,t))?(e=e.substring(r.raw.length),t.push(r),!0):!1))continue;if(r=this.tokenizer.space(e)){e=e.substring(r.raw.length);let l=t.at(-1);r.raw.length===1&&l!==void 0?l.raw+=`
`:t.push(r);continue}if(r=this.tokenizer.code(e)){e=e.substring(r.raw.length);let l=t.at(-1);(l==null?void 0:l.type)==="paragraph"||(l==null?void 0:l.type)==="text"?(l.raw+=(l.raw.endsWith(`
`)?"":`
`)+r.raw,l.text+=`
`+r.text,this.inlineQueue.at(-1).src=l.text):t.push(r);continue}if(r=this.tokenizer.fences(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.heading(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.hr(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.blockquote(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.list(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.html(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.def(e)){e=e.substring(r.raw.length);let l=t.at(-1);(l==null?void 0:l.type)==="paragraph"||(l==null?void 0:l.type)==="text"?(l.raw+=(l.raw.endsWith(`
`)?"":`
`)+r.raw,l.text+=`
`+r.raw,this.inlineQueue.at(-1).src=l.text):this.tokens.links[r.tag]||(this.tokens.links[r.tag]={href:r.href,title:r.title},t.push(r));continue}if(r=this.tokenizer.table(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.lheading(e)){e=e.substring(r.raw.length),t.push(r);continue}let a=e;if((o=this.options.extensions)!=null&&o.startBlock){let l=1/0,h=e.slice(1),d;this.options.extensions.startBlock.forEach(p=>{d=p.call({lexer:this},h),typeof d=="number"&&d>=0&&(l=Math.min(l,d))}),l<1/0&&l>=0&&(a=e.substring(0,l+1))}if(this.state.top&&(r=this.tokenizer.paragraph(a))){let l=t.at(-1);s&&(l==null?void 0:l.type)==="paragraph"?(l.raw+=(l.raw.endsWith(`
`)?"":`
`)+r.raw,l.text+=`
`+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=l.text):t.push(r),s=a.length!==e.length,e=e.substring(r.raw.length);continue}if(r=this.tokenizer.text(e)){e=e.substring(r.raw.length);let l=t.at(-1);(l==null?void 0:l.type)==="text"?(l.raw+=(l.raw.endsWith(`
`)?"":`
`)+r.raw,l.text+=`
`+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=l.text):t.push(r);continue}if(e){let l="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(l);break}else throw new Error(l)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){var a,l,h,d,p;let s=e,i=null;if(this.tokens.links){let u=Object.keys(this.tokens.links);if(u.length>0)for(;(i=this.tokenizer.rules.inline.reflinkSearch.exec(s))!=null;)u.includes(i[0].slice(i[0].lastIndexOf("[")+1,-1))&&(s=s.slice(0,i.index)+"["+"a".repeat(i[0].length-2)+"]"+s.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(i=this.tokenizer.rules.inline.anyPunctuation.exec(s))!=null;)s=s.slice(0,i.index)+"++"+s.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let n;for(;(i=this.tokenizer.rules.inline.blockSkip.exec(s))!=null;)n=i[2]?i[2].length:0,s=s.slice(0,i.index+n)+"["+"a".repeat(i[0].length-n-2)+"]"+s.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);s=((l=(a=this.options.hooks)==null?void 0:a.emStrongMask)==null?void 0:l.call({lexer:this},s))??s;let o=!1,r="";for(;e;){o||(r=""),o=!1;let u;if((d=(h=this.options.extensions)==null?void 0:h.inline)!=null&&d.some(m=>(u=m.call({lexer:this},e,t))?(e=e.substring(u.raw.length),t.push(u),!0):!1))continue;if(u=this.tokenizer.escape(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.tag(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.link(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(u.raw.length);let m=t.at(-1);u.type==="text"&&(m==null?void 0:m.type)==="text"?(m.raw+=u.raw,m.text+=u.text):t.push(u);continue}if(u=this.tokenizer.emStrong(e,s,r)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.codespan(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.br(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.del(e)){e=e.substring(u.raw.length),t.push(u);continue}if(u=this.tokenizer.autolink(e)){e=e.substring(u.raw.length),t.push(u);continue}if(!this.state.inLink&&(u=this.tokenizer.url(e))){e=e.substring(u.raw.length),t.push(u);continue}let g=e;if((p=this.options.extensions)!=null&&p.startInline){let m=1/0,v=e.slice(1),S;this.options.extensions.startInline.forEach(L=>{S=L.call({lexer:this},v),typeof S=="number"&&S>=0&&(m=Math.min(m,S))}),m<1/0&&m>=0&&(g=e.substring(0,m+1))}if(u=this.tokenizer.inlineText(g)){e=e.substring(u.raw.length),u.raw.slice(-1)!=="_"&&(r=u.raw.slice(-1)),o=!0;let m=t.at(-1);(m==null?void 0:m.type)==="text"?(m.raw+=u.raw,m.text+=u.text):t.push(u);continue}if(e){let m="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(m);break}else throw new Error(m)}}return t}},he=class{constructor(c){T(this,"options");T(this,"parser");this.options=c||O}space(c){return""}code({text:c,lang:e,escaped:t}){var n;let s=(n=(e||"").match(P.notSpaceStart))==null?void 0:n[0],i=c.replace(P.endingNewline,"")+`
`;return s?'<pre><code class="language-'+R(s)+'">'+(t?i:R(i,!0))+`</code></pre>
`:"<pre><code>"+(t?i:R(i,!0))+`</code></pre>
`}blockquote({tokens:c}){return`<blockquote>
${this.parser.parse(c)}</blockquote>
`}html({text:c}){return c}def(c){return""}heading({tokens:c,depth:e}){return`<h${e}>${this.parser.parseInline(c)}</h${e}>
`}hr(c){return`<hr>
`}list(c){let e=c.ordered,t=c.start,s="";for(let o=0;o<c.items.length;o++){let r=c.items[o];s+=this.listitem(r)}let i=e?"ol":"ul",n=e&&t!==1?' start="'+t+'"':"";return"<"+i+n+`>
`+s+"</"+i+`>
`}listitem(c){return`<li>${this.parser.parse(c.tokens)}</li>
`}checkbox({checked:c}){return"<input "+(c?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:c}){return`<p>${this.parser.parseInline(c)}</p>
`}table(c){let e="",t="";for(let i=0;i<c.header.length;i++)t+=this.tablecell(c.header[i]);e+=this.tablerow({text:t});let s="";for(let i=0;i<c.rows.length;i++){let n=c.rows[i];t="";for(let o=0;o<n.length;o++)t+=this.tablecell(n[o]);s+=this.tablerow({text:t})}return s&&(s=`<tbody>${s}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+s+`</table>
`}tablerow({text:c}){return`<tr>
${c}</tr>
`}tablecell(c){let e=this.parser.parseInline(c.tokens),t=c.header?"th":"td";return(c.align?`<${t} align="${c.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:c}){return`<strong>${this.parser.parseInline(c)}</strong>`}em({tokens:c}){return`<em>${this.parser.parseInline(c)}</em>`}codespan({text:c}){return`<code>${R(c,!0)}</code>`}br(c){return"<br>"}del({tokens:c}){return`<del>${this.parser.parseInline(c)}</del>`}link({href:c,title:e,tokens:t}){let s=this.parser.parseInline(t),i=Je(c);if(i===null)return s;c=i;let n='<a href="'+c+'"';return e&&(n+=' title="'+R(e)+'"'),n+=">"+s+"</a>",n}image({href:c,title:e,text:t,tokens:s}){s&&(t=this.parser.parseInline(s,this.parser.textRenderer));let i=Je(c);if(i===null)return R(t);c=i;let n=`<img src="${c}" alt="${t}"`;return e&&(n+=` title="${R(e)}"`),n+=">",n}text(c){return"tokens"in c&&c.tokens?this.parser.parseInline(c.tokens):"escaped"in c&&c.escaped?c.text:R(c.text)}},Re=class{strong({text:c}){return c}em({text:c}){return c}codespan({text:c}){return c}del({text:c}){return c}html({text:c}){return c}text({text:c}){return c}link({text:c}){return""+c}image({text:c}){return""+c}br(){return""}checkbox({raw:c}){return c}},q=class xe{constructor(e){T(this,"options");T(this,"renderer");T(this,"textRenderer");this.options=e||O,this.options.renderer=this.options.renderer||new he,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Re}static parse(e,t){return new xe(t).parse(e)}static parseInline(e,t){return new xe(t).parseInline(e)}parse(e){var s,i;let t="";for(let n=0;n<e.length;n++){let o=e[n];if((i=(s=this.options.extensions)==null?void 0:s.renderers)!=null&&i[o.type]){let a=o,l=this.options.extensions.renderers[a.type].call({parser:this},a);if(l!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(a.type)){t+=l||"";continue}}let r=o;switch(r.type){case"space":{t+=this.renderer.space(r);break}case"hr":{t+=this.renderer.hr(r);break}case"heading":{t+=this.renderer.heading(r);break}case"code":{t+=this.renderer.code(r);break}case"table":{t+=this.renderer.table(r);break}case"blockquote":{t+=this.renderer.blockquote(r);break}case"list":{t+=this.renderer.list(r);break}case"checkbox":{t+=this.renderer.checkbox(r);break}case"html":{t+=this.renderer.html(r);break}case"def":{t+=this.renderer.def(r);break}case"paragraph":{t+=this.renderer.paragraph(r);break}case"text":{t+=this.renderer.text(r);break}default:{let a='Token with "'+r.type+'" type was not found.';if(this.options.silent)return console.error(a),"";throw new Error(a)}}}return t}parseInline(e,t=this.renderer){var i,n;let s="";for(let o=0;o<e.length;o++){let r=e[o];if((n=(i=this.options.extensions)==null?void 0:i.renderers)!=null&&n[r.type]){let l=this.options.extensions.renderers[r.type].call({parser:this},r);if(l!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(r.type)){s+=l||"";continue}}let a=r;switch(a.type){case"escape":{s+=t.text(a);break}case"html":{s+=t.html(a);break}case"link":{s+=t.link(a);break}case"image":{s+=t.image(a);break}case"checkbox":{s+=t.checkbox(a);break}case"strong":{s+=t.strong(a);break}case"em":{s+=t.em(a);break}case"codespan":{s+=t.codespan(a);break}case"br":{s+=t.br(a);break}case"del":{s+=t.del(a);break}case"text":{s+=t.text(a);break}default:{let l='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(l),"";throw new Error(l)}}}return s}},ae,Y=(ae=class{constructor(c){T(this,"options");T(this,"block");this.options=c||O}preprocess(c){return c}postprocess(c){return c}processAllTokens(c){return c}emStrongMask(c){return c}provideLexer(){return this.block?I.lex:I.lexInline}provideParser(){return this.block?q.parse:q.parseInline}},T(ae,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens","emStrongMask"])),T(ae,"passThroughHooksRespectAsync",new Set(["preprocess","postprocess","processAllTokens"])),ae),ys=class{constructor(...c){T(this,"defaults",Ee());T(this,"options",this.setOptions);T(this,"parse",this.parseMarkdown(!0));T(this,"parseInline",this.parseMarkdown(!1));T(this,"Parser",q);T(this,"Renderer",he);T(this,"TextRenderer",Re);T(this,"Lexer",I);T(this,"Tokenizer",ce);T(this,"Hooks",Y);this.use(...c)}walkTokens(c,e){var s,i;let t=[];for(let n of c)switch(t=t.concat(e.call(this,n)),n.type){case"table":{let o=n;for(let r of o.header)t=t.concat(this.walkTokens(r.tokens,e));for(let r of o.rows)for(let a of r)t=t.concat(this.walkTokens(a.tokens,e));break}case"list":{let o=n;t=t.concat(this.walkTokens(o.items,e));break}default:{let o=n;(i=(s=this.defaults.extensions)==null?void 0:s.childTokens)!=null&&i[o.type]?this.defaults.extensions.childTokens[o.type].forEach(r=>{let a=o[r].flat(1/0);t=t.concat(this.walkTokens(a,e))}):o.tokens&&(t=t.concat(this.walkTokens(o.tokens,e)))}}return t}use(...c){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return c.forEach(t=>{let s={...t};if(s.async=this.defaults.async||s.async||!1,t.extensions&&(t.extensions.forEach(i=>{if(!i.name)throw new Error("extension name required");if("renderer"in i){let n=e.renderers[i.name];n?e.renderers[i.name]=function(...o){let r=i.renderer.apply(this,o);return r===!1&&(r=n.apply(this,o)),r}:e.renderers[i.name]=i.renderer}if("tokenizer"in i){if(!i.level||i.level!=="block"&&i.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let n=e[i.level];n?n.unshift(i.tokenizer):e[i.level]=[i.tokenizer],i.start&&(i.level==="block"?e.startBlock?e.startBlock.push(i.start):e.startBlock=[i.start]:i.level==="inline"&&(e.startInline?e.startInline.push(i.start):e.startInline=[i.start]))}"childTokens"in i&&i.childTokens&&(e.childTokens[i.name]=i.childTokens)}),s.extensions=e),t.renderer){let i=this.defaults.renderer||new he(this.defaults);for(let n in t.renderer){if(!(n in i))throw new Error(`renderer '${n}' does not exist`);if(["options","parser"].includes(n))continue;let o=n,r=t.renderer[o],a=i[o];i[o]=(...l)=>{let h=r.apply(i,l);return h===!1&&(h=a.apply(i,l)),h||""}}s.renderer=i}if(t.tokenizer){let i=this.defaults.tokenizer||new ce(this.defaults);for(let n in t.tokenizer){if(!(n in i))throw new Error(`tokenizer '${n}' does not exist`);if(["options","rules","lexer"].includes(n))continue;let o=n,r=t.tokenizer[o],a=i[o];i[o]=(...l)=>{let h=r.apply(i,l);return h===!1&&(h=a.apply(i,l)),h}}s.tokenizer=i}if(t.hooks){let i=this.defaults.hooks||new Y;for(let n in t.hooks){if(!(n in i))throw new Error(`hook '${n}' does not exist`);if(["options","block"].includes(n))continue;let o=n,r=t.hooks[o],a=i[o];Y.passThroughHooks.has(n)?i[o]=l=>{if(this.defaults.async&&Y.passThroughHooksRespectAsync.has(n))return(async()=>{let d=await r.call(i,l);return a.call(i,d)})();let h=r.call(i,l);return a.call(i,h)}:i[o]=(...l)=>{if(this.defaults.async)return(async()=>{let d=await r.apply(i,l);return d===!1&&(d=await a.apply(i,l)),d})();let h=r.apply(i,l);return h===!1&&(h=a.apply(i,l)),h}}s.hooks=i}if(t.walkTokens){let i=this.defaults.walkTokens,n=t.walkTokens;s.walkTokens=function(o){let r=[];return r.push(n.call(this,o)),i&&(r=r.concat(i.call(this,o))),r}}this.defaults={...this.defaults,...s}}),this}setOptions(c){return this.defaults={...this.defaults,...c},this}lexer(c,e){return I.lex(c,e??this.defaults)}parser(c,e){return q.parse(c,e??this.defaults)}parseMarkdown(c){return(e,t)=>{let s={...t},i={...this.defaults,...s},n=this.onError(!!i.silent,!!i.async);if(this.defaults.async===!0&&s.async===!1)return n(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof e>"u"||e===null)return n(new Error("marked(): input parameter is undefined or null"));if(typeof e!="string")return n(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected"));if(i.hooks&&(i.hooks.options=i,i.hooks.block=c),i.async)return(async()=>{let o=i.hooks?await i.hooks.preprocess(e):e,r=await(i.hooks?await i.hooks.provideLexer():c?I.lex:I.lexInline)(o,i),a=i.hooks?await i.hooks.processAllTokens(r):r;i.walkTokens&&await Promise.all(this.walkTokens(a,i.walkTokens));let l=await(i.hooks?await i.hooks.provideParser():c?q.parse:q.parseInline)(a,i);return i.hooks?await i.hooks.postprocess(l):l})().catch(n);try{i.hooks&&(e=i.hooks.preprocess(e));let o=(i.hooks?i.hooks.provideLexer():c?I.lex:I.lexInline)(e,i);i.hooks&&(o=i.hooks.processAllTokens(o)),i.walkTokens&&this.walkTokens(o,i.walkTokens);let r=(i.hooks?i.hooks.provideParser():c?q.parse:q.parseInline)(o,i);return i.hooks&&(r=i.hooks.postprocess(r)),r}catch(o){return n(o)}}}onError(c,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,c){let s="<p>An error occurred:</p><pre>"+R(t.message+"",!0)+"</pre>";return e?Promise.resolve(s):s}if(e)return Promise.reject(t);throw t}}},F=new ys;function x(c,e){return F.parse(c,e)}x.options=x.setOptions=function(c){return F.setOptions(c),x.defaults=F.defaults,ht(x.defaults),x};x.getDefaults=Ee;x.defaults=O;x.use=function(...c){return F.use(...c),x.defaults=F.defaults,ht(x.defaults),x};x.walkTokens=function(c,e){return F.walkTokens(c,e)};x.parseInline=F.parseInline;x.Parser=q;x.parser=q.parse;x.Renderer=he;x.TextRenderer=Re;x.Lexer=I;x.lexer=I.lex;x.Tokenizer=ce;x.Hooks=Y;x.parse=x;x.options;x.setOptions;x.use;x.walkTokens;x.parseInline;q.parse;I.lex;class ks extends ee{constructor(){super(),this._rawText=null,x.setOptions({gfm:!0,breaks:!1})}async loadFromFile(e){console.time("MarkdownParser.loadFromFile");const t=await e.text();this._rawText=t;const s=e.name+e.size+e.lastModified,i=await te(s),n=this._extractTitle(t)||e.name.replace(/\.(md|markdown)$/i,""),o=this._splitIntoChapters(t);return console.timeEnd("MarkdownParser.loadFromFile"),console.log(`Markdown loaded: ${o.length} chapters`),{id:i,title:n,author:"Unknown Author",coverImage:null,chapters:o,fileData:t,fileType:"markdown",lastOpened:Date.now()}}async initFromStoredData(e){this._rawText=e,console.log("MarkdownParser reinitialized from stored data")}async loadChapter(e,t){if(t<0||t>=e.chapters.length)return[];const s=e.chapters[t];if(s.loaded&&s.sentences)return s.sentences;console.time(`MarkdownParser.loadChapter[${t}]`);const i=x.parse(s._markdownContent||""),{html:n,sentences:o}=this._processHtmlWithSentences(i);return s.sentences=o,s.html=n,s.loaded=!0,console.timeEnd(`MarkdownParser.loadChapter[${t}]`),console.log(`Chapter ${t} loaded: ${o.length} sentences`),o}_maskCodeBlocks(e){return e.replace(/^(`{3,}|~{3,})[^\n]*\n[\s\S]*?^\1\s*$/gm,t=>t.replace(/[^\n]/g," "))}_extractTitle(e){const s=this._maskCodeBlocks(e).match(/^#\s+(.+)$/m);if(!s)return null;const i=s.index+s[0].indexOf(s[1]);return e.substring(i,i+s[1].length).trim()}_splitIntoChapters(e){const t=this._maskCodeBlocks(e);for(let s=1;s<=6;s++){const i="#".repeat(s),n=new RegExp(`^${i}\\s+(.+)$`,"gm"),o=[...t.matchAll(n)];if(o.length>=2||o.length===1&&s===1){const r=o.map(a=>{const h=e.substring(a.index,a.index+a[0].length).match(/^#{1,6}\s+(.+)$/);return{index:a.index,0:a[0],1:h?h[1]:a[1]}});return this._splitByMatches(e,r,i.length)}}return[{id:"chapter-0",title:"Content",href:"",sentences:null,html:null,loaded:!1,_markdownContent:e}]}_splitByMatches(e,t,s){const i=[],n=t[0].index;if(n>0){const o=e.substring(0,n).trim();o&&i.push({id:"chapter-0",title:"Preamble",href:"",sentences:null,html:null,loaded:!1,_markdownContent:o})}for(let o=0;o<t.length;o++){const r=t[o],a=r[1].trim(),l=r.index,h=o+1<t.length?t[o+1].index:e.length,d=e.substring(l,h).trim();i.push({id:`chapter-${i.length}`,title:a,href:"",sentences:null,html:null,loaded:!1,_markdownContent:d})}return i}_processHtmlWithSentences(e){var r;const i=new DOMParser().parseFromString(e,"text/html").body;if(!i||!((r=i.textContent)!=null&&r.trim()))return{html:'<div class="markdown-content"></div>',sentences:[]};i.querySelectorAll("script, style").forEach(a=>a.remove());const n=[];W(i,n);const o=document.createElement("div");return o.className="markdown-content",o.innerHTML=i.innerHTML,{html:o.outerHTML,sentences:n}}}class Ss extends ee{constructor(){super(),this._rawHtml=null}async loadFromFile(e){console.time("HTMLParser.loadFromFile");const t=await e.text();this._rawHtml=t;const s=e.name+e.size+e.lastModified,i=await te(s),o=new DOMParser().parseFromString(t,"text/html"),r=this._extractTitle(o)||e.name.replace(/\.(html|htm)$/i,""),a=this._extractAuthor(o)||"Unknown Author",l=this._splitIntoChapters(o);return console.timeEnd("HTMLParser.loadFromFile"),console.log(`HTML loaded: ${l.length} chapters`),{id:i,title:r,author:a,coverImage:null,chapters:l,fileData:t,fileType:"html",lastOpened:Date.now()}}async initFromStoredData(e){this._rawHtml=e,console.log("HTMLParser reinitialized from stored data")}async loadChapter(e,t){if(t<0||t>=e.chapters.length)return[];const s=e.chapters[t];if(s.loaded&&s.sentences)return s.sentences;console.time(`HTMLParser.loadChapter[${t}]`);const{html:i,sentences:n}=this._processHtmlWithSentences(s._htmlContent||"");return s.sentences=n,s.html=i,s.loaded=!0,console.timeEnd(`HTMLParser.loadChapter[${t}]`),console.log(`Chapter ${t} loaded: ${n.length} sentences`),n}_extractTitle(e){var i,n;const t=e.querySelector("title");if((i=t==null?void 0:t.textContent)!=null&&i.trim())return t.textContent.trim();const s=e.querySelector("h1");return((n=s==null?void 0:s.textContent)==null?void 0:n.trim())||null}_extractAuthor(e){var s;const t=e.querySelector('meta[name="author"]');return((s=t==null?void 0:t.getAttribute("content"))==null?void 0:s.trim())||null}_splitIntoChapters(e){const t=e.body;if(!t)return[{id:"chapter-0",title:"Content",href:"",sentences:null,html:null,loaded:!1,_htmlContent:""}];const s=t.querySelectorAll(":scope > section, :scope > article");if(s.length>=2)return this._chaptersFromElements(s);const i=t.querySelectorAll("main > section, main > article, div > section, div > article");if(i.length>=2)return this._chaptersFromElements(i);for(let n=1;n<=6;n++){const o=t.querySelectorAll(`h${n}`);if(o.length>=2||o.length===1&&n===1)return this._chaptersFromHeadings(t,o,n)}return[{id:"chapter-0",title:"Content",href:"",sentences:null,html:null,loaded:!1,_htmlContent:this._sanitizeHtml(t.innerHTML)}]}_chaptersFromElements(e){const t=[];return e.forEach((s,i)=>{var r;const n=s.querySelector("h1, h2, h3, h4, h5, h6"),o=((r=n==null?void 0:n.textContent)==null?void 0:r.trim())||`Section ${i+1}`;t.push({id:`chapter-${i}`,title:o,href:"",sentences:null,html:null,loaded:!1,_htmlContent:this._sanitizeHtml(s.innerHTML)})}),t}_chaptersFromHeadings(e,t,s){var r;const i=[],n=e.innerHTML,o=[];for(const a of t){const l=a.outerHTML,h=n.indexOf(l,o.length>0?o[o.length-1].end:0);h!==-1&&o.push({start:h,end:h+l.length,title:((r=a.textContent)==null?void 0:r.trim())||`Chapter ${o.length+1}`})}if(o.length===0)return[{id:"chapter-0",title:"Content",href:"",sentences:null,html:null,loaded:!1,_htmlContent:this._sanitizeHtml(n)}];if(o[0].start>0){const a=n.substring(0,o[0].start).trim();a&&this._hasTextContent(a)&&i.push({id:"chapter-0",title:"Preamble",href:"",sentences:null,html:null,loaded:!1,_htmlContent:this._sanitizeHtml(a)})}for(let a=0;a<o.length;a++){const l=o[a],h=a+1<o.length?o[a+1].start:n.length,d=n.substring(l.start,h).trim();i.push({id:`chapter-${i.length}`,title:l.title,href:"",sentences:null,html:null,loaded:!1,_htmlContent:this._sanitizeHtml(d)})}return i}_hasTextContent(e){var s;const t=document.createElement("div");return t.innerHTML=e,((s=t.textContent)==null?void 0:s.trim().length)>0}_sanitizeHtml(e){const i=new DOMParser().parseFromString(e,"text/html").body,n=["script","style",'link[rel="stylesheet"]',"iframe","object","embed",'[role="navigation"]','[role="banner"]',"nav","aside"];return i.querySelectorAll(n.join(",")).forEach(r=>r.remove()),i.querySelectorAll("*").forEach(r=>{const a=[...r.attributes];for(const l of a)(l.name.startsWith("on")||l.name==="style")&&r.removeAttribute(l.name)}),i.innerHTML}_processHtmlWithSentences(e){var r;const i=new DOMParser().parseFromString(e,"text/html").body;if(!i||!((r=i.textContent)!=null&&r.trim()))return{html:'<div class="html-content"></div>',sentences:[]};const n=[];W(i,n);const o=document.createElement("div");return o.className="html-content",o.innerHTML=i.innerHTML,{html:o.outerHTML,sentences:n}}}class ws extends ee{constructor(){super(),this._rawText=null}async loadFromFile(e){const t=await e.text();return this.loadFromText(t,e.name)}async loadFromText(e,t="Pasted Text"){console.time("PlainTextParser.loadFromText"),this._rawText=e;const s=await te(t+e.length+Date.now()),i=this._splitIntoChapters(e);return console.timeEnd("PlainTextParser.loadFromText"),console.log(`Plain text loaded: ${i.length} chapters`),{id:s,title:t,author:"Unknown Author",coverImage:null,chapters:i,fileData:e,fileType:"plaintext",lastOpened:Date.now()}}async initFromStoredData(e){this._rawText=e,console.log("PlainTextParser reinitialized from stored data")}async loadChapter(e,t){if(t<0||t>=e.chapters.length)return[];const s=e.chapters[t];if(s.loaded&&s.sentences)return s.sentences;console.time(`PlainTextParser.loadChapter[${t}]`);const i=this._textToHtml(s._plainTextContent||""),{html:n,sentences:o}=this._processHtmlWithSentences(i);return s.sentences=o,s.html=n,s.loaded=!0,console.timeEnd(`PlainTextParser.loadChapter[${t}]`),console.log(`Chapter ${t} loaded: ${o.length} sentences`),o}_textToHtml(e){return e.split(/\n{2,}/).map(s=>s.trim()).filter(s=>s.length>0).map(s=>`<p>${this._escapeHtml(s).replace(/\n/g,"<br>")}</p>`).join(`
`)}_escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}_splitIntoChapters(e){const t=/^(chapter\s+\w+|part\s+\w+|section\s+\w+|\d+\.\s+.+)$/gmi,s=[...e.matchAll(t)];return s.length>=2?this._splitByMatches(e,s):[{id:"chapter-0",title:"Content",href:"",sentences:null,html:null,loaded:!1,_plainTextContent:e}]}_splitByMatches(e,t){const s=[];if(t[0].index>0){const i=e.substring(0,t[0].index).trim();i&&s.push({id:"chapter-0",title:"Preamble",href:"",sentences:null,html:null,loaded:!1,_plainTextContent:i})}for(let i=0;i<t.length;i++){const n=t[i],o=n[1].trim(),r=n.index,a=i+1<t.length?t[i+1].index:e.length,l=e.substring(r,a).trim();s.push({id:`chapter-${s.length}`,title:o,href:"",sentences:null,html:null,loaded:!1,_plainTextContent:l})}return s}_processHtmlWithSentences(e){var r;const i=new DOMParser().parseFromString(e,"text/html").body;if(!i||!((r=i.textContent)!=null&&r.trim()))return{html:'<div class="plaintext-content"></div>',sentences:[]};const n=[];W(i,n);const o=document.createElement("div");return o.className="plaintext-content",o.innerHTML=i.innerHTML,{html:o.outerHTML,sentences:n}}}async function xs(c){var o;if(typeof pdfjsLib>"u")throw new Error("pdf.js library is not loaded. Please ensure pdfjs-dist is available.");const e=await pdfjsLib.getDocument({data:c}).promise,t=e.numPages,s=await e.getMetadata().catch(()=>null),i=((o=s==null?void 0:s.info)==null?void 0:o.Title)||"",n=[];for(let r=1;r<=t;r++){const a=await e.getPage(r),l=await a.getTextContent();a.getViewport({scale:1});const h=Cs(l);n.push({title:`Page ${r}`,markdown:h})}return{title:i,chapters:n}}function Cs(c,e){const t=c.items;if(!t||t.length===0)return"";const s=t.filter(l=>l.str&&l.str.trim()).map(l=>kt(l));if(s.length===0)return"";const i=Ls(s),n=Ts(t),o=[];let r=[],a=null;for(const l of n){if(!l.text.trim())continue;const h=l.avgFontSize,d=h>i*1.25,p=h>i*1.6;let u=!1;a!==null&&a-l.top>h*1.8&&(u=!0);const g=l.text.trim();(u||d||p)&&r.length>0&&(o.push(r.join(" ")),o.push(""),r=[]),p?(o.push(`# ${g}`),o.push("")):d?(o.push(`## ${g}`),o.push("")):r.push(g),a=l.top}return r.length>0&&o.push(r.join(" ")),o.join(`
`)}function Ts(c,e){if(c.length===0)return[];const t=c.filter(n=>n.str).map(n=>{const o=kt(n),r=n.transform[5],a=n.transform[4];return{text:n.str,x:a,y:r,fontSize:o,width:n.width||0}});if(t.length===0)return[];t.sort((n,o)=>{const r=o.y-n.y;return Math.abs(r)>2?r:n.x-o.x});const s=[];let i={items:[t[0]],y:t[0].y};for(let n=1;n<t.length;n++){const o=t[n],r=Math.max(i.items[0].fontSize*.5,3);Math.abs(o.y-i.y)<=r?i.items.push(o):(s.push(tt(i)),i={items:[o],y:o.y})}return s.push(tt(i)),s}function tt(c){const e=c.items.sort((i,n)=>i.x-n.x),t=e.reduce((i,n)=>i+n.fontSize,0)/e.length;let s="";for(let i=0;i<e.length;i++){const n=e[i];if(i>0){const o=e[i-1];n.x-(o.x+o.width)>t*.3&&(s+=" ")}s+=n.text}return{text:s,top:c.y,bottom:c.y-t,avgFontSize:t}}function kt(c){const e=Math.abs(c.transform[3]),t=Math.abs(c.transform[0]);return Math.max(e,t)||12}function Ls(c){if(c.length===0)return 0;const e=[...c].sort((s,i)=>s-i),t=Math.floor(e.length/2);return e.length%2!==0?e[t]:(e[t-1]+e[t])/2}class Es extends ee{constructor(){super(),this._rawData=null,x.setOptions({gfm:!0,breaks:!1})}async loadFromFile(e){console.time("PDFParser.loadFromFile");const t=await e.arrayBuffer(),s=t.slice(0);this._rawData=s;const i=e.name+e.size+e.lastModified,n=await te(i),o=await xs(t),r=o.title||e.name.replace(/\.pdf$/i,""),a=o.chapters.map((l,h)=>({id:`chapter-${h}`,title:l.title,href:"",sentences:null,html:null,loaded:!1,_markdownContent:l.markdown}));return console.timeEnd("PDFParser.loadFromFile"),console.log(`PDF loaded: ${a.length} pages/chapters`),{id:n,title:r,author:"Unknown Author",coverImage:null,chapters:a,fileData:s,fileType:"pdf",lastOpened:Date.now()}}async initFromStoredData(e){this._rawData=e,console.log("PDFParser reinitialized from stored data")}async loadChapter(e,t){if(t<0||t>=e.chapters.length)return[];const s=e.chapters[t];if(s.loaded&&s.sentences)return s.sentences;console.time(`PDFParser.loadChapter[${t}]`);const i=x.parse(s._markdownContent||""),{html:n,sentences:o}=this._processHtmlWithSentences(i);return s.sentences=o,s.html=n,s.loaded=!0,console.timeEnd(`PDFParser.loadChapter[${t}]`),console.log(`Chapter ${t} loaded: ${o.length} sentences`),o}_processHtmlWithSentences(e){var r;const i=new DOMParser().parseFromString(e,"text/html").body;if(!i||!((r=i.textContent)!=null&&r.trim()))return{html:'<div class="pdf-content"></div>',sentences:[]};i.querySelectorAll("script, style").forEach(a=>a.remove());const n=[];W(i,n);const o=document.createElement("div");return o.className="pdf-content",o.innerHTML=i.innerHTML,{html:o.outerHTML,sentences:n}}}const fe=new Map,St={".epub":"epub",".md":"markdown",".markdown":"markdown",".html":"html",".htm":"html",".pdf":"pdf"};Object.keys(St).join(",");const de={epub:"EPUB",markdown:"Markdown",html:"HTML",plaintext:"Text",pdf:"PDF"};function wt(c){const e=c.toLowerCase();for(const[t,s]of Object.entries(St))if(e.endsWith(t))return s;return null}function U(c){if(fe.has(c))return fe.get(c);let e;switch(c){case"epub":e=new ct;break;case"markdown":e=new ks;break;case"html":e=new Ss;break;case"plaintext":e=new ws;break;case"pdf":e=new Es;break;default:throw new Error(`Unsupported file format: ${c}`)}return fe.set(c,e),e}function Ps(c){const e=wt(c);if(!e){const t=c.split(".").pop();throw new Error(`Unsupported file format: .${t}. Supported formats: ${Object.keys(de).join(", ")}`)}return U(e)}const st="http://localhost:8880";class Bs{constructor(){this._kokoro=null,this._isReady=!1,this._isLoading=!1,this._useKokoro=!0,this._currentVoice="af_heart",this._speed=1,this._audioContext=null,this._onProgress=null,this._device="wasm",this._dtype="fp32",this._sampleRate=24e3,this._backend="kokoro-js",this._fastApiUrl=st,this._fastApiAvailable=!1,this._benchmarkResults=[],this._benchmarkEnabled=!1,this._synthesisQueue=[],this._isSynthesizing=!1,this._currentSource=null,this._webSpeechSupported="speechSynthesis"in window}onProgress(e){this._onProgress=e}async isWebGPUAvailable(){if(!navigator.gpu)return!1;try{return await navigator.gpu.requestAdapter()!==null}catch{return!1}}async isKokoroFastAPIAvailable(e){const t=e||this._fastApiUrl;try{const s=new AbortController,i=setTimeout(()=>s.abort(),2e3),n=await fetch(`${t}/v1/models`,{signal:s.signal});return clearTimeout(i),this._fastApiAvailable=n.ok,n.ok}catch{return this._fastApiAvailable=!1,!1}}isFastAPIAvailable(){return this._fastApiAvailable}setFastApiUrl(e){this._fastApiUrl=e||st}getFastApiUrl(){return this._fastApiUrl}getBackend(){return this._backend}async setBackend(e){e===this._backend&&this._isReady||(this._backend=e,this._isReady=!1,this._isLoading=!1,this._kokoro=null,await this.initialize({backend:e}))}async initialize(e={}){if(this._isReady)return this._useKokoro;if(this._isLoading)return new Promise(i=>{const n=setInterval(()=>{this._isReady&&(clearInterval(n),i(this._useKokoro))},100)});if(this._isLoading=!0,e.backend&&(this._backend=e.backend),this._backend==="kokoro-fastapi")try{if(this._reportProgress({status:"Connecting to Kokoro FastAPI..."}),await this.isKokoroFastAPIAvailable())return this._useKokoro=!0,this._device="fastapi",this._isReady=!0,this._isLoading=!1,this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)),this._reportProgress({status:"TTS ready (Kokoro FastAPI)",progress:100}),console.log(`Kokoro FastAPI TTS initialized: ${this._fastApiUrl}`),!0;console.warn("Kokoro FastAPI not available, falling back to kokoro-js"),this._backend="kokoro-js"}catch(i){console.warn("Kokoro FastAPI check failed:",i),this._backend="kokoro-js"}if(this._backend==="web-speech"){if(this._webSpeechSupported)return this._useKokoro=!1,this._device="web-speech",this._isReady=!0,this._isLoading=!1,this._reportProgress({status:"TTS ready (Browser)"}),console.log("Using Web Speech API backend"),!1;console.warn("Web Speech not supported, falling back to kokoro-js"),this._backend="kokoro-js"}let t=e.device||"auto";if(t==="auto"){const i=await this.isWebGPUAvailable();t=i?"webgpu":"wasm",console.log(`Auto-detected device: ${t} (WebGPU ${i?"available":"not available"})`),i||this._showWebGPUWarning()}let s=e.dtype;s||(s=t==="webgpu"?"fp32":"q8"),this._device=t,this._dtype=s;try{return this._reportProgress({status:`Loading TTS engine (${t})...`}),await this._initializeKokoro(t,s),this._useKokoro=!0,this._backend="kokoro-js",this._isReady=!0,this._reportProgress({status:`TTS ready (${t}, ${s})`,progress:100}),console.log(`Kokoro TTS initialized: device=${t}, dtype=${s}`),!0}catch(i){if(console.warn("Kokoro TTS failed to load, using Web Speech fallback:",i),this._webSpeechSupported)return this._useKokoro=!1,this._backend="web-speech",this._isReady=!0,this._reportProgress({status:"Using browser TTS (fallback)"}),!1;throw new Error("No TTS engine available. Please use a browser that supports speech synthesis.")}finally{this._isLoading=!1}}async _initializeKokoro(e,t){this._reportProgress({status:"Loading Kokoro library...",progress:10});const{KokoroTTS:s}=await ye(async()=>{const{KokoroTTS:i}=await import("https://cdn.jsdelivr.net/npm/kokoro-js@1.1.0/+esm");return{KokoroTTS:i}},[]);this._reportProgress({status:`Initializing model (${e}, ${t})...`,progress:30}),this._kokoro=await s.from_pretrained("onnx-community/Kokoro-82M-v1.0-ONNX",{dtype:t,device:e}),this._reportProgress({status:"Model loaded",progress:100}),this._audioContext=new(window.AudioContext||window.webkitAudioContext)}_reportProgress(e){this._onProgress&&this._onProgress(e)}_showWebGPUWarning(){const e=`No WebGPU enabled. For better performance, launch Google Chrome with:

google-chrome --enable-unsafe-webgpu --ozone-platform=x11 --use-angle=vulkan --enable-features=Vulkan,VulkanFromANGLE`;console.warn("WebGPU not available. Using WASM backend (slower)."),console.info(e);const t=document.createElement("div");t.id="webgpu-warning",t.style.cssText=`
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90vw;
            padding: 12px 16px;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            font-size: 13px;
            color: #92400e;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `,t.innerHTML=`
            <div style="display: flex; align-items: flex-start; gap: 10px;">
                <span style="font-size: 18px;">⚠️</span>
                <div>
                    <strong>WebGPU not enabled</strong><br>
                    <span style="font-size: 12px;">Using slower WASM backend. For better performance, launch Chrome with:</span><br>
                    <code style="font-size: 11px; background: #fde68a; padding: 2px 4px; border-radius: 3px; word-break: break-all;">
                        google-chrome --enable-unsafe-webgpu --ozone-platform=x11 --use-angle=vulkan --enable-features=Vulkan,VulkanFromANGLE
                    </code>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 0; margin-left: auto;">×</button>
            </div>
        `,document.body.appendChild(t),setTimeout(()=>{t==null||t.remove()},15e3)}setBenchmarkEnabled(e){this._benchmarkEnabled=e,e||(this._benchmarkResults=[])}getBenchmarkResults(){return[...this._benchmarkResults]}getAverageRTF(){return this._benchmarkResults.length===0?null:this._benchmarkResults.reduce((t,s)=>t+s.rtf,0)/this._benchmarkResults.length}clearBenchmarks(){this._benchmarkResults=[]}async synthesize(e,t={}){if(this._isReady||await this.initialize(),!e||!e.trim())throw new Error("No text provided for synthesis");return this._backend==="kokoro-fastapi"?this._queueSynthesis(e,t):this._useKokoro?this._queueSynthesis(e,t):this._synthesizeWebSpeech(e,t)}_queueSynthesis(e,t){return new Promise((s,i)=>{this._synthesisQueue.push({text:e,options:t,resolve:s,reject:i}),this._processQueue()})}async _processQueue(){if(this._isSynthesizing||this._synthesisQueue.length===0)return;this._isSynthesizing=!0;const{text:e,options:t,resolve:s,reject:i}=this._synthesisQueue.shift();try{let n;this._backend==="kokoro-fastapi"?n=await this._synthesizeKokoroFastAPI(e,t):n=await this._synthesizeKokoro(e,t),s(n)}catch(n){i(n)}finally{this._isSynthesizing=!1,this._processQueue()}}async _synthesizeKokoro(e,t){const s=t.voice||this._currentVoice,i=t.speed||this._speed,n=zt(e,500);if(n.length>1)return console.log(`Splitting long sentence (${e.length} chars) into ${n.length} chunks`),await this._synthesizeChunks(n,s,i);const o=performance.now(),r=await this._kokoro.generate(e,{voice:s,speed:i}),a=performance.now()-o,l=r.audio,h=r.sampling_rate||this._sampleRate,d=this._audioContext.createBuffer(1,l.length,h);d.getChannelData(0).set(l);const p=l.length/h*1e3;if(this._benchmarkEnabled){const u=a/p,g={text:e.slice(0,50)+(e.length>50?"...":""),textLength:e.length,synthesisTimeMs:Math.round(a),audioDurationMs:Math.round(p),rtf:Math.round(u*1e3)/1e3,device:this._device};this._benchmarkResults.push(g),console.log(`TTS Benchmark: ${g.synthesisTimeMs}ms for ${g.audioDurationMs}ms audio (RTF: ${g.rtf})`)}return d}async _synthesizeChunks(e,t,s){const i=[];let n=0,o=this._sampleRate;for(let h=0;h<e.length;h++){const d=e[h];console.log(`  Chunk ${h+1}/${e.length}: "${d.substring(0,50)}..."`);const p=await this._kokoro.generate(d,{voice:t,speed:s}),u=p.audio;o=p.sampling_rate||this._sampleRate;const g=this._audioContext.createBuffer(1,u.length,o);g.getChannelData(0).set(u),i.push(g),n+=u.length}const r=this._audioContext.createBuffer(1,n,o),a=r.getChannelData(0);let l=0;for(const h of i){const d=h.getChannelData(0);a.set(d,l),l+=d.length}return console.log(`Concatenated ${e.length} chunks into ${n} samples`),r}async _synthesizeKokoroFastAPI(e,t){const s=t.voice||this._currentVoice,i=t.speed||this._speed,n=performance.now(),o=await fetch(`${this._fastApiUrl}/v1/audio/speech`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"kokoro",input:e,voice:s,speed:i,response_format:"wav"})});if(!o.ok)throw new Error(`Kokoro FastAPI error: ${o.status} ${o.statusText}`);const r=await o.arrayBuffer(),a=performance.now()-n;this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext));const l=await this._audioContext.decodeAudioData(r);if(this._benchmarkEnabled){const h=l.duration*1e3,d=a/h,p={text:e.slice(0,50)+(e.length>50?"...":""),textLength:e.length,synthesisTimeMs:Math.round(a),audioDurationMs:Math.round(h),rtf:Math.round(d*1e3)/1e3,device:"fastapi"};this._benchmarkResults.push(p),console.log(`TTS Benchmark (FastAPI): ${p.synthesisTimeMs}ms for ${p.audioDurationMs}ms audio (RTF: ${p.rtf})`)}return l}async _synthesizeWebSpeech(e,t){this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext));const s=this._audioContext.createBuffer(1,1,22050);return s._webSpeechText=e,s._webSpeechOptions=t,s._isWebSpeechFallback=!0,s}async runBenchmark(e){if(this._isReady||await this.initialize(),!this._useKokoro&&this._backend!=="kokoro-fastapi")throw new Error("Benchmarking only available with Kokoro TTS");const t=this._benchmarkEnabled;this._benchmarkEnabled=!0;const s=this._benchmarkResults.length;console.log(`Running benchmark on ${e.length} sentences...`);for(const r of e)await this.synthesize(r);const i=this._benchmarkResults.slice(s),n=i.reduce((r,a)=>r+a.rtf,0)/i.length;this._benchmarkEnabled=t;const o={results:i,averageRTF:Math.round(n*1e3)/1e3,device:this._device,dtype:this._dtype,totalSynthesisTime:i.reduce((r,a)=>r+a.synthesisTimeMs,0),totalAudioTime:i.reduce((r,a)=>r+a.audioDurationMs,0)};return console.log("Benchmark Summary:",o),o}async playBuffer(e,t=1){return this._audioContext&&this._audioContext.state==="suspended"&&await this._audioContext.resume(),e._isWebSpeechFallback?this._playWebSpeech(e._webSpeechText,t):new Promise((s,i)=>{const n=this._audioContext.createBufferSource();n.buffer=e,n.connect(this._audioContext.destination),this._currentSource=n,n.onended=()=>{this._currentSource=null,s()},n.onerror=o=>{this._currentSource=null,i(o)},n.start()})}stopAudio(){if(this._currentSource){try{this._currentSource.stop()}catch{}this._currentSource=null}this.stopWebSpeech()}_playWebSpeech(e,t){return new Promise((s,i)=>{const n=new SpeechSynthesisUtterance(e);n.rate=t,n.onend=()=>s(),n.onerror=o=>i(o),speechSynthesis.speak(n)})}stopWebSpeech(){this._webSpeechSupported&&speechSynthesis.cancel()}isReady(){return this._isReady}isUsingKokoro(){return this._useKokoro}getDevice(){return this._device}getDtype(){return this._dtype}getAvailableVoices(){if(this._useKokoro){const e=this._backend!=="kokoro-fastapi";return[{id:"af_alloy",name:"Alloy (American Female)"},{id:"af_aoede",name:"Aoede (American Female)"},{id:"af_bella",name:"Bella (American Female)"},{id:"af_heart",name:"Heart (American Female)"},{id:"af_jessica",name:"Jessica (American Female)"},{id:"af_kore",name:"Kore (American Female)"},{id:"af_nicole",name:"Nicole (American Female)"},{id:"af_nova",name:"Nova (American Female)"},{id:"af_river",name:"River (American Female)"},{id:"af_sarah",name:"Sarah (American Female)"},{id:"af_sky",name:"Sky (American Female)"},{id:"am_adam",name:"Adam (American Male)"},{id:"am_echo",name:"Echo (American Male)"},{id:"am_eric",name:"Eric (American Male)"},{id:"am_fenrir",name:"Fenrir (American Male)"},{id:"am_liam",name:"Liam (American Male)"},{id:"am_michael",name:"Michael (American Male)"},{id:"am_onyx",name:"Onyx (American Male)"},{id:"am_puck",name:"Puck (American Male)"},{id:"bf_alice",name:"Alice (British Female)"},{id:"bf_emma",name:"Emma (British Female)"},{id:"bf_isabella",name:"Isabella (British Female)"},{id:"bf_lily",name:"Lily (British Female)"},{id:"bm_daniel",name:"Daniel (British Male)"},{id:"bm_fable",name:"Fable (British Male)"},{id:"bm_george",name:"George (British Male)"},{id:"bm_lewis",name:"Lewis (British Male)"},{id:"jf_alpha",name:"Alpha (Japanese Female)",disabled:e},{id:"jf_gongitsune",name:"Gongitsune (Japanese Female)",disabled:e},{id:"jf_nezumi",name:"Nezumi (Japanese Female)",disabled:e},{id:"jm_kumo",name:"Kumo (Japanese Male)",disabled:e},{id:"zf_xiaobei",name:"Xiaobei (Chinese Female)",disabled:e},{id:"zf_xiaoni",name:"Xiaoni (Chinese Female)",disabled:e},{id:"zf_xiaoxuan",name:"Xiaoxuan (Chinese Female)",disabled:e},{id:"zm_yunjian",name:"Yunjian (Chinese Male)",disabled:e},{id:"zm_yunxi",name:"Yunxi (Chinese Male)",disabled:e},{id:"zm_yunyang",name:"Yunyang (Chinese Male)",disabled:e},{id:"ff_siwis",name:"Siwis (French Female)",disabled:e},{id:"hf_alpha",name:"Alpha (Hindi Female)",disabled:e},{id:"hf_beta",name:"Beta (Hindi Female)",disabled:e},{id:"hm_omega",name:"Omega (Hindi Male)",disabled:e},{id:"hm_psi",name:"Psi (Hindi Male)",disabled:e},{id:"if_sara",name:"Sara (Italian Female)",disabled:e},{id:"im_nicola",name:"Nicola (Italian Male)",disabled:e},{id:"pf_dora",name:"Dora (Portuguese Female)",disabled:e},{id:"pm_alex",name:"Alex (Portuguese Male)",disabled:e},{id:"pm_santa",name:"Santa (Portuguese Male)",disabled:e},{id:"sf_dalia",name:"Dalia (Spanish Female)",disabled:e},{id:"sm_agustin",name:"Agustin (Spanish Male)",disabled:e}]}else return speechSynthesis.getVoices().map(t=>({id:t.voiceURI,name:t.name}))}getVoiceForLanguage(e){const s={en:"af_",ja:"jf_",zh:"zf_",fr:"ff_",hi:"hf_",it:"if_",pt:"pf_",es:"sf_"}[e];if(!s)return null;const n=this.getAvailableVoices().find(o=>o.id.startsWith(s));return n?n.id:null}setVoice(e){this._currentVoice=e}setSpeed(e){this._speed=Math.max(.5,Math.min(2,e))}getSpeed(){return this._speed}getAudioContext(){return this._audioContext||(this._audioContext=new(window.AudioContext||window.webkitAudioContext)),this._audioContext}destroy(){this.stopWebSpeech(),this._audioContext&&(this._audioContext.close(),this._audioContext=null),this._kokoro=null,this._isReady=!1,this._isLoading=!1}}const f=new Bs,it="reading-partner-db",nt=3,b={BOOKS:"books",POSITIONS:"positions",BOOKMARKS:"bookmarks",SETTINGS:"settings",HIGHLIGHTS:"highlights",LOOKUPS:"lookups"};class As{constructor(){this._db=null}async init(){try{await this._openDatabase()}catch(e){console.warn("Database init failed, deleting and retrying:",e.message),await this._deleteDatabase(),await this._openDatabase()}}_deleteDatabase(){return new Promise((e,t)=>{const s=indexedDB.deleteDatabase(it);s.onsuccess=()=>{console.log("Database deleted for fresh creation"),e()},s.onerror=()=>t(new Error("Failed to delete database")),s.onblocked=()=>{console.warn("Database delete blocked, resolving anyway"),e()}})}_openDatabase(){return new Promise((e,t)=>{const s=indexedDB.open(it,nt);let i=!1;s.onerror=()=>{var n;console.error("Database open error:",s.error),t(new Error("Failed to open database: "+(((n=s.error)==null?void 0:n.message)||"unknown error")))},s.onblocked=()=>{i=!0,console.warn("Database upgrade blocked by another connection"),t(new Error("Database upgrade blocked"))},s.onsuccess=()=>{i||(this._db=s.result,this._db.onversionchange=()=>{this._db.close(),this._db=null,console.log("Database version changed in another tab, connection closed")},console.log("Storage service initialized"),e())},s.onupgradeneeded=n=>{const o=n.target.result;if(o.objectStoreNames.contains(b.BOOKS)||o.createObjectStore(b.BOOKS,{keyPath:"id"}).createIndex("lastOpened","lastOpened",{unique:!1}),o.objectStoreNames.contains(b.POSITIONS)||o.createObjectStore(b.POSITIONS,{keyPath:"bookId"}),o.objectStoreNames.contains(b.BOOKMARKS)||o.createObjectStore(b.BOOKMARKS,{keyPath:"id"}).createIndex("bookId","bookId",{unique:!1}),o.objectStoreNames.contains(b.SETTINGS)||o.createObjectStore(b.SETTINGS,{keyPath:"key"}),o.objectStoreNames.contains(b.HIGHLIGHTS)||o.createObjectStore(b.HIGHLIGHTS,{keyPath:"id"}).createIndex("bookId","bookId",{unique:!1}),!o.objectStoreNames.contains(b.LOOKUPS)){const r=o.createObjectStore(b.LOOKUPS,{keyPath:"id"});r.createIndex("bookId","bookId",{unique:!1}),r.createIndex("timestamp","timestamp",{unique:!1})}console.log("Database schema created/upgraded to version",nt)}})}async saveBook(e){const s=this._db.transaction([b.BOOKS],"readwrite").objectStore(b.BOOKS);return e.lastOpened=Date.now(),new Promise((i,n)=>{const o=s.put(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async getBook(e){const s=this._db.transaction([b.BOOKS],"readonly").objectStore(b.BOOKS);return new Promise((i,n)=>{const o=s.get(e);o.onsuccess=()=>i(o.result||null),o.onerror=()=>n(o.error)})}async getAllBooks(){const s=this._db.transaction([b.BOOKS],"readonly").objectStore(b.BOOKS).index("lastOpened");return new Promise((i,n)=>{const o=s.openCursor(null,"prev"),r=[];o.onsuccess=a=>{const l=a.target.result;l?(r.push(l.value),l.continue()):i(r)},o.onerror=()=>n(o.error)})}async deleteBook(e){const s=this._db.transaction([b.BOOKS],"readwrite").objectStore(b.BOOKS);return new Promise((i,n)=>{const o=s.delete(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async savePosition(e){const s=this._db.transaction([b.POSITIONS],"readwrite").objectStore(b.POSITIONS);return e.updatedAt=Date.now(),new Promise((i,n)=>{const o=s.put(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async getPosition(e){const s=this._db.transaction([b.POSITIONS],"readonly").objectStore(b.POSITIONS);return new Promise((i,n)=>{const o=s.get(e);o.onsuccess=()=>i(o.result||null),o.onerror=()=>n(o.error)})}async deletePosition(e){const s=this._db.transaction([b.POSITIONS],"readwrite").objectStore(b.POSITIONS);return new Promise((i,n)=>{const o=s.delete(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async addBookmark(e){const s=this._db.transaction([b.BOOKMARKS],"readwrite").objectStore(b.BOOKMARKS);return e.createdAt=e.createdAt||Date.now(),new Promise((i,n)=>{const o=s.put(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async getBookmarks(e){const i=this._db.transaction([b.BOOKMARKS],"readonly").objectStore(b.BOOKMARKS).index("bookId");return new Promise((n,o)=>{const r=i.getAll(e);r.onsuccess=()=>n(r.result||[]),r.onerror=()=>o(r.error)})}async deleteBookmark(e){const s=this._db.transaction([b.BOOKMARKS],"readwrite").objectStore(b.BOOKMARKS);return new Promise((i,n)=>{const o=s.delete(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async addHighlight(e){const s=this._db.transaction([b.HIGHLIGHTS],"readwrite").objectStore(b.HIGHLIGHTS);return e.createdAt=e.createdAt||Date.now(),new Promise((i,n)=>{const o=s.put(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async getHighlights(e){const i=this._db.transaction([b.HIGHLIGHTS],"readonly").objectStore(b.HIGHLIGHTS).index("bookId");return new Promise((n,o)=>{const r=i.getAll(e);r.onsuccess=()=>n(r.result||[]),r.onerror=()=>o(r.error)})}async deleteHighlight(e){const s=this._db.transaction([b.HIGHLIGHTS],"readwrite").objectStore(b.HIGHLIGHTS);return new Promise((i,n)=>{const o=s.delete(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async saveLookup(e){const s=this._db.transaction([b.LOOKUPS],"readwrite").objectStore(b.LOOKUPS);return e.timestamp=e.timestamp||Date.now(),new Promise((i,n)=>{const o=s.put(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async getLookups(e){const i=this._db.transaction([b.LOOKUPS],"readonly").objectStore(b.LOOKUPS).index("bookId");return new Promise((n,o)=>{const r=i.getAll(e);r.onsuccess=()=>{const a=r.result||[];a.sort((l,h)=>h.timestamp-l.timestamp),n(a)},r.onerror=()=>o(r.error)})}async getAllLookups(){const t=this._db.transaction([b.LOOKUPS],"readonly").objectStore(b.LOOKUPS);return new Promise((s,i)=>{const n=t.getAll();n.onsuccess=()=>{const o=n.result||[];o.sort((r,a)=>a.timestamp-r.timestamp),s(o)},n.onerror=()=>i(n.error)})}async deleteLookup(e){const s=this._db.transaction([b.LOOKUPS],"readwrite").objectStore(b.LOOKUPS);return new Promise((i,n)=>{const o=s.delete(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}async saveQuizQuestion(e,t,s){const i=`quiz_${e}_ch${t}`,n=await this.getSetting(i)||[];n.push(s),await this.saveSetting(i,n)}async getQuizQuestions(e,t){const s=`quiz_${e}_ch${t}`;return await this.getSetting(s)||[]}async getAllQuizQuestionsForBook(e,t){const s=[];for(let i=0;i<t;i++){const n=await this.getQuizQuestions(e,i);n.length>0&&s.push({chapterIndex:i,questions:n})}return s}async clearQuizQuestions(e,t){const s=`quiz_${e}_ch${t}`;await this.deleteSetting(s)}async saveSetting(e,t){const i=this._db.transaction([b.SETTINGS],"readwrite").objectStore(b.SETTINGS);return new Promise((n,o)=>{const r=i.put({key:e,value:t});r.onsuccess=()=>n(),r.onerror=()=>o(r.error)})}async getSetting(e){const s=this._db.transaction([b.SETTINGS],"readonly").objectStore(b.SETTINGS);return new Promise((i,n)=>{const o=s.get(e);o.onsuccess=()=>{const r=o.result;i(r?r.value:null)},o.onerror=()=>n(o.error)})}async getAllSettings(){const t=this._db.transaction([b.SETTINGS],"readonly").objectStore(b.SETTINGS);return new Promise((s,i)=>{const n=t.getAll();n.onsuccess=()=>{const o={};n.result.forEach(r=>{o[r.key]=r.value}),s(o)},n.onerror=()=>i(n.error)})}async deleteSetting(e){const s=this._db.transaction([b.SETTINGS],"readwrite").objectStore(b.SETTINGS);return new Promise((i,n)=>{const o=s.delete(e);o.onsuccess=()=>i(),o.onerror=()=>n(o.error)})}close(){this._db&&(this._db.close(),this._db=null)}}const _=new As;class xt{async askQuestion(e,t,s){throw new Error("Not implemented")}async askQuestionStreaming(e,t,s,i,n){throw new Error("Not implemented")}async lookupWord(e){throw new Error("Not implemented")}async generateQuizQuestion(e){throw new Error("Not implemented")}async streamQuizChat(e,t,s){throw new Error("Not implemented")}async generateText(e){throw new Error("Not implemented")}async isAvailable(){throw new Error("Not implemented")}abort(){}_extractCompleteSentences(e){const t=[];let s=e;const i=/[.!?]+[\s"')\]]*(?=\s|$)/g;let n,o=0;for(;(n=i.exec(e))!==null;){const r=n.index+n[0].length,a=e.slice(o,r).trim();a&&t.push(a),o=r}return s=e.slice(o),{complete:t,remaining:s}}_parseJSON(e){let t=e.trim();t=t.replace(/^```(?:json)?\s*/i,"").replace(/\s*```$/i,""),t=t.trim();try{return JSON.parse(t)}catch{const s=t.match(/\{[\s\S]*\}/);if(s)return JSON.parse(s[0]);throw new Error("Failed to parse JSON from response")}}}const Z={free:[{id:"openai/gpt-oss-120b:free",name:"GPT OSS 120B (Free)"},{id:"google/gemma-3-27b-it:free",name:"Gemma 3 27B (Free)"},{id:"nvidia/nemotron-3-nano-30b-a3b:free",name:"Nemotron 3 Nano 30B (Free)"},{id:"xiaomi/mimo-v2-flash:free",name:"MiMo V2 Flash (Free)"},{id:"z-ai/glm-4.5-air:free",name:"GLM 4.5 Air (Free)"}],paid:[{id:"google/gemini-2.5-flash-lite",name:"Gemini 2.5 Flash Lite"},{id:"openai/gpt-4o-mini",name:"GPT-4o Mini"},{id:"anthropic/claude-sonnet-4",name:"Claude Sonnet 4"},{id:"google/gemini-2.5-pro",name:"Gemini 2.5 Pro"},{id:"google/gemini-2.5-flash",name:"Gemini 2.5 Flash"},{id:"anthropic/claude-opus-4",name:"Claude Opus 4"},{id:"openai/gpt-4o",name:"GPT-4o"},{id:"openai/gpt-4-turbo",name:"GPT-4 Turbo"},{id:"deepseek/deepseek-chat",name:"DeepSeek V3"},{id:"meta-llama/llama-3.1-405b-instruct",name:"Llama 3.1 405B"}]},H="google/gemini-2.5-flash-lite";class Is extends xt{constructor(e=null,t=H){super(),this._apiKey=e,this._model=t,this._endpoint="https://openrouter.ai/api/v1/chat/completions",this._abortController=null}setApiKey(e){this._apiKey=e}getApiKey(){return this._apiKey}hasApiKey(){return!!(this._apiKey&&this._apiKey.trim())}setModel(e){this._model=e}getModel(){return this._model}getAvailableModels(){return Z}async isAvailable(){return this.hasApiKey()}abort(){this._abortController&&(this._abortController.abort(),this._abortController=null)}async _apiCall(e,t={}){var r;if(!this._apiKey)throw new Error("API key not set");const{maxTokens:s=500,temperature:i=.7,stream:n=!1}=t;this._abortController=new AbortController;let o;try{o=await fetch(this._endpoint,{method:"POST",headers:{Authorization:`Bearer ${this._apiKey}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"Reading Partner"},body:JSON.stringify({model:this._model,messages:e,max_tokens:s,temperature:i,stream:n}),signal:this._abortController.signal})}catch(a){throw a.name==="AbortError"?new Error("Request aborted"):a}if(!o.ok){const a=await o.json().catch(()=>({}));throw new Error(((r=a.error)==null?void 0:r.message)||`API error: ${o.status}`)}return o}async _streamResponse(e,t,s){var a,l,h;const i=e.body.getReader(),n=new TextDecoder;let o="",r="";try{for(;;){const{done:d,value:p}=await i.read();if(d){r.trim()&&(s==null||s(r.trim()));break}const g=n.decode(p,{stream:!0}).split(`
`);for(const m of g)if(m.startsWith("data: ")){const v=m.slice(6);if(v==="[DONE]")continue;try{const L=(h=(l=(a=JSON.parse(v).choices)==null?void 0:a[0])==null?void 0:l.delta)==null?void 0:h.content;if(L){o+=L,r+=L,t==null||t(L);const B=this._extractCompleteSentences(r);if(B.complete.length>0){for(const M of B.complete)s==null||s(M);r=B.remaining}}}catch{}}}}catch(d){if(d.name==="AbortError")return o;throw d}finally{this._abortController=null}return o}_buildSystemPrompt(e){let t="You are a helpful reading assistant. The user is reading a book";return e!=null&&e.title&&(t+=` titled "${e.title}"`,e.author&&(t+=` by ${e.author}`)),t+=" and has a question about it. Answer based on the provided context. Be concise and helpful. If the answer cannot be found in the context, say so.",t}_buildUserMessage(e,t,s){const i=e.join(" ");let n="";return s!=null&&s.title&&(n+=`Book: ${s.title}`,s.author&&(n+=` by ${s.author}`),n+=`

`),n+=`Context from the book:
"${i}"

Question: ${t}`,n}async askQuestion(e,t,s){const i=this._buildSystemPrompt(s),n=this._buildUserMessage(e,t,s);return(await(await this._apiCall([{role:"system",content:i},{role:"user",content:n}],{maxTokens:500,temperature:.7})).json()).choices[0].message.content}async askQuestionStreaming(e,t,s,i,n){const o=this._buildSystemPrompt(n),r=this._buildUserMessage(e,t,n),a=await this._apiCall([{role:"system",content:o},{role:"user",content:r}],{maxTokens:500,temperature:.7,stream:!0});return this._streamResponse(a,s,i)}async lookupWord(e){var u,g,m;if(!this._apiKey)throw new Error("API key not set");const{phrase:t,sentenceContext:s,targetLanguage:i="auto",bookMeta:n}=e;this._abortController=new AbortController;const r=`You are a multilingual dictionary and translation assistant for a reading app. The user has selected a word or phrase while reading.

${i==="auto"?"Determine the most helpful language for the user based on context. If the phrase is in a foreign language, translate to English. If it's in English, provide the definition in English.":`Translate/define for a reader whose native language is ${i}.`}

Respond with ONLY a valid JSON object (no markdown fences, no extra text):
{
  "phrase": "the exact phrase looked up",
  "sourceLanguage": "detected source language (e.g. English, Japanese, Norwegian)",
  "sourceLanguageCode": "ISO 639-1 code (e.g. en, ja, no, nl, zh, fr)",
  "partOfSpeech": "noun/verb/adjective/etc. or null if not applicable",
  "pronunciation": "pronunciation guide (IPA or romanization for non-Latin scripts, e.g. furigana for Japanese)",
  "definition": "clear, concise definition in the source language",
  "translation": "translation into the target language, or null if source=target",
  "exampleSentence": "a short example sentence using the phrase, or null",
  "domain": "specialized domain if applicable (e.g. biomedical, legal, computing), or null",
  "notes": "any additional useful context (etymology, usage notes, cultural context), or null"
}

Requirements:
- For Japanese/Chinese: include romanization (romaji/pinyin) in pronunciation
- For technical/biomedical terms: always fill the domain field and give a clear layperson explanation
- Keep definitions concise (1-2 sentences)
- If the phrase is idiomatic, explain the idiomatic meaning`;let a="";n!=null&&n.title&&(a+=`Book: ${n.title}`,n.author&&(a+=` by ${n.author}`),a+=`

`),a+=`Phrase to look up: "${t}"`,s&&(a+=`

Context sentence: "${s}"`);const d=((m=(g=(u=(await(await this._apiCall([{role:"system",content:r},{role:"user",content:a}],{maxTokens:500,temperature:.3})).json()).choices)==null?void 0:u[0])==null?void 0:g.message)==null?void 0:m.content)||"",p=this._parseJSON(d);if(!p.phrase||!p.definition)throw new Error("Missing required fields (phrase, definition)");return p}async generateQuizQuestion(e){var v,S,L;if(!this._apiKey)throw new Error("API key not set");const{contextSentences:t,bookMeta:s,isMultipleChoice:i=!0,questionTypes:n=["factual"],previousQuestions:o=[],customSystemPrompt:r=""}=e;this._abortController=new AbortController;const a=t.join(" "),l=n.join(", ");let h;r?h=r:(h=`You are a quiz master for reading comprehension. Generate a single quiz question based on the provided book context.

Question type(s) to choose from: ${l}.`,o.length>0&&(h+=`

IMPORTANT: The user has already been asked ${o.length} question(s) in this session. You MUST generate a different question that does not repeat or closely paraphrase any previously asked question. Vary the topic, focus, and angle of your question.`),i?h+=`

Respond with ONLY a valid JSON object (no markdown fences, no extra text):
{
  "question": "the question text",
  "options": ["option A", "option B", "option C", "option D"],
  "correctIndex": 0,
  "explanation": "brief explanation of the correct answer"
}

Requirements:
- Exactly 4 options
- correctIndex is 0-3 indicating the correct option
- Make wrong options plausible but clearly incorrect
- Keep the explanation concise (1-2 sentences)`:h+=`

Respond with ONLY a valid JSON object (no markdown fences, no extra text):
{
  "question": "the question text"
}

Requirements:
- Ask an open-ended question that requires a thoughtful answer
- The question should be answerable from the provided context`);let d="";if(s!=null&&s.title&&(d+=`Book: ${s.title}`,s.author&&(d+=` by ${s.author}`),d+=`

`),d+=`Context from the book:
"${a}"`,o.length>0){const B=o.map(M=>M.question).join(`
- `);d+=`

Previously asked questions (do NOT repeat these):
- ${B}`}const g=((L=(S=(v=(await(await this._apiCall([{role:"system",content:h},{role:"user",content:d}],{maxTokens:500,temperature:.8})).json()).choices)==null?void 0:v[0])==null?void 0:S.message)==null?void 0:L.content)||"",m=this._parseJSON(g);if(!m.question||typeof m.question!="string")throw new Error("Missing or invalid question field");if(i){if(!Array.isArray(m.options)||m.options.length!==4)throw new Error("Missing or invalid options (need exactly 4)");if(typeof m.correctIndex!="number"||m.correctIndex<0||m.correctIndex>3)throw new Error("Missing or invalid correctIndex (need 0-3)");m.explanation||(m.explanation="No explanation provided.")}return m}async streamQuizChat(e,t,s){const i=await this._apiCall(e,{maxTokens:500,temperature:.7,stream:!0});return this._streamResponse(i,t,s)}async generateText(e){var S,L,B;if(!this._apiKey)throw new Error("API key not set");const{description:t,language:s,length:i,format:n,genre:o}=e;this._abortController=new AbortController;const r={short:"~300",medium:"~1000",long:"~3000"},a=r[i]||r.medium;let l="";o&&o!=="none"&&(l=`
The genre/style should be: ${{short_story:"a short story",essay:"an essay",news_article:"a news article",childrens_story:"a children's story",technical:"a technical document",blog_post:"a blog post",letter:"a letter",poem:"a poem",dialogue:"a dialogue"}[o]||o}.`);let h;n==="html"?h="Write the content as valid HTML (do NOT include <html>, <head>, or <body> tags — just the inner content starting with headings, paragraphs, etc.). You may use <ruby> tags for furigana where appropriate for Japanese text. Use semantic HTML elements like <h1>, <h2>, <p>, <ul>, <ol>, <blockquote>, etc.":h="Write the content in Markdown format. Use headings (#, ##), paragraphs, lists, blockquotes, and other Markdown formatting as appropriate.";const d=`You are a creative text generator for a reading application. Generate a text based on the user's description.

${h}

Requirements:
- Write entirely in ${s}
- Target length: ${a} words${l}
- Use section headings to structure longer texts
- The text should be well-written, engaging, and suitable for reading practice

Respond with ONLY a valid JSON object (no markdown fences, no extra text):
{
  "title": "a concise, descriptive title for the text in ${s}",
  "content": "the full ${n} content of the text"
}`,p=i==="long"?8e3:i==="medium"?4e3:1500,m=((B=(L=(S=(await(await this._apiCall([{role:"system",content:d},{role:"user",content:`Generate a text about: ${t}`}],{maxTokens:p,temperature:.8})).json()).choices)==null?void 0:S[0])==null?void 0:L.message)==null?void 0:B.content)||"",v=this._parseJSON(m);if(!v.title||!v.content)throw new Error("Missing required fields (title, content)");return{title:v.title,content:v.content}}async validateApiKey(e){try{return(await fetch(this._endpoint,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"Reading Partner"},body:JSON.stringify({model:H,messages:[{role:"user",content:"Hi"}],max_tokens:1})})).ok}catch{return!1}}}const Ct=[{id:"HuggingFaceTB/SmolLM2-360M-Instruct",name:"SmolLM2 360M (Recommended)",size:"~250 MB"},{id:"HuggingFaceTB/SmolLM2-135M-Instruct",name:"SmolLM2 135M (Faster)",size:"~100 MB"},{id:"HuggingFaceTB/SmolLM2-1.7B-Instruct",name:"SmolLM2 1.7B (Better Quality)",size:"~925 MB"}],Ce="HuggingFaceTB/SmolLM2-360M-Instruct";class qs extends xt{constructor(){super(),this._worker=null,this._isReady=!1,this._isLoading=!1,this._model=Ce,this._device="auto",this._dtype="q4f16",this.onModelProgress=null}setModel(e){var t;e!==this._model&&(this._model=e,this._isReady&&(this._isReady=!1,(t=this._worker)==null||t.postMessage({type:"unload"})))}getModel(){return this._model}setDevice(e){this._device=e}getAvailableModels(){return Ct}isModelReady(){return this._isReady}isModelLoading(){return this._isLoading}async isAvailable(){return this._isReady}async loadModel(){if(!this._isReady)return this._isLoading?new Promise((e,t)=>{const s=setInterval(()=>{this._isReady?(clearInterval(s),e()):this._isLoading||(clearInterval(s),t(new Error("Model loading failed")))},100)}):(this._isLoading=!0,new Promise((e,t)=>{this._worker=new Worker(new URL("/reading-partner/pr-previews/pr-43/assets/llm-worker-B9Rbj1E3.js",import.meta.url),{type:"module"}),this._worker.onmessage=s=>{var o;const{type:i,...n}=s.data;i==="loading"?(o=this.onModelProgress)==null||o.call(this,n.progress):i==="ready"?(this._isReady=!0,this._isLoading=!1,e()):i==="error"&&this._isLoading&&(this._isLoading=!1,t(new Error(n.error)))},this._worker.onerror=s=>{this._isLoading=!1,t(new Error(`Worker error: ${s.message}`))},this._worker.postMessage({type:"load",model:this._model,device:this._device,dtype:this._dtype})}))}unloadModel(){this._worker&&(this._worker.postMessage({type:"unload"}),this._isReady=!1)}destroy(){this._worker&&(this._worker.terminate(),this._worker=null),this._isReady=!1,this._isLoading=!1}abort(){var e;(e=this._worker)==null||e.postMessage({type:"abort"})}async _generate(e,t={},s,i){return this._isReady||await this.loadModel(),new Promise((n,o)=>{let r="",a="";const l=h=>{const{type:d,...p}=h.data;switch(d){case"token":{if(r+=p.token,a+=p.token,s==null||s(p.token),i){const u=this._extractCompleteSentences(a);if(u.complete.length>0){for(const g of u.complete)i(g);a=u.remaining}}break}case"complete":this._worker.removeEventListener("message",l),i&&a.trim()&&i(a.trim()),n(p.text||r);break;case"aborted":this._worker.removeEventListener("message",l),n(p.text||r);break;case"error":this._worker.removeEventListener("message",l),o(new Error(p.error));break}};this._worker.addEventListener("message",l),this._worker.postMessage({type:"generate",messages:e,max_new_tokens:t.maxTokens||512,temperature:t.temperature||.7,do_sample:t.temperature>0,...t})})}_buildSystemPrompt(e){let t="You are a helpful reading assistant.";return e!=null&&e.title&&(t+=` The user is reading "${e.title}"`,e.author&&(t+=` by ${e.author}`),t+="."),t+=" Answer based on the provided context. Be concise.",t}_buildUserMessage(e,t,s){return`Context: "${e.join(" ")}"

Question: ${t}`}async askQuestion(e,t,s){const i=[{role:"system",content:this._buildSystemPrompt(s)},{role:"user",content:this._buildUserMessage(e,t,s)}];return this._generate(i,{maxTokens:256,temperature:.7})}async askQuestionStreaming(e,t,s,i,n){const o=[{role:"system",content:this._buildSystemPrompt(n)},{role:"user",content:this._buildUserMessage(e,t,n)}];return this._generate(o,{maxTokens:256,temperature:.7},s,i)}async lookupWord(e){const{phrase:t,sentenceContext:s,targetLanguage:i="auto",bookMeta:n}=e,r=`You are a dictionary assistant. ${i==="auto"?"If the phrase is in a foreign language, translate to English. If it's in English, provide the definition in English.":`Define/translate for a ${i} speaker.`}
Respond with ONLY valid JSON:
{"phrase":"the phrase","sourceLanguage":"language name","sourceLanguageCode":"code","partOfSpeech":"type or null","pronunciation":"guide or null","definition":"concise definition","translation":"translation or null","exampleSentence":"example or null","domain":"domain or null","notes":"notes or null"}`;let a=`Look up: "${t}"`;s&&(a+=`
Context: "${s}"`);const l=[{role:"system",content:r},{role:"user",content:a}],h=await this._generate(l,{maxTokens:256,temperature:.3}),d=this._parseJSON(h);if(!d.phrase||!d.definition)throw new Error("Missing required fields (phrase, definition)");return d}async generateQuizQuestion(e){const{contextSentences:t,bookMeta:s,isMultipleChoice:i=!0,questionTypes:n=["factual"],previousQuestions:o=[],customSystemPrompt:r=""}=e,a=t.join(" "),l=n.join(", ");let h;r?h=r:i?h=`Generate a ${l} quiz question about the text. Respond with ONLY valid JSON:
{"question":"question text","options":["A","B","C","D"],"correctIndex":0,"explanation":"why"}
Requirements: exactly 4 options, correctIndex 0-3.`:h=`Generate a ${l} open-ended question about the text. Respond with ONLY valid JSON:
{"question":"question text"}`,o.length>0&&(h+=`
Do NOT repeat these questions: ${o.map(g=>g.question).join("; ")}`);const d=[{role:"system",content:h},{role:"user",content:`Text: "${a}"`}],p=await this._generate(d,{maxTokens:300,temperature:.8}),u=this._parseJSON(p);if(!u.question)throw new Error("Missing question field");if(i){if(!Array.isArray(u.options)||u.options.length!==4)throw new Error("Invalid options (need exactly 4)");if(typeof u.correctIndex!="number")throw new Error("Missing correctIndex");u.explanation||(u.explanation="No explanation provided.")}return u}async streamQuizChat(e,t,s){return this._generate(e,{maxTokens:256,temperature:.7},t,s)}async generateText(e){const{description:t,language:s,length:i,format:n,genre:o}=e,r={short:"~300",medium:"~1000",long:"~3000"},a=r[i]||r.medium,l=i==="long"?4e3:i==="medium"?2e3:800;let h=o&&o!=="none"?` in the style of ${o}`:"";const p=[{role:"system",content:`Generate a ${n} text in ${s}, ${a} words${h}. Respond with ONLY valid JSON:
{"title":"title in ${s}","content":"the full ${n} content"}`},{role:"user",content:`Write about: ${t}`}],u=await this._generate(p,{maxTokens:l,temperature:.8}),g=this._parseJSON(u);if(!g.title||!g.content)throw new Error("Missing required fields (title, content)");return{title:g.title,content:g.content}}}class Ms{constructor(e=null,t=H){this._openRouterProvider=new Is(e,t),this._localProvider=new qs,this._backend="openrouter",this.onModelProgress=null}getBackend(){return this._backend}setBackend(e){this._backend=e}_getProvider(){return this._backend==="local"?this._localProvider:this._openRouterProvider}getOpenRouterProvider(){return this._openRouterProvider}getLocalProvider(){return this._localProvider}setApiKey(e){this._openRouterProvider.setApiKey(e)}getApiKey(){return this._openRouterProvider.getApiKey()}hasApiKey(){return this._openRouterProvider.hasApiKey()}setModel(e){this._openRouterProvider.setModel(e)}getModel(){return this._openRouterProvider.getModel()}getAvailableModels(){return this._openRouterProvider.getAvailableModels()}setLocalModel(e){this._localProvider.setModel(e)}getLocalModel(){return this._localProvider.getModel()}setLocalDevice(e){this._localProvider.setDevice(e)}getLocalAvailableModels(){return this._localProvider.getAvailableModels()}isLocalModelReady(){return this._localProvider.isModelReady()}isLocalModelLoading(){return this._localProvider.isModelLoading()}async loadLocalModel(){return this._localProvider.onModelProgress=e=>{var t;(t=this.onModelProgress)==null||t.call(this,e)},this._localProvider.loadModel()}unloadLocalModel(){this._localProvider.unloadModel()}async askQuestion(e,t,s){return this._getProvider().askQuestion(e,t,s)}async askQuestionStreaming(e,t,s,i,n){return this._getProvider().askQuestionStreaming(e,t,s,i,n)}async lookupWord(e){return this._getProvider().lookupWord(e)}async generateQuizQuestion(e){return this._getProvider().generateQuizQuestion(e)}async streamQuizChat(e,t,s){return this._getProvider().streamQuizChat(e,t,s)}async generateText(e){return this._getProvider().generateText(e)}abort(){this._getProvider().abort()}async validateApiKey(e){return this._openRouterProvider.validateApiKey(e)}}const w=new Ms;class zs{constructor(){this._recognition=null,this._isSupported=!1,this._isListening=!1,this._silenceTimer=null,this._silenceTimeout=3e3,this.onInterimResult=null,this.onError=null,this.onStart=null,this.onEnd=null,this._initRecognition()}_initRecognition(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){console.warn("Web Speech API not supported"),this._isSupported=!1;return}this._isSupported=!0,this._recognition=new e,this._recognition.continuous=!0,this._recognition.interimResults=!0,this._recognition.lang="en-US",this._recognition.maxAlternatives=1}isSupported(){return this._isSupported}isListening(){return this._isListening}setSilenceTimeout(e){this._silenceTimeout=e}startListening(){return new Promise((e,t)=>{if(!this._isSupported){t(new Error("Speech recognition not supported"));return}if(this._isListening){t(new Error("Already listening"));return}this._isListening=!0;let s="",i=!1;const n=()=>{clearTimeout(this._silenceTimer),this._silenceTimer=setTimeout(()=>{this._isListening&&this._recognition.stop()},this._silenceTimeout)};this._recognition.onstart=()=>{var o;console.log("STT: Started listening"),(o=this.onStart)==null||o.call(this),n()},this._recognition.onresult=o=>{var l;const r=o.results[o.results.length-1],a=r[0].transcript;r.isFinal&&(s=a,i=!0),n(),a&&((l=this.onInterimResult)==null||l.call(this,a))},this._recognition.onerror=o=>{var a;if(console.error("STT Error:",o.error),clearTimeout(this._silenceTimer),o.error==="no-speech")return;this._isListening=!1;let r="Speech recognition error";switch(o.error){case"not-allowed":case"permission-denied":r="Microphone permission denied";break;case"audio-capture":r="No microphone found";break;case"network":r="Network error occurred";break;case"aborted":r="Speech recognition aborted";break}(a=this.onError)==null||a.call(this,o.error,r),t(new Error(r))},this._recognition.onend=()=>{var o;console.log("STT: Stopped listening"),clearTimeout(this._silenceTimer),this._isListening=!1,(o=this.onEnd)==null||o.call(this),i&&s.trim()?e(s.trim()):i||t(new Error("No speech detected"))};try{this._recognition.start()}catch(o){clearTimeout(this._silenceTimer),this._isListening=!1,t(o)}})}stopListening(){clearTimeout(this._silenceTimer),this._recognition&&this._isListening&&this._recognition.stop()}abortListening(){clearTimeout(this._silenceTimer),this._recognition&&this._isListening&&this._recognition.abort()}setLanguage(e){this._recognition&&(this._recognition.lang=e)}async requestPermission(){try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(t=>t.stop()),!0}catch(e){return console.error("Microphone permission denied:",e),!1}}}const V=new zs,Tt=[{id:"onnx-community/whisper-tiny.en",name:"Whisper Tiny (English)",size:"~75 MB"},{id:"onnx-community/whisper-base.en",name:"Whisper Base (English)",size:"~150 MB"},{id:"onnx-community/whisper-small.en",name:"Whisper Small (English)",size:"~470 MB"},{id:"onnx-community/whisper-tiny",name:"Whisper Tiny (Multilingual)",size:"~75 MB"},{id:"onnx-community/whisper-base",name:"Whisper Base (Multilingual)",size:"~150 MB"}],Te="onnx-community/whisper-tiny.en";class ve{constructor(){this._worker=null,this._isReady=!1,this._isLoading=!1,this._isListening=!1,this._silenceTimeout=3e3,this._mediaStream=null,this._audioContext=null,this._analyser=null,this._processor=null,this._audioChunks=[],this._silenceTimer=null,this._model=Te,this._device="auto",this.onInterimResult=null,this.onError=null,this.onStart=null,this.onEnd=null,this.onModelProgress=null}isSupported(){var e;return!!((e=navigator.mediaDevices)!=null&&e.getUserMedia&&typeof Worker<"u")}isListening(){return this._isListening}isModelReady(){return this._isReady}isModelLoading(){return this._isLoading}setSilenceTimeout(e){this._silenceTimeout=e}setModel(e){var t;e!==this._model&&(this._model=e,this._isReady&&(this._isReady=!1,(t=this._worker)==null||t.postMessage({type:"unload"})))}getModel(){return this._model}setDevice(e){this._device=e}getAvailableModels(){return Tt}async loadModel(){if(!this._isReady)return this._isLoading?new Promise((e,t)=>{const s=setInterval(()=>{this._isReady?(clearInterval(s),e()):this._isLoading||(clearInterval(s),t(new Error("Model loading failed")))},100)}):(this._isLoading=!0,new Promise((e,t)=>{this._worker=new Worker(new URL("/reading-partner/pr-previews/pr-43/assets/whisper-worker-C9-ZjuGI.js",import.meta.url),{type:"module"}),this._worker.onmessage=s=>{var o;const{type:i,...n}=s.data;switch(i){case"loading":(o=this.onModelProgress)==null||o.call(this,n.progress);break;case"ready":this._isReady=!0,this._isLoading=!1,e();break;case"error":this._isLoading=!1,t(new Error(n.error));break}},this._worker.onerror=s=>{this._isLoading=!1,t(new Error(`Worker error: ${s.message}`))},this._worker.postMessage({type:"load",model:this._model,device:this._device})}))}startListening(){return new Promise(async(e,t)=>{var s,i,n;if(!this.isSupported()){t(new Error("Whisper STT not supported in this browser"));return}if(this._isListening){t(new Error("Already listening"));return}try{this._isReady||await this.loadModel(),this._isListening=!0,this._audioChunks=[],this._mediaStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:16e3}}),this._audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3});const o=this._audioContext.createMediaStreamSource(this._mediaStream);this._analyser=this._audioContext.createAnalyser(),this._analyser.fftSize=2048,this._analyser.smoothingTimeConstant=.8,o.connect(this._analyser),this._processor=this._audioContext.createScriptProcessor(4096,1,1),o.connect(this._processor),this._processor.connect(this._audioContext.destination),this._processor.onaudioprocess=r=>{if(!this._isListening)return;const a=r.inputBuffer.getChannelData(0);this._audioChunks.push(new Float32Array(a))},(s=this.onStart)==null||s.call(this),(i=this.onInterimResult)==null||i.call(this,"Listening..."),this._startSilenceDetection(()=>{this._stopRecording().then(r=>{var l,h;if(!r||r.length<1600){this._isListening=!1,(l=this.onEnd)==null||l.call(this),t(new Error("No speech detected"));return}(h=this.onInterimResult)==null||h.call(this,"Transcribing...");const a=d=>{var g,m,v,S;const{type:p,...u}=d.data;p==="result"?(this._worker.removeEventListener("message",a),this._isListening=!1,(g=this.onEnd)==null||g.call(this),u.text&&u.text.trim()?((m=this.onInterimResult)==null||m.call(this,u.text),e(u.text)):t(new Error("No speech detected"))):p==="error"&&(this._worker.removeEventListener("message",a),this._isListening=!1,(v=this.onEnd)==null||v.call(this),(S=this.onError)==null||S.call(this,"transcription-error",u.error),t(new Error(u.error)))};this._worker.addEventListener("message",a),this._worker.postMessage({type:"transcribe",audio:r})})})}catch(o){this._isListening=!1,this._cleanup();let r="Microphone error";o.name==="NotAllowedError"?r="Microphone permission denied":o.name==="NotFoundError"&&(r="No microphone found"),(n=this.onError)==null||n.call(this,"audio-capture",r),t(new Error(r))}})}stopListening(){this._isListening&&(clearTimeout(this._silenceTimer),cancelAnimationFrame(this._silenceRAF),this._stopRecording())}abortListening(){var e;this._isListening=!1,clearTimeout(this._silenceTimer),cancelAnimationFrame(this._silenceRAF),this._cleanup(),(e=this.onEnd)==null||e.call(this)}setLanguage(e){this._language=e}async requestPermission(){try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(t=>t.stop()),!0}catch{return!1}}unloadModel(){this._worker&&(this._worker.postMessage({type:"unload"}),this._isReady=!1)}destroy(){this.abortListening(),this._worker&&(this._worker.terminate(),this._worker=null),this._isReady=!1,this._isLoading=!1}_startSilenceDetection(e){const t=this._analyser.frequencyBinCount,s=new Uint8Array(t);let i=null,n=!1;const o=()=>{if(!this._isListening)return;this._analyser.getByteFrequencyData(s);let r=0;for(let h=0;h<t;h++)r+=s[h];if(r/t>10)n=!0,i=null;else if(n){if(i===null)i=Date.now();else if(Date.now()-i>=this._silenceTimeout){e();return}}else if(i===null)i=Date.now();else if(Date.now()-i>=this._silenceTimeout*2){e();return}this._silenceRAF=requestAnimationFrame(o)};this._silenceRAF=requestAnimationFrame(o)}async _stopRecording(){this._isListening=!1;const e=this._audioChunks.reduce((i,n)=>i+n.length,0),t=new Float32Array(e);let s=0;for(const i of this._audioChunks)t.set(i,s),s+=i.length;return this._audioChunks=[],this._cleanup(),t}_cleanup(){this._processor&&(this._processor.disconnect(),this._processor=null),this._analyser&&(this._analyser.disconnect(),this._analyser=null),this._audioContext&&(this._audioContext.close().catch(()=>{}),this._audioContext=null),this._mediaStream&&(this._mediaStream.getTracks().forEach(e=>e.stop()),this._mediaStream=null)}}class Rs{constructor(){this._container=null,this._onCancel=null,this._isVisible=!1,this._currentFiles=new Map,this._createDOM()}async promptDownload({modelName:e,modelSize:t,purpose:s}){return new Promise(i=>{this._titleEl.textContent=`Download ${s} Model`,this._messageEl.textContent=`"${e}" needs to be downloaded (${t}). The model will be cached in your browser for future use.`,this._progressSection.classList.add("hidden"),this._promptSection.classList.remove("hidden"),this._doneSection.classList.add("hidden"),this._confirmBtn.onclick=()=>{i(!0),this._showProgress()},this._cancelBtn.onclick=()=>{i(!1),this.hide()},this._show()})}showProgress(e="Downloading Model"){this._titleEl.textContent=e,this._showProgress(),this._show()}updateProgress(e){if(e.status&&(this._statusEl.textContent=e.status),e.file&&e.total){this._currentFiles.set(e.file,{loaded:e.loaded||0,total:e.total});let t=0,s=0;for(const[,n]of this._currentFiles)t+=n.loaded,s+=n.total;const i=s>0?Math.round(t/s*100):0;this._progressBar.style.width=`${i}%`,this._progressText.textContent=`${this._formatBytes(t)} / ${this._formatBytes(s)} (${i}%)`}e.progress!==void 0&&!e.file&&(this._progressBar.style.width=`${Math.round(e.progress)}%`)}showComplete(e="Model downloaded successfully!"){this._progressSection.classList.add("hidden"),this._promptSection.classList.add("hidden"),this._doneSection.classList.remove("hidden"),this._doneMessage.textContent=e,setTimeout(()=>this.hide(),2e3)}showError(e){this._statusEl.textContent=`Error: ${e}`,this._statusEl.classList.add("error"),this._progressBar.classList.add("error")}onCancel(e){this._onCancel=e}hide(){this._isVisible=!1,this._container.classList.add("hidden"),this._container.classList.remove("visible"),this._currentFiles.clear(),this._statusEl.classList.remove("error"),this._progressBar.classList.remove("error")}_show(){this._isVisible=!0,this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("visible")}_showProgress(){this._promptSection.classList.add("hidden"),this._doneSection.classList.add("hidden"),this._progressSection.classList.remove("hidden"),this._progressBar.style.width="0%",this._progressText.textContent="Starting download...",this._statusEl.textContent="Preparing...",this._currentFiles.clear()}_createDOM(){this._container=document.createElement("div"),this._container.className="model-download-modal hidden",this._container.innerHTML=`
            <div class="model-download-backdrop"></div>
            <div class="model-download-dialog">
                <h3 class="model-download-title"></h3>

                <!-- Prompt section -->
                <div class="model-download-prompt">
                    <p class="model-download-message"></p>
                    <div class="model-download-actions">
                        <button class="model-download-cancel-btn">Cancel</button>
                        <button class="model-download-confirm-btn">Download</button>
                    </div>
                </div>

                <!-- Progress section -->
                <div class="model-download-progress hidden">
                    <div class="model-download-status"></div>
                    <div class="model-download-bar-container">
                        <div class="model-download-bar"></div>
                    </div>
                    <div class="model-download-progress-text"></div>
                </div>

                <!-- Done section -->
                <div class="model-download-done hidden">
                    <div class="model-download-done-message"></div>
                </div>
            </div>
        `,this._titleEl=this._container.querySelector(".model-download-title"),this._messageEl=this._container.querySelector(".model-download-message"),this._promptSection=this._container.querySelector(".model-download-prompt"),this._progressSection=this._container.querySelector(".model-download-progress"),this._doneSection=this._container.querySelector(".model-download-done"),this._doneMessage=this._container.querySelector(".model-download-done-message"),this._confirmBtn=this._container.querySelector(".model-download-confirm-btn"),this._cancelBtn=this._container.querySelector(".model-download-cancel-btn"),this._statusEl=this._container.querySelector(".model-download-status"),this._progressBar=this._container.querySelector(".model-download-bar"),this._progressText=this._container.querySelector(".model-download-progress-text"),this._container.querySelector(".model-download-backdrop").addEventListener("click",()=>{var e;this._progressSection.classList.contains("hidden")&&((e=this._onCancel)==null||e.call(this),this.hide())}),document.body.appendChild(this._container)}_formatBytes(e){if(e===0)return"0 B";const t=1024,s=["B","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(1))+" "+s[i]}}const E=new Rs;function ot(c){const s=8e3*c,i=44+s,n=new ArrayBuffer(i),o=new DataView(n),r=(h,d)=>{for(let p=0;p<d.length;p++)o.setUint8(h+p,d.charCodeAt(p))};r(0,"RIFF"),o.setUint32(4,i-8,!0),r(8,"WAVE"),r(12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,8e3,!0),o.setUint32(28,8e3,!0),o.setUint16(32,1,!0),o.setUint16(34,8,!0),r(36,"data"),o.setUint32(40,s,!0);for(let h=44;h<i;h++)o.setUint8(h,124+Math.floor(Math.random()*9));const a=new Uint8Array(n);let l="";for(let h=0;h<a.length;h++)l+=String.fromCharCode(a[h]);return"data:audio/wav;base64,"+btoa(l)}class Hs{constructor(){this._isSupported="mediaSession"in navigator,this._isInitialized=!1,this._isQAModeActive=!1,this._onPlay=null,this._onPause=null,this._onEnterQAMode=null,this._onExitQAMode=null,this._onQAPlayPause=null,this._onQANextQuestion=null,this._bookTitle="",this._chapterTitle="",this._author="",this._silentAudio=null,this._hasUserInteraction=!1,this._volume=.01,this._duration=300,this._isAndroid=/Android/i.test(navigator.userAgent)}isSupported(){return this._isSupported}configure({volume:e,duration:t}={}){const s=e!==void 0&&e!==this._volume,i=t!==void 0&&t!==this._duration;if(e!==void 0&&(this._volume=e),t!==void 0&&(this._duration=t),this._silentAudio&&(s&&(this._silentAudio.volume=this._volume),i)){const n=!this._silentAudio.paused;this._silentAudio.src=ot(this._duration),this._silentAudio.load(),n&&this._silentAudio.play().catch(()=>{})}}initialize({onPlay:e,onPause:t,onEnterQAMode:s,onExitQAMode:i,onQAPlayPause:n,onQANextQuestion:o}){if(!this._isSupported){console.warn("Media Session API not supported");return}this._onPlay=e,this._onPause=t,this._onEnterQAMode=s,this._onExitQAMode=i,this._onQAPlayPause=n,this._onQANextQuestion=o,this._createSilentAudio(),this._setupActionHandlers(),this._isInitialized=!0,console.log("Media Session Manager initialized"),console.log("Media Session debug: Call mediaSessionManager.diagnose() for diagnostic info")}_createSilentAudio(){this._silentAudio||(this._silentAudio=document.createElement("audio"),this._silentAudio.src=ot(this._duration),this._silentAudio.loop=!0,this._silentAudio.volume=this._volume,this._silentAudio.preload="auto",this._silentAudio.addEventListener("play",()=>{console.log("Media Session: Audio element started PLAYING")}),this._silentAudio.addEventListener("pause",()=>{console.log("Media Session: Audio element PAUSED")}),this._silentAudio.addEventListener("error",e=>{console.error("Media Session: Audio error",e.target.error)}),this._silentAudio.load())}_setupActionHandlers(){navigator.mediaSession.setActionHandler("play",async()=>{var t,s;if(console.log("Media Session: PLAY action received"),this._isQAModeActive){console.log("Media Session: Play in Q&A mode - delegating to exit Q&A"),(t=this._onQAPlayPause)==null||t.call(this);return}const e=navigator.mediaSession.playbackState;if(console.log(`Media Session: Current state is '${e}'`),e==="paused"||e==="none"){try{this._silentAudio.paused&&await this._silentAudio.play()}catch(i){console.warn("Media Session: Could not play audio:",i.message)}navigator.mediaSession.playbackState="playing",(s=this._onPlay)==null||s.call(this)}else console.log("Media Session: Already playing, ignoring duplicate play")}),navigator.mediaSession.setActionHandler("pause",()=>{var t,s,i;if(console.log("Media Session: PAUSE action received"),this._isQAModeActive){console.log("Media Session: Pause in Q&A mode - delegating to exit Q&A"),(t=this._onQAPlayPause)==null||t.call(this);return}const e=navigator.mediaSession.playbackState;if(console.log(`Media Session: Current state is '${e}'`),e==="playing")this._isAndroid||this._silentAudio.pause(),navigator.mediaSession.playbackState="paused",(s=this._onPause)==null||s.call(this);else if(e==="paused"||e==="none"){console.log("Media Session: Received pause while paused, treating as play");try{this._silentAudio.paused&&this._silentAudio.play()}catch(n){console.warn("Media Session: Could not play audio:",n.message)}navigator.mediaSession.playbackState="playing",(i=this._onPlay)==null||i.call(this)}}),navigator.mediaSession.setActionHandler("nexttrack",()=>{var e,t;console.log("Media Session: NEXTTRACK action received"),this._isQAModeActive?(console.log("Media Session: Next track in Q&A mode - asking another question"),(e=this._onQANextQuestion)==null||e.call(this)):(t=this._onEnterQAMode)==null||t.call(this)}),navigator.mediaSession.setActionHandler("previoustrack",()=>{var e;console.log("Media Session: PREVIOUSTRACK action received"),this._isQAModeActive&&((e=this._onExitQAMode)==null||e.call(this))}),navigator.mediaSession.setActionHandler("stop",()=>{var e,t;if(console.log("Media Session: STOP action received"),this._isQAModeActive){console.log("Media Session: Stop in Q&A mode - delegating to exit Q&A"),(e=this._onQAPlayPause)==null||e.call(this);return}this._silentAudio.pause(),navigator.mediaSession.playbackState="paused",(t=this._onPause)==null||t.call(this)});try{navigator.mediaSession.setActionHandler("seekbackward",null),navigator.mediaSession.setActionHandler("seekforward",null),navigator.mediaSession.setActionHandler("seekto",null)}catch{}}updateMetadata({bookTitle:e,chapterTitle:t,author:s}={}){if(!this._isSupported)return;e!==void 0&&(this._bookTitle=e),t!==void 0&&(this._chapterTitle=t),s!==void 0&&(this._author=s);let i=this._bookTitle||"Reading Partner";this._chapterTitle&&(i=this._chapterTitle);const n=[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📖</text></svg>",sizes:"512x512",type:"image/svg+xml"}];navigator.mediaSession.metadata=new MediaMetadata({title:i,artist:this._author||"Reading Partner",album:this._bookTitle||"",artwork:n}),console.log("Media Session: Metadata updated -",i)}_updatePositionState(){try{navigator.mediaSession.setPositionState&&navigator.mediaSession.setPositionState({duration:3600,playbackRate:1,position:0})}catch(e){console.warn("Media Session: Could not set position state:",e.message)}}async setPlaybackState(e){if(this._isSupported){if(console.log(`Media Session: setPlaybackState(${e}), Android=${this._isAndroid}`),e==="playing"){try{this._silentAudio.paused&&await this._silentAudio.play(),this._hasUserInteraction=!0}catch(t){console.warn("Media Session: Could not start audio:",t.message)}navigator.mediaSession.playbackState="playing",this._updatePositionState()}else if(e==="paused"||e==="stopped")if(navigator.mediaSession.playbackState="paused",this._isAndroid)try{this._hasUserInteraction&&this._silentAudio.paused&&await this._silentAudio.play()}catch(t){console.warn("Media Session: Could not maintain audio:",t.message)}else this._silentAudio.pause();console.log(`Media Session: playbackState=${navigator.mediaSession.playbackState}, audio.paused=${this._silentAudio.paused}`)}}setQAModeActive(e){if(this._isQAModeActive=e,console.log(`Media Session: Q&A mode ${e?"ACTIVE":"INACTIVE"}`),e){const t=[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📖</text></svg>",sizes:"512x512",type:"image/svg+xml"}];navigator.mediaSession.metadata=new MediaMetadata({title:"Q&A Mode - Ask a question",artist:this._bookTitle||"Reading Partner",album:"",artwork:t}),this._hasUserInteraction&&this._silentAudio.play().catch(()=>{})}else this.updateMetadata({})}isQAModeActive(){return this._isQAModeActive}diagnose(){var t,s;const e={supported:this._isSupported,initialized:this._isInitialized,hasUserInteraction:this._hasUserInteraction,isAndroid:this._isAndroid,audioElement:this._silentAudio?{paused:this._silentAudio.paused,currentTime:this._silentAudio.currentTime,duration:this._silentAudio.duration,readyState:this._silentAudio.readyState,volume:this._silentAudio.volume,src:this._silentAudio.src?"set":"not set"}:"not created",mediaSession:{playbackState:(t=navigator.mediaSession)==null?void 0:t.playbackState,metadata:(s=navigator.mediaSession)!=null&&s.metadata?{title:navigator.mediaSession.metadata.title,artist:navigator.mediaSession.metadata.artist}:"not set"},qaMode:this._isQAModeActive};return console.log("=== Media Session Diagnostic ==="),console.log(JSON.stringify(e,null,2)),console.log("================================"),console.log(`
📱 Android Troubleshooting:`),console.log("1. Check notification shade - do you see Reading Partner media controls?"),console.log("2. Is another app (Spotify, YouTube) controlling media?"),console.log("3. Try: Tap play button in app first, then use headset"),console.log("4. Make sure page is served over HTTPS"),console.log("5. Try locking/unlocking phone to refresh media session"),e}async forceStart(){console.log("Media Session: Force starting...");try{return await this._silentAudio.play(),this._hasUserInteraction=!0,navigator.mediaSession.playbackState=this._isAndroid?"playing":"paused",this._updatePositionState(),console.log(`Media Session: Force start successful, playbackState=${navigator.mediaSession.playbackState}`),this._isAndroid?console.log("Media Session: Keeping silent audio playing for Android notification"):setTimeout(()=>{this._silentAudio.pause(),console.log("Media Session: Ready for headset controls")},500),!0}catch(e){return console.error("Media Session: Force start failed:",e),!1}}destroy(){if(this._isSupported){this._silentAudio&&(this._silentAudio.pause(),this._silentAudio.src="",this._silentAudio=null);try{navigator.mediaSession.setActionHandler("play",null),navigator.mediaSession.setActionHandler("pause",null),navigator.mediaSession.setActionHandler("nexttrack",null),navigator.mediaSession.setActionHandler("previoustrack",null),navigator.mediaSession.setActionHandler("stop",null)}catch{}navigator.mediaSession.metadata=null,navigator.mediaSession.playbackState="none",this._isInitialized=!1}}}const A=new Hs;typeof window<"u"&&(window.mediaSessionManager=A);class $s{constructor({onSentenceChange:e,onStateChange:t,onChapterEnd:s}){this._onSentenceChange=e,this._onStateChange=t,this._onChapterEnd=s,this._sentences=[],this._currentIndex=0,this._status="stopped",this._speed=1,this._bufferQueue=new Map,this._prefetchAhead=2,this._bufferBehind=2,this._currentSource=null,this._isPlaying=!1,this._stopRequested=!1,this._generatingIndices=new Set}async initialize(){await f.initialize()}setSentences(e,t=0){this._sentences=e,this._currentIndex=t,this._clearBuffers(),e.length>0&&(console.log("Pre-buffering first sentence..."),this._generateBuffer(t).then(()=>{console.log("First sentence pre-buffered")}).catch(s=>{console.warn("Pre-buffer failed:",s)}))}async play(e){var t;if(e!==void 0&&(this._currentIndex=e),this._sentences.length===0){console.warn("No sentences to play");return}if(this._currentIndex>=this._sentences.length){(t=this._onChapterEnd)==null||t.call(this);return}this._stopRequested=!1,this._status="playing",this._notifyStateChange(),await this._playbackLoop()}async _playbackLoop(){var e,t;for(;!this._stopRequested&&this._currentIndex<this._sentences.length;){this._isPlaying=!0;let s=this._bufferQueue.get(this._currentIndex);if(!s){this._status="buffering",this._notifyStateChange(),console.time(`TTS generate sentence ${this._currentIndex}`);try{s=await this._generateBuffer(this._currentIndex)}catch(i){console.error("Failed to generate audio:",i),this._currentIndex++;continue}console.timeEnd(`TTS generate sentence ${this._currentIndex}`),this._status="playing",this._notifyStateChange()}if(this._stopRequested)break;(e=this._onSentenceChange)==null||e.call(this,this._currentIndex),this._maintainBuffer();try{await f.playBuffer(s,this._speed)}catch(i){console.error("Playback error:",i)}if(this._stopRequested)break;this._currentIndex++}this._isPlaying=!1,!this._stopRequested&&this._currentIndex>=this._sentences.length&&(this._status="stopped",this._notifyStateChange(),(t=this._onChapterEnd)==null||t.call(this))}pause(){this._stopRequested=!0,this._status="paused",f.stopAudio(),this._notifyStateChange()}resume(){this._status==="paused"&&this.play()}stop(){this._stopRequested=!0,this._status="stopped",this._currentIndex=0,f.stopAudio(),this._notifyStateChange()}skipForward(){var t;const e=this._status==="playing";this._stopRequested=!0,f.stopAudio(),this._currentIndex<this._sentences.length-1&&(this._currentIndex++,(t=this._onSentenceChange)==null||t.call(this,this._currentIndex),e&&setTimeout(()=>this.play(),50))}skipBackward(e=1){var s;const t=this._status==="playing";this._stopRequested=!0,f.stopAudio(),this._currentIndex=Math.max(0,this._currentIndex-e),(s=this._onSentenceChange)==null||s.call(this,this._currentIndex),t&&setTimeout(()=>this.play(),50)}goToSentence(e){var s;const t=this._status==="playing";this._stopRequested=!0,f.stopAudio(),this._currentIndex=Math.max(0,Math.min(e,this._sentences.length-1)),(s=this._onSentenceChange)==null||s.call(this,this._currentIndex),t&&setTimeout(()=>this.play(),50)}setSpeed(e){const t=Math.max(.5,Math.min(2,e));t!==this._speed&&(this._speed=t,f.setSpeed(t),this._clearBuffers())}getState(){return{status:this._status,currentIndex:this._currentIndex}}getCurrentIndex(){return this._currentIndex}isFirstBufferReady(){return this._bufferQueue.has(this._currentIndex)}_maintainBuffer(){const e=Math.min(this._sentences.length,this._currentIndex+this._prefetchAhead+1);for(let s=this._currentIndex+1;s<e;s++)!this._bufferQueue.has(s)&&!this._generatingIndices.has(s)&&this._generateBuffer(s).catch(i=>{console.warn(`Buffer generation error for sentence ${s}:`,i)});const t=Math.max(0,this._currentIndex-this._bufferBehind);for(const s of this._bufferQueue.keys())s<t&&this._bufferQueue.delete(s)}async _generateBuffer(e){if(this._bufferQueue.has(e))return this._bufferQueue.get(e);if(this._generatingIndices.has(e))return new Promise((t,s)=>{const i=setInterval(()=>{this._bufferQueue.has(e)&&(clearInterval(i),t(this._bufferQueue.get(e)))},50);setTimeout(()=>{clearInterval(i),s(new Error("Buffer generation timeout"))},3e4)});this._generatingIndices.add(e);try{const t=this._sentences[e];console.log(`Generating TTS for sentence ${e}: "${t.slice(0,50)}..."`);const s=await f.synthesize(t);return this._bufferQueue.set(e,s),console.log(`TTS ready for sentence ${e}`),s}finally{this._generatingIndices.delete(e)}}clearBuffers(){this._clearBuffers()}_clearBuffers(){this._bufferQueue.clear(),this._generatingIndices.clear()}_notifyStateChange(){var e;(e=this._onStateChange)==null||e.call(this,{status:this._status,currentIndex:this._currentIndex})}destroy(){this.stop(),this._clearBuffers()}}const y={IDLE:"idle",LISTENING:"listening",THINKING:"thinking",RESPONDING:"responding",PAUSED:"paused"};class Ds{constructor(e){this._readingState=e.readingState,this._onStateChange=e.onStateChange,this._onTranscript=e.onTranscript,this._onResponse=e.onResponse,this._onSentenceSpoken=e.onSentenceSpoken,this._onHistoryAdd=e.onHistoryAdd,this._sttService=e.sttService||V,this._state=y.IDLE,this._currentQuestion="",this._currentResponse="",this._responseSentences=[],this._currentSentenceIndex=0,this._isPaused=!1,this._isStopped=!1,this._isStreamingComplete=!1,this._playbackSpeed=1,this._audioBufferCache=new Map,this._nextSynthesisIndex=0,this._history=[],this._bookMeta=null,this._contextBefore=20,this._contextAfter=5,this._useFullChapter=!1,this._sttService.onInterimResult=t=>{var s;(s=this._onTranscript)==null||s.call(this,t)}}setSTTService(e){this._sttService=e,this._sttService.onInterimResult=t=>{var s;(s=this._onTranscript)==null||s.call(this,t)}}getState(){return this._state}isActive(){return this._state!==y.IDLE}getHistory(){return[...this._history]}clearHistory(){this._history=[]}setBookMeta(e){this._bookMeta=e}setContextSettings(e,t,s=!1){this._contextBefore=e,this._contextAfter=t,this._useFullChapter=s}setPlaybackSpeed(e){this._playbackSpeed=e}async startVoiceQA(){var e,t;if(this._state!==y.IDLE&&this._state!==y.PAUSED){console.warn("Q&A already in progress");return}this._isStopped=!1,this._isPaused=!1,this._setState(y.LISTENING);try{const s=await this._sttService.startListening();this._currentQuestion=s,(e=this._onTranscript)==null||e.call(this,s),await this._processQuestion(s)}catch(s){console.error("Voice Q&A error:",s),s.message!=="Speech recognition aborted"&&((t=this._onStateChange)==null||t.call(this,y.IDLE,{error:s.message})),this._setState(y.IDLE)}}async startTextQA(e){if(this._state!==y.IDLE&&this._state!==y.PAUSED){console.warn("Q&A already in progress");return}!e||!e.trim()||(this._isStopped=!1,this._isPaused=!1,this._currentQuestion=e.trim(),await this._processQuestion(this._currentQuestion))}async _processQuestion(e){var t,s;this._setState(y.THINKING),this._currentResponse="",this._responseSentences=[],this._currentSentenceIndex=0,this._isStreamingComplete=!1,this._audioBufferCache.clear(),this._nextSynthesisIndex=0;try{const i=await this._getContextSentences(),n=await w.askQuestionStreaming(i,e,r=>{var a;this._currentResponse+=r,(a=this._onResponse)==null||a.call(this,this._currentResponse)},r=>{if(this._isStopped)return;const a=this._responseSentences.length;this._responseSentences.push(r),this._prefetchSentenceAudio(a,r),this._state===y.THINKING&&this._responseSentences.length===1&&(this._setState(y.RESPONDING),this._startSpeaking())},this._bookMeta);this._isStreamingComplete=!0;const o={id:`qa_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,question:e,answer:n,timestamp:Date.now()};this._history.push(o),(t=this._onHistoryAdd)==null||t.call(this,o)}catch(i){console.error("Q&A processing error:",i),this._isStreamingComplete=!0,this._isStopped||((s=this._onStateChange)==null||s.call(this,y.IDLE,{error:i.message}),this._setState(y.IDLE))}}async _getContextSentences(){if(!this._readingState)return[];if(this._useFullChapter){const s=this._readingState.getCurrentPosition();return await this._readingState.loadChapter(s.chapterIndex)}const e=await this._readingState.getContextSentences(this._contextBefore),t=await this._readingState.getContextSentencesAfter(this._contextAfter);return[...e,...t]}async _startSpeaking(){var e;for(;!this._isStopped;){if(this._isPaused){await new Promise(t=>{this._resumeCallback=t});continue}if(this._currentSentenceIndex<this._responseSentences.length){const t=this._responseSentences[this._currentSentenceIndex];try{await this._speakSentence(t),(e=this._onSentenceSpoken)==null||e.call(this,t,this._currentSentenceIndex),this._currentSentenceIndex++}catch(s){if(this._isStopped||this._isPaused)break;console.error("TTS error:",s),this._currentSentenceIndex++}}else{if(this._isStreamingComplete)break;await new Promise(t=>setTimeout(t,100))}}!this._isStopped&&!this._isPaused&&this._setState(y.IDLE)}async _prefetchSentenceAudio(e,t){if(!t||!t.trim()||this._isStopped||this._audioBufferCache.has(e))return;const s=f.synthesize(t).then(i=>(this._isStopped||this._audioBufferCache.set(e,i),i)).catch(i=>(console.error(`Pre-fetch synthesis error for sentence ${e}:`,i),null));this._audioBufferCache.set(e,s)}async _speakSentence(e){if(!e||!e.trim())return;const t=this._currentSentenceIndex;let s;const i=this._audioBufferCache.get(t);i&&(s=await Promise.resolve(i)),s||(s=await f.synthesize(e)),!this._isStopped&&(this._audioBufferCache.delete(t),await f.playBuffer(s,this._playbackSpeed))}pause(){this._state===y.RESPONDING&&(this._isPaused=!0,this._setState(y.PAUSED),f.stopAudio())}resume(){this._state===y.PAUSED&&(this._isPaused=!1,this._setState(y.RESPONDING),this._resumeCallback?(this._resumeCallback(),this._resumeCallback=null):this._startSpeaking())}stop(){this._isStopped=!0,this._isPaused=!1,this._state===y.LISTENING&&this._sttService.abortListening(),w.abort(),f.stopAudio(),this._currentQuestion="",this._currentResponse="",this._responseSentences=[],this._currentSentenceIndex=0,this._audioBufferCache.clear(),this._nextSynthesisIndex=0,this._setState(y.IDLE)}cancelListening(){this._state===y.LISTENING&&(this._sttService.abortListening(),this._setState(y.IDLE))}askAnother(){this.stop(),setTimeout(()=>{this.startVoiceQA()},100)}getCurrentQuestion(){return this._currentQuestion}getCurrentResponse(){return this._currentResponse}isSTTSupported(){return this._sttService.isSupported()}async requestMicPermission(){return this._sttService.requestPermission()}_setState(e){var s;const t=this._state;this._state=e,t!==e&&((s=this._onStateChange)==null||s.call(this,e,{question:this._currentQuestion,response:this._currentResponse,sentenceIndex:this._currentSentenceIndex,totalSentences:this._responseSentences.length}))}}const k={IDLE:"idle",GENERATING:"generating",AWAITING_ANSWER:"awaiting_answer",EVALUATING:"evaluating",SPEAKING_QUESTION:"speaking_question",SPEAKING_FEEDBACK:"speaking_feedback"};class Ns{constructor(e){this._readingState=e.readingState,this._onStateChange=e.onStateChange,this._onQuestionReady=e.onQuestionReady,this._onFeedbackChunk=e.onFeedbackChunk,this._onAnswerResult=e.onAnswerResult,this._onTranscript=e.onTranscript,this._onVoiceStart=e.onVoiceStart,this._onVoiceEnd=e.onVoiceEnd,this._onError=e.onError,this._sttService=e.sttService||V,this._state=k.IDLE,this._currentQuestion=null,this._previousQuestions=[],this._disabledOptions=[],this._chatHistory=[],this._playbackSpeed=1,this._isStopped=!1,this._feedbackSentences=[],this._currentSentenceIndex=0,this._audioBufferCache=new Map,this._isStreamingComplete=!1,this._bookMeta=null,this._isMultipleChoice=!0,this._isGuided=!0,this._questionTypes=["factual"],this._useFullChapter=!0,this._customSystemPrompt="",this._selectionContext=null,this._readOptionsAloud=!0}getState(){return this._state}isActive(){return this._state!==k.IDLE}getCurrentQuestion(){return this._currentQuestion}getDisabledOptions(){return[...this._disabledOptions]}setSTTService(e){this._sttService=e}setBookMeta(e){this._bookMeta=e}setPlaybackSpeed(e){this._playbackSpeed=e}setSettings({isMultipleChoice:e,isGuided:t,questionTypes:s,useFullChapter:i,customSystemPrompt:n,readOptionsAloud:o}){e!==void 0&&(this._isMultipleChoice=e),t!==void 0&&(this._isGuided=t),s!==void 0&&(this._questionTypes=s),i!==void 0&&(this._useFullChapter=i),n!==void 0&&(this._customSystemPrompt=n),o!==void 0&&(this._readOptionsAloud=o)}setSelectionContext(e){this._selectionContext=e}async nextQuestion(){var e,t,s;if(!(this._state!==k.IDLE&&this._state!==k.AWAITING_ANSWER&&this._state!==k.SPEAKING_FEEDBACK)){this._isStopped=!1,this._disabledOptions=[],this._chatHistory=[],this._currentQuestion=null,this._clearTTSState(),this._setState(k.GENERATING);try{const i=await this._getContextSentences(),n=await w.generateQuizQuestion({contextSentences:i,bookMeta:this._bookMeta,isMultipleChoice:this._isMultipleChoice,questionTypes:this._questionTypes,previousQuestions:this._previousQuestions,customSystemPrompt:this._customSystemPrompt});if(this._isStopped||(this._currentQuestion=n,this._previousQuestions.push(n),await this._persistQuestion(n),(e=this._onQuestionReady)==null||e.call(this,n),this._setState(k.SPEAKING_QUESTION),await this._speakText(n.question),this._isStopped))return;if(this._readOptionsAloud&&this._isMultipleChoice&&((t=n.options)!=null&&t.length)){const o=["A","B","C","D"];for(let r=0;r<n.options.length;r++){if(this._isStopped)return;const a=o[r]||String(r+1);await this._speakText(`${a}. ${n.options[r]}`)}}if(this._isStopped)return;this._setState(k.AWAITING_ANSWER)}catch(i){if(this._isStopped)return;console.error("Quiz question generation error:",i),(s=this._onError)==null||s.call(this,i.message),this._setState(k.IDLE)}}}async submitMCAnswer(e){var s,i,n,o;if(this._state!==k.AWAITING_ANSWER||!this._currentQuestion)return;if(this._stopTTS(),e===this._currentQuestion.correctIndex){if((s=this._onAnswerResult)==null||s.call(this,{correct:!0,selectedIndex:e,feedback:this._currentQuestion.explanation,done:!0}),this._setState(k.SPEAKING_FEEDBACK),await this._speakText("Correct!"),this._isStopped)return;await this._speakText(this._currentQuestion.explanation),this._isStopped||this._setState(k.AWAITING_ANSWER)}else if(this._isGuided){this._disabledOptions.push(e),this._setState(k.EVALUATING);try{const r=await this._getMCHint(e);if(this._isStopped||((i=this._onAnswerResult)==null||i.call(this,{correct:!1,selectedIndex:e,feedback:r,done:!1}),this._setState(k.SPEAKING_FEEDBACK),await this._speakText("That is incorrect."),this._isStopped))return;await this._speakText(r),this._isStopped||this._setState(k.AWAITING_ANSWER)}catch(r){if(this._isStopped)return;console.error("Hint error:",r),(n=this._onError)==null||n.call(this,r.message),this._setState(k.AWAITING_ANSWER)}}else{const r=`The correct answer was: ${this._currentQuestion.options[this._currentQuestion.correctIndex]}. ${this._currentQuestion.explanation}`;if((o=this._onAnswerResult)==null||o.call(this,{correct:!1,selectedIndex:e,correctIndex:this._currentQuestion.correctIndex,feedback:r,done:!0}),this._setState(k.SPEAKING_FEEDBACK),await this._speakText("That is incorrect."),this._isStopped)return;await this._speakText(r),this._isStopped||this._setState(k.AWAITING_ANSWER)}}async submitFreeFormAnswer(e){var t,s,i,n;if(!(this._state!==k.AWAITING_ANSWER||!this._currentQuestion)&&!(!e||!e.trim())){this._stopTTS(),this._setState(k.EVALUATING);try{const r=(await this._getContextSentences()).join(" "),l=[{role:"system",content:`You are evaluating a reading comprehension answer. Based on the provided book context, evaluate if the student's answer is correct.

IMPORTANT: Start your response with exactly "CORRECT" or "INCORRECT" on the first line.
Then provide concise feedback.${this._isGuided?`
If incorrect, give a helpful hint without revealing the answer.`:`
If incorrect, explain the correct answer.`}`}];let h="";if((t=this._bookMeta)!=null&&t.title&&(h+=`Book: ${this._bookMeta.title}`,this._bookMeta.author&&(h+=` by ${this._bookMeta.author}`),h+=`

`),h+=`Context from the book:
"${r}"

Question: ${this._currentQuestion.question}`,this._chatHistory.length>0){for(const S of this._chatHistory)l.push({role:"user",content:S.userMsg}),l.push({role:"assistant",content:S.assistantMsg});l.push({role:"user",content:`Student's new answer: "${e.trim()}"`})}else l.push({role:"user",content:h+`

Student's answer: "${e.trim()}"`});let d="";if(await w.streamQuizChat(l,S=>{var L;d+=S,(L=this._onFeedbackChunk)==null||L.call(this,d)},S=>{if(this._isStopped)return;const L=this._feedbackSentences.length;this._feedbackSentences.push(S),this._prefetchAudio(L,S),this._state===k.EVALUATING&&this._feedbackSentences.length===1&&(this._setState(k.SPEAKING_FEEDBACK),this._startFeedbackSpeaking())}),this._isStopped)return;this._isStreamingComplete=!0;const u=d.trim().split(`
`)[0].toUpperCase().startsWith("CORRECT"),g=d.replace(/^(CORRECT|INCORRECT)[:\s]*/i,"").trim(),m=this._chatHistory.length>0?`Student's new answer: "${e.trim()}"`:`${h}

Student's answer: "${e.trim()}"`;this._chatHistory.push({userMsg:m,assistantMsg:d});const v=u||!this._isGuided;if(v||(s=this._onAnswerResult)==null||s.call(this,{correct:!1,feedback:g,done:!1}),await this._waitForSpeakingDone(),this._isStopped)return;v&&((i=this._onAnswerResult)==null||i.call(this,{correct:u,feedback:g,done:!0})),this._setState(k.AWAITING_ANSWER)}catch(o){if(this._isStopped)return;console.error("Answer evaluation error:",o),(n=this._onError)==null||n.call(this,o.message),this._setState(k.AWAITING_ANSWER)}}}async submitVoiceAnswer(){var t,s,i,n,o;if(this._state!==k.AWAITING_ANSWER)return;this._stopTTS();const e=this._sttService.onInterimResult;this._sttService.onInterimResult=r=>{var a;(a=this._onTranscript)==null||a.call(this,r)},(t=this._onVoiceStart)==null||t.call(this);try{const r=await this._sttService.startListening();if(this._sttService.onInterimResult=e,(s=this._onVoiceEnd)==null||s.call(this),r&&r.trim())if(this._isMultipleChoice){const a=this._matchVoiceToOption(r);a!==-1?await this.submitMCAnswer(a):(i=this._onError)==null||i.call(this,"Could not match your answer to an option. Please try clicking an option instead.")}else await this.submitFreeFormAnswer(r)}catch(r){this._sttService.onInterimResult=e,(n=this._onVoiceEnd)==null||n.call(this),r.message!=="Speech recognition aborted"&&((o=this._onError)==null||o.call(this,r.message))}}async skipToAnswer(){var e,t,s;if(this._currentQuestion)if(this._stopTTS(),this._clearTTSState(),w.abort(),this._isMultipleChoice){const i=`The correct answer is: ${this._currentQuestion.options[this._currentQuestion.correctIndex]}. ${this._currentQuestion.explanation}`;(e=this._onAnswerResult)==null||e.call(this,{correct:!1,correctIndex:this._currentQuestion.correctIndex,feedback:i,done:!0,skipped:!0}),this._setState(k.SPEAKING_FEEDBACK),await this._speakText(i),this._isStopped||this._setState(k.AWAITING_ANSWER)}else{this._setState(k.EVALUATING);try{const n=(await this._getContextSentences()).join(" "),o=[{role:"system",content:"You are a reading comprehension quiz master. The student is skipping this question. Provide the answer concisely."},{role:"user",content:`Context from the book:
"${n}"

Question: ${this._currentQuestion.question}

Please provide the answer.`}];let r="";if(await w.streamQuizChat(o,a=>{var l;r+=a,(l=this._onFeedbackChunk)==null||l.call(this,r)},a=>{if(this._isStopped)return;const l=this._feedbackSentences.length;this._feedbackSentences.push(a),this._prefetchAudio(l,a),this._state===k.EVALUATING&&this._feedbackSentences.length===1&&(this._setState(k.SPEAKING_FEEDBACK),this._startFeedbackSpeaking())}),this._isStopped||(this._isStreamingComplete=!0,await this._waitForSpeakingDone(),this._isStopped))return;(t=this._onAnswerResult)==null||t.call(this,{correct:!1,feedback:r,done:!0,skipped:!0}),this._isStopped||this._setState(k.AWAITING_ANSWER)}catch(i){if(this._isStopped)return;console.error("Skip to answer error:",i),(s=this._onError)==null||s.call(this,i.message),this._setState(k.AWAITING_ANSWER)}}}stop(){this._isStopped=!0,this._sttService.abortListening(),w.abort(),this._stopTTS(),this._clearTTSState(),this._currentQuestion=null,this._disabledOptions=[],this._chatHistory=[],this._selectionContext=null,this._setState(k.IDLE)}resetSession(){this._previousQuestions=[]}async _getContextSentences(){if(this._selectionContext&&this._selectionContext.length>0)return this._selectionContext;if(!this._readingState)return[];const e=this._readingState.getCurrentPosition();return this._useFullChapter?await this._readingState.loadChapter(e.chapterIndex):(await this._readingState.loadChapter(e.chapterIndex)).slice(0,e.sentenceIndex+1)}async _getMCHint(e){const s=(await this._getContextSentences()).join(" "),i=[{role:"system",content:"You are a quiz master helping a student. They selected a wrong answer. Give a brief, helpful hint (1-2 sentences) explaining why their choice is incorrect, without revealing the correct answer."},{role:"user",content:`Context: "${s}"

Question: ${this._currentQuestion.question}
Options: ${this._currentQuestion.options.map((o,r)=>`${r}) ${o}`).join(", ")}
Correct answer index: ${this._currentQuestion.correctIndex}
Student chose: ${e}) ${this._currentQuestion.options[e]}

Give a hint.`}];let n="";return await w.streamQuizChat(i,o=>{var r;n+=o,(r=this._onFeedbackChunk)==null||r.call(this,n)},null),n}_matchVoiceToOption(e){var i;const t=e.toLowerCase().trim(),s=["a","b","c","d"];for(let n=0;n<s.length;n++)if((t===s[n]||t.startsWith(s[n]+")")||t.startsWith(s[n]+".")||t.startsWith("option "+s[n]))&&!this._disabledOptions.includes(n))return n;for(let n=0;n<4;n++)if((t===String(n+1)||t.startsWith(String(n+1)+")"))&&!this._disabledOptions.includes(n))return n;if((i=this._currentQuestion)!=null&&i.options){for(let n=0;n<this._currentQuestion.options.length;n++)if(!this._disabledOptions.includes(n)&&(this._currentQuestion.options[n].toLowerCase().includes(t)||t.includes(this._currentQuestion.options[n].toLowerCase())))return n}return-1}_stopTTS(){f.stopAudio()}_clearTTSState(){this._feedbackSentences=[],this._currentSentenceIndex=0,this._audioBufferCache.clear(),this._isStreamingComplete=!1,this._speakingDoneResolve=null}async _speakText(e){if(!(!e||!e.trim()||this._isStopped))try{const t=await f.synthesize(e);if(this._isStopped)return;await f.playBuffer(t,this._playbackSpeed)}catch(t){console.error("TTS speak error:",t)}}async _prefetchAudio(e,t){if(!t||!t.trim()||this._isStopped||this._audioBufferCache.has(e))return;const s=f.synthesize(t).then(i=>(this._isStopped||this._audioBufferCache.set(e,i),i)).catch(i=>(console.error(`Pre-fetch error for sentence ${e}:`,i),null));this._audioBufferCache.set(e,s)}async _startFeedbackSpeaking(){var e;for(this._speakingDonePromise=new Promise(t=>{this._speakingDoneResolve=t});!this._isStopped;)if(this._currentSentenceIndex<this._feedbackSentences.length){const t=this._feedbackSentences[this._currentSentenceIndex];try{let s;const i=this._audioBufferCache.get(this._currentSentenceIndex);if(i&&(s=await Promise.resolve(i)),s||(s=await f.synthesize(t)),this._isStopped)break;this._audioBufferCache.delete(this._currentSentenceIndex),await f.playBuffer(s,this._playbackSpeed),this._currentSentenceIndex++}catch(s){if(this._isStopped)break;console.error("Feedback TTS error:",s),this._currentSentenceIndex++}}else{if(this._isStreamingComplete)break;await new Promise(t=>setTimeout(t,100))}(e=this._speakingDoneResolve)==null||e.call(this)}async _waitForSpeakingDone(){this._speakingDonePromise&&await this._speakingDonePromise}async _persistQuestion(e){var t,s;try{const i=(t=this._readingState)==null?void 0:t.getCurrentBook(),n=(s=this._readingState)==null?void 0:s.getCurrentPosition();if(!i||!n)return;await _.saveQuizQuestion(i.id,n.chapterIndex,{...e,timestamp:Date.now(),isMultipleChoice:this._isMultipleChoice})}catch(i){console.error("Failed to persist quiz question:",i)}}_setState(e){var s;const t=this._state;this._state=e,t!==e&&((s=this._onStateChange)==null||s.call(this,e,{question:this._currentQuestion,disabledOptions:this._disabledOptions}))}isSTTSupported(){return this._sttService.isSupported()}}class Fs{constructor({onPositionChange:e,onBookmarksChange:t,onHighlightsChange:s}={}){this._currentBook=null,this._position={chapterIndex:0,sentenceIndex:0},this._bookmarks=[],this._highlights=[],this._saveTimeout=null,this._onPositionChange=e,this._onBookmarksChange=t,this._onHighlightsChange=s}async init(){await _.init(),console.log("Reading state controller initialized")}async loadBook(e,t=null,s=null){const n=await Ps(e.name).loadFromFile(e);n.id=s||this._generateBookId(e.name),t?n.source=t:n.source={type:"local",filename:e.name},await _.saveBook(n),this._currentBook=n;const o=await _.getPosition(n.id);return o?(this._position={chapterIndex:o.chapterIndex,sentenceIndex:o.sentenceIndex},console.log("Restored position:",this._position)):this._position={chapterIndex:0,sentenceIndex:0},this._bookmarks=await _.getBookmarks(n.id),this._highlights=await _.getHighlights(n.id),n}async loadPastedContent(e,t,s){let i,n;if(t==="html"){i=U("html");const o=new Blob([e],{type:"text/html"}),r=new File([o],`${s}.html`,{type:"text/html"});n=await i.loadFromFile(r),n.fileType="html"}else if(t==="markdown"){i=U("markdown");const o=new Blob([e],{type:"text/markdown"}),r=new File([o],`${s}.md`,{type:"text/markdown"});n=await i.loadFromFile(r),n.fileType="markdown"}else i=U("plaintext"),n=await i.loadFromText(e,s),n.fileType="plaintext";return n.title=s,n.id=this._generateBookId("pasted_"+s),n.source={type:"pasted",format:t},n.fileData=e,await _.saveBook(n),this._currentBook=n,this._position={chapterIndex:0,sentenceIndex:0},this._bookmarks=[],this._highlights=[],n}async openBook(e){const t=await _.getBook(e);if(!t)throw new Error("Book not found");const s=t.fileData||t.epubData,i=t.fileType||"epub";if(s)await U(i).initFromStoredData(s);else throw new Error("File data not available");this._currentBook=t;const n=await _.getPosition(e);return n?this._position={chapterIndex:n.chapterIndex,sentenceIndex:n.sentenceIndex}:this._position={chapterIndex:0,sentenceIndex:0},this._bookmarks=await _.getBookmarks(e),this._highlights=await _.getHighlights(e),await _.saveBook(t),t}async getAllBooks(){return await _.getAllBooks()}async deleteBook(e){await _.deleteBook(e),await _.deletePosition(e);const t=await _.getBookmarks(e);for(const i of t)await _.deleteBookmark(i.id);const s=await _.getHighlights(e);for(const i of s)await _.deleteHighlight(i.id)}getCurrentBook(){return this._currentBook}getCurrentPosition(){return{...this._position}}async loadChapter(e){if(!this._currentBook)throw new Error("No book loaded");const t=this._currentBook.fileType||"epub";return await U(t).loadChapter(this._currentBook,e)}goToChapter(e,t=0){this._currentBook&&(this._position.chapterIndex=e,this._position.sentenceIndex=t,this._schedulePositionSave(),this._notifyPositionChange())}goToSentence(e){this._position.sentenceIndex=e,this._schedulePositionSave(),this._notifyPositionChange()}updateSentencePosition(e){this._position.sentenceIndex=e,this._schedulePositionSave()}goToBookmark(e){this._position.chapterIndex=e.chapterIndex,this._position.sentenceIndex=e.sentenceIndex,this._schedulePositionSave(),this._notifyPositionChange()}async addBookmark(e=""){if(!this._currentBook)throw new Error("No book loaded");const t={id:this._generateBookmarkId(),bookId:this._currentBook.id,chapterIndex:this._position.chapterIndex,sentenceIndex:this._position.sentenceIndex,note:e,createdAt:Date.now()};return await _.addBookmark(t),this._bookmarks.push(t),this._bookmarks.sort((s,i)=>s.chapterIndex!==i.chapterIndex?s.chapterIndex-i.chapterIndex:s.sentenceIndex-i.sentenceIndex),this._notifyBookmarksChange(),t}async deleteBookmark(e){await _.deleteBookmark(e),this._bookmarks=this._bookmarks.filter(t=>t.id!==e),this._notifyBookmarksChange()}getBookmarks(){return[...this._bookmarks]}async addHighlight(e,t,s,i,n="",o="yellow"){if(!this._currentBook)throw new Error("No book loaded");const r={id:this._generateHighlightId(),bookId:this._currentBook.id,chapterIndex:e,startSentenceIndex:t,endSentenceIndex:s,text:i,note:n,color:o,createdAt:Date.now()};return await _.addHighlight(r),this._highlights.push(r),this._highlights.sort((a,l)=>a.chapterIndex!==l.chapterIndex?a.chapterIndex-l.chapterIndex:a.startSentenceIndex-l.startSentenceIndex),this._notifyHighlightsChange(),r}async deleteHighlight(e){await _.deleteHighlight(e),this._highlights=this._highlights.filter(t=>t.id!==e),this._notifyHighlightsChange()}getHighlights(){return[...this._highlights]}getHighlightsForChapter(e){return this._highlights.filter(t=>t.chapterIndex===e)}_generateHighlightId(){return`highlight_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}_notifyHighlightsChange(){var e;(e=this._onHighlightsChange)==null||e.call(this)}async getContextSentences(e=20){if(!this._currentBook)return[];const t=[];let s=e,i=this._position.chapterIndex,n=this._position.sentenceIndex;for(;s>0&&i>=0;){const o=await this.loadChapter(i),r=Math.max(0,n-s+1),a=o.slice(r,n+1);t.unshift(...a),s-=a.length,i--,i>=0&&(n=(await this.loadChapter(i)).length-1)}return t.slice(-e)}async getContextSentencesAfter(e=5){if(!this._currentBook)return[];const t=[];let s=e,i=this._position.chapterIndex,n=this._position.sentenceIndex+1;for(;s>0&&i<this._currentBook.chapters.length;){const o=await this.loadChapter(i),r=Math.min(n+s,o.length),a=o.slice(n,r);t.push(...a),s-=a.length,i++,n=0}return t.slice(0,e)}_schedulePositionSave(){this._currentBook&&(this._saveTimeout&&clearTimeout(this._saveTimeout),this._saveTimeout=setTimeout(async()=>{try{await _.savePosition({bookId:this._currentBook.id,chapterIndex:this._position.chapterIndex,sentenceIndex:this._position.sentenceIndex}),console.log("Position saved:",this._position)}catch(e){console.error("Failed to save position:",e)}},2e3))}async savePositionNow(){this._currentBook&&(this._saveTimeout&&(clearTimeout(this._saveTimeout),this._saveTimeout=null),await _.savePosition({bookId:this._currentBook.id,chapterIndex:this._position.chapterIndex,sentenceIndex:this._position.sentenceIndex}))}_notifyPositionChange(){var e;(e=this._onPositionChange)==null||e.call(this,this._position.chapterIndex,this._position.sentenceIndex)}_notifyBookmarksChange(){var e;(e=this._onBookmarksChange)==null||e.call(this)}_generateBookId(e){const t=Date.now(),s=Math.random().toString(36).substring(2,9);return`${e.replace(/[^a-z0-9]/gi,"_")}_${t}_${s}`}_generateBookmarkId(){return`bookmark_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}destroy(){this._saveTimeout&&clearTimeout(this._saveTimeout)}}class Os{constructor({container:e,titleElement:t,bookTitleElement:s,onSentenceClick:i,onPageChange:n,onLinkClick:o,onImageClick:r,onHighlight:a,onLookup:l,onPrevChapter:h,onNextChapter:d}){this._container=e,this._titleElement=t,this._bookTitleElement=s,this._onSentenceClick=i,this._onPageChange=n,this._onLinkClick=o,this._onImageClick=r,this._onHighlight=a,this._onLookup=l,this._onPrevChapter=h,this._onNextChapter=d,this._textContent=e.querySelector("#text-content")||e,this._pageContainer=e.querySelector("#page-container"),this._prevBtn=e.querySelector("#page-prev-btn"),this._nextBtn=e.querySelector("#page-next-btn"),this._pageCurrentEl=e.querySelector("#page-current"),this._pageTotalEl=e.querySelector("#page-total"),this._sentences=[],this._currentIndex=-1,this._html=null,this._highlights=[],this._currentPage=0,this._totalPages=1,this._pageHeight=0,this._sentenceToPage=new Map,this._pageToSentences=new Map,this._isCalculatingPages=!1,this._isFirstChapter=!0,this._isLastChapter=!0,this._prevBtnMode="page",this._nextBtnMode="page",this._pendingGoToLastPage=!1,this._PAGE_ARROW_SVG='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>',this._PAGE_ARROW_SVG_NEXT='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>',this._CHAPTER_ARROW_SVG='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 18 11 12 17 6"/><line x1="7" y1="6" x2="7" y2="18"/></svg>',this._CHAPTER_ARROW_SVG_NEXT='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="7 18 13 12 7 6"/><line x1="17" y1="6" x2="17" y2="18"/></svg>',this._columnCount=1,this._columnAutoCenter=!0,this._multiColumnContainer=null,this._columnViewports=[],this._visiblePages=[],this._MIN_COLUMN_WIDTH=250,this._COLUMN_GAP=24,this._contentScrollHeight=0,this._highlightToolbar=null,this._createHighlightToolbar(),this._touchStartX=0,this._touchStartY=0,this._touchStartTime=0,this._isSwiping=!1,this._setupEventDelegation(),this._setupPageNavigation(),this._setupResizeHandler(),this._setupTextSelection(),this._setupMultiColumnContainer(),this._setupSwipeNavigation()}_setupMultiColumnContainer(){this._multiColumnContainer=document.createElement("div"),this._multiColumnContainer.className="multi-column-container multi-column-inactive",this._textContent.parentElement.insertBefore(this._multiColumnContainer,this._textContent.nextSibling),this._multiColumnContainer.addEventListener("click",e=>{var i,n;const t=e.target.closest("img");if(t&&t.src){e.preventDefault(),(i=this._onImageClick)==null||i.call(this,t.src,t.alt||"");return}const s=e.target.closest("a[href]");if(s){const o=s.getAttribute("href");if(o){if(o.startsWith("mailto:")||o.startsWith("tel:"))return;if(o.startsWith("http://")||o.startsWith("https://")){e.preventDefault(),window.open(o,"_blank","noopener,noreferrer");return}e.preventDefault(),(n=this._onLinkClick)==null||n.call(this,o);return}}}),this._multiColumnContainer.addEventListener("dblclick",e=>{var s;const t=e.target.closest(".sentence");if(t&&t.dataset.index!==void 0){const i=parseInt(t.dataset.index,10);(s=this._onSentenceClick)==null||s.call(this,i)}}),this._setupLongPress(this._multiColumnContainer)}setColumnCount(e){const t=Math.max(1,Math.min(5,e));t!==this._columnCount&&(this._columnCount=t,this._recalculatePages())}setColumnAutoCenter(e){this._columnAutoCenter=e,this._columnCount>1&&this._updateMultiColumnDisplay()}getColumnCount(){return this._columnCount}_getEffectiveColumnCount(){var s;if(this._columnCount<=1)return 1;const e=((s=this._pageContainer)==null?void 0:s.clientWidth)||window.innerWidth,t=Math.floor(e/this._MIN_COLUMN_WIDTH);return Math.max(1,Math.min(this._columnCount,t))}_updateMultiColumnMode(){const e=this._getEffectiveColumnCount();e<=1?(this._textContent.classList.remove("multi-column-hidden"),this._multiColumnContainer.classList.add("multi-column-inactive"),this._columnViewports=[],this._goToPageInternal(this._currentPage,!1)):(this._textContent.classList.add("multi-column-hidden"),this._multiColumnContainer.classList.remove("multi-column-inactive"),this._buildColumnViewports(e),this._updateMultiColumnDisplay()),this._updatePageIndicator(),this._updatePageButtons()}_buildColumnViewports(e){this._multiColumnContainer.innerHTML="",this._columnViewports=[];for(let t=0;t<e;t++){const s=document.createElement("div");s.className="column-viewport";const i=document.createElement("div");i.className="column-content",s.appendChild(i),this._multiColumnContainer.appendChild(s),this._columnViewports.push({viewport:s,content:i})}}_computeVisiblePages(){const e=this._getEffectiveColumnCount();if(e<=1)return[this._currentPage];const t=this._currentPage,s=[];if(this._columnAutoCenter){let i;e%2===0?i=Math.floor(e/2)-1:i=Math.floor(e/2);let n=t-i;n<0&&(n=0),n+e>this._totalPages&&(n=Math.max(0,this._totalPages-e));for(let o=0;o<e;o++){const r=n+o;s.push(r<this._totalPages?r:-1)}}else{const i=Math.floor(t/e)*e;for(let n=0;n<e;n++){const o=i+n;s.push(o<this._totalPages?o:-1)}}return s}_updateMultiColumnDisplay(){const e=this._getEffectiveColumnCount();if(!(e<=1||this._columnViewports.length===0)){this._columnViewports.length!==e&&this._buildColumnViewports(e),this._visiblePages=this._computeVisiblePages();for(let t=0;t<this._columnViewports.length;t++){const{viewport:s,content:i}=this._columnViewports[t],n=this._visiblePages[t];if(n<0||n>=this._totalPages){i.innerHTML="",s.classList.add("column-empty");continue}s.classList.remove("column-empty");const o=this._textContent.cloneNode(!0);o.removeAttribute("id"),o.classList.remove("multi-column-hidden"),o.className="text-content column-page-content",o.style.position="relative",o.style.overflow="hidden",o.style.height=`${this._pageHeight}px`;const r=(n+1)*this._pageHeight,a=this._contentScrollHeight||this._textContent.scrollHeight;if(a<r){const l=document.createElement("div");l.style.height=`${r-a}px`,l.style.flexShrink="0",o.appendChild(l)}i.innerHTML="",i.appendChild(o),o.scrollTop=n*this._pageHeight}}}_setupEventDelegation(){this._textContent.addEventListener("click",e=>{var i,n;const t=e.target.closest("img");if(t&&t.src){e.preventDefault();const o=t.alt||"";(i=this._onImageClick)==null||i.call(this,t.src,o);return}const s=e.target.closest("a[href]");if(s){const o=s.getAttribute("href");if(o){if(o.startsWith("mailto:")||o.startsWith("tel:"))return;if(o.startsWith("http://")||o.startsWith("https://")){e.preventDefault(),window.open(o,"_blank","noopener,noreferrer");return}e.preventDefault(),(n=this._onLinkClick)==null||n.call(this,o);return}}}),this._textContent.addEventListener("dblclick",e=>{var s;const t=e.target.closest(".sentence");if(t&&t.dataset.index!==void 0){const i=parseInt(t.dataset.index,10);(s=this._onSentenceClick)==null||s.call(this,i)}}),this._setupLongPress(this._textContent)}_setupLongPress(e){let t=null,s=0,i=0;e.addEventListener("touchstart",n=>{if(n.touches.length!==1)return;s=n.touches[0].clientX,i=n.touches[0].clientY;const o=n.target;t=setTimeout(()=>{var a,l;const r=o.closest(".sentence");if(r&&r.dataset.index!==void 0){const h=parseInt(r.dataset.index,10);(a=window.getSelection())==null||a.removeAllRanges(),this._hideHighlightToolbar(),(l=this._onSentenceClick)==null||l.call(this,h)}},500)},{passive:!0}),e.addEventListener("touchmove",n=>{if(t&&n.touches.length===1){const o=n.touches[0].clientX-s,r=n.touches[0].clientY-i;(Math.abs(o)>10||Math.abs(r)>10)&&(clearTimeout(t),t=null)}},{passive:!0}),e.addEventListener("touchend",()=>{t&&(clearTimeout(t),t=null)},{passive:!0}),e.addEventListener("touchcancel",()=>{t&&(clearTimeout(t),t=null)},{passive:!0})}_setupPageNavigation(){this._prevBtn&&this._prevBtn.addEventListener("click",()=>{var e;this._prevBtnMode==="chapter"?(e=this._onPrevChapter)==null||e.call(this):this.previousPage()}),this._nextBtn&&this._nextBtn.addEventListener("click",()=>{var e;this._nextBtnMode==="chapter"?(e=this._onNextChapter)==null||e.call(this):this.nextPage()})}_setupSwipeNavigation(){const e=this._pageContainer||this._container;e.addEventListener("touchstart",t=>{t.touches.length===1&&(this._touchStartX=t.touches[0].clientX,this._touchStartY=t.touches[0].clientY,this._touchStartTime=Date.now(),this._isSwiping=!1)},{passive:!0}),e.addEventListener("touchmove",t=>{if(t.touches.length!==1)return;const s=t.touches[0].clientX-this._touchStartX,i=t.touches[0].clientY-this._touchStartY;Math.abs(s)>10&&Math.abs(s)>Math.abs(i)*1.5&&(this._isSwiping=!0)},{passive:!0}),e.addEventListener("touchend",t=>{var a,l;if(!this._isSwiping)return;const s=t.changedTouches[0],i=s.clientX-this._touchStartX,n=s.clientY-this._touchStartY,o=Date.now()-this._touchStartTime;Math.abs(i)<50||Math.abs(i)<Math.abs(n)*1.2||o>600||(i<0?!this.nextPage()&&!this._isLastChapter&&((a=this._onNextChapter)==null||a.call(this)):!this.previousPage()&&!this._isFirstChapter&&((l=this._onPrevChapter)==null||l.call(this)))},{passive:!0})}_setupResizeHandler(){this._debouncedRecalculate=lt(()=>{(this._sentences.length>0||this._html)&&this._recalculatePages()},250),window.addEventListener("resize",this._debouncedRecalculate)}setBookTitle(e){this._bookTitleElement&&(this._bookTitleElement.textContent=e)}setChapterTitle(e){this._titleElement&&(this._titleElement.textContent=e)}setChapterBoundaries(e,t){this._isFirstChapter=e,this._isLastChapter=t,this._updatePageButtons()}goToLastPageAfterRender(){this._pendingGoToLastPage=!0}setSentences(e,t=0,s=null){console.time("ReaderView.setSentences"),this._sentences=e,this._currentIndex=t,this._html=s,this._currentPage=0;const i=this._getEffectiveColumnCount()>1;if(this._textContent.classList.remove("multi-column-hidden"),this._multiColumnContainer&&this._multiColumnContainer.classList.add("multi-column-inactive"),this._textContent.innerHTML="",e.length===0&&!s){this._textContent.innerHTML='<p class="empty-message">No content to display</p>',this._updatePageIndicator(),console.timeEnd("ReaderView.setSentences");return}console.log(`Chapter has ${e.length} sentences, HTML mode: ${!!s}`),s?this._renderHtml(s,t):this._renderSentencesOnly(e,t);const n=this._pendingGoToLastPage;this._pendingGoToLastPage=!1,requestAnimationFrame(()=>{requestAnimationFrame(()=>{var o;if(this._calculatePages(),n)this._currentPage=Math.max(0,this._totalPages-1);else if(t>0){const r=this._sentenceToPage.get(t);r!==void 0&&(this._currentPage=r)}if(i)this._textContent.classList.add("multi-column-hidden"),(o=this._multiColumnContainer)==null||o.classList.remove("multi-column-inactive"),this._buildColumnViewports(this._getEffectiveColumnCount()),this._updateMultiColumnDisplay();else if(this._currentPage>0){const r=this._pageHeight||this._textContent.clientHeight;this._textContent.scrollTop=this._currentPage*r}this._updatePageIndicator(),this._updatePageButtons()})}),console.timeEnd("ReaderView.setSentences")}renderSentences(e,t=0,s=null){this.setSentences(e,t,s)}_renderHtml(e,t){console.time("ReaderView._renderHtml"),this._textContent.innerHTML=e;const s=this._textContent.querySelectorAll(".sentence[data-index]");console.log(`Found ${s.length} sentence elements in HTML`),s.forEach(i=>{const n=parseInt(i.dataset.index,10);n<t?i.classList.add("played"):n===t&&i.classList.add("current")}),console.timeEnd("ReaderView._renderHtml")}_renderSentencesOnly(e,t){console.time("ReaderView._renderSentencesOnly");const s=document.createDocumentFragment();let i=document.createElement("p");i.className="paragraph";for(let n=0;n<e.length;n++){const o=e[n],r=document.createElement("span");r.className="sentence",r.dataset.index=n.toString(),r.textContent=o+" ",n<t?r.classList.add("played"):n===t&&r.classList.add("current"),i.appendChild(r);const a=/[.!?]["']?\s*$/.test(o),l=(n+1)%6===0;a&&l&&n<e.length-1&&(s.appendChild(i),i=document.createElement("p"),i.className="paragraph")}i.hasChildNodes()&&s.appendChild(i),this._textContent.appendChild(s),console.timeEnd("ReaderView._renderSentencesOnly")}_calculatePages(){if(this._isCalculatingPages)return;this._isCalculatingPages=!0,console.time("ReaderView._calculatePages");const e=this._getEffectiveColumnCount();let t=null;if(e>1){t=this._textContent.style.maxWidth;const d=((this._pageContainer||this._textContent.parentElement).clientWidth-(e-1)*this._COLUMN_GAP)/e;this._textContent.style.maxWidth=`${d}px`,this._textContent.offsetHeight}let i=(this._pageContainer||this._textContent.parentElement||this._textContent).clientHeight;const n=this._textContent.scrollHeight;console.log(`Page calculation: container=${i}px, content=${n}px`),(i<=0||i>=n)&&(i=Math.max(300,window.innerHeight-400),console.log(`Using fallback page height: ${i}px`)),this._sentenceToPage=new Map,this._pageToSentences=new Map,this._pageHeight=i;const o=this._textContent.querySelectorAll(".sentence[data-index]");if(o.length===0){const h=n/i,d=h%1;this._totalPages=d<.05?Math.floor(h):Math.ceil(h),this._totalPages=Math.max(1,this._totalPages),this._contentScrollHeight=n,t!==null?this._textContent.style.maxWidth=t:e>1&&(this._textContent.style.maxWidth=""),this._updatePageIndicator(),this._updatePageButtons(),this._isCalculatingPages=!1,console.log(`No sentence elements; ${this._totalPages} pages from content height (${n}px)`),console.timeEnd("ReaderView._calculatePages");return}const r=n/i,a=r%1;this._totalPages=a<.05?Math.floor(r):Math.ceil(r),this._totalPages=Math.max(1,this._totalPages),o.forEach(h=>{const d=parseInt(h.dataset.index,10);if(this._sentenceToPage.has(d))return;const p=h.offsetTop,u=Math.floor(p/i);this._sentenceToPage.set(d,u),this._pageToSentences.has(u)||this._pageToSentences.set(u,[]),this._pageToSentences.get(u).push(d)});const l=Math.max(...this._sentenceToPage.values(),0);this._totalPages=Math.max(this._totalPages,l+1),console.log(`Calculated ${this._totalPages} pages for ${o.length} sentences (pageHeight=${i}px)`),this._contentScrollHeight=n,t!==null?this._textContent.style.maxWidth=t:e>1&&(this._textContent.style.maxWidth=""),console.timeEnd("ReaderView._calculatePages"),this._updatePageIndicator(),this._updatePageButtons(),this._isCalculatingPages=!1}_recalculatePages(){var s,i;const e=this._textContent.classList.contains("multi-column-hidden");e&&(this._textContent.classList.remove("multi-column-hidden"),(s=this._multiColumnContainer)==null||s.classList.add("multi-column-inactive"));const t=this._currentIndex;if(this._calculatePages(),t>=0){const n=this._sentenceToPage.get(t);n!==void 0&&(this._currentPage=n)}e&&(this._textContent.classList.add("multi-column-hidden"),(i=this._multiColumnContainer)==null||i.classList.remove("multi-column-inactive")),this._updateMultiColumnMode()}goToPage(e){this._goToPageInternal(e,!0)}_goToPageInternal(e,t=!0){var n;const s=Math.max(0,Math.min(e,this._totalPages-1));if(s===this._currentPage&&this._totalPages>1)return;if(this._currentPage=s,this._getEffectiveColumnCount()>1)this._updateMultiColumnDisplay();else{const o=this._pageHeight||this._textContent.clientHeight,r=s*o;this._textContent.scrollTop=r}this._updatePageIndicator(),this._updatePageButtons(),t&&((n=this._onPageChange)==null||n.call(this))}nextPage(){const e=this._getEffectiveColumnCount();if(e>1&&!this._columnAutoCenter){const s=Math.floor(this._currentPage/e)*e+e;return s<this._totalPages?(this._goToPageInternal(s),!0):!1}return this._currentPage<this._totalPages-1?(this._goToPageInternal(this._currentPage+1),!0):!1}previousPage(){const e=this._getEffectiveColumnCount();if(e>1&&!this._columnAutoCenter){const s=Math.floor(this._currentPage/e)*e-e;return s>=0?(this._goToPageInternal(s),!0):!1}return this._currentPage>0?(this._goToPageInternal(this._currentPage-1),!0):!1}firstPage(){return this._currentPage>0?(this._goToPageInternal(0),!0):!1}lastPage(){return this._currentPage<this._totalPages-1?(this._goToPageInternal(this._totalPages-1),!0):!1}getCurrentPage(){return this._currentPage}getTotalPages(){return this._totalPages}_updatePageIndicator(){if(this._getEffectiveColumnCount()>1&&this._visiblePages.length>0){const t=this._visiblePages.filter(s=>s>=0);if(t.length>0){const s=Math.min(...t)+1,i=Math.max(...t)+1;this._pageCurrentEl&&(this._pageCurrentEl.textContent=s===i?`${s}`:`${s}-${i}`)}}else this._pageCurrentEl&&(this._pageCurrentEl.textContent=(this._currentPage+1).toString());this._pageTotalEl&&(this._pageTotalEl.textContent=this._totalPages.toString())}_updatePageButtons(){const e=this._getEffectiveColumnCount(),t=e>1&&!this._columnAutoCenter;let s,i;if(t){const n=Math.floor(this._currentPage/e)*e;s=n<=0,i=n+e>=this._totalPages}else s=this._currentPage<=0,i=this._currentPage>=this._totalPages-1;this._prevBtn&&(s&&!this._isFirstChapter?(this._prevBtnMode="chapter",this._prevBtn.disabled=!1,this._prevBtn.innerHTML=this._CHAPTER_ARROW_SVG,this._prevBtn.setAttribute("aria-label","Previous chapter"),this._prevBtn.setAttribute("title","Previous chapter"),this._prevBtn.classList.add("page-nav-chapter")):(this._prevBtnMode="page",this._prevBtn.disabled=s,this._prevBtn.innerHTML=this._PAGE_ARROW_SVG,this._prevBtn.setAttribute("aria-label","Previous page"),this._prevBtn.removeAttribute("title"),this._prevBtn.classList.remove("page-nav-chapter"))),this._nextBtn&&(i&&!this._isLastChapter?(this._nextBtnMode="chapter",this._nextBtn.disabled=!1,this._nextBtn.innerHTML=this._CHAPTER_ARROW_SVG_NEXT,this._nextBtn.setAttribute("aria-label","Next chapter"),this._nextBtn.setAttribute("title","Next chapter"),this._nextBtn.classList.add("page-nav-chapter")):(this._nextBtnMode="page",this._nextBtn.disabled=i,this._nextBtn.innerHTML=this._PAGE_ARROW_SVG_NEXT,this._nextBtn.setAttribute("aria-label","Next page"),this._nextBtn.removeAttribute("title"),this._nextBtn.classList.remove("page-nav-chapter")))}_navigateToSentencePage(e){const t=this._sentenceToPage.get(e);if(t===void 0)return!1;const s=this._getEffectiveColumnCount();return s>1&&this._columnAutoCenter?t!==this._currentPage?(this._goToPageInternal(t,!1),!0):!1:s>1&&!this._columnAutoCenter?this._computeVisiblePages().includes(t)?!1:(this._goToPageInternal(t,!1),!0):t!==this._currentPage?(this._goToPageInternal(t,!1),!0):!1}highlightSentence(e,t=!0){this._textContent.querySelectorAll(`.sentence[data-index="${this._currentIndex}"]`).forEach(n=>{n.classList.remove("current"),n.classList.add("played")}),this._currentIndex=e,this._textContent.querySelectorAll(`.sentence[data-index="${e}"]`).forEach(n=>{n.classList.remove("played"),n.classList.add("current")}),t?!this._navigateToSentencePage(e)&&this._getEffectiveColumnCount()>1&&this._updateMultiColumnDisplay():this._getEffectiveColumnCount()>1&&this._updateMultiColumnDisplay()}clearHighlights(){this._textContent.querySelectorAll(".sentence").forEach(t=>{t.classList.remove("current","played")}),this._currentIndex=-1,this._getEffectiveColumnCount()>1&&this._updateMultiColumnDisplay()}resetPlayedState(e){this._textContent.querySelectorAll(".sentence[data-index]").forEach(s=>{parseInt(s.dataset.index,10)>=e&&s.classList.remove("played")}),this._getEffectiveColumnCount()>1&&this._updateMultiColumnDisplay()}getCurrentIndex(){return this._currentIndex}getSentenceCount(){return this._sentences.length}getVisiblePages(){return this._getEffectiveColumnCount()>1?this._visiblePages.filter(e=>e>=0):[this._currentPage]}getSentenceToPageMap(){return this._sentenceToPage}getPageToSentencesMap(){return this._pageToSentences}getPageHeight(){return this._pageHeight}getTextContentElement(){return this._textContent}showLoading(){this._textContent.classList.remove("multi-column-hidden"),this._multiColumnContainer&&this._multiColumnContainer.classList.add("multi-column-inactive"),this._textContent.innerHTML=`
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading chapter...</p>
            </div>
        `,this._totalPages=1,this._currentPage=0,this._updatePageIndicator(),this._updatePageButtons()}showError(e){this._textContent.classList.remove("multi-column-hidden"),this._multiColumnContainer&&this._multiColumnContainer.classList.add("multi-column-inactive"),this._textContent.innerHTML=`
            <div class="error-message">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>${e}</span>
            </div>
        `,this._totalPages=1,this._currentPage=0,this._updatePageIndicator(),this._updatePageButtons()}scrollToTop(){this._goToPageInternal(0,!1)}scrollToFragment(e){if(!e)return!1;try{const t=this._textContent.querySelector(`[id="${CSS.escape(e)}"]`);if(t){const s=t.offsetTop,i=this._pageHeight||this._textContent.clientHeight;if(i>0){const n=Math.floor(s/i);this._goToPageInternal(n,!1)}return t.classList.add("link-target"),setTimeout(()=>t.classList.remove("link-target"),2e3),!0}}catch(t){console.warn("Failed to scroll to fragment:",e,t)}return!1}getSelectedSentenceTexts(){const e=window.getSelection();if(!e||e.isCollapsed||e.rangeCount===0)return null;const t=e.getRangeAt(0);if(!this._isWithinReaderContent(t.startContainer)||!this._isWithinReaderContent(t.endContainer))return null;const s=this._findSentenceElement(t.startContainer),i=this._findSentenceElement(t.endContainer);if(!s||!i)return null;const n=parseInt(s.dataset.index,10),o=parseInt(i.dataset.index,10),r=[];for(let a=n;a<=o;a++)a>=0&&a<this._sentences.length&&r.push(this._sentences[a]);return r.length>0?r:null}_createHighlightToolbar(){this._highlightToolbar=document.createElement("div"),this._highlightToolbar.className="highlight-toolbar hidden",this._highlightToolbar.innerHTML=`
            <button class="highlight-btn highlight-btn-yellow" data-color="yellow" title="Highlight yellow">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02zm1.414-1.414l2.829 2.828-1.415 1.414-2.828-2.828 1.414-1.414z"/>
                </svg>
            </button>
            <button class="highlight-btn highlight-btn-green" data-color="green" title="Highlight green">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02zm1.414-1.414l2.829 2.828-1.415 1.414-2.828-2.828 1.414-1.414z"/>
                </svg>
            </button>
            <button class="highlight-btn highlight-btn-blue" data-color="blue" title="Highlight blue">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02zm1.414-1.414l2.829 2.828-1.415 1.414-2.828-2.828 1.414-1.414z"/>
                </svg>
            </button>
            <button class="highlight-btn highlight-btn-pink" data-color="pink" title="Highlight pink">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                    <path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02zm1.414-1.414l2.829 2.828-1.415 1.414-2.828-2.828 1.414-1.414z"/>
                </svg>
            </button>
            <span class="highlight-toolbar-divider"></span>
            <button class="highlight-btn highlight-btn-lookup" title="Look up">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
            </button>
        `,document.body.appendChild(this._highlightToolbar),this._highlightToolbar.addEventListener("mousedown",e=>{e.preventDefault()}),this._highlightToolbar.addEventListener("click",e=>{const t=e.target.closest(".highlight-btn");if(t)if(t.classList.contains("highlight-btn-lookup"))this._lookupFromSelection();else{const s=t.dataset.color;this._createHighlightFromSelection(s)}})}_setupTextSelection(){document.addEventListener("selectionchange",()=>{this._handleSelectionChange()}),document.addEventListener("mousedown",t=>{!this._highlightToolbar.contains(t.target)&&!this._isWithinReaderContent(t.target)&&this._hideHighlightToolbar()});const e=t=>{(this._isWithinReaderContent(t.target)||this._highlightToolbar.contains(t.target))&&t.preventDefault()};document.addEventListener("contextmenu",e)}_isWithinReaderContent(e){return this._textContent.contains(e)||this._multiColumnContainer&&this._multiColumnContainer.contains(e)}_handleSelectionChange(){const e=window.getSelection();if(!e||e.isCollapsed||e.rangeCount===0){this._hideToolbarTimeout=setTimeout(()=>{this._hideHighlightToolbar()},200);return}const t=e.getRangeAt(0);if(!this._isWithinReaderContent(t.startContainer)||!this._isWithinReaderContent(t.endContainer))return;const s=this._findSentenceElement(t.startContainer),i=this._findSentenceElement(t.endContainer);if(!s||!i)return;this._hideToolbarTimeout&&(clearTimeout(this._hideToolbarTimeout),this._hideToolbarTimeout=null);const n=t.getBoundingClientRect();this._showHighlightToolbar(n)}_findSentenceElement(e){let t=e.nodeType===Node.TEXT_NODE?e.parentElement:e;for(;t&&t!==this._textContent&&t!==this._multiColumnContainer;){if(t.classList&&t.classList.contains("sentence")&&t.dataset.index!==void 0)return t;t=t.parentElement}return null}_showHighlightToolbar(e){const t=this._highlightToolbar;t.classList.remove("hidden");const s=t.offsetHeight,i=t.offsetWidth;let n=e.top-s-8+window.scrollY,o=e.left+e.width/2-i/2+window.scrollX;n<window.scrollY+4&&(n=e.bottom+8+window.scrollY),o=Math.max(4,Math.min(o,window.innerWidth-i-4)),t.style.top=`${n}px`,t.style.left=`${o}px`}_hideHighlightToolbar(){this._highlightToolbar.classList.add("hidden")}_createHighlightFromSelection(e="yellow"){var l;const t=window.getSelection();if(!t||t.isCollapsed||t.rangeCount===0)return;const s=t.getRangeAt(0),i=this._findSentenceElement(s.startContainer),n=this._findSentenceElement(s.endContainer);if(!i||!n)return;const o=parseInt(i.dataset.index,10),r=parseInt(n.dataset.index,10),a=t.toString().trim();a&&(this._applyHighlightToSentences(o,r,e),t.removeAllRanges(),this._hideHighlightToolbar(),this._getEffectiveColumnCount()>1&&this._updateMultiColumnDisplay(),(l=this._onHighlight)==null||l.call(this,o,r,a,e))}_lookupFromSelection(){var o;const e=window.getSelection();if(!e||e.isCollapsed||e.rangeCount===0)return;const t=e.getRangeAt(0),s=this._findSentenceElement(t.startContainer),i=e.toString().trim();if(!i)return;const n=s?parseInt(s.dataset.index,10):0;e.removeAllRanges(),this._hideHighlightToolbar(),(o=this._onLookup)==null||o.call(this,i,n)}_applyHighlightToSentences(e,t,s="yellow"){for(let i=e;i<=t;i++)this._textContent.querySelectorAll(`.sentence[data-index="${i}"]`).forEach(o=>o.classList.add("user-highlight",`highlight-${s}`))}_removeHighlightFromSentences(e,t){for(let s=e;s<=t;s++)this._textContent.querySelectorAll(`.sentence[data-index="${s}"]`).forEach(n=>n.classList.remove("user-highlight","highlight-yellow","highlight-green","highlight-blue","highlight-pink"))}setHighlights(e){this._highlights=e,this._applyAllHighlights()}_applyAllHighlights(){this._textContent.querySelectorAll(".user-highlight").forEach(t=>{t.classList.remove("user-highlight","highlight-yellow","highlight-green","highlight-blue","highlight-pink")});for(const t of this._highlights)this._applyHighlightToSentences(t.startSentenceIndex,t.endSentenceIndex,t.color||"yellow");this._getEffectiveColumnCount()>1&&this._updateMultiColumnDisplay()}applySearchHighlights(e,t,s,i,n){if(!e||i.length===0){this.clearSearchHighlights();return}let o="g";t||(o+="i");let r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");s&&(r=`\\b${r}\\b`);const a=new RegExp(r,o),l=new Set(i.map(d=>d.sentenceIndex));this._textContent.querySelectorAll(".sentence[data-index]").forEach(d=>{const p=parseInt(d.dataset.index,10);if(this._clearSearchHighlightsFromElement(d),!l.has(p))return;const u=p===n;this._highlightTextMatches(d,a,u)}),this._getEffectiveColumnCount()>1&&this._updateMultiColumnDisplay()}clearSearchHighlights(){this._textContent.querySelectorAll(".search-highlight, .search-highlight-active").forEach(t=>{const s=t.parentNode;for(;t.firstChild;)s.insertBefore(t.firstChild,t);s.removeChild(t),s.normalize()}),this._getEffectiveColumnCount()>1&&this._updateMultiColumnDisplay()}_clearSearchHighlightsFromElement(e){e.querySelectorAll(".search-highlight, .search-highlight-active").forEach(s=>{const i=s.parentNode;for(;s.firstChild;)i.insertBefore(s.firstChild,s);i.removeChild(s)}),e.normalize()}_highlightTextMatches(e,t,s){const i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),n=[];let o;for(;o=i.nextNode();)n.push(o);for(const r of n){const a=r.nodeValue;t.lastIndex=0;const l=[];let h;for(;(h=t.exec(a))!==null;)l.push({index:h.index,length:h[0].length});if(l.length===0)continue;const d=document.createDocumentFragment();let p=0;for(const u of l){u.index>p&&d.appendChild(document.createTextNode(a.substring(p,u.index)));const g=document.createElement("mark");g.className=s?"search-highlight-active":"search-highlight",g.textContent=a.substring(u.index,u.index+u.length),d.appendChild(g),p=u.index+u.length}p<a.length&&d.appendChild(document.createTextNode(a.substring(p))),r.parentNode.replaceChild(d,r)}}scrollToSentence(e){const t=this._sentenceToPage.get(e);if(t===void 0)return!1;this._goToPageInternal(t,!0);const s=this._textContent.querySelectorAll(`.sentence[data-index="${e}"]`);return s.length>0&&(s.forEach(i=>i.classList.add("link-target")),setTimeout(()=>s.forEach(i=>i.classList.remove("link-target")),2e3)),!0}destroy(){window.removeEventListener("resize",this._debouncedRecalculate),this._highlightToolbar&&this._highlightToolbar.remove(),this._hideToolbarTimeout&&clearTimeout(this._hideToolbarTimeout),this._multiColumnContainer&&this._multiColumnContainer.remove()}}class Qs{constructor(e,t){this._playBtn=e.playBtn,this._pauseIcon=e.pauseIcon,this._playIcon=e.playIcon,this._prevBtn=e.prevBtn,this._nextBtn=e.nextBtn,this._prevChapterBtn=e.prevChapterBtn,this._nextChapterBtn=e.nextChapterBtn,this._askBtn=e.askBtn,this._quizBtn=e.quizBtn,this._speedSlider=e.speedSlider||null,this._speedValue=e.speedValue||null,this._voiceSelect=e.voiceSelect||null,this._callbacks=t,this._isPlaying=!1,this._isEnabled=!1,this._setupEventListeners()}_setupEventListeners(){this._playBtn.addEventListener("click",()=>{var e,t,s,i;this._isPlaying?(t=(e=this._callbacks).onPause)==null||t.call(e):(i=(s=this._callbacks).onPlay)==null||i.call(s)}),this._prevBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onPrev)==null||t.call(e)}),this._nextBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onNext)==null||t.call(e)}),this._prevChapterBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onPrevChapter)==null||t.call(e)}),this._nextChapterBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onNextChapter)==null||t.call(e)}),this._askBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onAsk)==null||t.call(e)}),this._quizBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onQuiz)==null||t.call(e)}),this._speedSlider&&this._speedSlider.addEventListener("input",()=>{var t,s;const e=parseFloat(this._speedSlider.value);this._updateSpeedDisplay(e),(s=(t=this._callbacks).onSpeedChange)==null||s.call(t,e)}),this._voiceSelect&&this._voiceSelect.addEventListener("change",()=>{var t,s;const e=this._voiceSelect.value;(s=(t=this._callbacks).onVoiceChange)==null||s.call(t,e)})}_updateSpeedDisplay(e){this._speedValue&&(this._speedValue.textContent=`${e.toFixed(1)}x`)}setPlaying(e){this._isPlaying=e,this._setBuffering(!1),e?(this._playIcon.classList.add("hidden"),this._pauseIcon.classList.remove("hidden")):(this._playIcon.classList.remove("hidden"),this._pauseIcon.classList.add("hidden"))}setBuffering(e){this._setBuffering(e)}_setBuffering(e){e?(this._playBtn.classList.add("buffering"),this._playIcon.classList.add("hidden"),this._pauseIcon.classList.add("hidden")):this._playBtn.classList.remove("buffering")}setEnabled(e){this._isEnabled=e,this._playBtn.disabled=!e,this._prevBtn.disabled=!e,this._nextBtn.disabled=!e,this._prevChapterBtn.disabled=!e,this._nextChapterBtn.disabled=!e,this._askBtn.disabled=!e,this._quizBtn.disabled=!e,this._speedSlider&&(this._speedSlider.disabled=!e)}setSpeed(e){this._speedSlider&&(this._speedSlider.value=e.toString(),this._updateSpeedDisplay(e))}getSpeed(){return this._speedSlider?parseFloat(this._speedSlider.value):1}setVoices(e){if(!this._voiceSelect)return;const t=this._voiceSelect.value;this._voiceSelect.innerHTML="",e.forEach(s=>{const i=document.createElement("option");i.value=s.id,i.textContent=s.disabled?`${s.name} (FastAPI only)`:s.name,i.disabled=!!s.disabled,this._voiceSelect.appendChild(i)}),e.some(s=>s.id===t&&!s.disabled)&&(this._voiceSelect.value=t)}setVoice(e){this._voiceSelect&&(this._voiceSelect.value=e)}getVoice(){return this._voiceSelect?this._voiceSelect.value:"af_bella"}setAskDisabled(e,t){this._askBtn.disabled=e,e&&t?this._askBtn.title=t:this._askBtn.title="Ask a question"}setQuizDisabled(e,t){this._quizBtn.disabled=e,e&&t?this._quizBtn.title=t:this._quizBtn.title="Start quiz"}}class Gs{constructor(e,t){this._panel=e.panel,this._overlay=e.overlay,this._menuBtn=e.menuBtn,this._callbacks=t,this._currentBook=null,this._currentChapterIndex=0,this._bookmarks=[],this._highlights=[],this._lookups=[],this._quizHistory=[],this._setupEventListeners()}_setupEventListeners(){this._menuBtn.addEventListener("click",()=>{this.open()}),this._overlay.addEventListener("click",()=>{this.close()});const e=this._panel.querySelector(".nav-close-btn");e&&e.addEventListener("click",()=>{this.close()});const t=this._panel.querySelector("#add-bookmark-btn");t&&t.addEventListener("click",()=>{var i,n;(n=(i=this._callbacks).onAddBookmark)==null||n.call(i)});const s=this._panel.querySelector("#view-lookup-history-btn");s&&s.addEventListener("click",()=>{var i,n;this.close(),(n=(i=this._callbacks).onViewLookupHistory)==null||n.call(i)})}setBook(e,t=0){this._currentBook=e,this._currentChapterIndex=t,this.render()}setBookmarks(e){this._bookmarks=e,this._renderBookmarks()}setCurrentChapter(e){this._currentChapterIndex=e,this._renderChapters()}setHighlights(e){this._highlights=e,this._renderHighlights()}setLookups(e){this._lookups=e,this._renderLookups()}setQuizHistory(e){this._quizHistory=e,this._renderQuizHistory()}render(){this._currentBook&&(this._renderChapters(),this._renderBookmarks(),this._renderHighlights(),this._renderLookups(),this._renderQuizHistory())}_renderChapters(){const e=this._panel.querySelector("#chapters-list");!e||!this._currentBook||(e.innerHTML="",this._currentBook.chapters.forEach((t,s)=>{const i=document.createElement("div");i.className="nav-item",s===this._currentChapterIndex&&i.classList.add("active"),i.innerHTML=`
                <span class="chapter-number">${s+1}.</span>
                <span class="chapter-title">${this._escapeHtml(t.title)}</span>
            `,i.addEventListener("click",()=>{var n,o;(o=(n=this._callbacks).onChapterSelect)==null||o.call(n,s),this.close()}),e.appendChild(i)}))}_renderBookmarks(){const e=this._panel.querySelector("#bookmarks-list");if(e){if(this._bookmarks.length===0){e.innerHTML='<div class="nav-empty">No bookmarks yet</div>';return}e.innerHTML="",this._bookmarks.forEach(t=>{var r,a;const s=document.createElement("div");s.className="nav-item bookmark-item";const i=((a=(r=this._currentBook)==null?void 0:r.chapters[t.chapterIndex])==null?void 0:a.title)||"Unknown";s.innerHTML=`
                <div class="bookmark-content">
                    <div class="bookmark-icon">📑</div>
                    <div class="bookmark-details">
                        <div class="bookmark-chapter">Ch. ${t.chapterIndex+1}: ${this._escapeHtml(i)}</div>
                        ${t.note?`<div class="bookmark-note">${this._escapeHtml(t.note)}</div>`:""}
                    </div>
                </div>
                <button class="bookmark-delete-btn" aria-label="Delete bookmark">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `,s.querySelector(".bookmark-content").addEventListener("click",()=>{var l,h;(h=(l=this._callbacks).onBookmarkSelect)==null||h.call(l,t),this.close()}),s.querySelector(".bookmark-delete-btn").addEventListener("click",l=>{var h,d;l.stopPropagation(),confirm("Delete this bookmark?")&&((d=(h=this._callbacks).onBookmarkDelete)==null||d.call(h,t.id))}),e.appendChild(s)})}}_renderHighlights(){const e=this._panel.querySelector("#highlights-list");if(e){if(this._highlights.length===0){e.innerHTML='<div class="nav-empty">No highlights yet</div>';return}e.innerHTML="",this._highlights.forEach(t=>{var l,h;const s=document.createElement("div");s.className="nav-item highlight-item";const i=((h=(l=this._currentBook)==null?void 0:l.chapters[t.chapterIndex])==null?void 0:h.title)||"Unknown",n=`highlight-color-${t.color||"yellow"}`,o=t.text.length>80?t.text.substring(0,80)+"...":t.text;s.innerHTML=`
                <div class="highlight-nav-content">
                    <div class="highlight-color-indicator ${n}"></div>
                    <div class="highlight-nav-details">
                        <div class="highlight-nav-chapter">Ch. ${t.chapterIndex+1}: ${this._escapeHtml(i)}</div>
                        <div class="highlight-nav-text">"${this._escapeHtml(o)}"</div>
                    </div>
                </div>
                <button class="highlight-delete-btn" aria-label="Delete highlight">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            `,s.querySelector(".highlight-nav-content").addEventListener("click",()=>{var d,p;(p=(d=this._callbacks).onHighlightSelect)==null||p.call(d,t),this.close()}),s.querySelector(".highlight-delete-btn").addEventListener("click",d=>{var p,u;d.stopPropagation(),confirm("Delete this highlight?")&&((u=(p=this._callbacks).onHighlightDelete)==null||u.call(p,t.id))}),e.appendChild(s)})}}_renderLookups(){const e=this._panel.querySelector("#lookups-list");if(!e)return;if(!this._lookups||this._lookups.length===0){e.innerHTML='<div class="nav-empty">No lookups yet</div>';return}e.innerHTML="",this._lookups.slice(0,20).forEach(s=>{const i=document.createElement("div");i.className="nav-item lookup-nav-item";const n=s.result||{},o=this._escapeHtml(n.phrase||s.phrase),r=n.definition?this._escapeHtml(n.definition.length>60?n.definition.substring(0,60)+"...":n.definition):"",a=n.sourceLanguage?`<span class="lookup-nav-lang">${this._escapeHtml(n.sourceLanguage)}</span>`:"";i.innerHTML=`
                <div class="lookup-nav-content">
                    <div class="lookup-nav-phrase">${o} ${a}</div>
                    <div class="lookup-nav-def">${r}</div>
                </div>
            `,e.appendChild(i)})}_renderQuizHistory(){const e=this._panel.querySelector("#quiz-history-list");if(e){if(!this._quizHistory||this._quizHistory.length===0){e.innerHTML='<div class="nav-empty">No quiz questions yet</div>';return}e.innerHTML="",this._quizHistory.forEach(({chapterIndex:t,questions:s})=>{var o,r;const i=((r=(o=this._currentBook)==null?void 0:o.chapters[t])==null?void 0:r.title)||"Unknown",n=document.createElement("div");n.className="quiz-history-chapter",n.innerHTML=`
                <div class="quiz-history-chapter-title">Ch. ${t+1}: ${this._escapeHtml(i)}</div>
            `,e.appendChild(n),s.forEach((a,l)=>{const h=document.createElement("div");h.className="quiz-history-item";const d=a.wasCorrect!==void 0?a.wasCorrect:null,p=d===!0?'<span class="quiz-history-correct">&#10003;</span>':d===!1?'<span class="quiz-history-incorrect">&#10007;</span>':"";let u="";if(a.options&&a.correctIndex!==void 0){const g=a.options[a.correctIndex];u=`<div class="quiz-history-answer"><strong>Answer:</strong> ${this._escapeHtml(g)}</div>`}else a.explanation&&(u=`<div class="quiz-history-answer"><strong>Answer:</strong> ${this._escapeHtml(a.explanation)}</div>`);h.innerHTML=`
                    <div class="quiz-history-question">
                        ${p}
                        <span class="quiz-history-q-num">${l+1}.</span>
                        ${this._escapeHtml(a.question)}
                    </div>
                    ${u}
                `,e.appendChild(h)})})}}open(){this._panel.classList.add("active"),this._overlay.classList.add("active"),document.body.style.overflow="hidden"}close(){this._panel.classList.remove("active"),this._overlay.classList.remove("active"),document.body.style.overflow=""}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class Us{constructor(e,t){this._container=e.container,this._callbacks=t,this._state=y.IDLE,this._transcript="",this._response="",this._history=[],this._historyIndex=-1,this._showTextInput=!1,this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="qa-dialog">
                <div class="qa-header">
                    <h2 class="qa-title">Q&A Mode</h2>
                    <button class="qa-close-btn" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div class="qa-content">
                    <div class="qa-status-section">
                        <div class="qa-icon" id="qa-icon"></div>
                        <div class="qa-status" id="qa-status">Ready</div>
                    </div>

                    <div class="qa-transcript-section" id="qa-transcript-section">
                        <label class="qa-label">Your Question:</label>
                        <div class="qa-transcript" id="qa-transcript"></div>
                    </div>

                    <div class="qa-text-input-section hidden" id="qa-text-input-section">
                        <label class="qa-label">Type your question:</label>
                        <div class="qa-text-input-wrapper">
                            <input type="text" class="qa-text-input" id="qa-text-input" placeholder="Enter your question...">
                            <button class="btn btn-primary qa-submit-btn" id="qa-submit-btn">Ask</button>
                        </div>
                        <button class="btn btn-secondary qa-retry-voice-btn" id="qa-retry-voice-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            </svg>
                            Try Voice Again
                        </button>
                    </div>

                    <div class="qa-response-section hidden" id="qa-response-section">
                        <label class="qa-label">Answer:</label>
                        <div class="qa-response" id="qa-response"></div>
                    </div>

                    <div class="qa-history-section hidden" id="qa-history-section">
                        <label class="qa-label">Previous Q&A:</label>
                        <div class="qa-history-nav">
                            <button class="btn-icon qa-history-prev" id="qa-history-prev" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15 18 9 12 15 6"/>
                                </svg>
                            </button>
                            <span class="qa-history-counter" id="qa-history-counter">0 / 0</span>
                            <button class="btn-icon qa-history-next" id="qa-history-next" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"/>
                                </svg>
                            </button>
                        </div>
                        <div class="qa-history-item" id="qa-history-item">
                            <div class="qa-history-question" id="qa-history-question"></div>
                            <div class="qa-history-answer" id="qa-history-answer"></div>
                        </div>
                    </div>
                </div>

                <div class="qa-controls" id="qa-controls">
                    <button class="btn btn-secondary" id="qa-cancel-btn">Cancel</button>
                </div>
            </div>
        `,this._elements={dialog:this._container.querySelector(".qa-dialog"),closeBtn:this._container.querySelector(".qa-close-btn"),icon:this._container.querySelector("#qa-icon"),status:this._container.querySelector("#qa-status"),transcriptSection:this._container.querySelector("#qa-transcript-section"),transcript:this._container.querySelector("#qa-transcript"),textInputSection:this._container.querySelector("#qa-text-input-section"),textInput:this._container.querySelector("#qa-text-input"),submitBtn:this._container.querySelector("#qa-submit-btn"),retryVoiceBtn:this._container.querySelector("#qa-retry-voice-btn"),responseSection:this._container.querySelector("#qa-response-section"),response:this._container.querySelector("#qa-response"),historySection:this._container.querySelector("#qa-history-section"),historyPrev:this._container.querySelector("#qa-history-prev"),historyNext:this._container.querySelector("#qa-history-next"),historyCounter:this._container.querySelector("#qa-history-counter"),historyQuestion:this._container.querySelector("#qa-history-question"),historyAnswer:this._container.querySelector("#qa-history-answer"),controls:this._container.querySelector("#qa-controls"),cancelBtn:this._container.querySelector("#qa-cancel-btn")}}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._container.addEventListener("click",e=>{var t,s;e.target===this._container&&((s=(t=this._callbacks).onClose)==null||s.call(t))}),this._elements.submitBtn.addEventListener("click",()=>{this._submitTextQuestion()}),this._elements.textInput.addEventListener("keydown",e=>{e.key==="Enter"&&this._submitTextQuestion()}),this._elements.retryVoiceBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onRetryVoice)==null||t.call(e)}),this._elements.historyPrev.addEventListener("click",()=>{this._navigateHistory(-1)}),this._elements.historyNext.addEventListener("click",()=>{this._navigateHistory(1)}),this._elements.controls.addEventListener("click",e=>{var i,n,o,r,a,l,h,d,p,u,g,m,v,S;const t=e.target.closest("button");if(!t)return;switch(t.dataset.action){case"cancel":(n=(i=this._callbacks).onStop)==null||n.call(i),(r=(o=this._callbacks).onClose)==null||r.call(o);break;case"pause":(l=(a=this._callbacks).onPause)==null||l.call(a);break;case"resume":(d=(h=this._callbacks).onResume)==null||d.call(h);break;case"stop":(u=(p=this._callbacks).onStop)==null||u.call(p);break;case"continue":(m=(g=this._callbacks).onContinueReading)==null||m.call(g);break;case"ask-another":(S=(v=this._callbacks).onAskAnother)==null||S.call(v);break}})}_submitTextQuestion(){var t,s;const e=this._elements.textInput.value.trim();e&&(this._elements.textInput.value="",(s=(t=this._callbacks).onTextSubmit)==null||s.call(t,e))}show(){this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active")}hide(){this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||this._container.classList.add("hidden")},300)}isVisible(){return this._container.classList.contains("active")}setState(e,t={}){this._state=e,this._updateStatusDisplay(e),this._updateSectionsVisibility(e,t),this._updateControls(e),t.error&&this._showError(t.error)}_updateStatusDisplay(e){const t={[y.IDLE]:'<span class="qa-icon-emoji">?</span>',[y.LISTENING]:`
                <div class="qa-listening-animation">
                    <span></span><span></span><span></span>
                </div>
            `,[y.THINKING]:'<div class="spinner"></div>',[y.RESPONDING]:`
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 6 15 11 19 11 5"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
            `,[y.PAUSED]:`
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="6" y="4" width="4" height="16"/>
                    <rect x="14" y="4" width="4" height="16"/>
                </svg>
            `},s={[y.IDLE]:"Ready",[y.LISTENING]:"Listening...",[y.THINKING]:"Thinking...",[y.RESPONDING]:"Responding",[y.PAUSED]:"Paused"};this._elements.icon.innerHTML=t[e]||"",this._elements.status.textContent=s[e]||e}_updateSectionsVisibility(e,t){switch(this._elements.transcriptSection.classList.add("hidden"),this._elements.textInputSection.classList.add("hidden"),this._elements.responseSection.classList.add("hidden"),e){case y.IDLE:this._showTextInput&&this._elements.textInputSection.classList.remove("hidden");break;case y.LISTENING:this._elements.transcriptSection.classList.remove("hidden");break;case y.THINKING:this._elements.transcriptSection.classList.remove("hidden");break;case y.RESPONDING:case y.PAUSED:this._elements.transcriptSection.classList.remove("hidden"),this._elements.responseSection.classList.remove("hidden");break}}_updateControls(e){const t='<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',s='<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>',i='<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>',n='<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>';let o="";switch(e){case y.IDLE:o=`
                    <button class="btn btn-secondary" data-action="cancel">Close</button>
                `;break;case y.LISTENING:o=`
                    <button class="btn btn-secondary" data-action="cancel">Cancel</button>
                `;break;case y.THINKING:o=`
                    <button class="btn btn-secondary btn-icon-text" data-action="stop" title="Stop">${s}</button>
                `;break;case y.RESPONDING:o=`
                    <button class="btn btn-secondary btn-icon-text" data-action="pause" title="Pause">${t}</button>
                    <button class="btn btn-secondary btn-icon-text" data-action="stop" title="Stop">${s}</button>
                    <button class="btn btn-secondary btn-icon-text" data-action="ask-another" title="Ask Another">${n}</button>
                    <button class="btn btn-primary" data-action="continue">Continue Reading</button>
                `;break;case y.PAUSED:o=`
                    <button class="btn btn-primary btn-icon-text" data-action="resume" title="Resume">${i}</button>
                    <button class="btn btn-secondary btn-icon-text" data-action="stop" title="Stop">${s}</button>
                    <button class="btn btn-secondary btn-icon-text" data-action="ask-another" title="Ask Another">${n}</button>
                    <button class="btn btn-secondary" data-action="continue">Continue Reading</button>
                `;break}this._elements.controls.innerHTML=o}setTranscript(e){this._transcript=e,this._elements.transcript.textContent=e||"..."}setResponse(e){this._response=e,this._elements.response.textContent=e,this._elements.response.scrollTop=this._elements.response.scrollHeight}showTextInput(){this._showTextInput=!0,this._elements.textInputSection.classList.remove("hidden"),this._elements.textInput.focus()}hideTextInput(){this._showTextInput=!1,this._elements.textInputSection.classList.add("hidden")}_showError(e){this._elements.status.textContent=`Error: ${e}`,this._elements.icon.innerHTML=`
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        `}setHistory(e){this._history=e,this._historyIndex=e.length>0?e.length-1:-1,this._updateHistoryDisplay()}addHistoryEntry(e){this._history.push(e),this._historyIndex=this._history.length-1,this._updateHistoryDisplay()}_navigateHistory(e){const t=this._historyIndex+e;t>=0&&t<this._history.length&&(this._historyIndex=t,this._updateHistoryDisplay())}_updateHistoryDisplay(){if(this._history.length===0){this._elements.historySection.classList.add("hidden");return}this._elements.historySection.classList.remove("hidden"),this._elements.historyCounter.textContent=`${this._historyIndex+1} / ${this._history.length}`,this._elements.historyPrev.disabled=this._historyIndex<=0,this._elements.historyNext.disabled=this._historyIndex>=this._history.length-1;const e=this._history[this._historyIndex];e&&(this._elements.historyQuestion.textContent=e.question,this._elements.historyAnswer.textContent=e.answer)}reset(){this._transcript="",this._response="",this._showTextInput=!1,this._elements.transcript.textContent="",this._elements.response.textContent="",this._elements.textInput.value="",this.setState(y.IDLE)}}class Vs{constructor(e,t){this._container=e.container,this._callbacks=t,this._state=k.IDLE,this._currentQuestion=null,this._isMultipleChoice=!0,this._disabledOptions=[],this._selectedCorrect=-1,this._showNextButton=!1,this._feedbackText="",this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="quiz-dialog">
                <div class="quiz-header">
                    <h2 class="quiz-title">Quiz Mode</h2>
                    <button class="quiz-close-btn" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div class="quiz-content">
                    <!-- Status (loading/generating) -->
                    <div class="quiz-status-section" id="quiz-status-section">
                        <div class="quiz-icon" id="quiz-icon"></div>
                        <div class="quiz-status" id="quiz-status">Ready</div>
                    </div>

                    <!-- Question text -->
                    <div class="quiz-question-section hidden" id="quiz-question-section">
                        <div class="quiz-question-text" id="quiz-question-text"></div>
                    </div>

                    <!-- MC Options -->
                    <div class="quiz-options-section hidden" id="quiz-options-section">
                        <button class="quiz-option" data-index="0"><span class="quiz-option-label">A)</span> <span class="quiz-option-text"></span></button>
                        <button class="quiz-option" data-index="1"><span class="quiz-option-label">B)</span> <span class="quiz-option-text"></span></button>
                        <button class="quiz-option" data-index="2"><span class="quiz-option-label">C)</span> <span class="quiz-option-text"></span></button>
                        <button class="quiz-option" data-index="3"><span class="quiz-option-label">D)</span> <span class="quiz-option-text"></span></button>
                    </div>

                    <!-- Free-form input -->
                    <div class="quiz-input-section hidden" id="quiz-input-section">
                        <div class="quiz-text-input-wrapper">
                            <input type="text" class="quiz-text-input" id="quiz-text-input" placeholder="Type your answer...">
                            <button class="btn btn-primary quiz-submit-btn" id="quiz-submit-btn">Send</button>
                        </div>
                        <button class="btn btn-secondary quiz-mic-btn" id="quiz-mic-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            </svg>
                            Use Microphone
                        </button>
                    </div>

                    <!-- Voice transcript (shown during recording) -->
                    <div class="quiz-transcript-section hidden" id="quiz-transcript-section">
                        <label class="quiz-label">Listening...</label>
                        <div class="quiz-transcript" id="quiz-transcript">...</div>
                    </div>

                    <!-- Feedback -->
                    <div class="quiz-feedback-section hidden" id="quiz-feedback-section">
                        <label class="quiz-label">Feedback:</label>
                        <div class="quiz-feedback" id="quiz-feedback"></div>
                    </div>
                </div>

                <div class="quiz-controls" id="quiz-controls"></div>
            </div>
        `,this._elements={dialog:this._container.querySelector(".quiz-dialog"),closeBtn:this._container.querySelector(".quiz-close-btn"),statusSection:this._container.querySelector("#quiz-status-section"),icon:this._container.querySelector("#quiz-icon"),status:this._container.querySelector("#quiz-status"),questionSection:this._container.querySelector("#quiz-question-section"),questionText:this._container.querySelector("#quiz-question-text"),optionsSection:this._container.querySelector("#quiz-options-section"),options:this._container.querySelectorAll(".quiz-option"),optionTexts:this._container.querySelectorAll(".quiz-option-text"),inputSection:this._container.querySelector("#quiz-input-section"),textInput:this._container.querySelector("#quiz-text-input"),submitBtn:this._container.querySelector("#quiz-submit-btn"),micBtn:this._container.querySelector("#quiz-mic-btn"),transcriptSection:this._container.querySelector("#quiz-transcript-section"),transcript:this._container.querySelector("#quiz-transcript"),feedbackSection:this._container.querySelector("#quiz-feedback-section"),feedback:this._container.querySelector("#quiz-feedback"),controls:this._container.querySelector("#quiz-controls")}}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._container.addEventListener("click",e=>{var t,s;e.target===this._container&&((s=(t=this._callbacks).onClose)==null||s.call(t))}),this._elements.optionsSection.addEventListener("click",e=>{var i,n;const t=e.target.closest(".quiz-option");if(!t||t.disabled)return;const s=parseInt(t.dataset.index,10);(n=(i=this._callbacks).onMCAnswer)==null||n.call(i,s)}),this._elements.submitBtn.addEventListener("click",()=>{this._submitText()}),this._elements.textInput.addEventListener("keydown",e=>{e.key==="Enter"&&this._submitText()}),this._elements.micBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onVoiceAnswer)==null||t.call(e)}),this._elements.controls.addEventListener("click",e=>{var i,n,o,r,a,l;const t=e.target.closest("button");if(!t)return;switch(t.dataset.action){case"next-question":(n=(i=this._callbacks).onNextQuestion)==null||n.call(i);break;case"skip-answer":(r=(o=this._callbacks).onSkipToAnswer)==null||r.call(o);break;case"close":(l=(a=this._callbacks).onClose)==null||l.call(a);break}})}_submitText(){var t,s;const e=this._elements.textInput.value.trim();e&&(this._elements.textInput.value="",(s=(t=this._callbacks).onTextAnswer)==null||s.call(t,e))}show(){this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active")}hide(){this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||this._container.classList.add("hidden")},300)}isVisible(){return this._container.classList.contains("active")}setMultipleChoice(e){this._isMultipleChoice=e}showTranscript(){this._elements.transcriptSection.classList.remove("hidden"),this._elements.transcript.textContent="..."}hideTranscript(){this._elements.transcriptSection.classList.add("hidden")}setTranscript(e){this._elements.transcript.textContent=e||"..."}showQuestion(e){this._currentQuestion=e,this._disabledOptions=[],this._selectedCorrect=-1,this._showNextButton=!1,this._feedbackText="",this._elements.questionSection.classList.remove("hidden"),this._elements.questionText.textContent=e.question,this._elements.feedbackSection.classList.add("hidden"),this._elements.feedback.textContent="",this._isMultipleChoice&&e.options?(this._elements.optionsSection.classList.remove("hidden"),this._elements.inputSection.classList.add("hidden"),e.options.forEach((t,s)=>{this._elements.optionTexts[s].textContent=t,this._elements.options[s].disabled=!1,this._elements.options[s].className="quiz-option"})):(this._elements.optionsSection.classList.add("hidden"),this._elements.inputSection.classList.remove("hidden"),this._elements.textInput.value="",this._elements.textInput.disabled=!1,this._elements.submitBtn.disabled=!1,this._elements.micBtn.disabled=!1)}showAnswerResult(e){if(this._feedbackText=e.feedback||"",this._feedbackText&&(this._elements.feedbackSection.classList.remove("hidden"),this._elements.feedback.textContent=this._feedbackText,this._elements.feedback.scrollTop=this._elements.feedback.scrollHeight),this._isMultipleChoice){if(e.selectedIndex!==void 0){const t=this._elements.options[e.selectedIndex];e.correct?t.classList.add("quiz-option-correct"):(t.classList.add("quiz-option-incorrect"),t.disabled=!0,this._disabledOptions.push(e.selectedIndex))}e.done&&e.correctIndex!==void 0&&this._elements.options[e.correctIndex].classList.add("quiz-option-correct"),e.done&&this._elements.options.forEach(t=>t.disabled=!0)}else e.done&&(this._elements.textInput.disabled=!0,this._elements.submitBtn.disabled=!0,this._elements.micBtn.disabled=!0);this._showNextButton=e.done,this._updateControls()}setFeedbackText(e){this._feedbackText=e,this._elements.feedbackSection.classList.remove("hidden"),this._elements.feedback.textContent=e,this._elements.feedback.scrollTop=this._elements.feedback.scrollHeight}setState(e,t={}){this._state=e,this._updateStatusDisplay(e),this._updateInteractivity(e),this._updateControls()}showError(e){this._elements.icon.innerHTML=`
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        `,this._elements.status.textContent=`Error: ${e}`,this._elements.statusSection.classList.remove("hidden")}reset(){this._currentQuestion=null,this._disabledOptions=[],this._selectedCorrect=-1,this._showNextButton=!1,this._feedbackText="",this._elements.questionSection.classList.add("hidden"),this._elements.optionsSection.classList.add("hidden"),this._elements.inputSection.classList.add("hidden"),this._elements.transcriptSection.classList.add("hidden"),this._elements.feedbackSection.classList.add("hidden"),this._elements.feedback.textContent="",this._elements.transcript.textContent="...",this._elements.textInput.value="",this.setState(k.IDLE)}_updateStatusDisplay(e){switch(e){case k.IDLE:this._elements.statusSection.classList.remove("hidden"),this._elements.icon.innerHTML='<span class="quiz-icon-emoji">?</span>',this._elements.status.textContent="Ready to quiz";break;case k.GENERATING:this._elements.statusSection.classList.remove("hidden"),this._elements.icon.innerHTML='<div class="spinner"></div>',this._elements.status.textContent="Generating question...";break;case k.SPEAKING_QUESTION:this._elements.statusSection.classList.add("hidden");break;case k.AWAITING_ANSWER:this._elements.statusSection.classList.add("hidden");break;case k.EVALUATING:this._elements.statusSection.classList.remove("hidden"),this._elements.icon.innerHTML='<div class="spinner"></div>',this._elements.status.textContent="Evaluating...";break;case k.SPEAKING_FEEDBACK:this._elements.statusSection.classList.add("hidden");break}}_updateInteractivity(e){var s;const t=e===k.AWAITING_ANSWER;this._isMultipleChoice&&((s=this._currentQuestion)!=null&&s.options)&&this._elements.options.forEach((i,n)=>{this._disabledOptions.includes(n)||this._showNextButton?i.disabled=!0:i.disabled=!t}),this._elements.textInput.disabled=!t||this._showNextButton,this._elements.submitBtn.disabled=!t||this._showNextButton,this._elements.micBtn.disabled=!t||this._showNextButton}_updateControls(){let e="";this._state===k.GENERATING?e='<button class="btn btn-secondary" data-action="close">Cancel</button>':this._showNextButton?e=`
                <button class="btn btn-primary" data-action="next-question">Next Question</button>
                <button class="btn btn-secondary" data-action="close">Close</button>
            `:this._state===k.AWAITING_ANSWER||this._state===k.SPEAKING_QUESTION?e=`
                <button class="btn btn-secondary" data-action="skip-answer">Skip to Answer</button>
                <button class="btn btn-secondary" data-action="close">Close</button>
            `:this._state===k.EVALUATING||this._state===k.SPEAKING_FEEDBACK?e='<button class="btn btn-secondary" data-action="close">Close</button>':e=`
                <button class="btn btn-primary" data-action="next-question">Start Quiz</button>
                <button class="btn btn-secondary" data-action="close">Close</button>
            `,this._elements.controls.innerHTML=e}}class Ws{constructor(e,t){this._container=e.container,this._callbacks=t,this._fastApiAvailable=!1,this._settings={apiKey:"",model:H,fullChapterContext:!1,contextBefore:20,contextAfter:5,ttsBackend:"kokoro-js",fastApiUrl:"http://localhost:8880",voice:"af_bella",speed:1,font:"default",fontSize:16,marginSize:"medium",verticalMargin:2,lineSpacing:1.8,normalizeText:!0,normalizeNumbers:!0,normalizeAbbreviations:!0,quizMode:"multiple-choice",quizGuided:!0,quizReadOptionsAloud:!0,quizChapterScope:"full",quizQuestionTypes:{factual:!0,deeper_understanding:!0,vocabulary:!1,inference:!1,themes:!1},quizSystemPrompt:"",sttBackend:"web-speech",whisperModel:Te,whisperDevice:"auto",llmBackend:"openrouter",localLlmModel:Ce,localLlmDevice:"auto",lookupLanguage:"auto",readingHistorySize:3,columnCount:1,columnAutoCenter:!0,mediaSessionVolume:.01,mediaSessionDuration:300},this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="modal">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button class="btn-icon modal-close-btn" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div class="modal-content">
                    <div class="settings-section">
                        <h3>General</h3>

                        <div class="form-group">
                            <label for="settings-history-size">Reading History Size: <span id="settings-history-size-value">3</span></label>
                            <input type="range" id="settings-history-size" class="form-input" min="1" max="10" step="1" value="3">
                            <p class="form-hint">Number of recent books shown in "Continue reading" on the start screen</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Voice & Speed</h3>

                        <div class="form-group">
                            <label for="settings-voice">Voice</label>
                            <select id="settings-voice" class="form-select">
                                <option value="af_bella">Bella (American Female)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="settings-speed">Speed: <span id="settings-speed-value">1.0x</span></label>
                            <input type="range" id="settings-speed" class="form-input" min="0.5" max="2" step="0.1" value="1">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Typography</h3>

                        <div class="form-group">
                            <label for="settings-font">Font</label>
                            <select id="settings-font" class="form-select">
                                <option value="default">Default (System)</option>
                                <option value="serif">Serif</option>
                                <option value="sans-serif">Sans Serif</option>
                                <option value="georgia">Georgia</option>
                                <option value="times">Times New Roman</option>
                                <option value="palatino">Palatino</option>
                                <option value="bookerly">Bookerly</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="settings-font-size">Font Size: <span id="settings-font-size-value">16px</span></label>
                            <input type="range" id="settings-font-size" class="form-input" min="12" max="24" step="1" value="16">
                        </div>

                        <div class="form-group">
                            <label for="settings-margin">Horizontal Margins</label>
                            <select id="settings-margin" class="form-select">
                                <option value="narrow">Narrow</option>
                                <option value="medium">Medium</option>
                                <option value="wide">Wide</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="settings-vertical-margin">Vertical Margins: <span id="settings-vertical-margin-value">2px</span></label>
                            <input type="range" id="settings-vertical-margin" class="form-input" min="0" max="50" step="1" value="2">
                        </div>

                        <div class="form-group">
                            <label for="settings-line-spacing">Line Spacing: <span id="settings-line-spacing-value">1.8</span></label>
                            <input type="range" id="settings-line-spacing" class="form-input" min="1.0" max="2.5" step="0.1" value="1.8">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Layout</h3>

                        <div class="form-group">
                            <label>Columns: <span id="settings-column-count-value">1</span></label>
                            <div class="column-count-buttons" id="settings-column-count-buttons">
                                <button class="column-count-btn active" data-columns="1">1</button>
                                <button class="column-count-btn" data-columns="2">2</button>
                                <button class="column-count-btn" data-columns="3">3</button>
                                <button class="column-count-btn" data-columns="4">4</button>
                                <button class="column-count-btn" data-columns="5">5</button>
                            </div>
                            <p class="form-hint">Number of pages displayed side by side. Useful on wide screens.</p>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                                <input type="checkbox" id="settings-column-auto-center" checked>
                                Keep active page centered
                            </label>
                            <p class="form-hint">When enabled, the page with the current sentence stays in the center column. When disabled, the view advances only when the last visible page is reached.</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>TTS Backend</h3>

                        <div class="form-group">
                            <label for="settings-tts-backend">Text-to-Speech Engine</label>
                            <select id="settings-tts-backend" class="form-select">
                                <option value="kokoro-fastapi">Kokoro FastAPI (local server)</option>
                                <option value="kokoro-js">Kokoro.js (in-browser, WebGPU/WASM)</option>
                                <option value="web-speech">Browser TTS (Web Speech API)</option>
                            </select>
                            <p class="form-hint" id="settings-tts-backend-hint">
                                Kokoro FastAPI requires a local server running at the URL below.
                            </p>
                        </div>

                        <div class="form-group" id="settings-fastapi-url-group">
                            <label for="settings-fastapi-url">Kokoro FastAPI URL</label>
                            <input type="text" id="settings-fastapi-url" class="form-input" placeholder="http://localhost:8880" value="http://localhost:8880">
                            <p class="form-hint" id="settings-fastapi-status"></p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Text Normalization (Kokoro)</h3>
                        <p class="form-hint" style="margin-top: 0; margin-bottom: var(--spacing-md);">
                            Control how text is processed before being sent to Kokoro TTS.
                        </p>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="settings-normalize-text" checked>
                                Normalize Text
                            </label>
                            <p class="form-hint">Convert text to standard format (lowercase, remove extra spaces)</p>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="settings-normalize-numbers" checked>
                                Normalize Numbers
                            </label>
                            <p class="form-hint">Convert numbers to words (e.g., "123" → "one hundred twenty-three")</p>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="settings-normalize-abbreviations" checked>
                                Expand Abbreviations
                            </label>
                            <p class="form-hint">Expand common abbreviations (e.g., "Dr." → "Doctor", "St." → "Street")</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Word Lookup</h3>

                        <div class="form-group">
                            <label for="settings-lookup-language">Translation Target Language</label>
                            <select id="settings-lookup-language" class="form-select">
                                <option value="auto">Auto (LLM decides)</option>
                                <option value="English">English</option>
                                <option value="Norwegian">Norwegian</option>
                                <option value="Dutch">Dutch</option>
                                <option value="Japanese">Japanese</option>
                                <option value="German">German</option>
                                <option value="French">French</option>
                                <option value="Spanish">Spanish</option>
                                <option value="Portuguese">Portuguese</option>
                                <option value="Italian">Italian</option>
                                <option value="Chinese">Chinese</option>
                                <option value="Korean">Korean</option>
                                <option value="Hindi">Hindi</option>
                                <option value="Russian">Russian</option>
                                <option value="Arabic">Arabic</option>
                                <option value="Swedish">Swedish</option>
                                <option value="Danish">Danish</option>
                            </select>
                            <p class="form-hint">Select text and tap "Look up" in the toolbar to look up words and phrases. When set to Auto, the LLM determines the best language for definitions/translations based on context.</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Speech Recognition</h3>

                        <div class="form-group">
                            <label for="settings-stt-backend">STT Backend</label>
                            <select id="settings-stt-backend" class="form-select">
                                <option value="web-speech">Web Speech API (Online)</option>
                                <option value="whisper">Whisper (Local, On-Device)</option>
                            </select>
                            <p class="form-hint" id="settings-stt-backend-hint">
                                Uses the browser's built-in speech recognition. Requires an internet connection.
                            </p>
                        </div>

                        <div id="settings-whisper-options" style="display: none;">
                            <div class="form-group">
                                <label for="settings-whisper-model">Whisper Model</label>
                                <select id="settings-whisper-model" class="form-select">
                                    ${Tt.map(e=>`
                                        <option value="${e.id}">${e.name} (${e.size})</option>
                                    `).join("")}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="settings-whisper-device">Inference Device</label>
                                <select id="settings-whisper-device" class="form-select">
                                    <option value="auto">Auto (WebGPU if available)</option>
                                    <option value="webgpu">WebGPU</option>
                                    <option value="wasm">WASM (CPU)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div class="model-status" id="settings-whisper-status">
                                    <span class="model-status-text">Model not loaded</span>
                                    <button class="btn btn-secondary btn-sm" id="settings-whisper-download-btn">Download Model</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Q&A Settings</h3>

                        <div class="form-group">
                            <label for="settings-llm-backend">LLM Backend</label>
                            <select id="settings-llm-backend" class="form-select">
                                <option value="openrouter">OpenRouter (Cloud)</option>
                                <option value="local">Local (On-Device)</option>
                            </select>
                            <p class="form-hint" id="settings-llm-backend-hint">
                                Uses cloud AI models via OpenRouter. Requires an API key and internet connection.
                            </p>
                        </div>

                        <div id="settings-openrouter-options">
                            <div class="form-group">
                                <label for="settings-api-key">OpenRouter API Key</label>
                                <input type="password" id="settings-api-key" class="form-input" placeholder="sk-or-...">
                                <p class="form-hint">
                                    Get your free API key at <a href="https://openrouter.ai/keys" target="_blank" rel="noopener">openrouter.ai/keys</a>
                                </p>
                            </div>

                            <div class="form-group">
                                <label for="settings-model">AI Model</label>
                                <select id="settings-model" class="form-select">
                                    <optgroup label="Free Models">
                                        ${Z.free.map(e=>`
                                            <option value="${e.id}">${e.name}</option>
                                        `).join("")}
                                    </optgroup>
                                    <optgroup label="Paid Models">
                                        ${Z.paid.map(e=>`
                                            <option value="${e.id}">${e.name}</option>
                                        `).join("")}
                                    </optgroup>
                                </select>
                            </div>
                        </div>

                        <div id="settings-local-llm-options" style="display: none;">
                            <div class="form-group">
                                <label for="settings-local-llm-model">Local Model</label>
                                <select id="settings-local-llm-model" class="form-select">
                                    ${Ct.map(e=>`
                                        <option value="${e.id}">${e.name} (${e.size})</option>
                                    `).join("")}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="settings-local-llm-device">Inference Device</label>
                                <select id="settings-local-llm-device" class="form-select">
                                    <option value="auto">Auto (WebGPU if available)</option>
                                    <option value="webgpu">WebGPU</option>
                                    <option value="wasm">WASM (CPU)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <div class="model-status" id="settings-local-llm-status">
                                    <span class="model-status-text">Model not loaded</span>
                                    <button class="btn btn-secondary btn-sm" id="settings-local-llm-download-btn">Download Model</button>
                                </div>
                            </div>
                        </div>

                        <p class="form-hint" style="margin-top: 0; margin-bottom: var(--spacing-md);">
                            Context from the book is sent to the LLM along with your question.
                            You can either send the entire current chapter, or a configurable number
                            of sentences around your reading position.
                        </p>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                                <input type="checkbox" id="settings-full-chapter-context">
                                Send entire chapter as context
                            </label>
                            <p class="form-hint">When enabled, all sentences in the current chapter are sent to the LLM instead of the counts below</p>
                        </div>

                        <div class="form-group">
                            <label for="settings-context-before">Context Before (sentences)</label>
                            <input type="number" id="settings-context-before" class="form-input" min="0" max="500" value="20">
                            <p class="form-hint">Number of sentences before current position to include as context</p>
                        </div>

                        <div class="form-group">
                            <label for="settings-context-after">Context After (sentences)</label>
                            <input type="number" id="settings-context-after" class="form-input" min="0" max="500" value="5">
                            <p class="form-hint">Number of sentences after current position to include as context</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Quiz Settings</h3>

                        <div class="form-group">
                            <label for="settings-quiz-mode">Quiz Mode</label>
                            <select id="settings-quiz-mode" class="form-select">
                                <option value="multiple-choice">Multiple Choice</option>
                                <option value="free-form">Free Form</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                                <input type="checkbox" id="settings-quiz-guided" checked>
                                Guided Mode
                            </label>
                            <p class="form-hint">When enabled, the LLM provides hints after wrong answers instead of revealing the correct answer immediately</p>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                                <input type="checkbox" id="settings-quiz-read-options" checked>
                                Read Options Aloud
                            </label>
                            <p class="form-hint">When enabled, the TTS reads out the multiple choice answer options after the question</p>
                        </div>

                        <div class="form-group">
                            <label for="settings-quiz-scope">Chapter Scope</label>
                            <select id="settings-quiz-scope" class="form-select">
                                <option value="full">Entire chapter</option>
                                <option value="up-to-current">Up to current sentence</option>
                            </select>
                            <p class="form-hint">Determines whether questions cover the full chapter or only content up to your reading position</p>
                        </div>

                        <div class="form-group">
                            <label>Question Types</label>
                            <div style="display: flex; flex-direction: column; gap: var(--spacing-xs); margin-top: var(--spacing-xs);">
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="settings-quiz-type-factual" checked>
                                    Factual
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="settings-quiz-type-deeper">
                                    Deeper Understanding
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="settings-quiz-type-vocabulary">
                                    Vocabulary
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="settings-quiz-type-inference">
                                    Inference
                                </label>
                                <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer; font-weight: normal;">
                                    <input type="checkbox" id="settings-quiz-type-themes">
                                    Themes
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="settings-quiz-system-prompt">Custom System Prompt (optional)</label>
                            <textarea id="settings-quiz-system-prompt" class="form-input" rows="3" placeholder="Override the default system prompt for quiz generation..."></textarea>
                            <p class="form-hint">Leave empty to use the default quiz generation prompt</p>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3>Headset Controls</h3>

                        <div class="form-group">
                            <label for="settings-media-volume">Media Session Volume: <span id="settings-media-volume-value">0.01</span></label>
                            <input type="range" id="settings-media-volume" class="form-input" min="0.001" max="0.1" step="0.001" value="0.01">
                            <p class="form-hint">Volume of the background audio used to keep the media session active. Lower values are less audible but may not trigger the notification on some devices.</p>
                        </div>

                        <div class="form-group">
                            <label for="settings-media-duration">Media Session Duration: <span id="settings-media-duration-value">300s</span></label>
                            <input type="range" id="settings-media-duration" class="form-input" min="10" max="600" step="10" value="300">
                            <p class="form-hint">Duration of the background audio loop in seconds. Longer durations reduce loop restarts that could interrupt the media session.</p>
                        </div>

                        <h4 style="margin-top: var(--spacing-lg);">Diagnostics</h4>
                        <p class="form-hint" style="margin-top: 0; margin-bottom: var(--spacing-md);">
                            If headphone controls aren't working (especially on Android), use these tools to diagnose the issue.
                        </p>

                        <div id="diagnostic-status" class="form-hint" style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background-color: var(--bg-color); border-radius: var(--radius-md);">
                            Click "Run Diagnostics" to check your system.
                        </div>

                        <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
                            <button class="btn btn-secondary btn-sm" id="run-diagnostics-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                    <path d="M9 12l2 2 4-4"/>
                                    <circle cx="12" cy="12" r="10"/>
                                </svg>
                                Run Diagnostics
                            </button>
                            <button class="btn btn-secondary btn-sm" id="force-start-media-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polygon points="10 8 16 12 10 16 10 8"/>
                                </svg>
                                Force Start Media Session
                            </button>
                        </div>

                        <details style="margin-top: var(--spacing-md);">
                            <summary style="cursor: pointer; font-weight: 500; margin-bottom: var(--spacing-sm);">Android Troubleshooting Guide</summary>
                            <div class="form-hint" style="line-height: 1.6;">
                                <p><strong>Common issues on Android:</strong></p>
                                <ol style="margin-left: 20px; margin-top: var(--spacing-xs);">
                                    <li><strong>No notification:</strong> Make sure you've pressed play at least once in the app</li>
                                    <li><strong>Controls not responding:</strong> Try locking and unlocking your phone</li>
                                    <li><strong>Another app controlling media:</strong> Close Spotify, YouTube, etc.</li>
                                    <li><strong>HTTPS required:</strong> Some Android versions require HTTPS for Media Session API</li>
                                    <li><strong>Chrome flags:</strong> Visit chrome://flags and ensure "Hardware Media Key Handling" is enabled</li>
                                    <li><strong>Reset:</strong> Click "Force Start Media Session" above, then try headphone controls</li>
                                </ol>
                                <p style="margin-top: var(--spacing-sm);"><strong>Testing:</strong> After pressing play in the app, check your notification shade. You should see "Reading Partner" media controls there.</p>
                            </div>
                        </details>
                    </div>

                    <div class="settings-section">
                        <h3>About</h3>
                        <div id="settings-about-content" class="about-content">
                            <p>Loading information...</p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" id="settings-cancel-btn">Cancel</button>
                    <button class="btn btn-primary" id="settings-save-btn">Save</button>
                </div>
            </div>
        `,this._elements={modal:this._container.querySelector(".modal"),closeBtn:this._container.querySelector(".modal-close-btn"),historySize:this._container.querySelector("#settings-history-size"),historySizeValue:this._container.querySelector("#settings-history-size-value"),voice:this._container.querySelector("#settings-voice"),speed:this._container.querySelector("#settings-speed"),speedValue:this._container.querySelector("#settings-speed-value"),font:this._container.querySelector("#settings-font"),fontSize:this._container.querySelector("#settings-font-size"),fontSizeValue:this._container.querySelector("#settings-font-size-value"),margin:this._container.querySelector("#settings-margin"),verticalMargin:this._container.querySelector("#settings-vertical-margin"),verticalMarginValue:this._container.querySelector("#settings-vertical-margin-value"),lineSpacing:this._container.querySelector("#settings-line-spacing"),lineSpacingValue:this._container.querySelector("#settings-line-spacing-value"),columnCountButtons:this._container.querySelector("#settings-column-count-buttons"),columnCountValue:this._container.querySelector("#settings-column-count-value"),columnAutoCenter:this._container.querySelector("#settings-column-auto-center"),ttsBackend:this._container.querySelector("#settings-tts-backend"),fastApiUrl:this._container.querySelector("#settings-fastapi-url"),fastApiUrlGroup:this._container.querySelector("#settings-fastapi-url-group"),fastApiStatus:this._container.querySelector("#settings-fastapi-status"),ttsBackendHint:this._container.querySelector("#settings-tts-backend-hint"),lookupLanguage:this._container.querySelector("#settings-lookup-language"),normalizeText:this._container.querySelector("#settings-normalize-text"),normalizeNumbers:this._container.querySelector("#settings-normalize-numbers"),normalizeAbbreviations:this._container.querySelector("#settings-normalize-abbreviations"),mediaVolume:this._container.querySelector("#settings-media-volume"),mediaVolumeValue:this._container.querySelector("#settings-media-volume-value"),mediaDuration:this._container.querySelector("#settings-media-duration"),mediaDurationValue:this._container.querySelector("#settings-media-duration-value"),diagnosticStatus:this._container.querySelector("#diagnostic-status"),runDiagnosticsBtn:this._container.querySelector("#run-diagnostics-btn"),forceStartMediaBtn:this._container.querySelector("#force-start-media-btn"),sttBackend:this._container.querySelector("#settings-stt-backend"),sttBackendHint:this._container.querySelector("#settings-stt-backend-hint"),whisperOptions:this._container.querySelector("#settings-whisper-options"),whisperModel:this._container.querySelector("#settings-whisper-model"),whisperDevice:this._container.querySelector("#settings-whisper-device"),whisperStatus:this._container.querySelector("#settings-whisper-status"),whisperStatusText:this._container.querySelector("#settings-whisper-status .model-status-text"),whisperDownloadBtn:this._container.querySelector("#settings-whisper-download-btn"),llmBackend:this._container.querySelector("#settings-llm-backend"),llmBackendHint:this._container.querySelector("#settings-llm-backend-hint"),openrouterOptions:this._container.querySelector("#settings-openrouter-options"),localLlmOptions:this._container.querySelector("#settings-local-llm-options"),localLlmModel:this._container.querySelector("#settings-local-llm-model"),localLlmDevice:this._container.querySelector("#settings-local-llm-device"),localLlmStatus:this._container.querySelector("#settings-local-llm-status"),localLlmStatusText:this._container.querySelector("#settings-local-llm-status .model-status-text"),localLlmDownloadBtn:this._container.querySelector("#settings-local-llm-download-btn"),apiKey:this._container.querySelector("#settings-api-key"),model:this._container.querySelector("#settings-model"),fullChapterContext:this._container.querySelector("#settings-full-chapter-context"),contextBefore:this._container.querySelector("#settings-context-before"),contextAfter:this._container.querySelector("#settings-context-after"),quizMode:this._container.querySelector("#settings-quiz-mode"),quizGuided:this._container.querySelector("#settings-quiz-guided"),quizReadOptions:this._container.querySelector("#settings-quiz-read-options"),quizScope:this._container.querySelector("#settings-quiz-scope"),quizTypeFactual:this._container.querySelector("#settings-quiz-type-factual"),quizTypeDeeper:this._container.querySelector("#settings-quiz-type-deeper"),quizTypeVocabulary:this._container.querySelector("#settings-quiz-type-vocabulary"),quizTypeInference:this._container.querySelector("#settings-quiz-type-inference"),quizTypeThemes:this._container.querySelector("#settings-quiz-type-themes"),quizSystemPrompt:this._container.querySelector("#settings-quiz-system-prompt"),cancelBtn:this._container.querySelector("#settings-cancel-btn"),saveBtn:this._container.querySelector("#settings-save-btn"),aboutContent:this._container.querySelector("#settings-about-content")}}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._elements.cancelBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._elements.saveBtn.addEventListener("click",()=>{this._save()}),this._elements.ttsBackend.addEventListener("change",()=>{this._updateBackendUI()}),this._elements.sttBackend.addEventListener("change",()=>{this._updateSTTBackendUI()}),this._elements.llmBackend.addEventListener("change",()=>{this._updateLLMBackendUI()}),this._elements.whisperDownloadBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onWhisperDownload)==null||t.call(e,{model:this._elements.whisperModel.value,device:this._elements.whisperDevice.value})}),this._elements.localLlmDownloadBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onLocalLlmDownload)==null||t.call(e,{model:this._elements.localLlmModel.value,device:this._elements.localLlmDevice.value})}),this._elements.historySize.addEventListener("input",()=>{const e=parseInt(this._elements.historySize.value);this._elements.historySizeValue.textContent=e}),this._elements.speed.addEventListener("input",()=>{const e=parseFloat(this._elements.speed.value);this._elements.speedValue.textContent=`${e.toFixed(1)}x`}),this._elements.fontSize.addEventListener("input",()=>{const e=parseInt(this._elements.fontSize.value);this._elements.fontSizeValue.textContent=`${e}px`}),this._elements.verticalMargin.addEventListener("input",()=>{const e=parseInt(this._elements.verticalMargin.value);this._elements.verticalMarginValue.textContent=`${e}px`}),this._elements.lineSpacing.addEventListener("input",()=>{const e=parseFloat(this._elements.lineSpacing.value);this._elements.lineSpacingValue.textContent=e.toFixed(1)}),this._elements.columnCountButtons.addEventListener("click",e=>{const t=e.target.closest(".column-count-btn");if(!t)return;const s=parseInt(t.dataset.columns,10);this._elements.columnCountButtons.querySelectorAll(".column-count-btn").forEach(i=>i.classList.remove("active")),t.classList.add("active"),this._elements.columnCountValue.textContent=s}),this._elements.mediaVolume.addEventListener("input",()=>{const e=parseFloat(this._elements.mediaVolume.value);this._elements.mediaVolumeValue.textContent=e.toFixed(3)}),this._elements.mediaDuration.addEventListener("input",()=>{const e=parseInt(this._elements.mediaDuration.value);this._elements.mediaDurationValue.textContent=`${e}s`}),this._elements.runDiagnosticsBtn.addEventListener("click",()=>{this._runDiagnostics()}),this._elements.forceStartMediaBtn.addEventListener("click",async()=>{const e=this._elements.forceStartMediaBtn;e.disabled=!0,e.textContent="Starting...",await A.forceStart()?(e.textContent="✓ Started Successfully",e.style.color="#059669",setTimeout(()=>{e.textContent="Force Start Media Session",e.style.color="",e.disabled=!1},3e3)):(e.textContent="✗ Failed to Start",e.style.color="#dc2626",setTimeout(()=>{e.textContent="Force Start Media Session",e.style.color="",e.disabled=!1},3e3))}),this._container.addEventListener("click",e=>{var t,s;e.target===this._container&&((s=(t=this._callbacks).onClose)==null||s.call(t))}),document.addEventListener("keydown",e=>{var t,s;e.key==="Escape"&&this.isVisible()&&((s=(t=this._callbacks).onClose)==null||s.call(t))})}_updateBackendUI(){const e=this._elements.ttsBackend.value,t=e==="kokoro-fastapi";this._elements.fastApiUrlGroup.style.display=t?"":"none";const s={"kokoro-fastapi":"Kokoro FastAPI requires a local server running at the URL below.","kokoro-js":"Runs the Kokoro TTS model directly in the browser using WebGPU or WASM.","web-speech":"Uses the browser's built-in speech synthesis. No setup required."};this._elements.ttsBackendHint.textContent=s[e]||"",t&&(this._elements.fastApiStatus.textContent=this._fastApiAvailable?"Server detected":"Server not detected",this._elements.fastApiStatus.style.color=this._fastApiAvailable?"#059669":"#dc2626")}_updateSTTBackendUI(){const e=this._elements.sttBackend.value,t=e==="whisper";this._elements.whisperOptions.style.display=t?"":"none";const s={"web-speech":"Uses the browser's built-in speech recognition. Requires an internet connection.",whisper:"Runs the Whisper speech recognition model locally on your device. Works offline."};this._elements.sttBackendHint.textContent=s[e]||""}_updateLLMBackendUI(){const e=this._elements.llmBackend.value,t=e==="openrouter",s=e==="local";this._elements.openrouterOptions.style.display=t?"":"none",this._elements.localLlmOptions.style.display=s?"":"none";const i={openrouter:"Uses cloud AI models via OpenRouter. Requires an API key and internet connection.",local:"Runs a small language model locally on your device. Works offline but produces simpler responses."};this._elements.llmBackendHint.textContent=i[e]||""}setWhisperStatus(e){e.loading?(this._elements.whisperStatusText.textContent=e.statusText||"Loading...",this._elements.whisperDownloadBtn.style.display="none"):e.loaded?(this._elements.whisperStatusText.textContent=e.statusText||"Model ready",this._elements.whisperStatusText.style.color="#059669",this._elements.whisperDownloadBtn.style.display="none"):(this._elements.whisperStatusText.textContent=e.statusText||"Model not loaded",this._elements.whisperStatusText.style.color="",this._elements.whisperDownloadBtn.style.display="")}setLocalLlmStatus(e){e.loading?(this._elements.localLlmStatusText.textContent=e.statusText||"Loading...",this._elements.localLlmDownloadBtn.style.display="none"):e.loaded?(this._elements.localLlmStatusText.textContent=e.statusText||"Model ready",this._elements.localLlmStatusText.style.color="#059669",this._elements.localLlmDownloadBtn.style.display="none"):(this._elements.localLlmStatusText.textContent=e.statusText||"Model not loaded",this._elements.localLlmStatusText.style.color="",this._elements.localLlmDownloadBtn.style.display="")}_runDiagnostics(){const e=this._elements.diagnosticStatus;e.innerHTML="<strong>Running diagnostics...</strong>";const t=A.diagnose();let s='<div style="font-family: monospace; font-size: 13px;">';if(s+="<strong>📊 Diagnostic Results:</strong><br><br>",s+=`✓ Media Session API: ${t.supported?'<span style="color: #059669;">Supported</span>':'<span style="color: #dc2626;">Not Supported</span>'}<br>`,s+=`${t.initialized?"✓":"✗"} Initialized: ${t.initialized}<br>`,s+=`${t.hasUserInteraction?"✓":"✗"} User Interaction: ${t.hasUserInteraction}<br><br>`,t.audioElement!=="not created"){s+="<strong>🔊 Audio Element:</strong><br>";const r=!t.audioElement.paused;s+=`${r?"✓":"✗"} State: ${t.audioElement.paused?"Paused":"Playing"}`,t.isAndroid&&r?s+=' <span style="color: #059669;">(Good! Android needs this)</span>':t.isAndroid&&!r&&(s+=' <span style="color: #dc2626;">(Issue! Should be playing on Android)</span>'),s+="<br>",s+=`${t.audioElement.readyState>=2?"✓":"✗"} Ready State: ${t.audioElement.readyState}/4<br>`,s+=`Volume: ${t.audioElement.volume}<br><br>`}else s+="<strong>🔊 Audio Element:</strong> Not created<br><br>";s+="<strong>📱 Media Session:</strong><br>",s+=`State: ${t.mediaSession.playbackState||"none"}<br>`,t.mediaSession.metadata&&(s+=`Title: ${t.mediaSession.metadata.title}<br>`),s+=`Q&A Mode: ${t.qaMode?"Active":"Inactive"}<br><br>`;const i=/Android/i.test(navigator.userAgent),n=location.protocol==="https:";s+="<strong>🌐 Environment:</strong><br>",s+=`Platform: ${i?'<span style="color: #f59e0b;">Android</span>':"Other"}<br>`,s+=`Protocol: ${n?'<span style="color: #059669;">HTTPS</span>':'<span style="color: #f59e0b;">HTTP</span>'}<br><br>`,s+="<strong>💡 Recommendations:</strong><br>";const o=[];t.supported||o.push("⚠️ Media Session API not supported in this browser"),t.hasUserInteraction||o.push('⚠️ Click "Force Start Media Session" or press play in the app'),t.audioElement==="not created"&&o.push("⚠️ Audio element not created - try loading a book"),i&&t.audioElement!=="not created"&&t.audioElement.paused&&o.push(`🚨 <strong>CRITICAL:</strong> Silent audio is paused on Android! This is why you don't see the notification. Click "Force Start Media Session" button above to fix this.`),t.audioElement!=="not created"&&t.audioElement.paused&&t.mediaSession.playbackState==="playing"&&o.push("⚠️ State mismatch: Media Session says playing but audio is paused"),i&&!n&&o.push("⚠️ Android + HTTP: Some devices require HTTPS for media controls"),o.length===0?(s+='<span style="color: #059669;">✓ Everything looks good!<br><br>',s+='<strong>On Android:</strong> Check notification shade - you should see "Reading Partner" media controls.<br><br>',s+="<strong>If controls still don't work:</strong><br>",s+="  1. Check if notification is visible in notification shade<br>",s+="  2. Lock and unlock your phone<br>",s+="  3. Close other media apps (Spotify, YouTube)<br>",s+="  4. Try pressing play in the app, then use headphone controls</span>"):s+=o.join("<br>"),s+="</div>",e.innerHTML=s,console.log("=== Full Diagnostic Output ==="),console.log(JSON.stringify(t,null,2))}_save(){var n,o,r,a,l,h,d,p,u,g,m;const e={readingHistorySize:parseInt(this._elements.historySize.value)||3,apiKey:this._elements.apiKey.value.trim(),model:this._elements.model.value,fullChapterContext:this._elements.fullChapterContext.checked,contextBefore:parseInt(this._elements.contextBefore.value)||20,contextAfter:parseInt(this._elements.contextAfter.value)||5,ttsBackend:this._elements.ttsBackend.value,fastApiUrl:this._elements.fastApiUrl.value.trim()||"http://localhost:8880",voice:this._elements.voice.value,speed:parseFloat(this._elements.speed.value),font:this._elements.font.value,fontSize:parseInt(this._elements.fontSize.value),marginSize:this._elements.margin.value,verticalMargin:parseInt(this._elements.verticalMargin.value),lineSpacing:parseFloat(this._elements.lineSpacing.value),columnCount:parseInt(((n=this._elements.columnCountButtons.querySelector(".column-count-btn.active"))==null?void 0:n.dataset.columns)||"1",10),columnAutoCenter:this._elements.columnAutoCenter.checked,normalizeText:this._elements.normalizeText.checked,normalizeNumbers:this._elements.normalizeNumbers.checked,normalizeAbbreviations:this._elements.normalizeAbbreviations.checked,sttBackend:this._elements.sttBackend.value,whisperModel:this._elements.whisperModel.value,whisperDevice:this._elements.whisperDevice.value,llmBackend:this._elements.llmBackend.value,localLlmModel:this._elements.localLlmModel.value,localLlmDevice:this._elements.localLlmDevice.value,lookupLanguage:this._elements.lookupLanguage.value,quizMode:this._elements.quizMode.value,quizGuided:this._elements.quizGuided.checked,quizReadOptionsAloud:this._elements.quizReadOptions.checked,quizChapterScope:this._elements.quizScope.value,quizQuestionTypes:{factual:this._elements.quizTypeFactual.checked,deeper_understanding:this._elements.quizTypeDeeper.checked,vocabulary:this._elements.quizTypeVocabulary.checked,inference:this._elements.quizTypeInference.checked,themes:this._elements.quizTypeThemes.checked},quizSystemPrompt:this._elements.quizSystemPrompt.value.trim(),mediaSessionVolume:parseFloat(this._elements.mediaVolume.value)||.01,mediaSessionDuration:parseInt(this._elements.mediaDuration.value)||300};e.contextBefore<0&&(e.contextBefore=0),e.contextBefore>500&&(e.contextBefore=500),e.contextAfter<0&&(e.contextAfter=0),e.contextAfter>500&&(e.contextAfter=500);const t=e.ttsBackend!==this._settings.ttsBackend||e.fastApiUrl!==this._settings.fastApiUrl,s=e.voice!==this._settings.voice,i=e.speed!==this._settings.speed;this._settings=e,(r=(o=this._callbacks).onSave)==null||r.call(o,e),t&&((l=(a=this._callbacks).onBackendChange)==null||l.call(a,e.ttsBackend)),s&&((d=(h=this._callbacks).onVoiceChange)==null||d.call(h,e.voice)),i&&((u=(p=this._callbacks).onSpeedChange)==null||u.call(p,e.speed)),(m=(g=this._callbacks).onClose)==null||m.call(g)}async _loadBuildInfo(){try{let e=await fetch("/public/build-info.json");e.ok||(e=await fetch("/build-info.json"));const t=await e.json(),i=new Date(t.buildTime).toLocaleString();let n='<div class="about-info">';n+=`<p><strong>Version:</strong> ${t.version}</p>`,n+=`<p><strong>Last Updated:</strong> ${i}</p>`,n+=`<p><strong>Commit:</strong> <code>${t.commitShort}</code></p>`,n+=`<p><strong>Branch:</strong> ${t.branch}</p>`,n+="</div>",this._elements.aboutContent.innerHTML=n}catch(e){console.warn("Could not load build info:",e),this._elements.aboutContent.innerHTML='<p class="form-hint">Build information not available</p>'}}show(){this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active"),this._loadCurrentSettings(),this._loadBuildInfo()}hide(){this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||this._container.classList.add("hidden")},300)}isVisible(){return this._container.classList.contains("active")}_loadCurrentSettings(){this._elements.historySize.value=this._settings.readingHistorySize||3,this._elements.historySizeValue.textContent=this._settings.readingHistorySize||3,this._elements.apiKey.value=this._settings.apiKey||"",this._elements.model.value=this._settings.model||H,this._elements.fullChapterContext.checked=!!this._settings.fullChapterContext,this._elements.contextBefore.value=this._settings.contextBefore||20,this._elements.contextAfter.value=this._settings.contextAfter||5,this._elements.ttsBackend.value=this._settings.ttsBackend||"kokoro-js",this._elements.fastApiUrl.value=this._settings.fastApiUrl||"http://localhost:8880",this._elements.voice.value=this._settings.voice||"af_bella",this._elements.speed.value=this._settings.speed||1,this._elements.speedValue.textContent=`${(this._settings.speed||1).toFixed(1)}x`,this._elements.font.value=this._settings.font||"default",this._elements.fontSize.value=this._settings.fontSize||16,this._elements.fontSizeValue.textContent=`${this._settings.fontSize||16}px`,this._elements.margin.value=this._settings.marginSize||"medium",this._elements.verticalMargin.value=this._settings.verticalMargin!==void 0?this._settings.verticalMargin:2,this._elements.verticalMarginValue.textContent=`${this._elements.verticalMargin.value}px`,this._elements.lineSpacing.value=this._settings.lineSpacing||1.8,this._elements.lineSpacingValue.textContent=(this._settings.lineSpacing||1.8).toFixed(1);const e=this._settings.columnCount||1;this._elements.columnCountValue.textContent=e,this._elements.columnCountButtons.querySelectorAll(".column-count-btn").forEach(s=>{s.classList.toggle("active",parseInt(s.dataset.columns,10)===e)}),this._elements.columnAutoCenter.checked=this._settings.columnAutoCenter!==!1,this._elements.normalizeText.checked=this._settings.normalizeText!==!1,this._elements.normalizeNumbers.checked=this._settings.normalizeNumbers!==!1,this._elements.normalizeAbbreviations.checked=this._settings.normalizeAbbreviations!==!1,this._elements.sttBackend.value=this._settings.sttBackend||"web-speech",this._elements.whisperModel.value=this._settings.whisperModel||Te,this._elements.whisperDevice.value=this._settings.whisperDevice||"auto",this._updateSTTBackendUI(),this._elements.llmBackend.value=this._settings.llmBackend||"openrouter",this._elements.localLlmModel.value=this._settings.localLlmModel||Ce,this._elements.localLlmDevice.value=this._settings.localLlmDevice||"auto",this._updateLLMBackendUI(),this._elements.lookupLanguage.value=this._settings.lookupLanguage||"auto",this._elements.quizMode.value=this._settings.quizMode||"multiple-choice",this._elements.quizGuided.checked=this._settings.quizGuided!==!1,this._elements.quizReadOptions.checked=this._settings.quizReadOptionsAloud!==!1,this._elements.quizScope.value=this._settings.quizChapterScope||"full";const t=this._settings.quizQuestionTypes||{};this._elements.quizTypeFactual.checked=t.factual!==!1,this._elements.quizTypeDeeper.checked=!!t.deeper_understanding,this._elements.quizTypeVocabulary.checked=!!t.vocabulary,this._elements.quizTypeInference.checked=!!t.inference,this._elements.quizTypeThemes.checked=!!t.themes,this._elements.quizSystemPrompt.value=this._settings.quizSystemPrompt||"",this._elements.mediaVolume.value=this._settings.mediaSessionVolume||.01,this._elements.mediaVolumeValue.textContent=(this._settings.mediaSessionVolume||.01).toFixed(3),this._elements.mediaDuration.value=this._settings.mediaSessionDuration||300,this._elements.mediaDurationValue.textContent=`${this._settings.mediaSessionDuration||300}s`,this._updateBackendUI()}setSettings(e){this._settings={...this._settings,...e}}getSettings(){return{...this._settings}}hasApiKey(){return!!(this._settings.apiKey&&this._settings.apiKey.trim())}setFastApiAvailable(e){this._fastApiAvailable=e}setVoices(e){if(!this._elements.voice)return;const t=this._elements.voice.value;this._elements.voice.innerHTML="",e.forEach(s=>{const i=document.createElement("option");i.value=s.id,i.textContent=s.disabled?`${s.name} (FastAPI only)`:s.name,i.disabled=!!s.disabled,this._elements.voice.appendChild(i)}),e.some(s=>s.id===t&&!s.disabled)&&(this._elements.voice.value=t)}getVoice(){return this._settings.voice||"af_bella"}getSpeed(){return this._settings.speed||1}}class Ks{constructor(e,t){this._container=e.container,this._callbacks=t,this._currentImage=null,this._scale=1,this._translateX=0,this._translateY=0,this._isDragging=!1,this._startX=0,this._startY=0,this._lastTouchDistance=0,this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="image-viewer-content">
                <button class="image-viewer-close-btn btn-icon" aria-label="Close">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
                <div class="image-viewer-controls">
                    <button class="btn-icon" id="image-zoom-out" aria-label="Zoom out" title="Zoom out">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button class="btn-icon" id="image-zoom-in" aria-label="Zoom in" title="Zoom in">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            <line x1="11" y1="8" x2="11" y2="14"/>
                            <line x1="8" y1="11" x2="14" y2="11"/>
                        </svg>
                    </button>
                    <button class="btn-icon" id="image-reset" aria-label="Reset zoom" title="Reset zoom">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="1 4 1 10 7 10"/>
                            <polyline points="23 20 23 14 17 14"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                        </svg>
                    </button>
                </div>
                <div class="image-viewer-canvas" id="image-viewer-canvas">
                    <img id="image-viewer-img" alt="Full size image">
                </div>
            </div>
        `,this._elements={closeBtn:this._container.querySelector(".image-viewer-close-btn"),zoomInBtn:this._container.querySelector("#image-zoom-in"),zoomOutBtn:this._container.querySelector("#image-zoom-out"),resetBtn:this._container.querySelector("#image-reset"),canvas:this._container.querySelector("#image-viewer-canvas"),img:this._container.querySelector("#image-viewer-img")}}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{this.hide()}),this._container.addEventListener("click",e=>{e.target===this._container&&this.hide()}),this._escapeHandler=e=>{e.key==="Escape"&&this.isVisible()&&this.hide()},document.addEventListener("keydown",this._escapeHandler),this._elements.zoomInBtn.addEventListener("click",()=>{this._zoom(1.2)}),this._elements.zoomOutBtn.addEventListener("click",()=>{this._zoom(.8)}),this._elements.resetBtn.addEventListener("click",()=>{this._resetTransform()}),this._elements.canvas.addEventListener("wheel",e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1;this._zoom(t,e.clientX,e.clientY)},{passive:!1}),this._elements.canvas.addEventListener("mousedown",e=>{e.button===0&&this._startDrag(e.clientX,e.clientY)}),document.addEventListener("mousemove",e=>{this._isDragging&&this._drag(e.clientX,e.clientY)}),document.addEventListener("mouseup",()=>{this._endDrag()}),this._elements.canvas.addEventListener("touchstart",e=>{if(e.touches.length===1)this._startDrag(e.touches[0].clientX,e.touches[0].clientY);else if(e.touches.length===2){e.preventDefault();const t=e.touches[0],s=e.touches[1];this._lastTouchDistance=this._getTouchDistance(t,s)}},{passive:!1}),this._elements.canvas.addEventListener("touchmove",e=>{if(e.touches.length===1&&this._isDragging)this._drag(e.touches[0].clientX,e.touches[0].clientY);else if(e.touches.length===2){e.preventDefault();const t=e.touches[0],s=e.touches[1],i=this._getTouchDistance(t,s);if(this._lastTouchDistance>0){const n=i/this._lastTouchDistance,o=(t.clientX+s.clientX)/2,r=(t.clientY+s.clientY)/2;this._zoom(n,o,r)}this._lastTouchDistance=i}},{passive:!1}),this._elements.canvas.addEventListener("touchend",e=>{e.touches.length===0?(this._endDrag(),this._lastTouchDistance=0):e.touches.length===1&&(this._lastTouchDistance=0)})}_getTouchDistance(e,t){const s=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(s*s+i*i)}_startDrag(e,t){this._isDragging=!0,this._startX=e-this._translateX,this._startY=t-this._translateY,this._elements.canvas.style.cursor="grabbing"}_drag(e,t){this._isDragging&&(this._translateX=e-this._startX,this._translateY=t-this._startY,this._updateTransform())}_endDrag(){this._isDragging=!1,this._elements.canvas.style.cursor=this._scale>1?"grab":"default"}_zoom(e,t,s){const i=this._scale;if(this._scale=Math.min(Math.max(.5,this._scale*e),5),t!==void 0&&s!==void 0){const n=this._elements.canvas.getBoundingClientRect(),o=t-n.left,r=s-n.top;this._translateX=o-(o-this._translateX)*(this._scale/i),this._translateY=r-(r-this._translateY)*(this._scale/i)}this._updateTransform(),this._elements.canvas.style.cursor=this._scale>1?"grab":"default"}_resetTransform(){this._scale=1,this._translateX=0,this._translateY=0,this._updateTransform(),this._elements.canvas.style.cursor="default"}_updateTransform(){this._elements.img.style.transform=`translate(${this._translateX}px, ${this._translateY}px) scale(${this._scale})`}show(e,t=""){this._currentImage=e,this._elements.img.src=e,this._elements.img.alt=t,this._resetTransform(),this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active")}hide(){var e,t;this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||(this._container.classList.add("hidden"),this._elements.img.src="",this._currentImage=null)},300),(t=(e=this._callbacks).onClose)==null||t.call(e)}isVisible(){return this._container.classList.contains("active")}destroy(){document.removeEventListener("keydown",this._escapeHandler)}}function be(c){return!c||!c.trim()?"plaintext":js(c)?"html":Ys(c)?"markdown":"plaintext"}function js(c){if(/<(?:html|head|body|div|p|h[1-6]|ul|ol|li|table|section|article|header|footer|nav|main|form|pre|blockquote)\b[^>]*>/i.test(c)||/^\s*<!DOCTYPE\s+html/i.test(c))return!0;const t=c.match(/<\/[a-z][a-z0-9]*>/gi);return!!(t&&t.length>=3)}function Ys(c){let e=0;return/^#{1,6}\s+\S/m.test(c)&&(e+=2),(/\*{1,2}[^*\s][^*]*\*{1,2}/.test(c)||/_{1,2}[^_\s][^_]*_{1,2}/.test(c))&&(e+=1),/\[[^\]]+\]\([^)]+\)/.test(c)&&(e+=2),/!\[[^\]]*\]\([^)]+\)/.test(c)&&(e+=2),/^```/m.test(c)&&(e+=2),/`[^`]+`/.test(c)&&(e+=1),/^[\s]*[-*+]\s+\S/m.test(c)&&(e+=1),/^\s*\d+\.\s+\S/m.test(c)&&(e+=1),/^>\s+\S/m.test(c)&&(e+=1),/^[-*_]{3,}\s*$/m.test(c)&&(e+=1),e>=2}function Xs(c){switch(c){case"html":return"HTML";case"markdown":return"Markdown";case"plaintext":return"Plain Text";default:return"Text"}}const N=class N{constructor(e,t){this._container=e.container,this._callbacks=t,this._readingHistory=[],this._pasteExpanded=!1,this._generateExpanded=!1,this._isGenerating=!1,this._lastGenerateParams=null,this._lastGenerateResult=null,this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="modal book-loader-modal">
                <div class="modal-header">
                    <h2>Select eBook</h2>
                    <button class="btn-icon modal-close-btn" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>

                <div class="modal-content">
                    <!-- Continue Reading Section (populated dynamically) -->
                    <div id="modal-continue-reading" class="modal-continue-reading hidden"></div>

                    <!-- Local File Option -->
                    <div class="book-source-option" id="local-file-option">
                        <div class="book-source-header">
                            <div class="book-source-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                </svg>
                            </div>
                            <div class="book-source-info">
                                <h3>Load from Device</h3>
                                <p>EPUB, Markdown, HTML, or PDF file</p>
                            </div>
                        </div>
                        <input type="file" id="book-loader-file-input" accept=".epub,.md,.markdown,.html,.htm,.pdf" hidden>
                        <button class="btn btn-primary book-source-btn" id="browse-local-btn">
                            Browse Files
                        </button>
                        <div class="paste-toggle-wrapper">
                            <button class="paste-toggle-btn" id="paste-toggle-btn">or paste text directly</button>
                        </div>
                        <div class="paste-text-section hidden" id="paste-text-section">
                            <div class="paste-title-row">
                                <input type="text" id="paste-title-input" class="form-input" placeholder="Title (optional - auto-generated from content)">
                            </div>
                            <textarea id="paste-text-input" class="paste-text-input" placeholder="Paste your Markdown, HTML, or plain text here..." rows="8"></textarea>
                            <div class="paste-meta-row">
                                <span class="paste-format-badge" id="paste-format-badge">Plain Text</span>
                                <span class="paste-char-count" id="paste-char-count">0 / 2,000,000 chars</span>
                            </div>
                            <div class="paste-preview-section hidden" id="paste-preview-section">
                                <div class="paste-preview-label">Preview</div>
                                <div class="paste-preview" id="paste-preview"></div>
                            </div>
                            <button class="btn btn-primary book-source-btn" id="paste-load-btn" disabled>
                                Load Pasted Text
                            </button>
                        </div>
                    </div>

                    <div class="book-source-divider">
                        <span>or</span>
                    </div>

                    <!-- Project Gutenberg Option -->
                    <div class="book-source-option" id="gutenberg-option">
                        <div class="book-source-header">
                            <div class="book-source-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="2" y1="12" x2="22" y2="12"/>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                            </div>
                            <div class="book-source-info">
                                <h3>Load from Project Gutenberg</h3>
                                <p>Free public domain books</p>
                            </div>
                        </div>

                        <!-- Search Section -->
                        <div class="gutenberg-search-section">
                            <div class="gutenberg-input-row">
                                <input type="text" id="gutenberg-search-input" class="form-input" placeholder="Search books (e.g., Frankenstein)">
                                <button class="btn btn-primary" id="gutenberg-search-btn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                </button>
                            </div>
                            <div id="gutenberg-search-results" class="gutenberg-search-results hidden"></div>
                        </div>

                        <div class="gutenberg-or-divider">
                            <span>or enter book ID directly</span>
                        </div>

                        <!-- Direct ID Input -->
                        <div class="gutenberg-input-row">
                            <input type="text" id="book-loader-gutenberg-input" class="form-input" placeholder="Book ID or URL (e.g., 1342)">
                            <button class="btn btn-primary" id="load-gutenberg-btn">Load</button>
                        </div>
                        <p class="form-hint gutenberg-hint">
                            Enter a book ID (e.g., 1342 for Pride and Prejudice) or paste a Gutenberg URL.
                            <a href="https://www.gutenberg.org/" target="_blank" rel="noopener">Browse Gutenberg</a>
                        </p>
                    </div>

                    <div class="book-source-divider">
                        <span>or</span>
                    </div>

                    <!-- Generate Text with LLM -->
                    <div class="book-source-option" id="generate-text-option">
                        <div class="book-source-header">
                            <div class="book-source-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                    <path d="M2 17l10 5 10-5"/>
                                    <path d="M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div class="book-source-info">
                                <h3>Generate Text with AI</h3>
                                <p>Create reading content using LLM</p>
                            </div>
                        </div>
                        <div class="generate-text-body" id="generate-text-body">
                            <div class="generate-disabled-notice hidden" id="generate-disabled-notice">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" y1="8" x2="12" y2="12"/>
                                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                                </svg>
                                <span>Configure an API key in Settings to enable text generation.</span>
                            </div>
                            <div class="generate-form" id="generate-form">
                                <div class="generate-form-group">
                                    <label for="generate-description">Description</label>
                                    <textarea id="generate-description" class="form-input generate-description" placeholder="Describe what the text should be about..." rows="3"></textarea>
                                </div>
                                <div class="generate-form-row">
                                    <div class="generate-form-group generate-form-half">
                                        <label for="generate-language">Language</label>
                                        <select id="generate-language" class="form-select">
                                            <option value="English">English</option>
                                            <option value="Japanese">Japanese</option>
                                            <option value="Norwegian">Norwegian</option>
                                            <option value="Dutch">Dutch</option>
                                        </select>
                                    </div>
                                    <div class="generate-form-group generate-form-half">
                                        <label for="generate-length">Length</label>
                                        <select id="generate-length" class="form-select">
                                            <option value="short">Short (~300 words)</option>
                                            <option value="medium" selected>Medium (~1000 words)</option>
                                            <option value="long">Long (~3000 words)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="generate-form-row">
                                    <div class="generate-form-group generate-form-half">
                                        <label for="generate-format">Format</label>
                                        <select id="generate-format" class="form-select">
                                            <option value="markdown" selected>Markdown</option>
                                            <option value="html">HTML</option>
                                        </select>
                                    </div>
                                    <div class="generate-form-group generate-form-half">
                                        <label for="generate-genre">Genre</label>
                                        <select id="generate-genre" class="form-select">
                                            <option value="none" selected>None</option>
                                            <option value="short_story">Short Story</option>
                                            <option value="essay">Essay</option>
                                            <option value="news_article">News Article</option>
                                            <option value="childrens_story">Children's Story</option>
                                            <option value="technical">Technical</option>
                                            <option value="blog_post">Blog Post</option>
                                            <option value="letter">Letter</option>
                                            <option value="poem">Poem</option>
                                            <option value="dialogue">Dialogue</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="btn btn-primary book-source-btn" id="generate-btn" disabled>
                                    Generate
                                </button>
                            </div>
                            <div class="generate-preview-section hidden" id="generate-preview-section">
                                <div class="generate-preview-header">
                                    <div class="generate-preview-label">Preview</div>
                                    <div class="generate-preview-title" id="generate-preview-title"></div>
                                </div>
                                <div class="generate-preview" id="generate-preview"></div>
                                <div class="generate-preview-actions">
                                    <button class="btn btn-secondary" id="generate-regenerate-btn">Regenerate</button>
                                    <button class="btn btn-primary" id="generate-load-btn">Load Text</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="book-source-divider">
                        <span>or</span>
                    </div>

                    <!-- Load from URL Option -->
                    <div class="book-source-option" id="url-load-option">
                        <div class="book-source-header">
                            <div class="book-source-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                            </div>
                            <div class="book-source-info">
                                <h3>Load from URL</h3>
                                <p>HTML page, PDF, Markdown, or EPUB from the web</p>
                            </div>
                        </div>
                        <div class="url-input-row">
                            <input type="text" id="url-load-input" class="form-input" placeholder="https://example.com/document.pdf">
                            <button class="btn btn-primary" id="url-load-btn">Load</button>
                        </div>
                        <p class="form-hint url-hint">
                            Enter a URL to an HTML page, PDF, Markdown, or EPUB file.
                            Content type is auto-detected from the response.
                        </p>
                    </div>

                    <!-- Loading State -->
                    <div id="book-loader-loading" class="book-loader-loading hidden">
                        <div class="spinner"></div>
                        <p id="book-loader-loading-text">Loading...</p>
                    </div>

                    <!-- Error State -->
                    <div id="book-loader-error" class="book-loader-error hidden">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span id="book-loader-error-text"></span>
                    </div>
                </div>
            </div>
        `,this._elements={modal:this._container.querySelector(".modal"),closeBtn:this._container.querySelector(".modal-close-btn"),continueReading:this._container.querySelector("#modal-continue-reading"),fileInput:this._container.querySelector("#book-loader-file-input"),browseLocalBtn:this._container.querySelector("#browse-local-btn"),pasteToggleBtn:this._container.querySelector("#paste-toggle-btn"),pasteSection:this._container.querySelector("#paste-text-section"),pasteTitleInput:this._container.querySelector("#paste-title-input"),pasteTextInput:this._container.querySelector("#paste-text-input"),pasteFormatBadge:this._container.querySelector("#paste-format-badge"),pasteCharCount:this._container.querySelector("#paste-char-count"),pastePreviewSection:this._container.querySelector("#paste-preview-section"),pastePreview:this._container.querySelector("#paste-preview"),pasteLoadBtn:this._container.querySelector("#paste-load-btn"),generateOption:this._container.querySelector("#generate-text-option"),generateDisabledNotice:this._container.querySelector("#generate-disabled-notice"),generateForm:this._container.querySelector("#generate-form"),generateDescription:this._container.querySelector("#generate-description"),generateLanguage:this._container.querySelector("#generate-language"),generateLength:this._container.querySelector("#generate-length"),generateFormat:this._container.querySelector("#generate-format"),generateGenre:this._container.querySelector("#generate-genre"),generateBtn:this._container.querySelector("#generate-btn"),generatePreviewSection:this._container.querySelector("#generate-preview-section"),generatePreviewTitle:this._container.querySelector("#generate-preview-title"),generatePreview:this._container.querySelector("#generate-preview"),generateRegenerateBtn:this._container.querySelector("#generate-regenerate-btn"),generateLoadBtn:this._container.querySelector("#generate-load-btn"),urlInput:this._container.querySelector("#url-load-input"),urlLoadBtn:this._container.querySelector("#url-load-btn"),searchInput:this._container.querySelector("#gutenberg-search-input"),searchBtn:this._container.querySelector("#gutenberg-search-btn"),searchResults:this._container.querySelector("#gutenberg-search-results"),gutenbergInput:this._container.querySelector("#book-loader-gutenberg-input"),loadGutenbergBtn:this._container.querySelector("#load-gutenberg-btn"),loading:this._container.querySelector("#book-loader-loading"),loadingText:this._container.querySelector("#book-loader-loading-text"),error:this._container.querySelector("#book-loader-error"),errorText:this._container.querySelector("#book-loader-error-text")},this._isSearching=!1}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._container.addEventListener("click",e=>{var t,s;e.target===this._container&&((s=(t=this._callbacks).onClose)==null||s.call(t))}),this._escapeHandler=e=>{var t,s;e.key==="Escape"&&this.isVisible()&&((s=(t=this._callbacks).onClose)==null||s.call(t))},document.addEventListener("keydown",this._escapeHandler),this._elements.browseLocalBtn.addEventListener("click",()=>{this._elements.fileInput.click()}),this._elements.fileInput.addEventListener("change",e=>{var s,i,n;const t=(s=e.target.files)==null?void 0:s[0];if(t){this._hideError();const o={type:"local",filename:t.name};(n=(i=this._callbacks).onFileSelect)==null||n.call(i,t,o)}e.target.value=""}),this._elements.pasteToggleBtn.addEventListener("click",()=>{this._togglePasteSection()}),this._pasteInputDebounce=null,this._elements.pasteTextInput.addEventListener("input",()=>{this._updatePasteMeta(),clearTimeout(this._pasteInputDebounce),this._pasteInputDebounce=setTimeout(()=>{this._updatePastePreview()},300)}),this._elements.pasteLoadBtn.addEventListener("click",()=>{this._submitPastedText()}),this._elements.loadGutenbergBtn.addEventListener("click",()=>{this._loadFromGutenberg()}),this._elements.gutenbergInput.addEventListener("keypress",e=>{e.key==="Enter"&&this._loadFromGutenberg()}),this._elements.searchBtn.addEventListener("click",()=>{this._searchGutenberg()}),this._elements.searchInput.addEventListener("keypress",e=>{e.key==="Enter"&&this._searchGutenberg()}),this._elements.generateDescription.addEventListener("input",()=>{this._updateGenerateBtn()}),this._elements.generateBtn.addEventListener("click",()=>{this._generateText()}),this._elements.generateRegenerateBtn.addEventListener("click",()=>{this._generateText()}),this._elements.generateLoadBtn.addEventListener("click",()=>{this._submitGeneratedText()}),this._elements.urlLoadBtn.addEventListener("click",()=>{this._loadFromURL()}),this._elements.urlInput.addEventListener("keypress",e=>{e.key==="Enter"&&this._loadFromURL()}),this._elements.searchResults.addEventListener("click",e=>{var s,i;const t=e.target.closest(".gutenberg-search-result");if(t){const n=t.dataset.bookId;n&&(this._hideError(),this._clearSearchResults(),(i=(s=this._callbacks).onGutenbergLoad)==null||i.call(s,n))}})}_togglePasteSection(){this._pasteExpanded=!this._pasteExpanded,this._pasteExpanded?(this._elements.pasteSection.classList.remove("hidden"),this._elements.pasteToggleBtn.textContent="hide paste area",this._elements.pasteTextInput.focus()):(this._elements.pasteSection.classList.add("hidden"),this._elements.pasteToggleBtn.textContent="or paste text directly")}_updatePasteMeta(){const e=this._elements.pasteTextInput.value,t=new TextEncoder().encode(e).length,s=N.PASTE_MAX_BYTES,i=e.length.toLocaleString(),n=s.toLocaleString();if(this._elements.pasteCharCount.textContent=`${i} / ${n} chars`,t>s?this._elements.pasteCharCount.classList.add("paste-char-over"):this._elements.pasteCharCount.classList.remove("paste-char-over"),e.trim()){const o=be(e);this._elements.pasteFormatBadge.textContent=Xs(o),this._elements.pasteFormatBadge.className=`paste-format-badge paste-format-${o}`}else this._elements.pasteFormatBadge.textContent="Plain Text",this._elements.pasteFormatBadge.className="paste-format-badge";this._elements.pasteLoadBtn.disabled=!e.trim()||t>s}_updatePastePreview(){const e=this._elements.pasteTextInput.value.trim();if(!e){this._elements.pastePreviewSection.classList.add("hidden"),this._elements.pastePreview.innerHTML="";return}this._elements.pastePreviewSection.classList.remove("hidden");const t=be(e),s=e.substring(0,2e3);let i="";try{switch(t){case"html":i=this._sanitizePreviewHtml(s);break;case"markdown":i=this._sanitizePreviewHtml(x.parse(s));break;case"plaintext":default:i=this._plainTextToPreviewHtml(s);break}}catch{i=this._plainTextToPreviewHtml(s)}this._elements.pastePreview.innerHTML=i}_sanitizePreviewHtml(e){const i=new DOMParser().parseFromString(e,"text/html").body;return i.querySelectorAll("script, style, iframe, object, embed, link").forEach(n=>n.remove()),i.querySelectorAll("*").forEach(n=>{const o=[...n.attributes];for(const r of o)(r.name.startsWith("on")||r.name==="style")&&n.removeAttribute(r.name)}),i.innerHTML}_plainTextToPreviewHtml(e){return this._escapeHtml(e).split(/\n{2,}/).map(i=>i.trim()).filter(i=>i.length>0).map(i=>`<p>${i.replace(/\n/g,"<br>")}</p>`).join("")}_submitPastedText(){var o,r;const e=this._elements.pasteTextInput.value;if(!e.trim()){this._showError("Please paste some text content");return}if(new TextEncoder().encode(e).length>N.PASTE_MAX_BYTES){this._showError(`Content exceeds the ${(N.PASTE_MAX_BYTES/1024/1024).toFixed(0)} MB size limit`);return}const s=be(e),n=this._elements.pasteTitleInput.value.trim()||this._autoGenerateTitle(e,s);this._hideError(),(r=(o=this._callbacks).onPasteText)==null||r.call(o,e,s,n)}_autoGenerateTitle(e,t){var i,n,o,r;if(t==="markdown"){const a=e.match(/^#\s+(.+)$/m);if(a)return a[1].trim().substring(0,100)}if(t==="html"){const l=new DOMParser().parseFromString(e,"text/html"),h=(n=(i=l.querySelector("title"))==null?void 0:i.textContent)==null?void 0:n.trim();if(h)return h.substring(0,100);const d=(r=(o=l.querySelector("h1"))==null?void 0:o.textContent)==null?void 0:r.trim();if(d)return d.substring(0,100)}const s=e.trim().split(`
`)[0].replace(/^#+\s*/,"").trim();return s.length<=60?s||"Pasted Text":s.substring(0,57)+"..."}_loadFromGutenberg(){var s,i;const e=this._elements.gutenbergInput.value.trim();if(!e){this._showError("Please enter a book ID or URL");return}let t;if(e.includes("gutenberg.org")){const n=e.match(/\/(?:ebooks|files|cache\/epub)\/(\d+)/);if(n)t=n[1];else{this._showError("Invalid Project Gutenberg URL");return}}else t=e;if(!/^\d+$/.test(t)){this._showError("Please enter a valid book ID (numbers only) or URL");return}this._hideError(),(i=(s=this._callbacks).onGutenbergLoad)==null||i.call(s,t)}_loadFromURL(){var t,s;const e=this._elements.urlInput.value.trim();if(!e){this._showError("Please enter a URL");return}try{new URL(e)}catch{this._showError("Please enter a valid URL (e.g., https://example.com/document.pdf)");return}this._hideError(),(s=(t=this._callbacks).onURLLoad)==null||s.call(t,e)}async _searchGutenberg(){const e=this._elements.searchInput.value.trim();if(!e){this._showError("Please enter a search term");return}if(!this._isSearching){this._isSearching=!0,this._hideError(),this._showSearchLoading();try{const t=`https://www.gutenberg.org/ebooks/search/?query=${encodeURIComponent(e)}`,s=`https://api.allorigins.win/get?url=${encodeURIComponent(t)}`,i=await fetch(s);if(!i.ok)throw new Error("Failed to fetch search results");const n=await i.json();if(!n.contents)throw new Error("No content received from proxy");const a=new DOMParser().parseFromString(n.contents,"text/html").querySelectorAll(".booklink"),l=[];a.forEach(h=>{var g,m;const d=h.querySelector(".title"),p=h.querySelector(".subtitle"),u=h.querySelector("a.link");if(d&&u){const S=(u.getAttribute("href")||"").match(/\/ebooks\/(\d+)/),L=S?S[1]:null;L&&l.push({id:L,title:((g=d.textContent)==null?void 0:g.trim())||"Unknown Title",author:((m=p==null?void 0:p.textContent)==null?void 0:m.trim())||"Unknown Author"})}}),this._displaySearchResults(l,e)}catch(t){console.error("Gutenberg search error:",t),this._showError(`Search failed: ${t.message}`),this._clearSearchResults()}finally{this._isSearching=!1}}}_showSearchLoading(){this._elements.searchResults.classList.remove("hidden"),this._elements.searchResults.innerHTML=`
            <div class="gutenberg-search-loading">
                <div class="spinner"></div>
                <span>Searching Project Gutenberg...</span>
            </div>
        `}_displaySearchResults(e,t){if(this._elements.searchResults.classList.remove("hidden"),e.length===0){this._elements.searchResults.innerHTML=`
                <div class="gutenberg-search-empty">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <p>No books found for "${this._escapeHtml(t)}"</p>
                </div>
            `;return}const s=e.map(i=>`
            <div class="gutenberg-search-result" data-book-id="${i.id}">
                <div class="result-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                </div>
                <div class="result-info">
                    <div class="result-title">${this._escapeHtml(i.title)}</div>
                    <div class="result-author">${this._escapeHtml(i.author)}</div>
                </div>
                <div class="result-id">#${i.id}</div>
            </div>
        `).join("");this._elements.searchResults.innerHTML=`
            <div class="gutenberg-search-header">
                <span>${e.length} result${e.length!==1?"s":""} for "${this._escapeHtml(t)}"</span>
            </div>
            <div class="gutenberg-search-list">
                ${s}
            </div>
        `}_clearSearchResults(){this._elements.searchResults.classList.add("hidden"),this._elements.searchResults.innerHTML=""}_updateGenerateBtn(){const e=this._elements.generateDescription.value.trim().length>0;this._elements.generateBtn.disabled=!e||this._isGenerating}_updateGenerateAvailability(){w.hasApiKey()?(this._elements.generateDisabledNotice.classList.add("hidden"),this._elements.generateForm.classList.remove("generate-form-disabled"),this._elements.generateDescription.disabled=!1,this._elements.generateLanguage.disabled=!1,this._elements.generateLength.disabled=!1,this._elements.generateFormat.disabled=!1,this._elements.generateGenre.disabled=!1,this._updateGenerateBtn()):(this._elements.generateDisabledNotice.classList.remove("hidden"),this._elements.generateForm.classList.add("generate-form-disabled"),this._elements.generateDescription.disabled=!0,this._elements.generateLanguage.disabled=!0,this._elements.generateLength.disabled=!0,this._elements.generateFormat.disabled=!0,this._elements.generateGenre.disabled=!0,this._elements.generateBtn.disabled=!0)}async _generateText(){const e=this._elements.generateDescription.value.trim();if(!e)return;this._isGenerating=!0,this._elements.generateBtn.disabled=!0,this._elements.generateBtn.textContent="Generating...",this._elements.generateRegenerateBtn.disabled=!0,this._elements.generatePreviewSection.classList.add("hidden"),this._hideError();const t={description:e,language:this._elements.generateLanguage.value,length:this._elements.generateLength.value,format:this._elements.generateFormat.value,genre:this._elements.generateGenre.value};this._lastGenerateParams=t;try{const s=await w.generateText(t);this._lastGenerateResult=s,this._elements.generatePreviewTitle.textContent=s.title;let i="";t.format==="html"?i=this._sanitizePreviewHtml(s.content):i=this._sanitizePreviewHtml(x.parse(s.content)),this._elements.generatePreview.innerHTML=i,this._elements.generatePreviewSection.classList.remove("hidden")}catch(s){s.message!=="Request aborted"&&this._showError(`Generation failed: ${s.message}`)}finally{this._isGenerating=!1,this._elements.generateBtn.textContent="Generate",this._elements.generateRegenerateBtn.disabled=!1,this._updateGenerateBtn()}}_submitGeneratedText(){var n,o;if(!this._lastGenerateResult||!this._lastGenerateParams)return;const{title:e,content:t}=this._lastGenerateResult,s=this._lastGenerateParams.format,i={source:"llm-generated",model:w.getModel(),language:this._lastGenerateParams.language,length:this._lastGenerateParams.length,genre:this._lastGenerateParams.genre,description:this._lastGenerateParams.description};this._hideError(),(o=(n=this._callbacks).onGenerateText)==null||o.call(n,t,s,e,i)}setReadingHistory(e){this._readingHistory=e||[]}_renderContinueReading(){var s,i,n,o,r;const e=this._elements.continueReading;if(!this._readingHistory.length){e.classList.add("hidden"),e.innerHTML="";return}e.classList.remove("hidden");let t='<div class="modal-continue-reading-title">Continue reading</div>';t+='<div class="modal-continue-reading-list">';for(const a of this._readingHistory){if(!a.bookId)continue;const l=this._formatTimeAgo(a.timestamp),h=a.fileType||"epub",d=de[h]||h.toUpperCase(),p=`<span class="format-badge format-badge-sm format-${h}">${d}</span>`,u=((s=a.source)==null?void 0:s.type)==="pasted"?'<svg class="resume-paste-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg> ':((i=a.source)==null?void 0:i.type)==="llm-generated"?'<svg class="resume-paste-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg> ':"";let g="";((n=a.source)==null?void 0:n.type)==="gutenberg"?g=' <span class="resume-source">from Project Gutenberg</span>':((o=a.source)==null?void 0:o.type)==="pasted"?g=' <span class="resume-source">pasted</span>':((r=a.source)==null?void 0:r.type)==="llm-generated"&&(g=' <span class="resume-source">AI generated</span>');const m=[];a.bookmarkCount>0&&m.push(`${a.bookmarkCount} bookmark${a.bookmarkCount>1?"s":""}`),a.highlightCount>0&&m.push(`${a.highlightCount} highlight${a.highlightCount>1?"s":""}`);const v=m.length>0?` (${m.join(", ")})`:"";t+=`
                <div class="modal-resume-item" data-book-id="${this._escapeHtml(a.bookId)}">
                    <div class="resume-info">
                        <div class="resume-detail">${p} ${u}"${this._escapeHtml(a.bookTitle)}"${g} - Chapter ${a.chapterIndex+1}${v}</div>
                        <div class="resume-time">Last read ${l}</div>
                    </div>
                    <button class="btn btn-primary btn-sm resume-btn">Resume</button>
                </div>
            `}t+="</div>",e.innerHTML=t,e.querySelectorAll(".modal-resume-item .resume-btn").forEach(a=>{a.addEventListener("click",()=>{var d,p;const l=a.closest(".modal-resume-item").dataset.bookId,h=this._readingHistory.find(u=>u.bookId===l);h&&((p=(d=this._callbacks).onResumeBook)==null||p.call(d,h))})})}_formatTimeAgo(e){const t=Math.floor((Date.now()-e)/1e3);if(t<60)return"just now";const s=Math.floor(t/60);if(s<60)return`${s} minute${s>1?"s":""} ago`;const i=Math.floor(s/60);if(i<24)return`${i} hour${i>1?"s":""} ago`;const n=Math.floor(i/24);if(n<30)return`${n} day${n>1?"s":""} ago`;const o=Math.floor(n/30);return`${o} month${o>1?"s":""} ago`}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}show(){this._elements.gutenbergInput.value="",this._elements.searchInput.value="",this._clearSearchResults(),this._hideLoading(),this._hideError(),this._elements.pasteTextInput.value="",this._elements.pasteTitleInput.value="",this._elements.pasteSection.classList.add("hidden"),this._elements.pastePreviewSection.classList.add("hidden"),this._elements.pastePreview.innerHTML="",this._elements.pasteLoadBtn.disabled=!0,this._elements.pasteToggleBtn.textContent="or paste text directly",this._elements.pasteFormatBadge.textContent="Plain Text",this._elements.pasteFormatBadge.className="paste-format-badge",this._elements.pasteCharCount.textContent=`0 / ${N.PASTE_MAX_BYTES.toLocaleString()} chars`,this._elements.pasteCharCount.classList.remove("paste-char-over"),this._pasteExpanded=!1,this._elements.generateDescription.value="",this._elements.generateLanguage.value="English",this._elements.generateLength.value="medium",this._elements.generateFormat.value="markdown",this._elements.generateGenre.value="none",this._elements.generatePreviewSection.classList.add("hidden"),this._elements.generatePreview.innerHTML="",this._elements.generatePreviewTitle.textContent="",this._elements.generateBtn.textContent="Generate",this._elements.generateRegenerateBtn.disabled=!1,this._isGenerating=!1,this._lastGenerateParams=null,this._lastGenerateResult=null,this._updateGenerateAvailability(),this._renderContinueReading(),this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active"),setTimeout(()=>{this._elements.gutenbergInput.focus()},100)}hide(){this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||this._container.classList.add("hidden")},300)}isVisible(){return this._container.classList.contains("active")}showLoading(e="Loading..."){this._elements.loadingText.textContent=e,this._elements.loading.classList.remove("hidden"),this._elements.browseLocalBtn.disabled=!0,this._elements.loadGutenbergBtn.disabled=!0,this._elements.pasteLoadBtn.disabled=!0,this._elements.generateBtn.disabled=!0,this._elements.generateLoadBtn.disabled=!0}_hideLoading(){this._elements.loading.classList.add("hidden"),this._elements.browseLocalBtn.disabled=!1,this._elements.loadGutenbergBtn.disabled=!1;const e=this._elements.pasteTextInput.value,t=new TextEncoder().encode(e).length;this._elements.pasteLoadBtn.disabled=!e.trim()||t>N.PASTE_MAX_BYTES,this._updateGenerateBtn(),this._elements.generateLoadBtn.disabled=!1}hideLoading(){this._hideLoading()}_showError(e){this._elements.errorText.textContent=e,this._elements.error.classList.remove("hidden")}showError(e){this._hideLoading(),this._showError(e)}_hideError(){this._elements.error.classList.add("hidden")}destroy(){document.removeEventListener("keydown",this._escapeHandler),clearTimeout(this._pasteInputDebounce)}};T(N,"PASTE_MAX_BYTES",2*1024*1024);let Le=N;class Js{constructor(e,t){this._container=e.container,this._callbacks=t,this._chapters=[],this._currentChapterIndex=0,this._currentPage=0,this._totalPages=0,this._pageHeight=0,this._textContentEl=null,this._sentenceToPage=new Map,this._currentSentenceIndex=-1,this._readPages=new Set,this._bookmarks=[],this._highlights=[],this._pageToSentences=new Map,this._buildUI(),this._setupEventListeners()}_buildUI(){this._container.innerHTML=`
            <div class="chapter-overview-overlay">
                <div class="chapter-overview-header">
                    <div class="chapter-overview-title-row">
                        <h2>Chapter Overview</h2>
                        <button class="btn-icon chapter-overview-close-btn" aria-label="Close">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="chapter-overview-chapter-select">
                        <select class="chapter-overview-select" id="chapter-overview-select">
                        </select>
                    </div>
                </div>
                <div class="chapter-overview-grid" id="chapter-overview-grid">
                    <!-- Thumbnails will be rendered here -->
                </div>
            </div>
        `,this._elements={overlay:this._container.querySelector(".chapter-overview-overlay"),closeBtn:this._container.querySelector(".chapter-overview-close-btn"),chapterSelect:this._container.querySelector("#chapter-overview-select"),grid:this._container.querySelector("#chapter-overview-grid")}}_setupEventListeners(){this._elements.closeBtn.addEventListener("click",()=>{var e,t;(t=(e=this._callbacks).onClose)==null||t.call(e)}),this._container.addEventListener("click",e=>{var t,s;e.target===this._container&&((s=(t=this._callbacks).onClose)==null||s.call(t))}),this._escapeHandler=e=>{var t,s;e.key==="Escape"&&this.isVisible()&&((s=(t=this._callbacks).onClose)==null||s.call(t))},document.addEventListener("keydown",this._escapeHandler),this._elements.chapterSelect.addEventListener("change",()=>{var t,s;const e=parseInt(this._elements.chapterSelect.value,10);(s=(t=this._callbacks).onChapterSelect)==null||s.call(t,e)}),this._elements.grid.addEventListener("click",e=>{var s,i;const t=e.target.closest(".chapter-overview-thumbnail");if(t&&t.dataset.page!==void 0){const n=parseInt(t.dataset.page,10);(i=(s=this._callbacks).onPageSelect)==null||i.call(s,n)}})}setChapters(e,t){this._chapters=e,this._currentChapterIndex=t,this._elements.chapterSelect.innerHTML=e.map((s,i)=>`<option value="${i}" ${i===t?"selected":""}>${s.title||`Chapter ${i+1}`}</option>`).join("")}setCurrentChapter(e){this._currentChapterIndex=e,this._elements.chapterSelect.value=e.toString()}setPageData(e){this._textContentEl=e.textContentEl,this._totalPages=e.totalPages,this._pageHeight=e.pageHeight,this._currentPage=e.currentPage,this._currentSentenceIndex=e.currentSentenceIndex,this._sentenceToPage=e.sentenceToPage,this._pageToSentences=e.pageToSentences,this._computeReadPages()}setBookmarks(e){this._bookmarks=e}setHighlights(e){this._highlights=e}_computeReadPages(){if(this._readPages=new Set,this._currentSentenceIndex<0)return;const e=this._sentenceToPage.get(this._currentSentenceIndex);if(e!==void 0)for(let t=0;t<e;t++)this._readPages.add(t)}_getBookmarkedPages(){const e=new Set;for(const t of this._bookmarks){const s=this._sentenceToPage.get(t.sentenceIndex);s!==void 0&&e.add(s)}return e}_getHighlightedPages(){const e=new Set;for(const t of this._highlights){const s=this._sentenceToPage.get(t.startSentenceIndex),i=this._sentenceToPage.get(t.endSentenceIndex);if(s!==void 0){const n=i!==void 0?i:s;for(let o=s;o<=n;o++)e.add(o)}}return e}_renderThumbnails(){if(this._elements.grid.innerHTML="",this._intersectionObserver&&this._intersectionObserver.disconnect(),!this._textContentEl||this._totalPages<=0||this._pageHeight<=0){this._elements.grid.innerHTML='<p class="chapter-overview-empty">No pages to display</p>';return}const e=this._getBookmarkedPages(),t=this._getHighlightedPages(),s=this._textContentEl.scrollWidth||this._textContentEl.clientWidth,i=180,n=s>0?i/s:.2,o=Math.round(this._pageHeight*n);this._thumbScale=n,this._thumbWidth=i,this._thumbHeight=o,this._contentWidth=s;const r=document.createDocumentFragment();for(let l=0;l<this._totalPages;l++){const h=document.createElement("div");h.className="chapter-overview-thumbnail",h.dataset.page=l.toString(),l===this._currentPage&&h.classList.add("current-page"),this._readPages.has(l)&&h.classList.add("read-page");const d=document.createElement("div");d.className="chapter-overview-preview",d.style.width=`${i}px`,d.style.height=`${o}px`;const p=document.createElement("div");p.className="chapter-overview-page-label",p.textContent=(l+1).toString();const u=document.createElement("div");if(u.className="chapter-overview-badges",e.has(l)){const g=document.createElement("span");g.className="chapter-overview-badge bookmark-badge",g.title="Bookmark",g.innerHTML='<svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M5 2h14v20l-7-4-7 4V2z"/></svg>',u.appendChild(g)}if(t.has(l)){const g=document.createElement("span");g.className="chapter-overview-badge highlight-badge",g.title="Highlight",g.innerHTML='<svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M15.243 3.515l5.242 5.242-12.02 12.02H3.222v-5.243l12.02-12.02z"/></svg>',u.appendChild(g)}h.appendChild(d),h.appendChild(p),u.hasChildNodes()&&h.appendChild(u),r.appendChild(h)}this._elements.grid.appendChild(r),this._intersectionObserver=new IntersectionObserver(l=>{for(const h of l)if(h.isIntersecting){const d=h.target,p=d.querySelector(".chapter-overview-preview");p&&!p.dataset.rendered&&(this._renderThumbnailContent(p,parseInt(d.dataset.page,10)),p.dataset.rendered="true"),this._intersectionObserver.unobserve(d)}},{root:this._elements.grid,rootMargin:"200px"}),this._elements.grid.querySelectorAll(".chapter-overview-thumbnail").forEach(l=>this._intersectionObserver.observe(l)),requestAnimationFrame(()=>{const l=this._elements.grid.querySelector(".current-page");l&&l.scrollIntoView({behavior:"instant",block:"center"})})}_renderThumbnailContent(e,t){const s=this._textContentEl.cloneNode(!0);s.removeAttribute("id"),s.classList.remove("multi-column-hidden"),s.className="text-content chapter-overview-clone",s.style.cssText=`
            width: ${this._contentWidth}px;
            height: ${this._pageHeight}px;
            overflow: hidden;
            position: relative;
            pointer-events: none;
            max-width: none;
            margin: 0;
            flex: none;
        `;const i=document.createElement("div");i.style.cssText=`
            transform: scale(${this._thumbScale});
            transform-origin: top left;
            width: ${this._contentWidth}px;
            height: ${this._pageHeight}px;
            position: absolute;
            top: 0;
            left: 0;
        `,i.appendChild(s);const n=document.createElement("div");n.style.cssText=`
            position: relative;
            width: ${this._thumbWidth}px;
            height: ${this._thumbHeight}px;
            overflow: hidden;
        `,n.appendChild(i),e.appendChild(n),requestAnimationFrame(()=>{s.scrollTop=t*this._pageHeight})}show(){this._container.classList.remove("hidden"),this._container.offsetHeight,this._container.classList.add("active"),this._renderThumbnails()}hide(){this._container.classList.remove("active"),setTimeout(()=>{this._container.classList.contains("active")||(this._container.classList.add("hidden"),this._elements.grid.innerHTML="")},300)}isVisible(){return this._container.classList.contains("active")}destroy(){document.removeEventListener("keydown",this._escapeHandler)}}class Zs{constructor(e,t){this._container=e.container,this._callbacks=t,this._isOpen=!1,this._query="",this._caseSensitive=!1,this._wholeWord=!1,this._results=[],this._currentResultIndex=-1,this._isSearching=!1,this._searchAbortController=null,this._chaptersSearched=0,this._totalChapters=0,this._render(),this._setupEventListeners()}open(){this._isOpen||(this._isOpen=!0,this._container.classList.add("active"),setTimeout(()=>{var e;return(e=this._input)==null?void 0:e.focus()},100))}close(){var e,t;this._isOpen&&(this._isOpen=!1,this._container.classList.remove("active"),this._clearSearch(),(t=(e=this._callbacks).onClose)==null||t.call(e))}toggle(){this._isOpen?this.close():this.open()}isOpen(){return this._isOpen}getResults(){return this._results}getCurrentResultIndex(){return this._currentResultIndex}getQuery(){return this._query}isCaseSensitive(){return this._caseSensitive}isWholeWord(){return this._wholeWord}_render(){this._container.innerHTML=`
            <div class="search-header">
                <div class="search-input-row">
                    <div class="search-input-wrapper">
                        <svg class="search-input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                        </svg>
                        <input type="text" class="search-input" placeholder="Search in book..." aria-label="Search in book">
                    </div>
                    <button class="search-close-btn" aria-label="Close search">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="search-options-row">
                    <label class="search-option">
                        <input type="checkbox" class="search-option-checkbox" data-option="caseSensitive">
                        <span>Aa</span>
                    </label>
                    <label class="search-option" title="Whole word">
                        <input type="checkbox" class="search-option-checkbox" data-option="wholeWord">
                        <span class="search-option-word">W</span>
                    </label>
                    <div class="search-nav-controls">
                        <button class="search-nav-btn" id="search-prev-btn" aria-label="Previous result" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="18 15 12 9 6 15"/>
                            </svg>
                        </button>
                        <span class="search-counter" id="search-counter"></span>
                        <button class="search-nav-btn" id="search-next-btn" aria-label="Next result" disabled>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="search-progress hidden" id="search-progress">
                <div class="search-progress-bar">
                    <div class="search-progress-fill" id="search-progress-fill"></div>
                </div>
                <span class="search-progress-text" id="search-progress-text">Searching...</span>
            </div>
            <div class="search-results" id="search-results">
                <div class="search-empty">Type to search across the book</div>
            </div>
        `,this._input=this._container.querySelector(".search-input"),this._closeBtn=this._container.querySelector(".search-close-btn"),this._prevBtn=this._container.querySelector("#search-prev-btn"),this._nextBtn=this._container.querySelector("#search-next-btn"),this._counter=this._container.querySelector("#search-counter"),this._resultsList=this._container.querySelector("#search-results"),this._progressBar=this._container.querySelector("#search-progress"),this._progressFill=this._container.querySelector("#search-progress-fill"),this._progressText=this._container.querySelector("#search-progress-text")}_setupEventListeners(){this._closeBtn.addEventListener("click",()=>this.close());const e=lt(()=>this._performSearch(),300);this._input.addEventListener("input",()=>{this._query=this._input.value,e()}),this._input.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),t.shiftKey?this._goToPrevResult():this._goToNextResult()),t.key==="Escape"&&(t.preventDefault(),this.close())}),this._container.querySelectorAll(".search-option-checkbox").forEach(t=>{t.addEventListener("change",()=>{t.dataset.option==="caseSensitive"?this._caseSensitive=t.checked:t.dataset.option==="wholeWord"&&(this._wholeWord=t.checked),this._query.length>=2&&this._performSearch()})}),this._prevBtn.addEventListener("click",()=>this._goToPrevResult()),this._nextBtn.addEventListener("click",()=>this._goToNextResult())}_clearSearch(){this._searchAbortController&&(this._searchAbortController.abort(),this._searchAbortController=null),this._query="",this._results=[],this._currentResultIndex=-1,this._isSearching=!1,this._input&&(this._input.value=""),this._updateCounter(),this._updateNavButtons(),this._hideProgress(),this._resultsList&&(this._resultsList.innerHTML='<div class="search-empty">Type to search across the book</div>')}_buildMatcher(e){let t="g";this._caseSensitive||(t+="i");let s=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this._wholeWord&&(s=`\\b${s}\\b`);const i=new RegExp(s,t);return{match(n){const o=[];let r;for(i.lastIndex=0;(r=i.exec(n))!==null;)o.push({index:r.index,length:r[0].length});return o},queryLength:e.length}}_stripHtml(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""}async _performSearch(){var r,a;this._searchAbortController&&this._searchAbortController.abort();const e=this._query.trim();if(e.length<2){this._results=[],this._currentResultIndex=-1,this._updateCounter(),this._updateNavButtons(),this._hideProgress(),this._resultsList.innerHTML=e.length>0?'<div class="search-empty">Type at least 2 characters</div>':'<div class="search-empty">Type to search across the book</div>';return}const t=(a=(r=this._callbacks).getBook)==null?void 0:a.call(r);if(!t||!t.chapters)return;this._searchAbortController=new AbortController;const s=this._searchAbortController.signal;this._isSearching=!0,this._results=[],this._currentResultIndex=-1,this._totalChapters=t.chapters.length,this._chaptersSearched=0,this._resultsList.innerHTML="",this._showProgress();const i=this._buildMatcher(e),n=200;let o=0;for(let l=0;l<t.chapters.length;l++){if(s.aborted)return;const h=t.chapters[l];let d=h.sentences;if(!d||!h.loaded){try{d=await this._callbacks.loadChapter(l)}catch(u){console.warn(`Failed to load chapter ${l} for search:`,u),this._chaptersSearched++,this._updateProgress();continue}if(s.aborted)return}const p=[];for(let u=0;u<d.length;u++){const g=this._stripHtml(d[u]),m=i.match(g);if(m.length>0&&(p.push({chapterIndex:l,sentenceIndex:u,sentence:g,matchStart:m[0].index,matchLength:m[0].length}),o++),o>=n)break}if(p.length>0&&(this._results.push(...p),this._renderChapterGroup(h.title,l,p)),this._chaptersSearched++,this._updateProgress(),this._updateCounter(),this._updateNavButtons(),o>=n){this._showMaxReached();break}await new Promise(u=>setTimeout(u,0))}s.aborted||(this._isSearching=!1,this._hideProgress(),this._updateCounter(),this._updateNavButtons(),this._results.length===0&&(this._resultsList.innerHTML='<div class="search-empty">No results found</div>'))}_renderChapterGroup(e,t,s){const i=document.createElement("div");i.className="search-chapter-group";const n=document.createElement("div");n.className="search-chapter-header",n.innerHTML=`
            <span class="search-chapter-title">Ch. ${t+1}: ${this._escapeHtml(e)}</span>
            <span class="search-chapter-count">${s.length}</span>
        `,i.appendChild(n),s.forEach(o=>{const r=document.createElement("div");r.className="search-result-item",r.dataset.resultIndex=this._getResultGlobalIndex(o);const a=this._buildSnippet(o.sentence,o.matchStart,o.matchLength);r.innerHTML=`<div class="search-result-snippet">${a}</div>`,r.addEventListener("click",()=>{const l=parseInt(r.dataset.resultIndex,10);this._selectResult(l)}),i.appendChild(r)}),this._resultsList.appendChild(i)}_getResultGlobalIndex(e){return this._results.findIndex(t=>t.chapterIndex===e.chapterIndex&&t.sentenceIndex===e.sentenceIndex)}_buildSnippet(e,t,s){const n=Math.floor((80-s)/2);let o=Math.max(0,t-n),r=Math.min(e.length,t+s+n);if(o>0){const u=e.indexOf(" ",o);u!==-1&&u<t&&(o=u+1)}if(r<e.length){const u=e.lastIndexOf(" ",r);u!==-1&&u>t+s&&(r=u)}const a=o>0?"...":"",l=r<e.length?"...":"",h=this._escapeHtml(e.substring(o,t)),d=this._escapeHtml(e.substring(t,t+s)),p=this._escapeHtml(e.substring(t+s,r));return`${a}${h}<mark class="search-match-highlight">${d}</mark>${p}${l}`}_showMaxReached(){const e=document.createElement("div");e.className="search-max-notice",e.textContent="Showing first 200 results. Refine your search for more specific results.",this._resultsList.appendChild(e)}_selectResult(e){var i,n;if(e<0||e>=this._results.length)return;this._currentResultIndex=e;const t=this._results[e];this._updateResultSelection(),this._updateCounter(),this._updateNavButtons(),this._resultsList.querySelectorAll(".search-result-item").forEach(o=>{parseInt(o.dataset.resultIndex,10)===e&&o.scrollIntoView({block:"nearest",behavior:"smooth"})}),(n=(i=this._callbacks).onResultSelect)==null||n.call(i,t.chapterIndex,t.sentenceIndex)}_updateResultSelection(){this._resultsList.querySelectorAll(".search-result-item").forEach(t=>{const s=parseInt(t.dataset.resultIndex,10);t.classList.toggle("active",s===this._currentResultIndex)})}_goToNextResult(){if(this._results.length===0)return;const e=this._currentResultIndex<this._results.length-1?this._currentResultIndex+1:0;this._selectResult(e)}_goToPrevResult(){if(this._results.length===0)return;const e=this._currentResultIndex>0?this._currentResultIndex-1:this._results.length-1;this._selectResult(e)}_updateCounter(){if(this._counter)if(this._results.length===0)this._counter.textContent="";else if(this._currentResultIndex>=0){const e=this._isSearching?"+":"";this._counter.textContent=`${this._currentResultIndex+1} of ${this._results.length}${e}`}else{const e=this._isSearching?"+":"";this._counter.textContent=`${this._results.length}${e} results`}}_updateNavButtons(){const e=this._results.length>0;this._prevBtn&&(this._prevBtn.disabled=!e),this._nextBtn&&(this._nextBtn.disabled=!e)}_showProgress(){var e;(e=this._progressBar)==null||e.classList.remove("hidden"),this._updateProgress()}_hideProgress(){var e;(e=this._progressBar)==null||e.classList.add("hidden")}_updateProgress(){if(!this._progressFill||!this._progressText)return;const e=this._totalChapters>0?Math.round(this._chaptersSearched/this._totalChapters*100):0;this._progressFill.style.width=`${e}%`,this._progressText.textContent=`Searching... ${this._chaptersSearched}/${this._totalChapters} chapters`}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class ei{constructor(e){this._callbacks=e,this._container=null,this._currentEntry=null,this._buildUI()}_buildUI(){this._container=document.createElement("div"),this._container.className="lookup-drawer",this._container.innerHTML=`
            <div class="lookup-drawer-handle" aria-label="Drag to resize">
                <div class="lookup-drawer-handle-bar"></div>
            </div>
            <div class="lookup-drawer-content">
                <div class="lookup-drawer-header">
                    <div class="lookup-drawer-phrase-row">
                        <span class="lookup-drawer-phrase"></span>
                        <button class="lookup-drawer-pronounce-btn" title="Pronounce" aria-label="Pronounce">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                            </svg>
                        </button>
                    </div>
                    <div class="lookup-drawer-meta">
                        <span class="lookup-drawer-lang"></span>
                        <span class="lookup-drawer-pos"></span>
                        <span class="lookup-drawer-domain"></span>
                    </div>
                </div>
                <div class="lookup-drawer-body">
                    <div class="lookup-drawer-pronunciation"></div>
                    <div class="lookup-drawer-definition"></div>
                    <div class="lookup-drawer-translation"></div>
                    <div class="lookup-drawer-example"></div>
                    <div class="lookup-drawer-notes"></div>
                </div>
                <div class="lookup-drawer-actions">
                    <button class="lookup-drawer-history-btn" title="View lookup history">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        History
                    </button>
                    <button class="lookup-drawer-close-btn" title="Close">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="lookup-drawer-loading hidden">
                    <div class="lookup-drawer-spinner"></div>
                    <span>Looking up...</span>
                </div>
                <div class="lookup-drawer-error hidden"></div>
            </div>
        `,document.body.appendChild(this._container),this._setupEventListeners()}_setupEventListeners(){this._container.querySelector(".lookup-drawer-close-btn").addEventListener("click",()=>{this.hide()}),this._container.querySelector(".lookup-drawer-pronounce-btn").addEventListener("click",()=>{var s,i,n;if((s=this._currentEntry)!=null&&s.result){const o=this._currentEntry.result;(n=(i=this._callbacks).onPronounce)==null||n.call(i,o.phrase||this._currentEntry.phrase,o.sourceLanguageCode||"en")}}),this._container.querySelector(".lookup-drawer-history-btn").addEventListener("click",()=>{var s,i;(i=(s=this._callbacks).onShowHistory)==null||i.call(s)});let e=0;const t=this._container.querySelector(".lookup-drawer-handle");t.addEventListener("touchstart",s=>{e=s.touches[0].clientY},{passive:!0}),t.addEventListener("touchmove",s=>{s.touches[0].clientY-e>60&&this.hide()},{passive:!0}),document.addEventListener("mousedown",s=>{this._container.classList.contains("active")&&!this._container.contains(s.target)&&this.hide()})}showLoading(e){this._container.classList.add("active"),this._container.querySelector(".lookup-drawer-phrase").textContent=e,this._container.querySelector(".lookup-drawer-loading").classList.remove("hidden"),this._container.querySelector(".lookup-drawer-error").classList.add("hidden"),this._container.querySelector(".lookup-drawer-body").classList.add("hidden"),this._container.querySelector(".lookup-drawer-meta").classList.add("hidden"),this._container.querySelector(".lookup-drawer-pronounce-btn").classList.add("hidden")}showResult(e){this._currentEntry=e;const t=e.result;this._container.classList.add("active"),this._container.querySelector(".lookup-drawer-loading").classList.add("hidden"),this._container.querySelector(".lookup-drawer-error").classList.add("hidden"),this._container.querySelector(".lookup-drawer-body").classList.remove("hidden"),this._container.querySelector(".lookup-drawer-meta").classList.remove("hidden"),this._container.querySelector(".lookup-drawer-pronounce-btn").classList.remove("hidden"),this._container.querySelector(".lookup-drawer-phrase").textContent=t.phrase||e.phrase;const s=this._container.querySelector(".lookup-drawer-lang");s.textContent=t.sourceLanguage||"",s.classList.toggle("hidden",!t.sourceLanguage);const i=this._container.querySelector(".lookup-drawer-pos");i.textContent=t.partOfSpeech||"",i.classList.toggle("hidden",!t.partOfSpeech);const n=this._container.querySelector(".lookup-drawer-domain");n.textContent=t.domain||"",n.classList.toggle("hidden",!t.domain);const o=this._container.querySelector(".lookup-drawer-pronunciation");o.textContent=t.pronunciation||"",o.classList.toggle("hidden",!t.pronunciation);const r=this._container.querySelector(".lookup-drawer-definition");r.textContent=t.definition||"",r.classList.toggle("hidden",!t.definition);const a=this._container.querySelector(".lookup-drawer-translation");t.translation?(a.innerHTML=`<strong>Translation:</strong> ${this._escapeHtml(t.translation)}`,a.classList.remove("hidden")):a.classList.add("hidden");const l=this._container.querySelector(".lookup-drawer-example");t.exampleSentence?(l.innerHTML=`<em>${this._escapeHtml(t.exampleSentence)}</em>`,l.classList.remove("hidden")):l.classList.add("hidden");const h=this._container.querySelector(".lookup-drawer-notes");t.notes?(h.textContent=t.notes,h.classList.remove("hidden")):h.classList.add("hidden")}showError(e){this._container.querySelector(".lookup-drawer-loading").classList.add("hidden"),this._container.querySelector(".lookup-drawer-body").classList.add("hidden");const t=this._container.querySelector(".lookup-drawer-error");t.textContent=e,t.classList.remove("hidden")}hide(){this._container.classList.remove("active")}isVisible(){return this._container.classList.contains("active")}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class ti{constructor(e){this._callbacks=e,this._lookups=[],this._books={},this._searchQuery="",this._container=null,this._buildUI()}_buildUI(){this._container=document.createElement("div"),this._container.className="lookup-history-overlay",this._container.innerHTML=`
            <div class="lookup-history-dialog">
                <div class="lookup-history-header">
                    <h2>Lookup History</h2>
                    <button class="lookup-history-close-btn" aria-label="Close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="lookup-history-search">
                    <input type="text" class="lookup-history-search-input" placeholder="Search lookups..." />
                </div>
                <div class="lookup-history-list"></div>
            </div>
        `,document.body.appendChild(this._container),this._setupEventListeners()}_setupEventListeners(){this._container.querySelector(".lookup-history-close-btn").addEventListener("click",()=>{this.hide()}),this._container.addEventListener("click",t=>{t.target===this._container&&this.hide()}),this._container.querySelector(".lookup-history-search-input").addEventListener("input",t=>{this._searchQuery=t.target.value.trim().toLowerCase(),this._renderList()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.isVisible()&&this.hide()})}show(e,t={}){this._lookups=e,this._books=t,this._searchQuery="",this._container.querySelector(".lookup-history-search-input").value="",this._renderList(),this._container.classList.add("active")}hide(){this._container.classList.remove("active")}isVisible(){return this._container.classList.contains("active")}_renderList(){const e=this._container.querySelector(".lookup-history-list");e.innerHTML="";let t=this._lookups;if(this._searchQuery&&(t=this._lookups.filter(i=>{var a,l;const n=(i.phrase||"").toLowerCase(),o=(((a=i.result)==null?void 0:a.definition)||"").toLowerCase(),r=(((l=i.result)==null?void 0:l.translation)||"").toLowerCase();return n.includes(this._searchQuery)||o.includes(this._searchQuery)||r.includes(this._searchQuery)})),t.length===0){e.innerHTML='<div class="lookup-history-empty">No lookups found</div>';return}const s=new Map;for(const i of t){const n=i.bookId||"unknown";s.has(n)||s.set(n,[]),s.get(n).push(i)}for(const[i,n]of s){const o=this._books[i],r=(o==null?void 0:o.title)||"Unknown Book",a=document.createElement("div");a.className="lookup-history-group";const l=document.createElement("div");l.className="lookup-history-group-header",l.textContent=r,a.appendChild(l);for(const h of n)a.appendChild(this._renderCard(h));e.appendChild(a)}}_renderCard(e){const t=document.createElement("div");t.className="lookup-history-card";const s=e.result||{},i=document.createElement("div");i.className="lookup-history-card-front";let n="";s.sourceLanguage&&(n+=`<span class="lookup-history-tag">${this._escapeHtml(s.sourceLanguage)}</span>`),s.partOfSpeech&&(n+=`<span class="lookup-history-tag">${this._escapeHtml(s.partOfSpeech)}</span>`),s.domain&&(n+=`<span class="lookup-history-tag lookup-history-tag-domain">${this._escapeHtml(s.domain)}</span>`),i.innerHTML=`
            <div class="lookup-history-card-phrase">${this._escapeHtml(s.phrase||e.phrase)}</div>
            ${n?`<div class="lookup-history-card-meta">${n}</div>`:""}
            <div class="lookup-history-card-hint">Tap to reveal</div>
        `;const o=document.createElement("div");o.className="lookup-history-card-back hidden";let r="";s.pronunciation&&(r+=`<div class="lookup-history-card-pron">${this._escapeHtml(s.pronunciation)}</div>`),s.definition&&(r+=`<div class="lookup-history-card-def">${this._escapeHtml(s.definition)}</div>`),s.translation&&(r+=`<div class="lookup-history-card-trans"><strong>Translation:</strong> ${this._escapeHtml(s.translation)}</div>`),s.exampleSentence&&(r+=`<div class="lookup-history-card-example"><em>${this._escapeHtml(s.exampleSentence)}</em></div>`),s.notes&&(r+=`<div class="lookup-history-card-notes">${this._escapeHtml(s.notes)}</div>`),o.innerHTML=r;const a=document.createElement("div");a.className="lookup-history-card-actions",a.innerHTML=`
            <button class="lookup-history-card-pronounce" title="Pronounce" aria-label="Pronounce">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
            </button>
            <button class="lookup-history-card-delete" title="Delete" aria-label="Delete">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6l-1 14H6L5 6"/>
                    <path d="M10 11v6"/>
                    <path d="M14 11v6"/>
                </svg>
            </button>
        `,t.appendChild(i),t.appendChild(o),t.appendChild(a);let l=!1;return t.addEventListener("click",h=>{h.target.closest(".lookup-history-card-actions")||(l=!l,i.querySelector(".lookup-history-card-hint").textContent=l?"Tap to hide":"Tap to reveal",o.classList.toggle("hidden",!l),a.classList.toggle("hidden",!l),t.classList.toggle("revealed",l))}),a.classList.add("hidden"),a.querySelector(".lookup-history-card-pronounce").addEventListener("click",h=>{var d,p;h.stopPropagation(),(p=(d=this._callbacks).onPronounce)==null||p.call(d,s.phrase||e.phrase,s.sourceLanguageCode||"en")}),a.querySelector(".lookup-history-card-delete").addEventListener("click",h=>{var d,p;h.stopPropagation(),confirm("Delete this lookup?")&&((p=(d=this._callbacks).onDelete)==null||p.call(d,e.id),t.remove(),this._lookups=this._lookups.filter(u=>u.id!==e.id))}),t}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class si{constructor(){this._targetLanguage="auto",this._abortController=null}setTargetLanguage(e){this._targetLanguage=e}getTargetLanguage(){return this._targetLanguage}async lookup(e){const{phrase:t,sentenceContext:s,bookId:i,chapterIndex:n,sentenceIndex:o,bookMeta:r}=e,a=await this._findCachedLookup(i,t);if(a)return a.timestamp=Date.now(),await _.saveLookup(a),a;const l=await w.lookupWord({phrase:t,sentenceContext:s,targetLanguage:this._targetLanguage,bookMeta:r}),h={id:`lookup_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,bookId:i,chapterIndex:n,sentenceIndex:o,phrase:t.trim(),context:s,result:l,timestamp:Date.now()};return await _.saveLookup(h),h}async pronounce(e,t){const s=f.getVoiceForLanguage(t);if(s&&f._useKokoro){const i=await f.synthesize(e,{voice:s,speed:.9});await f.playAudio(i)}else if("speechSynthesis"in window){const i=new SpeechSynthesisUtterance(e);i.lang=t,i.rate=.9;const o=speechSynthesis.getVoices().find(r=>r.lang.startsWith(t));o&&(i.voice=o),speechSynthesis.speak(i)}}async getBookLookups(e){return _.getLookups(e)}async getAllLookups(){return _.getAllLookups()}async deleteLookup(e){return _.deleteLookup(e)}async _findCachedLookup(e,t){const s=await _.getLookups(e),i=t.trim().toLowerCase();return s.find(n=>n.phrase.toLowerCase()===i)||null}abort(){w.abort()}}const z=new si;class ii{constructor({maxDepth:e=50,onChange:t}={}){this._maxDepth=e,this._onChange=t,this._backStack=[],this._forwardStack=[]}pushCurrentPosition(e,t,s){var i;this._backStack.push({chapterIndex:e,sentenceIndex:t,page:s}),this._backStack.length>this._maxDepth&&this._backStack.shift(),this._forwardStack=[],(i=this._onChange)==null||i.call(this)}goBack(e,t,s){var n;if(this._backStack.length===0)return null;this._forwardStack.push({chapterIndex:e,sentenceIndex:t,page:s});const i=this._backStack.pop();return(n=this._onChange)==null||n.call(this),i}goForward(e,t,s){var n;if(this._forwardStack.length===0)return null;this._backStack.push({chapterIndex:e,sentenceIndex:t,page:s}),this._backStack.length>this._maxDepth&&this._backStack.shift();const i=this._forwardStack.pop();return(n=this._onChange)==null||n.call(this),i}canGoBack(){return this._backStack.length>0}canGoForward(){return this._forwardStack.length>0}clear(){var e;this._backStack=[],this._forwardStack=[],(e=this._onChange)==null||e.call(this)}}class ni{constructor(){this._currentBook=null,this._currentChapterIndex=0,this._isInitialized=!1,this._savedSpeed=void 0,this._savedVoice=void 0,this._wasPlayingBeforeQA=!1,this._readingHistorySize=3,this._sttBackend="web-speech",this._whisperService=null,this._activeSTTService=V,this._llmBackend="openrouter",this._qaSettings={apiKey:"",model:H,fullChapterContext:!1,contextBefore:20,contextAfter:5},this._quizSettings={quizMode:"multiple-choice",quizGuided:!0,quizReadOptionsAloud:!0,quizChapterScope:"full",quizQuestionTypes:{factual:!0,deeper_understanding:!0,vocabulary:!1,inference:!1,themes:!1},quizSystemPrompt:""},this._elements={},this._readingState=null,this._readerView=null,this._controls=null,this._audioController=null,this._navigation=null,this._qaController=null,this._qaOverlay=null,this._quizController=null,this._quizOverlay=null,this._settingsModal=null,this._imageViewerModal=null,this._bookLoaderModal=null,this._chapterOverview=null,this._searchPanel=null,this._lookupDrawer=null,this._lookupHistoryOverlay=null,this._navigationHistory=null,this._viewDecoupled=!1,this._playbackChapterIndex=0,this._playbackSentenceIndex=0}async init(){var t,s,i,n,o;this._cacheElements(),this._setupUploadHandlers(),this._setupKeyboardShortcuts(),this._setupFullscreen(),this._setupQASetup(),this._readingState=new Fs({onPositionChange:(r,a)=>{this._onPositionChange(r,a)},onBookmarksChange:()=>{this._onBookmarksChange()},onHighlightsChange:()=>{this._onHighlightsChange()}});try{await this._readingState.init()}catch(r){console.error("Storage initialization failed:",r)}this._navigation=new Gs({panel:document.getElementById("nav-panel"),overlay:document.getElementById("nav-overlay"),menuBtn:this._elements.menuBtn},{onChapterSelect:r=>this._navigateToChapter(r),onBookmarkSelect:r=>this._navigateToBookmark(r),onBookmarkDelete:r=>this._deleteBookmark(r),onAddBookmark:()=>this._addBookmark(),onHighlightSelect:r=>this._navigateToHighlight(r),onHighlightDelete:r=>this._deleteHighlight(r),onViewLookupHistory:()=>this._showLookupHistory()}),this._navigationHistory=new ii({maxDepth:50,onChange:()=>this._updateNavHistoryButtons()}),this._setupNavHistoryButtons(),this._qaOverlay=new Us({container:document.getElementById("qa-overlay")},{onClose:()=>this._closeQAOverlay(),onPause:()=>{var r;return(r=this._qaController)==null?void 0:r.pause()},onResume:()=>{var r;return(r=this._qaController)==null?void 0:r.resume()},onStop:()=>{var r;return(r=this._qaController)==null?void 0:r.stop()},onContinueReading:()=>this._continueReadingFromQA(),onAskAnother:()=>this._askAnotherQuestion(),onTextSubmit:r=>this._submitTextQuestion(r),onRetryVoice:()=>this._retryVoiceInput()}),this._quizOverlay=new Vs({container:document.getElementById("quiz-overlay")},{onClose:()=>this._closeQuizOverlay(),onNextQuestion:()=>{var r;return(r=this._quizController)==null?void 0:r.nextQuestion()},onMCAnswer:r=>{var a;return(a=this._quizController)==null?void 0:a.submitMCAnswer(r)},onTextAnswer:r=>{var a;return(a=this._quizController)==null?void 0:a.submitFreeFormAnswer(r)},onVoiceAnswer:()=>{var r;return(r=this._quizController)==null?void 0:r.submitVoiceAnswer()},onSkipToAnswer:()=>{var r;return(r=this._quizController)==null?void 0:r.skipToAnswer()}}),this._settingsModal=new Ws({container:document.getElementById("settings-modal")},{onClose:()=>this._settingsModal.hide(),onSave:r=>this._saveQASettings(r),onBackendChange:r=>this._onTTSBackendChange(r),onVoiceChange:r=>this._onVoiceChange(r),onSpeedChange:r=>this._onSpeedChange(r),onWhisperDownload:r=>this._downloadWhisperModel(r),onLocalLlmDownload:r=>this._downloadLocalLlmModel(r)}),this._elements.settingsBtn=document.getElementById("settings-btn"),(t=this._elements.settingsBtn)==null||t.addEventListener("click",()=>{this._settingsModal.setSettings({readingHistorySize:this._readingHistorySize,lookupLanguage:z.getTargetLanguage(),...this._qaSettings,...this._quizSettings}),this._settingsModal.show()}),this._lookupDrawer=new ei({onPronounce:(r,a)=>z.pronounce(r,a),onShowHistory:()=>this._showLookupHistory()}),this._lookupHistoryOverlay=new ti({onPronounce:(r,a)=>z.pronounce(r,a),onDelete:async r=>{await z.deleteLookup(r),this._refreshLookupNav()}}),this._imageViewerModal=new Ks({container:document.getElementById("image-viewer-modal")},{onClose:()=>this._imageViewerModal.hide()}),this._bookLoaderModal=new Le({container:document.getElementById("book-loader-modal")},{onClose:()=>this._bookLoaderModal.hide(),onFileSelect:(r,a)=>this._handleFileSelect(r,a),onGutenbergLoad:r=>this._handleGutenbergLoad(r),onResumeBook:r=>this._handleResumeFromModal(r),onPasteText:(r,a,l)=>this._handlePasteText(r,a,l),onGenerateText:(r,a,l,h)=>this._handleGenerateText(r,a,l,h),onURLLoad:r=>this._handleURLLoad(r)}),this._chapterOverview=new Js({container:document.getElementById("chapter-overview")},{onClose:()=>this._closeChapterOverview(),onPageSelect:r=>this._onOverviewPageSelect(r),onChapterSelect:r=>this._onOverviewChapterSelect(r)}),this._searchPanel=new Zs({container:document.getElementById("search-panel")},{onClose:()=>this._onSearchClose(),onResultSelect:(r,a)=>this._onSearchResultSelect(r,a),loadChapter:r=>this._readingState.loadChapter(r),getBook:()=>this._currentBook}),(s=this._elements.searchBtn)==null||s.addEventListener("click",()=>{this._toggleSearchPanel()});const e=document.getElementById("search-overlay");e==null||e.addEventListener("click",()=>{this._searchPanel.close()}),this._elements.pageNumber=document.getElementById("page-number"),(i=this._elements.pageNumber)==null||i.addEventListener("click",()=>{this._openChapterOverview()}),(n=this._elements.loadBookBtn)==null||n.addEventListener("click",()=>{this._bookLoaderModal.setReadingHistory(this._loadCookieState()),this._bookLoaderModal.show()}),(o=this._elements.selectEbookBtn)==null||o.addEventListener("click",()=>{this._bookLoaderModal.setReadingHistory(this._loadCookieState()),this._bookLoaderModal.show()}),await this._loadSettings(),this._checkResumeState(),this._showTTSStatus("Detecting TTS backends..."),f.onProgress(r=>{this._showTTSStatus(r.status)});try{const r=await _.getSetting("ttsBackend"),a=await _.getSetting("fastApiUrl");a&&f.setFastApiUrl(a);const l=await f.isKokoroFastAPIAvailable();this._settingsModal.setFastApiAvailable(l),console.log(`Kokoro FastAPI: ${l?"available":"not available"} at ${f.getFastApiUrl()}`);let h=r;h||(h=l?"kokoro-fastapi":"kokoro-js");const d=await f.initialize({backend:h}),p=f.getBackend();if(p==="kokoro-fastapi")this._showTTSStatus("TTS ready (Kokoro FastAPI)"),console.log(`TTS Engine: Kokoro FastAPI at ${f.getFastApiUrl()}`);else if(d){const u=f.getDevice(),g=f.getDtype();this._showTTSStatus(`TTS ready (${u}, ${g})`),console.log(`TTS Engine: Kokoro with ${u} backend, ${g} precision`)}else this._showTTSStatus("TTS ready (Browser)");this._settingsModal.setSettings({...this._settingsModal.getSettings(),ttsBackend:p,fastApiUrl:f.getFastApiUrl()}),setTimeout(()=>this._hideTTSStatus(),3e3)}catch(r){console.error("TTS initialization failed:",r),this._showTTSStatus("TTS initialization failed")}this._isInitialized=!0,console.log("Reading Partner initialized"),console.log("Tip: Run readingPartner.runBenchmark() to test TTS performance")}_cacheElements(){this._elements={uploadScreen:document.getElementById("upload-screen"),readerScreen:document.getElementById("reader-screen"),uploadArea:document.getElementById("upload-area"),fileInput:document.getElementById("file-input"),selectEbookBtn:document.getElementById("select-ebook-btn"),loadingIndicator:document.getElementById("loading-indicator"),loadingText:document.getElementById("loading-text"),qaSetupDetails:document.getElementById("qa-setup-details"),qaSetupStatus:document.getElementById("qa-setup-status"),setupApiKey:document.getElementById("setup-api-key"),setupModel:document.getElementById("setup-model"),setupFreeModels:document.getElementById("setup-free-models"),setupPaidModels:document.getElementById("setup-paid-models"),saveQaSetupBtn:document.getElementById("save-qa-setup-btn"),menuBtn:document.getElementById("menu-btn"),settingsBtn:document.getElementById("settings-btn"),bookTitle:document.getElementById("book-title"),chapterTitle:document.getElementById("chapter-title"),readerContent:document.getElementById("reader-content"),textContent:document.getElementById("text-content"),pageContainer:document.getElementById("page-container"),pagePrevBtn:document.getElementById("page-prev-btn"),pageNextBtn:document.getElementById("page-next-btn"),pageCurrent:document.getElementById("page-current"),pageTotal:document.getElementById("page-total"),playBtn:document.getElementById("play-btn"),playIcon:document.getElementById("play-icon"),pauseIcon:document.getElementById("pause-icon"),prevBtn:document.getElementById("prev-btn"),nextBtn:document.getElementById("next-btn"),prevChapterBtn:document.getElementById("prev-chapter-btn"),nextChapterBtn:document.getElementById("next-chapter-btn"),askBtn:document.getElementById("ask-btn"),quizBtn:document.getElementById("quiz-btn"),fullscreenBtn:document.getElementById("fullscreen-btn"),fullscreenExpandIcon:document.getElementById("fullscreen-expand-icon"),fullscreenCollapseIcon:document.getElementById("fullscreen-collapse-icon"),searchBtn:document.getElementById("search-btn"),loadBookBtn:document.getElementById("load-book-btn"),navBackBtn:document.getElementById("nav-back-btn"),navForwardBtn:document.getElementById("nav-forward-btn"),navHomeBtn:document.getElementById("nav-home-btn"),ttsStatus:document.getElementById("tts-status")}}_setupUploadHandlers(){const{uploadArea:e,fileInput:t}=this._elements;t.addEventListener("change",s=>{var n;const i=(n=s.target.files)==null?void 0:n[0];if(i){const o={type:"local",filename:i.name};this._loadBook(i,o)}s.target.value=""}),e.addEventListener("dragover",s=>{s.preventDefault(),e.classList.add("dragover")}),e.addEventListener("dragleave",()=>{e.classList.remove("dragover")}),e.addEventListener("drop",s=>{var n,o;s.preventDefault(),e.classList.remove("dragover");const i=(o=(n=s.dataTransfer)==null?void 0:n.files)==null?void 0:o[0];if(i){const r={type:"local",filename:i.name};this._loadBook(i,r)}})}async _handleFileSelect(e,t){var i,n,o,r,a;this._elements.readerScreen.classList.contains("active")&&(this._pause(),(i=this._qaController)==null||i.stop(),(n=this._qaOverlay)==null||n.hide(),(o=this._quizController)==null||o.stop(),(r=this._quizOverlay)==null||r.hide(),this._qaController&&(this._qaController.setBookMeta(null),this._qaController.clearHistory()),(a=this._quizController)==null||a.resetSession(),this._currentChapterIndex=0),this._bookLoaderModal.hide(),await this._loadBook(e,t)}async _handlePasteText(e,t,s){var r,a,l,h,d,p;const i=this._elements.readerScreen.classList.contains("active");i&&(this._pause(),(r=this._qaController)==null||r.stop(),(a=this._qaOverlay)==null||a.hide(),(l=this._quizController)==null||l.stop(),(h=this._quizOverlay)==null||h.hide(),this._qaController&&(this._qaController.setBookMeta(null),this._qaController.clearHistory()),(d=this._quizController)==null||d.resetSession(),this._currentChapterIndex=0),this._bookLoaderModal.hide();const{loadingIndicator:n,loadingText:o}=this._elements;try{if(i?this._showTTSStatus("Loading pasted content..."):(n.classList.remove("hidden"),o.textContent="Parsing pasted content..."),this._currentBook=await this._readingState.loadPastedContent(e,t,s),!this._currentBook.chapters.length)throw new Error("No readable content found in pasted text");i?this._showTTSStatus("Preparing reader..."):o.textContent="Preparing reader...",this._controls?(this._readerView.setBookTitle(this._currentBook.title),this._controls.setEnabled(!0),this._controls.setAskDisabled(!this._qaSettings.apiKey,"Configure API key in Q&A Settings to enable voice questions")):this._initializeReader(),(p=this._navigationHistory)==null||p.clear(),this._viewDecoupled=!1;const u=this._readingState.getCurrentPosition();await this._loadChapter(u.chapterIndex,!1),this._navigation.setBook(this._currentBook,u.chapterIndex),this._navigation.setBookmarks(this._readingState.getBookmarks()),this._navigation.setHighlights(this._readingState.getHighlights()),this._refreshLookupNav(),this._loadQuizHistory(),this._showScreen("reader"),this._saveCookieState(),i&&(this._hideTTSStatus(),this._showToast(`Loaded "${this._currentBook.title}"`))}catch(u){console.error("Failed to load pasted content:",u),i?(this._hideTTSStatus(),this._showToast(`Failed to load: ${u.message}`)):(n.classList.add("hidden"),this._bookLoaderModal.show(),this._bookLoaderModal.showError(u.message))}}async _handleGenerateText(e,t,s,i){var a,l,h,d,p,u;const n=this._elements.readerScreen.classList.contains("active");n&&(this._pause(),(a=this._qaController)==null||a.stop(),(l=this._qaOverlay)==null||l.hide(),(h=this._quizController)==null||h.stop(),(d=this._quizOverlay)==null||d.hide(),this._qaController&&(this._qaController.setBookMeta(null),this._qaController.clearHistory()),(p=this._quizController)==null||p.resetSession(),this._currentChapterIndex=0),this._bookLoaderModal.hide();const{loadingIndicator:o,loadingText:r}=this._elements;try{if(n?this._showTTSStatus("Loading generated content..."):(o.classList.remove("hidden"),r.textContent="Parsing generated content..."),this._currentBook=await this._readingState.loadPastedContent(e,t,s),this._currentBook.source={type:"llm-generated",format:t,model:i.model,language:i.language,length:i.length,genre:i.genre,description:i.description},this._currentBook.author=`Generated by ${i.model}`,await _.saveBook(this._currentBook),!this._currentBook.chapters.length)throw new Error("No readable content found in generated text");n?this._showTTSStatus("Preparing reader..."):r.textContent="Preparing reader...",this._controls?(this._readerView.setBookTitle(this._currentBook.title),this._controls.setEnabled(!0),this._controls.setAskDisabled(!this._qaSettings.apiKey,"Configure API key in Q&A Settings to enable voice questions")):this._initializeReader(),(u=this._navigationHistory)==null||u.clear(),this._viewDecoupled=!1;const g=this._readingState.getCurrentPosition();await this._loadChapter(g.chapterIndex,!1),this._navigation.setBook(this._currentBook,g.chapterIndex),this._navigation.setBookmarks(this._readingState.getBookmarks()),this._navigation.setHighlights(this._readingState.getHighlights()),this._refreshLookupNav(),this._loadQuizHistory(),this._showScreen("reader"),this._saveCookieState(),n&&(this._hideTTSStatus(),this._showToast(`Loaded "${this._currentBook.title}"`))}catch(g){console.error("Failed to load generated content:",g),n?(this._hideTTSStatus(),this._showToast(`Failed to load: ${g.message}`)):(o.classList.add("hidden"),this._bookLoaderModal.show(),this._bookLoaderModal.showError(g.message))}}async _handleGutenbergLoad(e){var s,i,n,o,r;this._elements.readerScreen.classList.contains("active")&&(this._pause(),(s=this._qaController)==null||s.stop(),(i=this._qaOverlay)==null||i.hide(),(n=this._quizController)==null||n.stop(),(o=this._quizOverlay)==null||o.hide(),this._qaController&&(this._qaController.setBookMeta(null),this._qaController.clearHistory()),(r=this._quizController)==null||r.resetSession(),this._currentChapterIndex=0),this._bookLoaderModal.showLoading("Fetching from Project Gutenberg...");try{this._bookLoaderModal.showLoading("Downloading EPUB...");const{file:a,source:l}=await this._downloadGutenbergEpub(e);this._bookLoaderModal.hide(),await this._loadBook(a,l)}catch(a){console.error("Failed to load from Gutenberg:",a),this._bookLoaderModal.showError(a.message)}}async _handleResumeFromModal(e){var s,i,n,o,r;this._elements.readerScreen.classList.contains("active")&&(this._pause(),(s=this._qaController)==null||s.stop(),(i=this._qaOverlay)==null||i.hide(),(n=this._quizController)==null||n.stop(),(o=this._quizOverlay)==null||o.hide(),this._qaController&&(this._qaController.setBookMeta(null),this._qaController.clearHistory()),(r=this._quizController)==null||r.resetSession(),this._currentChapterIndex=0),this._bookLoaderModal.hide(),await this._resumeLastBook(e)}async _downloadGutenbergEpub(e){const t=[`https://www.gutenberg.org/cache/epub/${e}/pg${e}.epub`,`https://www.gutenberg.org/files/${e}/${e}-0.epub`,`https://www.gutenberg.org/files/${e}/${e}.epub`],s=[n=>`https://corsproxy.io/?${encodeURIComponent(n)}`,n=>`https://api.allorigins.win/raw?url=${encodeURIComponent(n)}`],i=[];for(const n of t)for(const o of s)i.push(o(n));for(const n of i)try{const o=await fetch(n);if(o.ok){const r=await o.blob();if(r.size<100)throw new Error("Downloaded file is too small to be an EPUB");return{file:new File([r],`gutenberg-${e}.epub`,{type:"application/epub+zip"}),source:{type:"gutenberg",bookId:e}}}}catch(o){console.log(`Failed to load from ${n}:`,o.message)}throw new Error(`Book ${e} could not be loaded. The book might not be available as EPUB. Try downloading manually from https://www.gutenberg.org/ebooks/${e}`)}async _handleURLLoad(e){var s,i,n,o,r;this._elements.readerScreen.classList.contains("active")&&(this._pause(),(s=this._qaController)==null||s.stop(),(i=this._qaOverlay)==null||i.hide(),(n=this._quizController)==null||n.stop(),(o=this._quizOverlay)==null||o.hide(),this._qaController&&(this._qaController.setBookMeta(null),this._qaController.clearHistory()),(r=this._quizController)==null||r.resetSession(),this._currentChapterIndex=0),this._bookLoaderModal.showLoading("Fetching from URL...");try{const{file:a,source:l}=await this._downloadFromURL(e);this._bookLoaderModal.hide(),await this._loadBook(a,l)}catch(a){console.error("Failed to load from URL:",a),this._bookLoaderModal.showError(a.message)}}async _downloadFromURL(e){const t=[i=>`https://corsproxy.io/?${encodeURIComponent(i)}`,i=>`https://api.allorigins.win/raw?url=${encodeURIComponent(i)}`];let s=null;for(const i of t)try{const n=i(e),o=await fetch(n);if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const r=await o.blob();if(r.size<50)throw new Error("Downloaded content is too small");const a=o.headers.get("content-type")||"",{extension:l,mimeType:h}=this._detectContentType(e,a,r),p=new URL(e).pathname.split("/").pop()||"document",u=p.includes(".")?p:`${p}${l}`;return{file:new File([r],u,{type:h}),source:{type:"url",url:e}}}catch(n){s=n,console.log("Failed to load from URL via proxy:",n.message)}throw new Error(`Could not load content from URL. ${(s==null?void 0:s.message)||"All proxies failed."} The server may block cross-origin requests.`)}_detectContentType(e,t,s){const i=e.toLowerCase(),n=t.toLowerCase();return i.endsWith(".pdf")||n.includes("application/pdf")?{extension:".pdf",mimeType:"application/pdf"}:i.endsWith(".epub")||n.includes("application/epub")?{extension:".epub",mimeType:"application/epub+zip"}:i.endsWith(".md")||i.endsWith(".markdown")?{extension:".md",mimeType:"text/markdown"}:i.endsWith(".html")||i.endsWith(".htm")?{extension:".html",mimeType:"text/html"}:n.includes("text/markdown")?{extension:".md",mimeType:"text/markdown"}:n.includes("text/html")||n.includes("application/xhtml")?{extension:".html",mimeType:"text/html"}:n.includes("text/plain")?{extension:".html",mimeType:"text/html"}:{extension:".html",mimeType:"text/html"}}_setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{var i,n,o,r,a,l,h,d,p,u;if(!this._elements.readerScreen.classList.contains("active"))return;if((e.ctrlKey||e.metaKey)&&e.code==="KeyF"){e.preventDefault(),this._toggleSearchPanel();return}if(e.code==="Escape"&&((i=this._searchPanel)!=null&&i.isOpen())){e.preventDefault(),this._searchPanel.close(),(n=document.getElementById("search-overlay"))==null||n.classList.remove("active");return}const t=document.activeElement;if(!(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable)))switch(e.code){case"Space":e.preventDefault(),this._togglePlayPause();break;case"ArrowLeft":e.preventDefault(),(o=this._audioController)==null||o.skipBackward(1);break;case"ArrowRight":e.preventDefault(),(r=this._audioController)==null||r.skipForward();break;case"KeyB":e.preventDefault(),this._navigateToPrevChapter();break;case"KeyN":e.preventDefault(),this._navigateToNextChapter();break;case"PageUp":e.preventDefault(),e.shiftKey?this._navigateToPrevChapter():(a=this._readerView)!=null&&a.previousPage()||this._navigateToPrevChapter({goToLastPage:!0});break;case"PageDown":e.preventDefault(),e.shiftKey?this._navigateToNextChapter():(l=this._readerView)!=null&&l.nextPage()||this._navigateToNextChapter();break;case"Home":e.preventDefault(),e.shiftKey?this._navigateToChapter(0):(h=this._readerView)==null||h.firstPage();break;case"End":if(e.preventDefault(),e.shiftKey){const g=(((p=(d=this._currentBook)==null?void 0:d.chapters)==null?void 0:p.length)||1)-1;this._navigateToChapter(g)}else(u=this._readerView)==null||u.lastPage();break;case"KeyF":e.preventDefault(),this._toggleFullscreen();break}})}_setupFullscreen(){const{fullscreenBtn:e}=this._elements;if(!e)return;if(!(document.fullscreenEnabled||document.webkitFullscreenEnabled)){e.style.display="none";return}e.addEventListener("click",()=>{this._toggleFullscreen()});const s=()=>this._updateFullscreenIcon();document.addEventListener("fullscreenchange",s),document.addEventListener("webkitfullscreenchange",s)}async _toggleFullscreen(){const e=document.fullscreenElement||document.webkitFullscreenElement;try{if(e)document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen&&await document.webkitExitFullscreen();else{const t=document.documentElement;t.requestFullscreen?await t.requestFullscreen():t.webkitRequestFullscreen&&await t.webkitRequestFullscreen()}}catch(t){console.warn("Fullscreen toggle failed:",t)}}_updateFullscreenIcon(){const{fullscreenExpandIcon:e,fullscreenCollapseIcon:t}=this._elements;if(!e||!t)return;document.fullscreenElement||document.webkitFullscreenElement?(e.classList.add("hidden"),t.classList.remove("hidden")):(e.classList.remove("hidden"),t.classList.add("hidden"))}async _loadBook(e,t=null,s=null){var r;const{loadingIndicator:i,loadingText:n}=this._elements,o=this._elements.readerScreen.classList.contains("active");try{if(o)this._showTTSStatus("Loading new book...");else{i.classList.remove("hidden");const l=wt(e.name),h=l?de[l]:"file";n.textContent=`Parsing ${h}...`}if(this._currentBook=await this._readingState.loadBook(e,t,s),!this._currentBook.chapters.length)throw new Error("No readable content found in this file");o?this._showTTSStatus("Preparing reader..."):n.textContent="Preparing reader...",this._controls?(this._readerView.setBookTitle(this._currentBook.title),this._controls.setEnabled(!0),this._controls.setAskDisabled(!this._qaSettings.apiKey,"Configure API key in Q&A Settings to enable voice questions")):this._initializeReader(),(r=this._navigationHistory)==null||r.clear(),this._viewDecoupled=!1;const a=this._readingState.getCurrentPosition();await this._loadChapter(a.chapterIndex,!1),this._navigation.setBook(this._currentBook,a.chapterIndex),this._navigation.setBookmarks(this._readingState.getBookmarks()),this._navigation.setHighlights(this._readingState.getHighlights()),this._refreshLookupNav(),this._loadQuizHistory(),a.sentenceIndex>0&&(this._audioController.goToSentence(a.sentenceIndex),this._readerView.highlightSentence(a.sentenceIndex),this._playbackSentenceIndex=a.sentenceIndex),this._showScreen("reader"),this._saveCookieState(),o&&(this._hideTTSStatus(),this._showToast(`Loaded "${this._currentBook.title}"`))}catch(a){console.error("Failed to load book:",a),o?(this._hideTTSStatus(),this._showToast(`Failed to load: ${a.message}`)):this._showUploadError(a.message)}finally{o||i.classList.add("hidden")}}_initializeReader(){this._readerView=new Os({container:this._elements.readerContent,titleElement:this._elements.chapterTitle,bookTitleElement:this._elements.bookTitle,onSentenceClick:async t=>{var s;if(this._viewDecoupled){this._viewDecoupled=!1,this._pause();const i=await this._readingState.loadChapter(this._currentChapterIndex);this._audioController.setSentences(i,0),this._audioController.goToSentence(t),this._playbackChapterIndex=this._currentChapterIndex,this._playbackSentenceIndex=t,this._readingState.goToChapter(this._currentChapterIndex,t),this._updateNavHistoryButtons()}else(s=this._audioController)==null||s.goToSentence(t)},onLinkClick:t=>{this._handleInternalLink(t)},onImageClick:(t,s)=>{var i;(i=this._imageViewerModal)==null||i.show(t,s)},onHighlight:(t,s,i,n)=>{this._addHighlight(t,s,i,n)},onLookup:(t,s)=>{this._performLookup(t,s)},onPrevChapter:()=>this._navigateToPrevChapter({goToLastPage:!0}),onNextChapter:()=>this._navigateToNextChapter()}),this._audioController=new $s({onSentenceChange:t=>{this._playbackSentenceIndex=t,this._viewDecoupled?this._currentChapterIndex===this._playbackChapterIndex&&this._readerView.highlightSentence(t,!1):this._readerView.highlightSentence(t,!0),this._readingState&&this._readingState.updateSentencePosition(t)},onStateChange:t=>{t.status==="buffering"?this._controls.setBuffering(!0):this._controls.setPlaying(t.status==="playing"),A.setPlaybackState(t.status)},onChapterEnd:()=>{this._onChapterEnd()}}),this._initializeMediaSession(),this._pendingQuizSelection=null,this._elements.quizBtn&&this._elements.quizBtn.addEventListener("mousedown",()=>{var t;this._pendingQuizSelection=((t=this._readerView)==null?void 0:t.getSelectedSentenceTexts())||null}),this._controls=new Qs({playBtn:this._elements.playBtn,playIcon:this._elements.playIcon,pauseIcon:this._elements.pauseIcon,prevBtn:this._elements.prevBtn,nextBtn:this._elements.nextBtn,prevChapterBtn:this._elements.prevChapterBtn,nextChapterBtn:this._elements.nextChapterBtn,askBtn:this._elements.askBtn,quizBtn:this._elements.quizBtn},{onPlay:()=>this._play(),onPause:()=>this._pause(),onPrev:()=>this._audioController.skipBackward(1),onNext:()=>this._audioController.skipForward(),onPrevChapter:()=>this._navigateToPrevChapter(),onNextChapter:()=>this._navigateToNextChapter(),onAsk:()=>this._startQA(),onQuiz:()=>this._startQuiz()});const e=f.getAvailableVoices();this._settingsModal.setVoices(e),this._savedVoice&&f.setVoice(this._savedVoice),this._savedSpeed!==void 0&&this._audioController.setSpeed(this._savedSpeed),this._applyTypographySettings(),this._readerView.setBookTitle(this._currentBook.title),this._controls.setEnabled(!0),this._updateAskQuizButtons()}_initializeMediaSession(){if(!A.isSupported()){console.log("Media Session API not supported on this device");return}A.initialize({onPlay:()=>{this._play()},onPause:()=>{this._pause()},onEnterQAMode:()=>{this._qaSettings.apiKey?this._startQA():this._showToast("Q&A not available - configure API key in settings")},onExitQAMode:()=>{this._continueReadingFromQA()},onQAPlayPause:()=>{this._continueReadingFromQA()},onQANextQuestion:()=>{this._askAnotherQuestion()}}),console.log("Media Session initialized for headset controls")}_updateMediaSessionMetadata(){if(!this._currentBook)return;const e=this._currentBook.chapters[this._currentChapterIndex];A.updateMetadata({bookTitle:this._currentBook.title,chapterTitle:(e==null?void 0:e.title)||"",author:this._currentBook.author||""})}async _loadChapter(e,t=!0,{viewOnly:s=!1}={}){if(!this._currentBook||e<0||e>=this._currentBook.chapters.length)return;console.time(`App._loadChapter[${e}]`),this._currentChapterIndex=e;const i=this._currentBook.chapters[e];this._readerView.setChapterTitle(i.title),this._readerView.showLoading();const n=await this._readingState.loadChapter(e);if(console.timeEnd(`App._loadChapter[${e}]`),n.length===0&&t){const a=this._currentBook.chapters[e].html;if(!(a&&(a.includes("<img")||a.includes("<svg")||a.includes("<image")||a.includes("<video")||a.includes("<canvas")))){if(console.log(`Chapter ${e} is empty, skipping to next...`),e<this._currentBook.chapters.length-1)return this._loadChapter(e+1,t,{viewOnly:s});this._readerView.showError("No readable content found");return}}const o=this._currentBook.chapters[e].html||null;this._readerView.renderSentences(n,0,o),this._readerView.scrollToTop();const r=this._currentBook.chapters.length;if(this._readerView.setChapterBoundaries(e<=0,e>=r-1),this._readingState){const a=this._readingState.getHighlightsForChapter(e);this._readerView.setHighlights(a)}s||(this._audioController.setSentences(n,0),this._playbackChapterIndex=e,this._playbackSentenceIndex=0),this._updateMediaSessionMetadata()}async _onChapterEnd(){const e=this._playbackChapterIndex;if(e<this._currentBook.chapters.length-1){const t=e+1;if(this._readingState.goToChapter(t,0),this._viewDecoupled){const s=await this._readingState.loadChapter(t);this._audioController.setSentences(s,0),this._playbackChapterIndex=t,this._playbackSentenceIndex=0}else await this._loadChapter(t),this._navigation.setCurrentChapter(t);this._play()}else console.log("End of book reached"),this._showToast("End of book reached")}async _play(){this._audioController&&(f.isReady()||(this._showTTSStatus("Initializing TTS..."),await f.initialize(),this._hideTTSStatus()),this._audioController.play())}_pause(){var e;(e=this._audioController)==null||e.pause()}_togglePlayPause(){var t;const e=(t=this._audioController)==null?void 0:t.getState();(e==null?void 0:e.status)==="playing"?this._pause():this._play()}_setupQASetup(){const{setupFreeModels:e,setupPaidModels:t,setupApiKey:s,setupModel:i,saveQaSetupBtn:n}=this._elements;e&&t&&(Z.free.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=o.name,e.appendChild(r)}),Z.paid.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=o.name,t.appendChild(r)}),i&&(i.value=H)),n==null||n.addEventListener("click",()=>{var a;const o=((a=s==null?void 0:s.value)==null?void 0:a.trim())||"",r=(i==null?void 0:i.value)||H;this._qaSettings.apiKey=o,this._qaSettings.model=r,w.setApiKey(o),w.setModel(r),this._saveQASettings(this._qaSettings),this._updateQASetupStatus(),this._showToast("Q&A settings saved")})}_updateQASetupStatus(){const{qaSetupStatus:e,setupApiKey:t,setupModel:s}=this._elements;e&&(this._qaSettings.apiKey?(e.textContent="Configured",e.classList.add("configured")):(e.textContent="Not configured",e.classList.remove("configured"))),t&&(t.value=this._qaSettings.apiKey||""),s&&(s.value=this._qaSettings.model||H)}async _startQA(){var t,s,i;if(!this._qaSettings.apiKey){this._showToast("Please configure Q&A settings first"),this._settingsModal.setSettings(this._qaSettings),this._settingsModal.show();return}this._wasPlayingBeforeQA=((s=(t=this._audioController)==null?void 0:t.getState())==null?void 0:s.status)==="playing",this._pause(),this._qaController||this._initializeQAController(),this._qaController.setContextSettings(this._qaSettings.contextBefore,this._qaSettings.contextAfter,this._qaSettings.fullChapterContext);const e=this._savedSpeed||((i=this._settingsModal)==null?void 0:i.getSpeed())||1;this._qaController.setPlaybackSpeed(e),this._currentBook&&this._qaController.setBookMeta({title:this._currentBook.title,author:this._currentBook.author}),this._qaOverlay.reset(),this._qaOverlay.setHistory(this._qaController.getHistory()),this._qaOverlay.show(),A.setQAModeActive(!0),this._qaController.isSTTSupported()?this._qaController.startVoiceQA():(this._qaOverlay.setState(y.IDLE),this._qaOverlay.showTextInput())}_initializeQAController(){w.setApiKey(this._qaSettings.apiKey),w.setModel(this._qaSettings.model),this._qaController=new Ds({readingState:this._readingState,sttService:this._activeSTTService,onStateChange:(e,t)=>{this._qaOverlay.setState(e,t),t!=null&&t.error&&e===y.IDLE&&(t.error.includes("permission")||t.error.includes("Microphone"))&&this._qaOverlay.showTextInput()},onTranscript:e=>{this._qaOverlay.setTranscript(e)},onResponse:e=>{this._qaOverlay.setResponse(e)},onSentenceSpoken:(e,t)=>{},onHistoryAdd:e=>{this._qaOverlay.addHistoryEntry(e)}})}_closeQAOverlay(){var e;(e=this._qaController)==null||e.stop(),this._qaOverlay.hide(),A.setQAModeActive(!1)}_continueReadingFromQA(){var e;(e=this._qaController)==null||e.stop(),this._qaOverlay.hide(),A.setQAModeActive(!1),this._wasPlayingBeforeQA&&this._play()}_askAnotherQuestion(){var e,t,s;(e=this._qaController)==null||e.stop(),this._qaOverlay.reset(),this._qaOverlay.setHistory(((t=this._qaController)==null?void 0:t.getHistory())||[]),(s=this._qaController)!=null&&s.isSTTSupported()?this._qaController.startVoiceQA():(this._qaOverlay.setState(y.IDLE),this._qaOverlay.showTextInput())}_submitTextQuestion(e){this._qaController||this._initializeQAController(),this._qaOverlay.hideTextInput(),this._qaController.startTextQA(e)}async _retryVoiceInput(){this._qaController||this._initializeQAController(),await this._qaController.requestMicPermission()?(this._qaOverlay.hideTextInput(),this._qaController.startVoiceQA()):this._showToast("Microphone permission denied")}async _startQuiz(){var n;if(!this._qaSettings.apiKey){this._showToast("Please configure API key in Settings first"),this._settingsModal.setSettings({...this._qaSettings,...this._quizSettings}),this._settingsModal.show();return}this._pause(),this._quizController||this._initializeQuizController();const e=this._quizSettings.quizMode==="multiple-choice",t=Object.entries(this._quizSettings.quizQuestionTypes).filter(([,o])=>o).map(([o])=>o.replace(/_/g," "));t.length===0&&t.push("factual"),this._quizController.setSettings({isMultipleChoice:e,isGuided:this._quizSettings.quizGuided,readOptionsAloud:this._quizSettings.quizReadOptionsAloud,questionTypes:t,useFullChapter:this._quizSettings.quizChapterScope==="full",customSystemPrompt:this._quizSettings.quizSystemPrompt});const s=this._savedSpeed||((n=this._settingsModal)==null?void 0:n.getSpeed())||1;this._quizController.setPlaybackSpeed(s),this._currentBook&&this._quizController.setBookMeta({title:this._currentBook.title,author:this._currentBook.author});const i=this._pendingQuizSelection;this._pendingQuizSelection=null,this._quizController.setSelectionContext(i),this._quizOverlay.setMultipleChoice(e),this._quizOverlay.reset(),this._quizOverlay.show()}_initializeQuizController(){w.setApiKey(this._qaSettings.apiKey),w.setModel(this._qaSettings.model),this._quizController=new Ns({readingState:this._readingState,sttService:this._activeSTTService,onStateChange:(e,t)=>{this._quizOverlay.setState(e,t)},onQuestionReady:e=>{this._quizOverlay.showQuestion(e)},onFeedbackChunk:e=>{this._quizOverlay.setFeedbackText(e)},onAnswerResult:e=>{this._quizOverlay.showAnswerResult(e)},onTranscript:e=>{this._quizOverlay.setTranscript(e)},onVoiceStart:()=>{this._quizOverlay.showTranscript()},onVoiceEnd:()=>{this._quizOverlay.hideTranscript()},onError:e=>{this._quizOverlay.showError(e)}})}_closeQuizOverlay(){var e;(e=this._quizController)==null||e.stop(),this._quizOverlay.hide(),this._loadQuizHistory()}_openChapterOverview(){var s,i;if(!this._currentBook||!this._readerView)return;this._chapterOverview.setChapters(this._currentBook.chapters,this._currentChapterIndex),this._chapterOverview.setPageData({textContentEl:this._readerView.getTextContentElement(),totalPages:this._readerView.getTotalPages(),pageHeight:this._readerView.getPageHeight(),currentPage:this._readerView.getCurrentPage(),currentSentenceIndex:this._readerView.getCurrentIndex(),sentenceToPage:this._readerView.getSentenceToPageMap(),pageToSentences:this._readerView.getPageToSentencesMap()});const e=(((s=this._readingState)==null?void 0:s.getBookmarks())||[]).filter(n=>n.chapterIndex===this._currentChapterIndex),t=((i=this._readingState)==null?void 0:i.getHighlightsForChapter(this._currentChapterIndex))||[];this._chapterOverview.setBookmarks(e),this._chapterOverview.setHighlights(t),this._chapterOverview.show()}_closeChapterOverview(){this._chapterOverview.hide()}_onOverviewPageSelect(e){this._chapterOverview.hide(),this._readerView.goToPage(e)}async _onOverviewChapterSelect(e){e!==this._currentChapterIndex&&(this._chapterOverview.hide(),await this._navigateToChapter(e),setTimeout(()=>{this._openChapterOverview()},500))}async _loadQuizHistory(){if(!(!this._currentBook||!this._navigation))try{const e=await _.getAllQuizQuestionsForBook(this._currentBook.id,this._currentBook.chapters.length);this._navigation.setQuizHistory(e)}catch(e){console.error("Failed to load quiz history:",e)}}async _onTTSBackendChange(e){this._showTTSStatus("Switching TTS backend..."),this._pause(),this._audioController&&this._audioController.clearBuffers();try{const t=this._settingsModal.getSettings();f.setFastApiUrl(t.fastApiUrl),await f.setBackend(e);const s=f.getBackend();if(s==="kokoro-fastapi")this._showTTSStatus("TTS ready (Kokoro FastAPI)");else if(s==="kokoro-js"){const n=f.getDevice(),o=f.getDtype();this._showTTSStatus(`TTS ready (${n}, ${o})`)}else this._showTTSStatus("TTS ready (Browser)");const i=f.getAvailableVoices();this._controls&&this._controls.setVoices(i),this._settingsModal&&this._settingsModal.setVoices(i),setTimeout(()=>this._hideTTSStatus(),3e3)}catch(t){console.error("Failed to switch TTS backend:",t),this._showTTSStatus("Backend switch failed"),setTimeout(()=>this._hideTTSStatus(),5e3)}}_onVoiceChange(e){f.setVoice(e),this._savedVoice=e,this._saveSettings()}_onSpeedChange(e){var t;(t=this._audioController)==null||t.setSpeed(e),this._savedSpeed=e,this._saveSettings()}_applyTypographySettings(){var r;const e=(r=this._settingsModal)==null?void 0:r.getSettings();if(!e)return;const t=this._elements.textContent;if(!t)return;const s={default:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',serif:'Georgia, "Times New Roman", Times, serif',"sans-serif":"Arial, Helvetica, sans-serif",georgia:"Georgia, serif",times:'"Times New Roman", Times, serif',palatino:'"Palatino Linotype", "Book Antiqua", Palatino, serif',bookerly:"Bookerly, Georgia, serif"};t.style.fontFamily=s[e.font]||s.default,t.style.fontSize=`${e.fontSize}px`,t.style.lineHeight=e.lineSpacing;const n={narrow:30,medium:50,wide:80}[e.marginSize]||50,o=e.verticalMargin!==void 0?e.verticalMargin:2;if(t.style.padding=`${o}px ${n}px`,this._readerView){const a=e.columnCount||1,l=e.columnAutoCenter!==!1;this._readerView.setColumnAutoCenter(l),this._readerView.setColumnCount(a)}}async _saveQASettings(e){this._qaSettings={...this._qaSettings,...e},w.setApiKey(this._qaSettings.apiKey),w.setModel(this._qaSettings.model),this._qaController&&this._qaController.setContextSettings(this._qaSettings.contextBefore,this._qaSettings.contextAfter,this._qaSettings.fullChapterContext),e.readingHistorySize!==void 0&&(this._readingHistorySize=e.readingHistorySize,this._trimCookieHistory());try{e.readingHistorySize!==void 0&&await _.saveSetting("readingHistorySize",e.readingHistorySize),await _.saveSetting("qaApiKey",this._qaSettings.apiKey),await _.saveSetting("qaModel",this._qaSettings.model),await _.saveSetting("qaFullChapterContext",this._qaSettings.fullChapterContext),await _.saveSetting("qaContextBefore",this._qaSettings.contextBefore),await _.saveSetting("qaContextAfter",this._qaSettings.contextAfter),e.ttsBackend&&await _.saveSetting("ttsBackend",e.ttsBackend),e.fastApiUrl&&await _.saveSetting("fastApiUrl",e.fastApiUrl),e.voice&&(await _.saveSetting("voice",e.voice),this._savedVoice=e.voice),e.speed!==void 0&&(await _.saveSetting("playbackSpeed",e.speed),this._savedSpeed=e.speed),e.font&&await _.saveSetting("font",e.font),e.fontSize&&await _.saveSetting("fontSize",e.fontSize),e.marginSize&&await _.saveSetting("marginSize",e.marginSize),e.verticalMargin!==void 0&&await _.saveSetting("verticalMargin",e.verticalMargin),e.lineSpacing&&await _.saveSetting("lineSpacing",e.lineSpacing),e.columnCount!==void 0&&await _.saveSetting("columnCount",e.columnCount),e.columnAutoCenter!==void 0&&await _.saveSetting("columnAutoCenter",e.columnAutoCenter),e.normalizeText!==void 0&&await _.saveSetting("normalizeText",e.normalizeText),e.normalizeNumbers!==void 0&&await _.saveSetting("normalizeNumbers",e.normalizeNumbers),e.normalizeAbbreviations!==void 0&&await _.saveSetting("normalizeAbbreviations",e.normalizeAbbreviations),e.lookupLanguage!==void 0&&(z.setTargetLanguage(e.lookupLanguage),await _.saveSetting("lookupLanguage",e.lookupLanguage)),e.quizMode!==void 0&&(this._quizSettings.quizMode=e.quizMode,await _.saveSetting("quizMode",e.quizMode)),e.quizGuided!==void 0&&(this._quizSettings.quizGuided=e.quizGuided,await _.saveSetting("quizGuided",e.quizGuided)),e.quizReadOptionsAloud!==void 0&&(this._quizSettings.quizReadOptionsAloud=e.quizReadOptionsAloud,await _.saveSetting("quizReadOptionsAloud",e.quizReadOptionsAloud)),e.quizChapterScope!==void 0&&(this._quizSettings.quizChapterScope=e.quizChapterScope,await _.saveSetting("quizChapterScope",e.quizChapterScope)),e.quizQuestionTypes!==void 0&&(this._quizSettings.quizQuestionTypes=e.quizQuestionTypes,await _.saveSetting("quizQuestionTypes",e.quizQuestionTypes)),e.quizSystemPrompt!==void 0&&(this._quizSettings.quizSystemPrompt=e.quizSystemPrompt,await _.saveSetting("quizSystemPrompt",e.quizSystemPrompt)),e.mediaSessionVolume!==void 0&&await _.saveSetting("mediaSessionVolume",e.mediaSessionVolume),e.mediaSessionDuration!==void 0&&await _.saveSetting("mediaSessionDuration",e.mediaSessionDuration),(e.mediaSessionVolume!==void 0||e.mediaSessionDuration!==void 0)&&A.configure({volume:e.mediaSessionVolume,duration:e.mediaSessionDuration}),e.sttBackend!==void 0&&(this._sttBackend=e.sttBackend,await _.saveSetting("sttBackend",e.sttBackend),e.sttBackend==="whisper"?this._switchToWhisperSTT(e.whisperModel,e.whisperDevice):this._switchToWebSpeechSTT()),e.whisperModel!==void 0&&await _.saveSetting("whisperModel",e.whisperModel),e.whisperDevice!==void 0&&await _.saveSetting("whisperDevice",e.whisperDevice),e.llmBackend!==void 0&&(this._llmBackend=e.llmBackend,await _.saveSetting("llmBackend",e.llmBackend),w.setBackend(e.llmBackend)),e.localLlmModel!==void 0&&(await _.saveSetting("localLlmModel",e.localLlmModel),w.setLocalModel(e.localLlmModel)),e.localLlmDevice!==void 0&&(await _.saveSetting("localLlmDevice",e.localLlmDevice),w.setLocalDevice(e.localLlmDevice))}catch(t){console.error("Failed to save settings:",t)}this._applyTypographySettings(),this._updateQASetupStatus(),this._settingsModal.setSettings({...this._qaSettings,...this._quizSettings}),this._updateAskQuizButtons()}_updateAskQuizButtons(){if(!this._controls)return;const e=this._llmBackend==="local"||this._qaSettings.apiKey,t=this._llmBackend==="openrouter"&&!this._qaSettings.apiKey?"Configure API key in Q&A Settings or switch to Local LLM":null;this._controls.setAskDisabled(!e,t),this._controls.setQuizDisabled(!e,t)}async runBenchmark(e=5){if(this._currentBook){const t=this._currentBook.chapters[this._currentChapterIndex],s=t.sentences.slice(0,e);return console.log(`Running benchmark on ${s.length} sentences from "${t.title}"...`),f.runBenchmark(s)}else{const t=["The quick brown fox jumps over the lazy dog.","She sells seashells by the seashore.","How much wood would a woodchuck chuck if a woodchuck could chuck wood?","Peter Piper picked a peck of pickled peppers.","The rain in Spain stays mainly in the plain.","To be or not to be, that is the question.","All that glitters is not gold.","A journey of a thousand miles begins with a single step."];return console.log("No book loaded, using test sentences..."),f.runBenchmark(t.slice(0,e))}}setBenchmarkMode(e){f.setBenchmarkEnabled(e),console.log(`Benchmark mode ${e?"enabled":"disabled"}`),e&&console.log("TTS timing will be logged for each sentence.")}getTTSInfo(){return{ready:f.isReady(),usingKokoro:f.isUsingKokoro(),backend:f.getBackend(),device:f.getDevice(),dtype:f.getDtype(),fastApiUrl:f.getFastApiUrl(),fastApiAvailable:f.isFastAPIAvailable(),averageRTF:f.getAverageRTF(),benchmarkResults:f.getBenchmarkResults()}}_showScreen(e){this._elements.uploadScreen.classList.remove("active"),this._elements.readerScreen.classList.remove("active"),e==="upload"?this._elements.uploadScreen.classList.add("active"):this._elements.readerScreen.classList.add("active")}_showUploadError(e){const t=this._elements.uploadScreen.querySelector(".error-message");t&&t.remove();const s=document.createElement("div");s.className="error-message",s.innerHTML=`
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>${e}</span>
        `,this._elements.uploadArea.insertAdjacentElement("afterend",s),setTimeout(()=>{s.remove()},5e3)}_showTTSStatus(e){const t=this._elements.ttsStatus;t.querySelector("p").textContent=e,t.classList.remove("hidden")}_hideTTSStatus(){this._elements.ttsStatus.classList.add("hidden")}_setupNavHistoryButtons(){var e,t,s;(e=this._elements.navBackBtn)==null||e.addEventListener("click",()=>this._goBack()),(t=this._elements.navForwardBtn)==null||t.addEventListener("click",()=>this._goForward()),(s=this._elements.navHomeBtn)==null||s.addEventListener("click",()=>this._goHome())}_updateNavHistoryButtons(){var i,n;const{navBackBtn:e,navForwardBtn:t,navHomeBtn:s}=this._elements;e&&(e.disabled=!((i=this._navigationHistory)!=null&&i.canGoBack())),t&&(t.disabled=!((n=this._navigationHistory)!=null&&n.canGoForward())),s&&(s.disabled=!this._currentBook)}async _goBack(){var s,i,n;if(!((s=this._navigationHistory)!=null&&s.canGoBack()))return;const e=((i=this._readerView)==null?void 0:i.getCurrentPage())??0,t=this._navigationHistory.goBack(this._currentChapterIndex,((n=this._audioController)==null?void 0:n.getCurrentIndex())??0,e);t&&(this._viewDecoupled=!0,t.chapterIndex!==this._currentChapterIndex&&(await this._loadChapter(t.chapterIndex,!1,{viewOnly:!0}),this._navigation.setCurrentChapter(t.chapterIndex)),requestAnimationFrame(()=>{requestAnimationFrame(()=>{var o;(o=this._readerView)==null||o.goToPage(t.page)})}),this._updateNavHistoryButtons())}async _goForward(){var s,i,n;if(!((s=this._navigationHistory)!=null&&s.canGoForward()))return;const e=((i=this._readerView)==null?void 0:i.getCurrentPage())??0,t=this._navigationHistory.goForward(this._currentChapterIndex,((n=this._audioController)==null?void 0:n.getCurrentIndex())??0,e);t&&(this._viewDecoupled=!0,t.chapterIndex!==this._currentChapterIndex&&(await this._loadChapter(t.chapterIndex,!1,{viewOnly:!0}),this._navigation.setCurrentChapter(t.chapterIndex)),requestAnimationFrame(()=>{requestAnimationFrame(()=>{var o;(o=this._readerView)==null||o.goToPage(t.page)})}),this._updateNavHistoryButtons())}async _goHome(){var s;this._viewDecoupled=!1;const e=this._playbackChapterIndex,t=this._playbackSentenceIndex;if(e!==this._currentChapterIndex){await this._loadChapter(e,!1,{viewOnly:!0}),this._navigation.setCurrentChapter(e);const i=this._currentBook.chapters[e].sentences||[];this._audioController.setSentences(i,t)}(s=this._readerView)==null||s.highlightSentence(t,!0),this._updateNavHistoryButtons()}async _navigateToPrevChapter({goToLastPage:e=!1}={}){!this._currentBook||this._currentChapterIndex<=0||await this._navigateToChapter(this._currentChapterIndex-1,{pushHistory:!0,goToLastPage:e})}async _navigateToNextChapter(){!this._currentBook||this._currentChapterIndex>=this._currentBook.chapters.length-1||await this._navigateToChapter(this._currentChapterIndex+1,{pushHistory:!0})}async _navigateToChapter(e,{pushHistory:t=!0,goToLastPage:s=!1}={}){var i,n;e!==this._currentChapterIndex&&(t&&this._navigationHistory&&this._navigationHistory.pushCurrentPosition(this._currentChapterIndex,((i=this._audioController)==null?void 0:i.getCurrentIndex())??0,((n=this._readerView)==null?void 0:n.getCurrentPage())??0),t&&(this._viewDecoupled=!1,this._updateNavHistoryButtons()),this._pause(),this._readingState.goToChapter(e,0),s&&this._readerView.goToLastPageAfterRender(),await this._loadChapter(e,!1),this._navigation.setCurrentChapter(e),this._audioController.goToSentence(0),this._readerView.highlightSentence(0))}async _navigateToBookmark(e){var t,s;this._navigationHistory&&this._navigationHistory.pushCurrentPosition(this._currentChapterIndex,((t=this._audioController)==null?void 0:t.getCurrentIndex())??0,((s=this._readerView)==null?void 0:s.getCurrentPage())??0),this._viewDecoupled=!1,this._updateNavHistoryButtons(),this._pause(),this._readingState.goToBookmark(e),e.chapterIndex!==this._currentChapterIndex&&(await this._loadChapter(e.chapterIndex,!1),this._navigation.setCurrentChapter(e.chapterIndex)),this._audioController.goToSentence(e.sentenceIndex),this._readerView.highlightSentence(e.sentenceIndex),this._playbackChapterIndex=e.chapterIndex,this._playbackSentenceIndex=e.sentenceIndex}async _handleInternalLink(e){var r,a,l,h;if(!this._currentBook)return;const t=e.indexOf("#"),s=t>=0?e.substring(0,t):e,i=t>=0?e.substring(t+1):"";if(!s&&i){this._navigationHistory&&this._navigationHistory.pushCurrentPosition(this._currentChapterIndex,((r=this._audioController)==null?void 0:r.getCurrentIndex())??0,((a=this._readerView)==null?void 0:a.getCurrentPage())??0),this._viewDecoupled=!0,this._updateNavHistoryButtons(),this._readerView.scrollToFragment(i);return}const n=s.split("/").pop(),o=this._currentBook.chapters.findIndex(d=>d.href.split("/").pop().split("#")[0]===n);if(o===-1){console.warn("Could not find chapter for internal link:",e);return}this._navigationHistory&&this._navigationHistory.pushCurrentPosition(this._currentChapterIndex,((l=this._audioController)==null?void 0:l.getCurrentIndex())??0,((h=this._readerView)==null?void 0:h.getCurrentPage())??0),this._viewDecoupled=!0,this._updateNavHistoryButtons(),o!==this._currentChapterIndex&&(await this._loadChapter(o,!1,{viewOnly:!0}),this._navigation.setCurrentChapter(o)),i&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{this._readerView.scrollToFragment(i)})})})}async _addBookmark(){if(this._readingState)try{const e=prompt("Add a note (optional):");if(e===null)return;await this._readingState.addBookmark(e),this._showToast("Bookmark added"),this._navigation.setBookmarks(this._readingState.getBookmarks())}catch(e){console.error("Failed to add bookmark:",e),this._showToast("Failed to add bookmark")}}async _deleteBookmark(e){try{await this._readingState.deleteBookmark(e),this._showToast("Bookmark deleted"),this._navigation.setBookmarks(this._readingState.getBookmarks())}catch(t){console.error("Failed to delete bookmark:",t)}}async _addHighlight(e,t,s,i){if(this._readingState)try{await this._readingState.addHighlight(this._currentChapterIndex,e,t,s,"",i),this._showToast("Highlight added"),this._saveCookieState()}catch(n){console.error("Failed to add highlight:",n),this._showToast("Failed to add highlight")}}async _deleteHighlight(e){try{if(await this._readingState.deleteHighlight(e),this._showToast("Highlight deleted"),this._readerView&&this._readingState){const t=this._readingState.getHighlightsForChapter(this._currentChapterIndex);this._readerView.setHighlights(t)}this._saveCookieState()}catch(t){console.error("Failed to delete highlight:",t)}}async _navigateToHighlight(e){var t,s;this._navigationHistory&&this._navigationHistory.pushCurrentPosition(this._currentChapterIndex,((t=this._audioController)==null?void 0:t.getCurrentIndex())??0,((s=this._readerView)==null?void 0:s.getCurrentPage())??0),this._viewDecoupled=!1,this._updateNavHistoryButtons(),this._pause(),e.chapterIndex!==this._currentChapterIndex&&(this._readingState.goToChapter(e.chapterIndex,e.startSentenceIndex),await this._loadChapter(e.chapterIndex,!1),this._navigation.setCurrentChapter(e.chapterIndex)),this._audioController.goToSentence(e.startSentenceIndex),this._readerView.highlightSentence(e.startSentenceIndex),this._playbackChapterIndex=e.chapterIndex,this._playbackSentenceIndex=e.startSentenceIndex}_toggleSearchPanel(){const e=document.getElementById("search-overlay");this._searchPanel.isOpen()?(this._searchPanel.close(),e==null||e.classList.remove("active")):(this._searchPanel.open(),e==null||e.classList.add("active"))}async _onSearchResultSelect(e,t){var s,i;this._navigationHistory&&this._navigationHistory.pushCurrentPosition(this._currentChapterIndex,((s=this._audioController)==null?void 0:s.getCurrentIndex())??0,((i=this._readerView)==null?void 0:i.getCurrentPage())??0),this._viewDecoupled=!0,this._updateNavHistoryButtons(),e!==this._currentChapterIndex&&(await this._loadChapter(e,!1,{viewOnly:!0}),this._navigation.setCurrentChapter(e)),this._applySearchHighlightsForChapter(e,t),requestAnimationFrame(()=>{requestAnimationFrame(()=>{var n;(n=this._readerView)==null||n.scrollToSentence(t)})})}_applySearchHighlightsForChapter(e,t=-1){if(!this._searchPanel||!this._readerView)return;const s=this._searchPanel.getQuery();if(!s||s.trim().length<2){this._readerView.clearSearchHighlights();return}const n=this._searchPanel.getResults().filter(o=>o.chapterIndex===e);this._readerView.applySearchHighlights(s,this._searchPanel.isCaseSensitive(),this._searchPanel.isWholeWord(),n,t)}_onSearchClose(){var e,t;(e=this._readerView)==null||e.clearSearchHighlights(),(t=document.getElementById("search-overlay"))==null||t.classList.remove("active")}_onPositionChange(e,t){this._saveCookieState()}_onBookmarksChange(){this._navigation&&this._readingState&&this._navigation.setBookmarks(this._readingState.getBookmarks()),this._saveCookieState()}_onHighlightsChange(){this._navigation&&this._readingState&&this._navigation.setHighlights(this._readingState.getHighlights())}async _performLookup(e,t){var o;if(!w.hasApiKey()){this._lookupDrawer.showLoading(e),this._lookupDrawer.showError("Please set an OpenRouter API key in Settings to use word lookup.");return}if(!this._currentBook)return;this._lookupDrawer.showLoading(e);const s=(o=this._currentBook.chapters)==null?void 0:o[this._currentChapterIndex],n=((s==null?void 0:s.sentences)||[])[t]||"";try{const r=await z.lookup({phrase:e,sentenceContext:n,bookId:this._currentBook.id,chapterIndex:this._currentChapterIndex,sentenceIndex:t,bookMeta:{title:this._currentBook.title,author:this._currentBook.author}});this._lookupDrawer.showResult(r),this._refreshLookupNav()}catch(r){console.error("Lookup failed:",r),this._lookupDrawer.showError(r.message||"Lookup failed. Please try again.")}}async _showLookupHistory(){try{const e=await z.getAllLookups(),t={};this._currentBook&&(t[this._currentBook.id]={title:this._currentBook.title,author:this._currentBook.author});for(const s of e)t[s.bookId]||(t[s.bookId]={title:s.bookId});this._lookupHistoryOverlay.show(e,t)}catch(e){console.error("Failed to load lookup history:",e)}}async _refreshLookupNav(){if(!(!this._currentBook||!this._navigation))try{const e=await z.getBookLookups(this._currentBook.id);this._navigation.setLookups(e)}catch(e){console.error("Failed to refresh lookup nav:",e)}}async _loadSettings(){var e;try{const t=await _.getSetting("readingHistorySize");t!==null&&(this._readingHistorySize=t);const s=await _.getSetting("playbackSpeed");s!==null&&(this._savedSpeed=s);const i=await _.getSetting("voice");i!==null&&(this._savedVoice=i);const n=await _.getSetting("qaApiKey");n!==null&&(this._qaSettings.apiKey=n,w.setApiKey(n));const o=await _.getSetting("qaModel");o!==null&&(this._qaSettings.model=o,w.setModel(o));const r=await _.getSetting("qaFullChapterContext");r!==null&&(this._qaSettings.fullChapterContext=r);const a=await _.getSetting("qaContextBefore");a!==null&&(this._qaSettings.contextBefore=a);const l=await _.getSetting("qaContextAfter");l!==null&&(this._qaSettings.contextAfter=l);const h=await _.getSetting("font"),d=await _.getSetting("fontSize"),p=await _.getSetting("marginSize"),u=await _.getSetting("verticalMargin"),g=await _.getSetting("lineSpacing"),m={};h!==null&&(m.font=h),d!==null&&(m.fontSize=d),p!==null&&(m.marginSize=p),u!==null&&(m.verticalMargin=u),g!==null&&(m.lineSpacing=g);const v=await _.getSetting("columnCount"),S=await _.getSetting("columnAutoCenter");v!==null&&(m.columnCount=v),S!==null&&(m.columnAutoCenter=S);const L=await _.getSetting("normalizeText"),B=await _.getSetting("normalizeNumbers"),M=await _.getSetting("normalizeAbbreviations"),Q={};L!==null&&(Q.normalizeText=L),B!==null&&(Q.normalizeNumbers=B),M!==null&&(Q.normalizeAbbreviations=M);const $=await _.getSetting("lookupLanguage");$!==null&&z.setTargetLanguage($);const D=await _.getSetting("quizMode");D!==null&&(this._quizSettings.quizMode=D);const He=await _.getSetting("quizGuided");He!==null&&(this._quizSettings.quizGuided=He);const $e=await _.getSetting("quizReadOptionsAloud");$e!==null&&(this._quizSettings.quizReadOptionsAloud=$e);const De=await _.getSetting("quizChapterScope");De!==null&&(this._quizSettings.quizChapterScope=De);const Ne=await _.getSetting("quizQuestionTypes");Ne!==null&&(this._quizSettings.quizQuestionTypes=Ne);const Fe=await _.getSetting("quizSystemPrompt");Fe!==null&&(this._quizSettings.quizSystemPrompt=Fe);const ie=await _.getSetting("mediaSessionVolume"),ne=await _.getSetting("mediaSessionDuration"),oe={};ie!==null&&(oe.volume=ie),ne!==null&&(oe.duration=ne),Object.keys(oe).length>0&&A.configure(oe);const Oe=await _.getSetting("sttBackend");Oe!==null&&(this._sttBackend=Oe);const Qe=await _.getSetting("whisperModel"),Ge=await _.getSetting("whisperDevice"),Ue=await _.getSetting("llmBackend");Ue!==null&&(this._llmBackend=Ue);const ge=await _.getSetting("localLlmModel"),_e=await _.getSetting("localLlmDevice");this._sttBackend==="whisper"&&this._switchToWhisperSTT(Qe,Ge),this._llmBackend==="local"&&(w.setBackend("local"),ge&&w.setLocalModel(ge),_e&&w.setLocalDevice(_e)),this._updateQASetupStatus(),(e=this._settingsModal)==null||e.setSettings({readingHistorySize:this._readingHistorySize,...this._qaSettings,...this._quizSettings,voice:this._savedVoice,speed:this._savedSpeed,...m,...Q,lookupLanguage:$!==null?$:"auto",mediaSessionVolume:ie!==null?ie:void 0,mediaSessionDuration:ne!==null?ne:void 0,sttBackend:this._sttBackend,whisperModel:Qe||void 0,whisperDevice:Ge||"auto",llmBackend:this._llmBackend,localLlmModel:ge||void 0,localLlmDevice:_e||"auto"})}catch(t){console.error("Failed to load settings:",t)}}_switchToWhisperSTT(e,t){var s,i;this._whisperService||(this._whisperService=new ve),e&&this._whisperService.setModel(e),t&&this._whisperService.setDevice(t),this._activeSTTService=this._whisperService,(s=this._qaController)==null||s.setSTTService(this._whisperService),(i=this._quizController)==null||i.setSTTService(this._whisperService),console.log(`STT: Switched to Whisper (${e||"default"}, ${t||"auto"})`)}_switchToWebSpeechSTT(){var e,t;this._activeSTTService=V,(e=this._qaController)==null||e.setSTTService(V),(t=this._quizController)==null||t.setSTTService(V),console.log("STT: Switched to Web Speech API")}async _downloadWhisperModel(e){this._whisperService||(this._whisperService=new ve),this._whisperService.setModel(e.model),this._whisperService.setDevice(e.device),this._settingsModal.setWhisperStatus({loading:!0,statusText:"Starting download..."}),this._whisperService.onModelProgress=t=>{E.updateProgress(t),this._settingsModal.setWhisperStatus({loading:!0,statusText:t.status||"Downloading..."})},E.showProgress("Downloading Whisper Model");try{await this._whisperService.loadModel(),E.showComplete("Whisper model ready!"),this._settingsModal.setWhisperStatus({loaded:!0,statusText:"Model ready"})}catch(t){E.showError(t.message),this._settingsModal.setWhisperStatus({loaded:!1,statusText:`Error: ${t.message}`})}}async _downloadLocalLlmModel(e){w.setLocalModel(e.model),w.setLocalDevice(e.device),this._settingsModal.setLocalLlmStatus({loading:!0,statusText:"Starting download..."}),w.onModelProgress=t=>{E.updateProgress(t),this._settingsModal.setLocalLlmStatus({loading:!0,statusText:t.status||"Downloading..."})},E.showProgress("Downloading LLM Model");try{await w.loadLocalModel(),E.showComplete("LLM model ready!"),this._settingsModal.setLocalLlmStatus({loaded:!0,statusText:"Model ready"})}catch(t){E.showError(t.message),this._settingsModal.setLocalLlmStatus({loaded:!1,statusText:`Error: ${t.message}`})}}async _ensureLocalLlmReady(){if(w.isLocalModelReady())return!0;const{modelManager:e}=await ye(async()=>{const{modelManager:o}=await import("./model-manager-DUHq7npU.js");return{modelManager:o}},[]),t=w.getLocalModel(),s=e.getModelSize(t),i=w.getLocalAvailableModels().find(o=>o.id===t);if(!await E.promptDownload({modelName:(i==null?void 0:i.name)||t,modelSize:s.download,purpose:"AI Assistant"}))return!1;w.onModelProgress=o=>{E.updateProgress(o)};try{return await w.loadLocalModel(),E.showComplete("LLM model ready!"),!0}catch(o){return E.showError(o.message),!1}}async _ensureWhisperReady(){var o;if((o=this._whisperService)!=null&&o.isModelReady())return!0;this._whisperService||(this._whisperService=new ve);const{modelManager:e}=await ye(async()=>{const{modelManager:r}=await import("./model-manager-DUHq7npU.js");return{modelManager:r}},[]),t=this._whisperService.getModel(),s=e.getModelSize(t),i=this._whisperService.getAvailableModels().find(r=>r.id===t);if(!await E.promptDownload({modelName:(i==null?void 0:i.name)||t,modelSize:s.download,purpose:"Speech Recognition"}))return!1;this._whisperService.onModelProgress=r=>{E.updateProgress(r)};try{return await this._whisperService.loadModel(),E.showComplete("Whisper model ready!"),!0}catch(r){return E.showError(r.message),!1}}async _saveSettings(){try{this._savedSpeed!==void 0&&await _.saveSetting("playbackSpeed",this._savedSpeed),this._savedVoice!==void 0&&await _.saveSetting("voice",this._savedVoice)}catch(e){console.error("Failed to save settings:",e)}}_saveCookieState(){if(!this._currentBook||!this._readingState)return;const e=this._readingState.getCurrentPosition(),t={bookId:this._currentBook.id,bookTitle:this._currentBook.title,chapterIndex:e.chapterIndex,sentenceIndex:e.sentenceIndex,bookmarkCount:this._readingState.getBookmarks().length,highlightCount:this._readingState.getHighlights().length,source:this._currentBook.source||null,fileType:this._currentBook.fileType||"epub",timestamp:Date.now()};try{let s=this._loadCookieState();s=s.filter(r=>r.bookId!==t.bookId),s.unshift(t);const i=this._readingHistorySize||3;s=s.slice(0,i);const n=JSON.stringify(s),o=new Date(Date.now()+365*24*60*60*1e3).toUTCString();document.cookie=`readingPartnerState=${encodeURIComponent(n)};expires=${o};path=/;SameSite=Lax`}catch(s){console.error("Failed to save cookie state:",s)}}_loadCookieState(){try{const e=document.cookie.split(";");for(const t of e){const[s,i]=t.trim().split("=");if(s==="readingPartnerState"&&i){const n=JSON.parse(decodeURIComponent(i));return n&&!Array.isArray(n)?[n]:Array.isArray(n)?n:[]}}}catch(e){console.error("Failed to load cookie state:",e)}return[]}_trimCookieHistory(){try{let e=this._loadCookieState();const t=this._readingHistorySize||3;if(e.length>t){e=e.slice(0,t);const s=JSON.stringify(e),i=new Date(Date.now()+365*24*60*60*1e3).toUTCString();document.cookie=`readingPartnerState=${encodeURIComponent(s)};expires=${i};path=/;SameSite=Lax`}}catch(e){console.error("Failed to trim cookie history:",e)}}_checkResumeState(){var r,a;const e=this._loadCookieState();if(!e||e.length===0)return;const t=(r=this._elements.uploadScreen)==null?void 0:r.querySelector(".upload-container");if(!t)return;const s=t.querySelector(".resume-section");s&&s.remove();const i=document.createElement("div");i.className="resume-section";const n=document.createElement("div");n.className="resume-section-title",n.textContent="Continue reading",i.appendChild(n);for(const l of e){if(!l.bookId)continue;const h=document.createElement("div");h.className="resume-banner";const d=this._formatTimeAgo(l.timestamp),p=[];l.bookmarkCount>0&&p.push(`${l.bookmarkCount} bookmark${l.bookmarkCount>1?"s":""}`),l.highlightCount>0&&p.push(`${l.highlightCount} highlight${l.highlightCount>1?"s":""}`);const u=p.length>0?` (${p.join(", ")})`:"";let g="";((a=l.source)==null?void 0:a.type)==="gutenberg"&&(g=' <span class="resume-source">from Project Gutenberg</span>');const m=l.fileType||"epub",v=de[m]||m.toUpperCase(),S=`<span class="format-badge format-badge-sm format-${m}">${v}</span>`;h.innerHTML=`
                <div class="resume-info">
                    <div class="resume-detail">${S} "${this._escapeHtml(l.bookTitle)}"${g} - Chapter ${l.chapterIndex+1}${u}</div>
                    <div class="resume-time">Last read ${d}</div>
                </div>
                <button class="btn btn-primary btn-sm resume-btn">Resume</button>
            `,h.querySelector(".resume-btn").addEventListener("click",()=>{this._resumeLastBook(l)}),i.appendChild(h)}const o=t.querySelector(".upload-area");o?t.insertBefore(i,o):t.appendChild(i)}async _resumeLastBook(e){var n;const{loadingIndicator:t,loadingText:s}=this._elements,i=e.bookId;try{t.classList.remove("hidden"),s.textContent="Resuming book...";let o=null;try{this._currentBook=await this._readingState.openBook(i)}catch(a){o=a}if(o){const a=e.source;if((a==null?void 0:a.type)==="gutenberg"&&a.bookId){console.log("File data not in storage, re-downloading from Gutenberg..."),s.textContent="Re-downloading from Gutenberg...";const{file:l,source:h}=await this._downloadGutenbergEpub(a.bookId);await this._loadBook(l,h,i);return}throw new Error(o.message+". Please load the file again.")}if(!this._currentBook.chapters.length)throw new Error("No readable content found");s.textContent="Preparing reader...",this._controls?(this._readerView.setBookTitle(this._currentBook.title),this._controls.setEnabled(!0),this._controls.setAskDisabled(!this._qaSettings.apiKey,"Configure API key in Q&A Settings to enable voice questions")):this._initializeReader(),(n=this._navigationHistory)==null||n.clear(),this._viewDecoupled=!1;const r=this._readingState.getCurrentPosition();await this._loadChapter(r.chapterIndex,!1),this._navigation.setBook(this._currentBook,r.chapterIndex),this._navigation.setBookmarks(this._readingState.getBookmarks()),this._navigation.setHighlights(this._readingState.getHighlights()),this._loadQuizHistory(),r.sentenceIndex>0&&(this._audioController.goToSentence(r.sentenceIndex),this._readerView.highlightSentence(r.sentenceIndex),this._playbackSentenceIndex=r.sentenceIndex),this._showScreen("reader")}catch(o){console.error("Failed to resume book:",o),this._showUploadError("Could not resume: "+o.message)}finally{t.classList.add("hidden")}}_formatTimeAgo(e){const t=Math.floor((Date.now()-e)/1e3);if(t<60)return"just now";const s=Math.floor(t/60);if(s<60)return`${s} minute${s>1?"s":""} ago`;const i=Math.floor(s/60);if(i<24)return`${i} hour${i>1?"s":""} ago`;const n=Math.floor(i/24);if(n<30)return`${n} day${n>1?"s":""} ago`;const o=Math.floor(n/30);return`${o} month${o>1?"s":""} ago`}_escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}_showToast(e){const t=document.createElement("div");t.className="toast",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("show")},10),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>{t.remove()},300)},2e3)}}document.addEventListener("DOMContentLoaded",()=>{const c=new ni;c.init(),window.readingPartner=c,window.ttsEngine=f});
